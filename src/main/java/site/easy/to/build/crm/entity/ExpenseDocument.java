package site.easy.to.build.crm.entity;

import jakarta.persistence.*;
import java.time.LocalDateTime;

/**
 * ExpenseDocument - Links expense transactions to their supporting documents.
 *
 * Supports two types of documents:
 * 1. Generated Invoices - PDF invoices generated by the system for expenses
 * 2. Receipt Attachments - Uploaded receipts/invoices from vendors stored in Google Drive
 *
 * This enables property owners to:
 * - Download generated expense invoices for their records
 * - View attached receipts/vendor invoices for expense verification
 */
@Entity
@Table(name = "expense_documents")
public class ExpenseDocument {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // ===== TRANSACTION LINK =====

    /**
     * Link to UnifiedTransaction (primary source for expenses)
     */
    @Column(name = "unified_transaction_id")
    private Long unifiedTransactionId;

    /**
     * Link to FinancialTransaction (PayProp direct)
     */
    @Column(name = "financial_transaction_id")
    private Long financialTransactionId;

    /**
     * Link to HistoricalTransaction (CSV imports)
     */
    @Column(name = "historical_transaction_id")
    private Long historicalTransactionId;

    // ===== DOCUMENT REFERENCE =====

    /**
     * For uploaded receipts - links to GoogleDriveFile
     */
    @Column(name = "google_drive_file_id")
    private Integer googleDriveFileId;

    /**
     * For generated invoices - path/reference to generated PDF
     * Format: "generated/{propertyId}/{transactionId}_{timestamp}.pdf"
     */
    @Column(name = "generated_document_path", length = 500)
    private String generatedDocumentPath;

    /**
     * Google Drive file ID for generated invoice (if stored in Drive)
     */
    @Column(name = "generated_drive_file_id", length = 100)
    private String generatedDriveFileId;

    // ===== DOCUMENT METADATA =====

    /**
     * Document type: INVOICE, RECEIPT, QUOTE, CREDIT_NOTE, OTHER
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "document_type", length = 20, nullable = false)
    private DocumentType documentType;

    /**
     * Document status: PENDING, AVAILABLE, ARCHIVED
     */
    @Enumerated(EnumType.STRING)
    @Column(name = "status", length = 20)
    private DocumentStatus status = DocumentStatus.AVAILABLE;

    @Column(name = "document_number", length = 100)
    private String documentNumber;

    @Column(name = "document_description", length = 500)
    private String documentDescription;

    /**
     * Vendor/supplier name for the expense
     */
    @Column(name = "vendor_name", length = 255)
    private String vendorName;

    // ===== PROPERTY CONTEXT =====

    @Column(name = "property_id")
    private Long propertyId;

    @Column(name = "customer_id")
    private Integer customerId;

    // ===== AUDIT FIELDS =====

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @Column(name = "created_by")
    private Integer createdBy;

    // ===== ENUMS =====

    public enum DocumentType {
        INVOICE,        // Generated expense invoice
        RECEIPT,        // Uploaded receipt/proof of payment
        QUOTE,          // Quote/estimate
        CREDIT_NOTE,    // Credit note/refund
        VENDOR_INVOICE, // Invoice from vendor/contractor
        OTHER
    }

    public enum DocumentStatus {
        PENDING,    // Document generation pending
        AVAILABLE,  // Document ready for download
        ARCHIVED,   // Document archived (soft delete)
        ERROR       // Error generating document
    }

    // ===== CONSTRUCTORS =====

    public ExpenseDocument() {
        this.createdAt = LocalDateTime.now();
        this.status = DocumentStatus.AVAILABLE;
    }

    public ExpenseDocument(Long unifiedTransactionId, DocumentType documentType) {
        this();
        this.unifiedTransactionId = unifiedTransactionId;
        this.documentType = documentType;
    }

    // ===== LIFECYCLE CALLBACKS =====

    @PrePersist
    protected void onCreate() {
        if (createdAt == null) {
            createdAt = LocalDateTime.now();
        }
        if (status == null) {
            status = DocumentStatus.AVAILABLE;
        }
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }

    // ===== UTILITY METHODS =====

    /**
     * Check if this is a generated invoice (vs uploaded receipt)
     */
    public boolean isGeneratedDocument() {
        return generatedDocumentPath != null || generatedDriveFileId != null;
    }

    /**
     * Check if this is an uploaded document (stored in Google Drive)
     */
    public boolean isUploadedDocument() {
        return googleDriveFileId != null;
    }

    /**
     * Check if document is available for download
     */
    public boolean isAvailable() {
        return status == DocumentStatus.AVAILABLE;
    }

    // ===== GETTERS AND SETTERS =====

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getUnifiedTransactionId() {
        return unifiedTransactionId;
    }

    public void setUnifiedTransactionId(Long unifiedTransactionId) {
        this.unifiedTransactionId = unifiedTransactionId;
    }

    public Long getFinancialTransactionId() {
        return financialTransactionId;
    }

    public void setFinancialTransactionId(Long financialTransactionId) {
        this.financialTransactionId = financialTransactionId;
    }

    public Long getHistoricalTransactionId() {
        return historicalTransactionId;
    }

    public void setHistoricalTransactionId(Long historicalTransactionId) {
        this.historicalTransactionId = historicalTransactionId;
    }

    public Integer getGoogleDriveFileId() {
        return googleDriveFileId;
    }

    public void setGoogleDriveFileId(Integer googleDriveFileId) {
        this.googleDriveFileId = googleDriveFileId;
    }

    public String getGeneratedDocumentPath() {
        return generatedDocumentPath;
    }

    public void setGeneratedDocumentPath(String generatedDocumentPath) {
        this.generatedDocumentPath = generatedDocumentPath;
    }

    public String getGeneratedDriveFileId() {
        return generatedDriveFileId;
    }

    public void setGeneratedDriveFileId(String generatedDriveFileId) {
        this.generatedDriveFileId = generatedDriveFileId;
    }

    public DocumentType getDocumentType() {
        return documentType;
    }

    public void setDocumentType(DocumentType documentType) {
        this.documentType = documentType;
    }

    public DocumentStatus getStatus() {
        return status;
    }

    public void setStatus(DocumentStatus status) {
        this.status = status;
    }

    public String getDocumentNumber() {
        return documentNumber;
    }

    public void setDocumentNumber(String documentNumber) {
        this.documentNumber = documentNumber;
    }

    public String getDocumentDescription() {
        return documentDescription;
    }

    public void setDocumentDescription(String documentDescription) {
        this.documentDescription = documentDescription;
    }

    public String getVendorName() {
        return vendorName;
    }

    public void setVendorName(String vendorName) {
        this.vendorName = vendorName;
    }

    public Long getPropertyId() {
        return propertyId;
    }

    public void setPropertyId(Long propertyId) {
        this.propertyId = propertyId;
    }

    public Integer getCustomerId() {
        return customerId;
    }

    public void setCustomerId(Integer customerId) {
        this.customerId = customerId;
    }

    public LocalDateTime getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(LocalDateTime createdAt) {
        this.createdAt = createdAt;
    }

    public LocalDateTime getUpdatedAt() {
        return updatedAt;
    }

    public void setUpdatedAt(LocalDateTime updatedAt) {
        this.updatedAt = updatedAt;
    }

    public Integer getCreatedBy() {
        return createdBy;
    }

    public void setCreatedBy(Integer createdBy) {
        this.createdBy = createdBy;
    }

    @Override
    public String toString() {
        return "ExpenseDocument{" +
                "id=" + id +
                ", unifiedTransactionId=" + unifiedTransactionId +
                ", documentType=" + documentType +
                ", status=" + status +
                ", documentNumber='" + documentNumber + '\'' +
                ", vendorName='" + vendorName + '\'' +
                ", propertyId=" + propertyId +
                '}';
    }
}
