<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<!-- Form CSS -->
<link th:href="@{/css/bootstrap-datepicker.min.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

<style>
    .review-card {
        margin-bottom: 15px;
        border-left: 4px solid #ddd;
    }
    .review-card.perfect {
        border-left-color: #28a745;
    }
    .review-card.needs-review {
        border-left-color: #ffc107;
    }
    .review-card.has-issues {
        border-left-color: #dc3545;
    }
    .status-badge {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 3px;
    }
    .match-option {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .match-option:hover {
        background-color: #f8f9fa;
        border-color: #007bff;
    }
    .match-option.selected {
        background-color: #e7f3ff;
        border-color: #007bff;
        border-width: 2px;
    }
    .match-score {
        float: right;
        font-size: 12px;
        color: #666;
    }
    .duplicate-warning {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
    .csv-line {
        font-family: monospace;
        font-size: 12px;
        background-color: #f8f9fa;
        padding: 8px;
        border-radius: 4px;
        margin-top: 8px;
        overflow-x: auto;
        white-space: nowrap;
    }
    .create-entity-btn {
        font-size: 12px;
        padding: 4px 10px;
    }
    .summary-stats {
        position: sticky;
        top: 20px;
    }
    .property-search-dropdown {
        min-height: 200px !important;
        height: auto !important;
        font-size: 13px;
        border: 2px solid #007bff;
    }
    .property-search-dropdown option {
        padding: 8px;
        border-bottom: 1px solid #f0f0f0;
    }
    .property-search-dropdown option:hover {
        background-color: #e7f3ff;
    }
    .suggested-match {
        background-color: #fffbea !important;
        font-weight: 600;
    }
</style>

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>

    <div class="page-wrapper">
        <div class="container-fluid">

            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-6 align-self-center">
                    <h4 class="text-themecolor">Review Import Data</h4>
                </div>
                <div class="col-md-6 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0)">Financial</a></li>
                            <li class="breadcrumb-item"><a th:href="@{/employee/transaction/import}">Import</a></li>
                            <li class="breadcrumb-item active">Review</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Summary Panel -->
                <div class="col-lg-3">
                    <div class="card summary-stats">
                        <div class="card-header bg-info">
                            <h4 class="mb-0 text-white">
                                <i class="fas fa-chart-pie"></i> Summary
                            </h4>
                        </div>
                        <div class="card-body">
                            <div id="summaryContent">
                                <p class="text-center text-muted">Loading...</p>
                            </div>

                            <hr>

                            <button class="btn btn-success btn-block" id="confirmAllBtn" disabled>
                                <i class="fas fa-check"></i> Confirm & Import
                            </button>
                            <button class="btn btn-secondary btn-block" onclick="window.location.href='/employee/transaction/import'">
                                <i class="fas fa-arrow-left"></i> Back to Import
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Review Queue -->
                <div class="col-lg-9">
                    <div class="card">
                        <div class="card-header bg-primary">
                            <h4 class="mb-0 text-white">
                                <i class="fas fa-tasks"></i> Transaction Review Queue
                            </h4>
                        </div>
                        <div class="card-body">

                            <!-- Filter Buttons -->
                            <div class="btn-group mb-3" role="group">
                                <button type="button" class="btn btn-outline-secondary active" data-filter="all">
                                    All (<span id="countAll">0</span>)
                                </button>
                                <button type="button" class="btn btn-outline-success" data-filter="perfect">
                                    Perfect (<span id="countPerfect">0</span>)
                                </button>
                                <button type="button" class="btn btn-outline-warning" data-filter="needs-review">
                                    Needs Review (<span id="countNeedsReview">0</span>)
                                </button>
                                <button type="button" class="btn btn-outline-danger" data-filter="has-issues">
                                    Issues (<span id="countIssues">0</span>)
                                </button>
                            </div>

                            <!-- Review Items Container -->
                            <div id="reviewQueueContainer">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                                    <p>Loading review data...</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div th:replace="~{general/footer.html}"></div>
    </div>
</div>

<!-- Create Property Modal -->
<div class="modal fade" id="createPropertyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Property</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createPropertyForm">
                    <div class="form-group">
                        <label>Property Name *</label>
                        <input type="text" class="form-control" id="newPropertyName" required>
                    </div>
                    <div class="form-group">
                        <label>Address Line 1</label>
                        <input type="text" class="form-control" id="newPropertyAddress">
                    </div>
                    <div class="form-group">
                        <label>Postcode</label>
                        <input type="text" class="form-control" id="newPropertyPostcode">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePropertyBtn">Create Property</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Customer Modal -->
<div class="modal fade" id="createCustomerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Customer</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createCustomerForm">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" class="form-control" id="newCustomerFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" class="form-control" id="newCustomerLastName">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="newCustomerEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" class="form-control" id="newCustomerPhone">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomerBtn">Create Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Payment Source Modal -->
<div class="modal fade" id="createPaymentSourceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Payment Source</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createPaymentSourceForm">
                    <div class="form-group">
                        <label>Payment Source Name *</label>
                        <input type="text" class="form-control" id="newPaymentSourceName" required
                               placeholder="e.g., Old Account System, PayProp System">
                        <small class="form-text text-muted">A descriptive name for this payment source</small>
                    </div>
                    <div class="form-group">
                        <label>Source Type *</label>
                        <select class="form-control" id="newPaymentSourceType" required>
                            <option value="">-- Select Type --</option>
                            <option value="BANK_STATEMENT">Bank Statement</option>
                            <option value="LEGACY_SYSTEM">Legacy System / Old Account</option>
                            <option value="API_SYNC">API / External System</option>
                            <option value="MANUAL_ENTRY">Manual Entry</option>
                            <option value="SPREADSHEET">Spreadsheet Import</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="newPaymentSourceDescription" rows="2"
                                  placeholder="Optional description of this payment source"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePaymentSourceBtn">Create Payment Source</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>

<script th:inline="javascript">
/*<![CDATA[*/
$(document).ready(function() {
    // CRITICAL: Hide the preloader immediately to prevent blank screen
    $(".preloader").fadeOut(100);

    // Safety check - force hide preloader after 3 seconds if still visible
    setTimeout(function() {
        if ($(".preloader").is(":visible")) {
            console.log("‚ö†Ô∏è Preloader was still visible - force hiding it");
            $(".preloader").hide();
        }
    }, 3000);

    const batchId = /*[[${batchId}]]*/ null;
    const csrfToken = $('meta[name="_csrf"]').attr('content');
    const csrfHeader = $('meta[name="_csrf_header"]').attr('content');

    let reviewQueue = null;
    let currentFilter = 'all';
    let currentCreateContext = null; // For entity creation callbacks
    window.paymentSources = []; // Global payment sources list

    // Load payment sources, properties, and customers first, then review data
    Promise.all([loadPaymentSources(), loadAllProperties(), loadAllCustomers()]).then(() => {
        loadReviewData();
    });

    function loadPaymentSources() {
        console.log('üìã Loading payment sources...');
        return $.ajax({
            url: '/employee/payment-sources/all',
            method: 'GET',
            headers: {
                [csrfHeader]: csrfToken
            }
        }).done(function(response) {
            if (response.success && response.sources) {
                window.paymentSources = response.sources;
                console.log(`‚úÖ Loaded ${response.sources.length} payment sources`);
            } else {
                console.error('‚ùå Failed to load payment sources:', response);
                showError('Failed to load payment sources. Please refresh the page.');
            }
        }).fail(function(xhr, status, error) {
            console.error('‚ùå Payment sources API error:', error);
            showError('Failed to load payment sources: ' + error);
        });
    }

    function loadAllProperties() {
        console.log('üè† Loading all properties...');
        return $.ajax({
            url: '/employee/property/all-properties',
            method: 'GET',
            headers: {
                [csrfHeader]: csrfToken
            }
        }).done(function(response) {
            if (response && Array.isArray(response)) {
                window.allProperties = response;
                console.log(`‚úÖ Loaded ${response.length} properties`);
            } else {
                console.error('‚ùå Failed to load properties:', response);
            }
        }).fail(function(xhr, status, error) {
            console.error('‚ùå Properties API error:', error);
        });
    }

    function loadAllCustomers() {
        console.log('üë• Loading all customers...');
        return $.ajax({
            url: '/employee/customer/manager/all-customers',
            method: 'GET',
            headers: {
                [csrfHeader]: csrfToken
            }
        }).done(function(response) {
            if (response && Array.isArray(response)) {
                window.allCustomers = response;
                console.log(`‚úÖ Loaded ${response.length} customers`);
            } else {
                console.error('‚ùå Failed to load customers:', response);
            }
        }).fail(function(xhr, status, error) {
            console.error('‚ùå Customers API error:', error);
        });
    }

    function loadReviewData() {
        console.log('üîç Loading review data from localStorage...');
        const reviewData = localStorage.getItem('reviewData');
        console.log('üìã localStorage reviewData:', reviewData ? 'Found (' + reviewData.length + ' chars)' : 'NULL');

        if (!reviewData) {
            console.error('‚ùå No review data in localStorage');
            showError('No review data found. Please return to import page and click "Review & Verify".');
            return;
        }

        try {
            reviewQueue = JSON.parse(reviewData);
            console.log('‚úÖ Parsed review queue:', reviewQueue);
            console.log('üìä Review queue has', reviewQueue.reviews ? reviewQueue.reviews.length : 0, 'reviews');
            renderReviewQueue();
            updateSummary();
        } catch (e) {
            console.error('‚ùå Failed to parse review data:', e);
            console.error('Raw data:', reviewData);
            showError('Invalid review data format: ' + e.message);
        }
    }

    function renderReviewQueue() {
        console.log('üìù renderReviewQueue() called');
        const container = $('#reviewQueueContainer');
        container.empty();
        console.log('üóëÔ∏è Container cleared');

        if (!reviewQueue || !reviewQueue.reviews || reviewQueue.reviews.length === 0) {
            console.warn('‚ö†Ô∏è No reviews to render');
            container.html('<p class="text-center text-muted">No transactions to review.</p>');
            return;
        }

        console.log('üîÑ Creating', reviewQueue.reviews.length, 'review cards...');

        try {
            reviewQueue.reviews.forEach((review, index) => {
                console.log('üìã Creating card', index, 'for review:', review);
                const card = createReviewCard(review, index);
                console.log('üé¥ Card created, type:', typeof card, 'length:', card ? card.length : 'N/A');
                console.log('‚ûï Appending card to container...');
                container.append(card);
                console.log('‚úÖ Card', index, 'appended successfully');
                console.log('üì¶ Container now has', container.children().length, 'children');
            });

            console.log('üèÅ forEach loop complete - moving to updateCounts');
            console.log('üìä Updating counts...');
            updateCounts();
            console.log('üéØ Applying filter...');
            applyFilter();
            console.log('‚úÖ renderReviewQueue() complete');
        } catch (e) {
            console.error('üí• FATAL ERROR in renderReviewQueue:', e);
            console.error('Stack trace:', e.stack);
            showError('Failed to render review cards: ' + e.message);
        }
    }

    function createReviewCard(review, index) {
        const statusClass = getStatusClass(review.status);
        const statusLabel = getStatusLabel(review.status);
        const statusBadge = getStatusBadge(review.status);

        let card = $(`
            <div class="review-card card ${statusClass}" data-index="${index}" data-status-class="${statusClass}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>
                                Line ${review.lineNumber}
                                ${statusBadge}
                            </h6>
                            <div class="csv-line">${escapeHtml(review.csvLine)}</div>

                            ${renderParsedData(review)}
                            ${renderPaymentSourceSelector(review, index)}
                            ${renderPropertyOptions(review, index)}
                            ${renderCustomerOptions(review, index)}
                            ${renderDuplicateInfo(review, index)}
                            ${renderErrorMessage(review)}
                        </div>
                        <div class="col-md-4">
                            ${renderUserActions(review, index)}
                        </div>
                    </div>
                </div>
            </div>
        `);

        return card;
    }

    function getStatusClass(status) {
        if (status === 'PERFECT') return 'perfect';
        if (status === 'VALIDATION_ERROR') return 'has-issues';
        return 'needs-review';
    }

    function getStatusLabel(status) {
        const labels = {
            'PERFECT': 'Perfect Match',
            'AMBIGUOUS_PROPERTY': 'Multiple Property Matches',
            'AMBIGUOUS_CUSTOMER': 'Multiple Customer Matches',
            'MISSING_PROPERTY': 'Property Not Found',
            'MISSING_CUSTOMER': 'Customer Not Found',
            'POTENTIAL_DUPLICATE': 'Potential Duplicate',
            'VALIDATION_ERROR': 'Validation Error'
        };
        return labels[status] || status;
    }

    function getStatusBadge(status) {
        const badges = {
            'PERFECT': '<span class="badge badge-success status-badge">‚úì Perfect</span>',
            'AMBIGUOUS_PROPERTY': '<span class="badge badge-warning status-badge">‚ö† Choose Property</span>',
            'AMBIGUOUS_CUSTOMER': '<span class="badge badge-warning status-badge">‚ö† Choose Customer</span>',
            'MISSING_PROPERTY': '<span class="badge badge-danger status-badge">‚úó Property Missing</span>',
            'MISSING_CUSTOMER': '<span class="badge badge-info status-badge">? Customer Missing</span>',
            'POTENTIAL_DUPLICATE': '<span class="badge badge-warning status-badge">‚ö† Duplicate?</span>',
            'VALIDATION_ERROR': '<span class="badge badge-danger status-badge">‚úó Error</span>'
        };
        return badges[status] || '';
    }

    function renderParsedData(review) {
        if (!review.parsedData) return '';

        const data = review.parsedData;
        return `
            <div class="mt-2">
                <small class="text-muted">
                    <strong>Date:</strong> ${data.date || 'N/A'} |
                    <strong>Amount:</strong> ${data.amount || 'N/A'} |
                    <strong>Type:</strong> ${data.type || 'N/A'}
                </small>
                <br>
                <small class="text-muted">
                    <strong>Description:</strong> ${escapeHtml(data.description || 'N/A')}
                </small>
            </div>
        `;
    }

    function renderPropertyOptions(review, index) {
        if (!review.propertyOptions || review.propertyOptions.length === 0) {
            if (review.status === 'MISSING_PROPERTY') {
                // Show search + all properties dropdown when no matches found
                let html = `
                    <div class="mt-3">
                        <strong class="text-danger">Property: "${escapeHtml(review.parsedData.propertyRef || 'Unknown')}" not found</strong>

                        <div class="mt-2">
                            <label class="font-weight-bold">Search & Select Property:</label>
                            <input type="text" class="form-control form-control-sm mb-2"
                                   id="propertySearch${index}"
                                   placeholder="Type to search properties..."
                                   onkeyup="filterPropertyDropdown(${index})"
                                   onfocus="this.select()">
                            <select class="form-control form-control-sm property-search-dropdown"
                                    id="propertyDropdown${index}"
                                    onchange="selectPropertyFromDropdown(${index})"
                                    size="8">
                                <option value="">-- Select Any Property --</option>`;

                // Add ALL properties
                if (window.allProperties && window.allProperties.length > 0) {
                    window.allProperties.forEach(prop => {
                        const selected = review.selectedPropertyId === prop.id ? 'selected' : '';
                        const propName = escapeHtml(prop.property_name || prop.propertyName);
                        const address = escapeHtml((prop.address_line_1 || prop.addressLine1 || '') + ' ' + (prop.postcode || ''));
                        html += `<option value="${prop.id}" ${selected} data-search="${propName.toLowerCase()} ${address.toLowerCase()}">${propName}${address ? ' - ' + address : ''}</option>`;
                    });
                }

                html += `</select>
                            <small class="text-muted d-block mt-1" id="searchResultCount${index}"></small>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-primary create-entity-btn" onclick="createProperty(${index}, '${escapeHtml(review.parsedData.propertyRef || '')}')">
                                <i class="fas fa-plus"></i> Create New Property
                            </button>
                        </div>
                    </div>
                `;
                return html;
            }
            return '';
        }

        let html = '<div class="mt-3">';
        html += '<div class="row">';
        html += '<div class="col-md-8"><strong>Select Property:</strong></div>';
        html += '<div class="col-md-4 text-right">';
        html += `<button class="btn btn-xs btn-outline-primary" onclick="createProperty(${index}, '${escapeHtml(review.parsedData.propertyRef || '')}')">
                    <i class="fas fa-plus"></i> Create New
                 </button>`;
        html += '</div>';
        html += '</div>';

        // Show suggested matches as clickable boxes
        if (review.propertyOptions && review.propertyOptions.length > 0) {
            html += '<div class="mt-2">';
            html += '<small class="text-muted font-weight-bold">SUGGESTED MATCHES:</small>';
            review.propertyOptions.forEach((option, optIndex) => {
                const selected = review.selectedPropertyId === option.propertyId ? 'selected' : '';
                html += `
                    <div class="match-option ${selected}" data-index="${index}" data-option-id="${option.propertyId}" onclick="selectProperty(${index}, ${option.propertyId})">
                        <strong>${escapeHtml(option.propertyName)}</strong>
                        <span class="match-score">${option.matchScore}% match</span>
                        <br>
                        <small class="text-muted">${escapeHtml(option.addressLine1 || '')} ${escapeHtml(option.postcode || '')}</small>
                    </div>
                `;
            });
            html += '</div>';
        }

        // Add searchable dropdown for ALL properties
        html += '<div class="mt-3">';
        html += '<small class="text-muted font-weight-bold">OR SEARCH ALL PROPERTIES:</small>';
        html += '<input type="text" class="form-control form-control-sm mb-2 mt-1" ';
        html += `id="propertySearch${index}" `;
        html += 'placeholder="Type to search all properties..."';
        html += `onkeyup="filterPropertyDropdown(${index})" onfocus="this.select()">`;
        html += `<select class="form-control form-control-sm property-search-dropdown" id="propertyDropdown${index}" onchange="selectPropertyFromDropdown(${index})" size="8">`;
        html += '<option value="">-- Select Any Property --</option>';

        // Add suggested matches first (with match score)
        if (review.propertyOptions && review.propertyOptions.length > 0) {
            review.propertyOptions.forEach(option => {
                const selected = review.selectedPropertyId === option.propertyId ? 'selected' : '';
                const propName = escapeHtml(option.propertyName);
                const address = escapeHtml((option.addressLine1 || '') + ' ' + (option.postcode || ''));
                html += `<option value="${option.propertyId}" ${selected} data-search="${propName.toLowerCase()} ${address.toLowerCase()}" class="suggested-match">üìå ${propName} (${option.matchScore}% match)${address ? ' - ' + address : ''}</option>`;
            });
        }

        // Add separator
        if (review.propertyOptions && review.propertyOptions.length > 0) {
            html += '<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
        }

        // Add ALL properties
        if (window.allProperties && window.allProperties.length > 0) {
            window.allProperties.forEach(prop => {
                // Skip if already in suggested matches
                const alreadySuggested = review.propertyOptions && review.propertyOptions.some(opt => opt.propertyId === prop.id);
                if (!alreadySuggested) {
                    const selected = review.selectedPropertyId === prop.id ? 'selected' : '';
                    const propName = escapeHtml(prop.property_name || prop.propertyName);
                    const address = escapeHtml((prop.address_line_1 || prop.addressLine1 || '') + ' ' + (prop.postcode || ''));
                    html += `<option value="${prop.id}" ${selected} data-search="${propName.toLowerCase()} ${address.toLowerCase()}">${propName}${address ? ' - ' + address : ''}</option>`;
                }
            });
        }
        html += '</select>';
        html += '<small class="text-muted d-block mt-1" id="searchResultCount${index}"></small>';
        html += '</div>';

        html += '</div>';
        return html;
    }

    function renderCustomerOptions(review, index) {
        if (!review.customerOptions || review.customerOptions.length === 0) {
            if (review.status === 'MISSING_CUSTOMER') {
                // Get property-related customers if property is selected
                const propertyId = review.selectedPropertyId;
                let propertyCustomers = [];
                let otherCustomers = [];

                if (propertyId && window.allCustomers) {
                    window.allCustomers.forEach(customer => {
                        // Check if customer is related to this property (owner, tenant, or beneficiary)
                        const isPropertyRelated = customer.propertyOwnerId === propertyId ||
                            (customer.properties && customer.properties.includes(propertyId)) ||
                            (customer.assignedProperties && customer.assignedProperties.includes(propertyId));

                        if (isPropertyRelated) {
                            propertyCustomers.push(customer);
                        } else {
                            otherCustomers.push(customer);
                        }
                    });
                }

                // Show search + customers dropdown prioritizing property-related customers
                let html = `
                    <div class="mt-3">
                        <strong class="text-info">Customer: "${escapeHtml(review.parsedData.customerRef || 'Unknown')}" not found</strong>`;

                if (propertyCustomers.length > 0) {
                    html += `<div class="alert alert-info mt-2 py-2 px-3" style="font-size: 12px;">
                        <i class="fas fa-lightbulb"></i> <strong>${propertyCustomers.length} customer(s)</strong> associated with selected property
                    </div>`;
                }

                html += `<div class="mt-2">
                            <label class="font-weight-bold">Search & Select Customer:</label>
                            <input type="text" class="form-control form-control-sm mb-2"
                                   id="customerSearch${index}"
                                   placeholder="Type to search customers..."
                                   onkeyup="filterCustomerDropdown(${index})"
                                   onfocus="this.select()">
                            <select class="form-control form-control-sm property-search-dropdown"
                                    id="customerDropdown${index}"
                                    onchange="selectCustomerFromDropdown(${index})"
                                    size="8">
                                <option value="">-- Select Any Customer --</option>`;

                // Add property-related customers FIRST
                if (propertyCustomers.length > 0) {
                    propertyCustomers.forEach(customer => {
                        const selected = review.selectedCustomerId === customer.id ? 'selected' : '';
                        const custName = escapeHtml(customer.name || customer.fullName || (customer.firstName + ' ' + customer.lastName));
                        const contact = escapeHtml((customer.email || '') + ' ' + (customer.phone || customer.mobileNumber || ''));
                        const type = customer.accountType === 'property_owner' ? 'üè† Owner' : (customer.accountType === 'beneficiary' ? 'üí∞ Beneficiary' : 'üë§ Tenant');
                        html += `<option value="${customer.id}" ${selected} data-search="${custName.toLowerCase()} ${contact.toLowerCase()}" class="suggested-match">‚≠ê ${type} - ${custName}${contact ? ' - ' + contact : ''}</option>`;
                    });

                    // Add separator if there are other customers
                    if (otherCustomers.length > 0) {
                        html += '<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
                    }
                }

                // Add other customers
                if (window.allCustomers && window.allCustomers.length > 0) {
                    const customersToShow = propertyCustomers.length > 0 ? otherCustomers : window.allCustomers;
                    customersToShow.forEach(customer => {
                        const selected = review.selectedCustomerId === customer.id ? 'selected' : '';
                        const custName = escapeHtml(customer.name || customer.fullName || (customer.firstName + ' ' + customer.lastName));
                        const contact = escapeHtml((customer.email || '') + ' ' + (customer.phone || customer.mobileNumber || ''));
                        html += `<option value="${customer.id}" ${selected} data-search="${custName.toLowerCase()} ${contact.toLowerCase()}">${custName}${contact ? ' - ' + contact : ''}</option>`;
                    });
                }

                html += `</select>
                            <small class="text-muted d-block mt-1" id="customerSearchResultCount${index}"></small>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-primary create-entity-btn" onclick="createCustomer(${index}, '${escapeHtml(review.parsedData.customerRef || '')}')">
                                <i class="fas fa-plus"></i> Create New Customer
                            </button>
                        </div>
                    </div>
                `;
                return html;
            }
            return '';
        }

        let html = '<div class="mt-3">';
        html += '<div class="row">';
        html += '<div class="col-md-8"><strong>Select Customer:</strong></div>';
        html += '<div class="col-md-4 text-right">';
        html += `<button class="btn btn-xs btn-outline-primary" onclick="createCustomer(${index}, '${escapeHtml(review.parsedData.customerRef || '')}')">
                    <i class="fas fa-plus"></i> Create New
                 </button>`;
        html += '</div>';
        html += '</div>';

        // Show suggested matches as clickable boxes
        if (review.customerOptions && review.customerOptions.length > 0) {
            html += '<div class="mt-2">';
            html += '<small class="text-muted font-weight-bold">SUGGESTED MATCHES:</small>';
            review.customerOptions.forEach((option, optIndex) => {
                const selected = review.selectedCustomerId === option.customerId ? 'selected' : '';
                html += `
                    <div class="match-option ${selected}" data-index="${index}" data-option-id="${option.customerId}" onclick="selectCustomer(${index}, ${option.customerId})">
                        <strong>${escapeHtml(option.fullName)}</strong>
                        <span class="match-score">${option.matchScore}% match</span>
                        <br>
                        <small class="text-muted">${escapeHtml(option.email || '')} ${escapeHtml(option.phone || '')}</small>
                    </div>
                `;
            });
            html += '</div>';
        }

        // Add searchable dropdown for ALL customers
        html += '<div class="mt-3">';
        html += '<small class="text-muted font-weight-bold">OR SEARCH ALL CUSTOMERS:</small>';
        html += '<input type="text" class="form-control form-control-sm mb-2 mt-1" ';
        html += `id="customerSearch${index}" `;
        html += 'placeholder="Type to search all customers..."';
        html += `onkeyup="filterCustomerDropdown(${index})" onfocus="this.select()">`;
        html += `<select class="form-control form-control-sm property-search-dropdown" id="customerDropdown${index}" onchange="selectCustomerFromDropdown(${index})" size="8">`;
        html += '<option value="">-- Select Any Customer --</option>';

        // Add suggested matches first
        if (review.customerOptions && review.customerOptions.length > 0) {
            review.customerOptions.forEach(option => {
                const selected = review.selectedCustomerId === option.customerId ? 'selected' : '';
                const custName = escapeHtml(option.fullName);
                const contact = escapeHtml((option.email || '') + ' ' + (option.phone || ''));
                html += `<option value="${option.customerId}" ${selected} data-search="${custName.toLowerCase()} ${contact.toLowerCase()}" class="suggested-match">üìå ${custName} (${option.matchScore}% match)${contact ? ' - ' + contact : ''}</option>`;
            });
        }

        // Add separator
        if (review.customerOptions && review.customerOptions.length > 0) {
            html += '<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
        }

        // Add ALL customers
        if (window.allCustomers && window.allCustomers.length > 0) {
            window.allCustomers.forEach(customer => {
                // Skip if already in suggested matches
                const alreadySuggested = review.customerOptions && review.customerOptions.some(opt => opt.customerId === customer.id);
                if (!alreadySuggested) {
                    const selected = review.selectedCustomerId === customer.id ? 'selected' : '';
                    const custName = escapeHtml(customer.name || customer.fullName || (customer.firstName + ' ' + customer.lastName));
                    const contact = escapeHtml((customer.email || '') + ' ' + (customer.phone || customer.mobileNumber || ''));
                    html += `<option value="${customer.id}" ${selected} data-search="${custName.toLowerCase()} ${contact.toLowerCase()}">${custName}${contact ? ' - ' + contact : ''}</option>`;
                }
            });
        }
        html += '</select>';
        html += '<small class="text-muted d-block mt-1" id="customerSearchResultCount${index}"></small>';
        html += '</div>';

        html += '</div>';
        return html;
    }

    function renderPaymentSourceSelector(review, index) {
        // Always show payment source selector for every transaction
        let html = `<div class="mt-3">
            <strong>Payment Source: <span class="text-danger">*</span></strong>
            <div class="input-group mt-1">
                <select class="form-control form-control-sm" id="paymentSource${index}" onchange="selectPaymentSource(${index})">
                    <option value="">-- Select Payment Source --</option>
        `;

        // Payment source options will be loaded from server
        if (window.paymentSources && window.paymentSources.length > 0) {
            window.paymentSources.forEach(source => {
                const selected = review.selectedPaymentSourceId === source.id ? 'selected' : '';
                html += `<option value="${source.id}" ${selected}>${escapeHtml(source.name)}</option>`;
            });
        }

        html += `</select>
                <div class="input-group-append">
                    <button class="btn btn-sm btn-primary" type="button" onclick="createPaymentSource(${index}, '${escapeHtml(review.parsedData?.paymentSource || '')}')">
                        <i class="fas fa-plus"></i> New
                    </button>
                </div>
            </div>`;

        // Show payment source hint from CSV if available
        if (review.parsedData && review.parsedData.paymentSource) {
            html += `<small class="text-muted">CSV suggests: ${escapeHtml(review.parsedData.paymentSource)}</small>`;
        }

        html += `</div>`;
        return html;
    }

    function renderDuplicateInfo(review, index) {
        if (!review.duplicateInfo) return '';

        return `
            <div class="duplicate-warning mt-3">
                <strong><i class="fas fa-exclamation-triangle"></i> Potential Duplicate Detected</strong>
                <p class="mb-2">Existing: ${escapeHtml(review.duplicateInfo.description)} |
                   ${review.duplicateInfo.amount} | ${review.duplicateInfo.transactionDate}</p>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="skipDup${index}" onchange="toggleSkipDuplicate(${index})">
                    <label class="form-check-label" for="skipDup${index}">
                        Import anyway (not a duplicate)
                    </label>
                </div>
                <input type="text" class="form-control form-control-sm mt-2" id="dupNote${index}"
                       placeholder="Add note (e.g., 'Expense 1 vs Expense 2')"
                       onchange="updateDuplicateNote(${index})">
            </div>
        `;
    }

    function renderErrorMessage(review) {
        if (!review.errorMessage) return '';
        return `
            <div class="alert alert-danger mt-3 mb-0">
                <strong>Error:</strong> ${escapeHtml(review.errorMessage)}
            </div>
        `;
    }

    function renderUserActions(review, index) {
        return `
            <div class="text-right">
                <button class="btn btn-sm btn-danger mb-2" onclick="deleteTransaction(${index})" title="Delete this transaction">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <textarea class="form-control form-control-sm" rows="2"
                          placeholder="Add note..."
                          id="userNote${index}"
                          onchange="updateUserNote(${index})"></textarea>
            </div>
        `;
    }

    // Global functions for onclick handlers
    window.selectProperty = function(index, propertyId) {
        reviewQueue.reviews[index].selectedPropertyId = propertyId;
        $(`.match-option[data-index="${index}"]`).removeClass('selected');
        $(`.match-option[data-index="${index}"][data-option-id="${propertyId}"]`).addClass('selected');
        $(`#propertyDropdown${index}`).val(propertyId); // Sync dropdown

        // If this transaction needs a customer, refresh the customer dropdown with property-related customers
        if (reviewQueue.reviews[index].status === 'MISSING_CUSTOMER' ||
            reviewQueue.reviews[index].customerOptions) {
            refreshCustomerDropdownForProperty(index, propertyId);
        }

        updateReadiness();
    };

    window.selectPropertyFromDropdown = function(index) {
        const propertyId = $(`#propertyDropdown${index}`).val();
        if (propertyId) {
            reviewQueue.reviews[index].selectedPropertyId = parseInt(propertyId);
            $(`.match-option[data-index="${index}"]`).removeClass('selected');
            $(`.match-option[data-index="${index}"][data-option-id="${propertyId}"]`).addClass('selected');
            console.log(`Property ${propertyId} selected from dropdown for transaction ${index}`);

            // If this transaction needs a customer, refresh the customer dropdown
            if (reviewQueue.reviews[index].status === 'MISSING_CUSTOMER' ||
                reviewQueue.reviews[index].customerOptions) {
                refreshCustomerDropdownForProperty(index, parseInt(propertyId));
            }
        } else {
            reviewQueue.reviews[index].selectedPropertyId = null;
        }
        updateReadiness();
    };

    function refreshCustomerDropdownForProperty(index, propertyId) {
        const customerDropdown = $(`#customerDropdown${index}`);
        if (customerDropdown.length === 0) return;

        console.log(`üîÑ Refreshing customer dropdown for transaction ${index} with property ${propertyId}`);

        // Clear current options except placeholder
        customerDropdown.find('option:not(:first)').remove();

        let propertyCustomers = [];
        let otherCustomers = [];

        if (propertyId && window.allCustomers) {
            window.allCustomers.forEach(customer => {
                const isPropertyRelated = customer.propertyOwnerId === propertyId ||
                    (customer.properties && customer.properties.includes(propertyId)) ||
                    (customer.assignedProperties && customer.assignedProperties.includes(propertyId));

                if (isPropertyRelated) {
                    propertyCustomers.push(customer);
                } else {
                    otherCustomers.push(customer);
                }
            });
        }

        // Add property-related customers first
        if (propertyCustomers.length > 0) {
            propertyCustomers.forEach(customer => {
                const custName = customer.name || customer.fullName || (customer.firstName + ' ' + customer.lastName);
                const contact = (customer.email || '') + ' ' + (customer.phone || customer.mobileNumber || '');
                const type = customer.accountType === 'property_owner' ? 'üè† Owner' : (customer.accountType === 'beneficiary' ? 'üí∞ Beneficiary' : 'üë§ Tenant');
                const option = $('<option>')
                    .val(customer.id)
                    .text(`‚≠ê ${type} - ${custName}${contact ? ' - ' + contact : ''}`)
                    .attr('data-search', `${custName.toLowerCase()} ${contact.toLowerCase()}`)
                    .addClass('suggested-match');
                customerDropdown.append(option);
            });

            // Add separator
            if (otherCustomers.length > 0) {
                customerDropdown.append($('<option>').prop('disabled', true).text('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'));
            }
        }

        // Add other customers
        const customersToShow = propertyCustomers.length > 0 ? otherCustomers : window.allCustomers || [];
        customersToShow.forEach(customer => {
            const custName = customer.name || customer.fullName || (customer.firstName + ' ' + customer.lastName);
            const contact = (customer.email || '') + ' ' + (customer.phone || customer.mobileNumber || '');
            const option = $('<option>')
                .val(customer.id)
                .text(`${custName}${contact ? ' - ' + contact : ''}`)
                .attr('data-search', `${custName.toLowerCase()} ${contact.toLowerCase()}`);
            customerDropdown.append(option);
        });

        // Update info message if it exists
        const infoAlert = customerDropdown.closest('.mt-3').prev('.alert-info');
        if (infoAlert.length > 0 && propertyCustomers.length > 0) {
            infoAlert.html(`<i class="fas fa-lightbulb"></i> <strong>${propertyCustomers.length} customer(s)</strong> associated with selected property`);
            infoAlert.show();
        }

        console.log(`‚úÖ Refreshed customer dropdown: ${propertyCustomers.length} property customers, ${otherCustomers.length} other customers`);
    }

    window.filterPropertyDropdown = function(index) {
        const searchText = $(`#propertySearch${index}`).val().toLowerCase();
        const dropdown = $(`#propertyDropdown${index}`);
        let visibleCount = 0;

        dropdown.find('option').each(function() {
            const option = $(this);

            // Always show placeholder and separator
            if (option.val() === '' || option.prop('disabled')) {
                option.show();
                return;
            }

            const searchData = option.attr('data-search') || option.text().toLowerCase();
            if (!searchText || searchData.includes(searchText)) {
                option.show();
                visibleCount++;
            } else {
                option.hide();
            }
        });

        // Show result count
        const countElement = $(`#searchResultCount${index}`);
        if (searchText) {
            countElement.text(`${visibleCount} properties found`);
            if (visibleCount === 0) {
                countElement.html('<span class="text-danger">No properties found matching "' + escapeHtml(searchText) + '"</span>');
            }
        } else {
            countElement.text('');
        }
    };

    window.selectCustomer = function(index, customerId) {
        reviewQueue.reviews[index].selectedCustomerId = customerId;
        $(`.match-option[data-index="${index}"]`).removeClass('selected');
        $(`.match-option[data-index="${index}"][data-option-id="${customerId}"]`).addClass('selected');
        $(`#customerDropdown${index}`).val(customerId); // Sync dropdown
        updateReadiness();
    };

    window.selectCustomerFromDropdown = function(index) {
        const customerId = $(`#customerDropdown${index}`).val();
        if (customerId) {
            reviewQueue.reviews[index].selectedCustomerId = parseInt(customerId);
            $(`.match-option[data-index="${index}"]`).removeClass('selected');
            $(`.match-option[data-index="${index}"][data-option-id="${customerId}"]`).addClass('selected');
            console.log(`Customer ${customerId} selected from dropdown for transaction ${index}`);
        } else {
            reviewQueue.reviews[index].selectedCustomerId = null;
        }
        updateReadiness();
    };

    window.filterCustomerDropdown = function(index) {
        const searchText = $(`#customerSearch${index}`).val().toLowerCase();
        const dropdown = $(`#customerDropdown${index}`);
        let visibleCount = 0;

        dropdown.find('option').each(function() {
            const option = $(this);

            // Always show placeholder and separator
            if (option.val() === '' || option.prop('disabled')) {
                option.show();
                return;
            }

            const searchData = option.attr('data-search') || option.text().toLowerCase();
            if (!searchText || searchData.includes(searchText)) {
                option.show();
                visibleCount++;
            } else {
                option.hide();
            }
        });

        // Show result count
        const countElement = $(`#customerSearchResultCount${index}`);
        if (searchText) {
            countElement.text(`${visibleCount} customers found`);
            if (visibleCount === 0) {
                countElement.html('<span class="text-danger">No customers found matching "' + escapeHtml(searchText) + '"</span>');
            }
        } else {
            countElement.text('');
        }
    };

    window.selectPaymentSource = function(index) {
        const paymentSourceId = $(`#paymentSource${index}`).val();
        reviewQueue.reviews[index].selectedPaymentSourceId = paymentSourceId ? parseInt(paymentSourceId) : null;
        console.log(`Payment source ${paymentSourceId} selected for transaction ${index}`);

        // AUTO-MAP: Find all other transactions with the same CSV payment_source value
        const currentCsvPaymentSource = reviewQueue.reviews[index].parsedData?.paymentSource;
        if (currentCsvPaymentSource && paymentSourceId) {
            let autoMappedCount = 0;
            reviewQueue.reviews.forEach((review, i) => {
                if (i !== index && review.parsedData?.paymentSource === currentCsvPaymentSource) {
                    review.selectedPaymentSourceId = parseInt(paymentSourceId);
                    $(`#paymentSource${i}`).val(paymentSourceId);
                    autoMappedCount++;
                }
            });
            if (autoMappedCount > 0) {
                console.log(`üîÑ Auto-mapped ${autoMappedCount} other transactions with payment_source="${currentCsvPaymentSource}"`);
            }
        }

        // Save updated review queue to localStorage
        localStorage.setItem('reviewData', JSON.stringify(reviewQueue));
        console.log(`‚úÖ Payment source saved to localStorage: ${paymentSourceId}`);

        updateReadiness();
    };

    window.toggleSkipDuplicate = function(index) {
        reviewQueue.reviews[index].skipDuplicate = $(`#skipDup${index}`).is(':checked');
        updateReadiness();
    };

    window.updateDuplicateNote = function(index) {
        reviewQueue.reviews[index].userNote = $(`#dupNote${index}`).val();
    };

    window.updateUserNote = function(index) {
        reviewQueue.reviews[index].userNote = $(`#userNote${index}`).val();
    };

    window.deleteTransaction = function(index) {
        const review = reviewQueue.reviews[index];
        const description = review.parsedData?.description || 'this transaction';

        if (!confirm(`Delete transaction?\n\nLine ${review.lineNumber}: ${description}\n\nThis cannot be undone.`)) {
            return;
        }

        console.log(`üóëÔ∏è Deleting transaction at index ${index}`);

        // Remove from reviews array
        reviewQueue.reviews.splice(index, 1);
        reviewQueue.totalRows = reviewQueue.reviews.length;

        // Update localStorage
        localStorage.setItem('reviewData', JSON.stringify(reviewQueue));
        console.log(`‚úÖ Transaction deleted, ${reviewQueue.reviews.length} remaining`);

        // Re-render the entire review queue
        renderReviewQueue();
        updateSummary();

        showSuccess('Transaction deleted successfully');
    };

    window.createProperty = function(index, suggestedName) {
        currentCreateContext = {type: 'property', index: index};
        $('#newPropertyName').val(suggestedName);
        $('#createPropertyModal').modal('show');
    };

    window.createCustomer = function(index, suggestedName) {
        currentCreateContext = {type: 'customer', index: index};
        const nameParts = suggestedName.split(' ');
        $('#newCustomerFirstName').val(nameParts[0] || '');
        $('#newCustomerLastName').val(nameParts.slice(1).join(' ') || '');
        $('#createCustomerModal').modal('show');
    };

    window.createPaymentSource = function(index, suggestedName) {
        currentCreateContext = {type: 'paymentSource', index: index};
        $('#newPaymentSourceName').val(suggestedName || '');

        // Auto-select type based on suggested name
        if (suggestedName) {
            const normalized = suggestedName.toUpperCase();
            if (normalized.includes('OLD') || normalized.includes('LEGACY')) {
                $('#newPaymentSourceType').val('LEGACY_SYSTEM');
            } else if (normalized.includes('PAYPROP') || normalized.includes('API')) {
                $('#newPaymentSourceType').val('API_SYNC');
            } else if (normalized.includes('BANK')) {
                $('#newPaymentSourceType').val('BANK_STATEMENT');
            }
        }

        $('#createPaymentSourceModal').modal('show');
    };

    // Save new property
    $('#savePropertyBtn').click(function() {
        const propertyData = {
            propertyName: $('#newPropertyName').val(),
            addressLine1: $('#newPropertyAddress').val(),
            postcode: $('#newPropertyPostcode').val()
        };

        $.ajax({
            url: '/employee/transaction/import/create-property',
            method: 'POST',
            contentType: 'application/json',
            headers: { [csrfHeader]: csrfToken },
            data: JSON.stringify(propertyData),
            success: function(response) {
                if (response.success) {
                    // Add new property to review options
                    const index = currentCreateContext.index;
                    if (!reviewQueue.reviews[index].propertyOptions) {
                        reviewQueue.reviews[index].propertyOptions = [];
                    }
                    reviewQueue.reviews[index].propertyOptions.unshift({
                        propertyId: response.propertyId,
                        propertyName: response.propertyName,
                        addressLine1: propertyData.addressLine1,
                        postcode: propertyData.postcode,
                        matchScore: 100
                    });
                    reviewQueue.reviews[index].selectedPropertyId = response.propertyId;
                    reviewQueue.reviews[index].status = 'PERFECT';

                    $('#createPropertyModal').modal('hide');
                    renderReviewQueue();
                    showSuccess('Property created successfully');
                } else {
                    showError(response.error || 'Failed to create property');
                }
            },
            error: function(xhr) {
                showError('Failed to create property: ' + (xhr.responseJSON?.error || xhr.statusText));
            }
        });
    });

    // Save new customer
    $('#saveCustomerBtn').click(function() {
        const customerData = {
            firstName: $('#newCustomerFirstName').val(),
            lastName: $('#newCustomerLastName').val(),
            email: $('#newCustomerEmail').val(),
            phone: $('#newCustomerPhone').val()
        };

        $.ajax({
            url: '/employee/transaction/import/create-customer',
            method: 'POST',
            contentType: 'application/json',
            headers: { [csrfHeader]: csrfToken },
            data: JSON.stringify(customerData),
            success: function(response) {
                if (response.success) {
                    // Add new customer to review options
                    const index = currentCreateContext.index;
                    if (!reviewQueue.reviews[index].customerOptions) {
                        reviewQueue.reviews[index].customerOptions = [];
                    }
                    reviewQueue.reviews[index].customerOptions.unshift({
                        customerId: response.customerId,
                        fullName: response.fullName,
                        email: customerData.email,
                        phone: customerData.phone,
                        matchScore: 100
                    });
                    reviewQueue.reviews[index].selectedCustomerId = response.customerId;

                    $('#createCustomerModal').modal('hide');
                    renderReviewQueue();
                    showSuccess('Customer created successfully');
                } else {
                    showError(response.error || 'Failed to create customer');
                }
            },
            error: function(xhr) {
                showError('Failed to create customer: ' + (xhr.responseJSON?.error || xhr.statusText));
            }
        });
    });

    // Save new payment source
    $('#savePaymentSourceBtn').click(function() {
        const paymentSourceData = {
            name: $('#newPaymentSourceName').val(),
            sourceType: $('#newPaymentSourceType').val(),
            description: $('#newPaymentSourceDescription').val()
        };

        // Validation
        if (!paymentSourceData.name || !paymentSourceData.sourceType) {
            showError('Please fill in all required fields');
            return;
        }

        $.ajax({
            url: '/employee/payment-sources/create',
            method: 'POST',
            headers: { [csrfHeader]: csrfToken },
            data: paymentSourceData,
            success: function(response) {
                if (response.success && response.source) {
                    // Add new payment source to global list
                    window.paymentSources.push(response.source);

                    // Select it for the current transaction
                    const index = currentCreateContext.index;
                    reviewQueue.reviews[index].selectedPaymentSourceId = response.source.id;

                    $('#createPaymentSourceModal').modal('hide');
                    renderReviewQueue();
                    showSuccess('Payment source "' + response.source.name + '" created successfully');
                } else {
                    showError(response.error || 'Failed to create payment source');
                }
            },
            error: function(xhr) {
                showError('Failed to create payment source: ' + (xhr.responseJSON?.error || xhr.statusText));
            }
        });
    });

    // Filter buttons
    $('.btn-group button[data-filter]').click(function() {
        $('.btn-group button').removeClass('active');
        $(this).addClass('active');
        currentFilter = $(this).data('filter');
        applyFilter();
    });

    function applyFilter() {
        console.log('üéØ applyFilter() called, currentFilter:', currentFilter);
        try {
            const cards = $('.review-card');
            console.log('üÉè Found', cards.length, 'review cards');

            cards.each(function() {
                const statusClass = $(this).data('status-class');
                if (currentFilter === 'all' || statusClass === currentFilter) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
            console.log('‚úÖ applyFilter() complete');
        } catch (e) {
            console.error('‚ùå applyFilter() failed:', e);
        }
    }

    function updateCounts() {
        console.log('üìä updateCounts() called');
        try {
            const perfect = reviewQueue.reviews.filter(r => r.status === 'PERFECT').length;
            const needsReview = reviewQueue.reviews.filter(r =>
                ['AMBIGUOUS_PROPERTY', 'AMBIGUOUS_CUSTOMER', 'POTENTIAL_DUPLICATE'].includes(r.status)
            ).length;
            const issues = reviewQueue.reviews.filter(r =>
                ['MISSING_PROPERTY', 'MISSING_CUSTOMER', 'VALIDATION_ERROR'].includes(r.status)
            ).length;

            console.log('üìà Counts:', {perfect, needsReview, issues, total: reviewQueue.reviews.length});

            $('#countAll').text(reviewQueue.reviews.length);
            $('#countPerfect').text(perfect);
            $('#countNeedsReview').text(needsReview);
            $('#countIssues').text(issues);
            console.log('‚úÖ updateCounts() complete');
        } catch (e) {
            console.error('‚ùå updateCounts() failed:', e);
        }
    }

    function updateSummary() {
        const summary = `
            <div class="mb-3">
                <h5 class="text-center">${reviewQueue.totalRows}</h5>
                <p class="text-center text-muted mb-0">Total Transactions</p>
            </div>
            <hr>
            <div class="row text-center">
                <div class="col-12 mb-2">
                    <span class="badge badge-success" style="font-size: 14px; padding: 8px 12px;">
                        ${reviewQueue.perfectMatches} Perfect
                    </span>
                </div>
                <div class="col-12 mb-2">
                    <span class="badge badge-warning" style="font-size: 14px; padding: 8px 12px;">
                        ${reviewQueue.needsReview} Needs Review
                    </span>
                </div>
                <div class="col-12 mb-2">
                    <span class="badge badge-danger" style="font-size: 14px; padding: 8px 12px;">
                        ${reviewQueue.hasIssues} Issues
                    </span>
                </div>
            </div>
        `;
        $('#summaryContent').html(summary);
        updateReadiness();
    }

    function updateReadiness() {
        // Check if all transactions are ready for import
        let allReady = true;
        reviewQueue.reviews.forEach(review => {
            if (review.status === 'VALIDATION_ERROR') {
                allReady = false;
                return;
            }
            // Payment source is REQUIRED for all transactions
            if (!review.selectedPaymentSourceId) {
                allReady = false;
                return;
            }
            if (review.status === 'AMBIGUOUS_PROPERTY' && !review.selectedPropertyId) {
                allReady = false;
                return;
            }
            if (review.status === 'AMBIGUOUS_CUSTOMER' && !review.selectedCustomerId) {
                allReady = false;
                return;
            }
            if (review.status === 'MISSING_PROPERTY' && !review.selectedPropertyId) {
                allReady = false;
                return;
            }
            if (review.duplicateInfo && !review.skipDuplicate) {
                allReady = false;
                return;
            }
        });

        $('#confirmAllBtn').prop('disabled', !allReady);
    }

    // Confirm and import
    $('#confirmAllBtn').click(function() {
        if (!confirm('Import ' + reviewQueue.totalRows + ' transactions?')) {
            return;
        }

        const importData = {
            batchId: reviewQueue.batchId,
            reviews: reviewQueue.reviews
        };

        $.ajax({
            url: '/employee/transaction/import/review-confirm',
            method: 'POST',
            contentType: 'application/json',
            headers: { [csrfHeader]: csrfToken },
            data: JSON.stringify(importData),
            success: function(response) {
                if (response.success) {
                    localStorage.removeItem('reviewData');
                    showSuccess('Import completed successfully: ' + response.imported + ' transactions imported');
                    setTimeout(() => {
                        window.location.href = '/employee/transaction/import';
                    }, 2000);
                } else {
                    showError(response.error || 'Import failed');
                }
            },
            error: function(xhr) {
                showError('Import failed: ' + (xhr.responseJSON?.error || xhr.statusText));
            }
        });
    });

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showSuccess(message) {
        // Display success message in fixed notification
        const notification = $(`
            <div class="alert alert-success" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <strong><i class="fas fa-check-circle"></i> Success!</strong><br>
                ${message}
            </div>
        `);
        $('body').append(notification);

        // Auto-hide after 3 seconds
        setTimeout(() => {
            notification.fadeOut(500, function() { $(this).remove(); });
        }, 3000);
    }

    function showError(message) {
        // Display error in fixed notification
        const notification = $(`
            <div class="alert alert-danger" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <strong><i class="fas fa-exclamation-triangle"></i> Error!</strong><br>
                ${message}
            </div>
        `);
        $('body').append(notification);

        // Auto-hide after 5 seconds
        setTimeout(() => {
            notification.fadeOut(500, function() { $(this).remove(); });
        }, 5000);

        // Also clear loading spinner and show error in container if initial load fails
        const container = $('#reviewQueueContainer');
        if (container.find('.fa-spinner').length > 0) {
            container.html(`
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Error</h5>
                    <p>${message}</p>
                    <a href="/employee/transaction/import" class="btn btn-primary mt-3">
                        <i class="fas fa-arrow-left"></i> Return to Import Page
                    </a>
                </div>
            `);
        }
    }
});
/*]]>*/
</script>

</body>
</html>
