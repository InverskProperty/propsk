<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<!-- Form CSS -->
<link th:href="@{/css/bootstrap-datepicker.min.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>
    
    <div class="page-wrapper">
        <div class="container-fluid">
            
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-5 align-self-center">
                    <h4 class="text-themecolor">Historical Transaction Import</h4>
                </div>
                <div class="col-md-7 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0)">Financial</a></li>
                            <li class="breadcrumb-item active">Transaction Import</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                <span th:text="${success}"></span>
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                <span th:text="${error}"></span>
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
            <div th:if="${warning}" class="alert alert-warning alert-dismissible fade show">
                <span th:text="${warning}"></span>
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>

            <div class="row">
                <!-- File Upload Section -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-primary">
                            <h4 class="mb-0 text-white">
                                <i class="fas fa-file-upload"></i> Import Historical Transactions
                            </h4>
                        </div>
                        <div class="card-body">
                            
                            <!-- Upload Type Tabs -->
                            <ul class="nav nav-pills mb-4" id="uploadTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="csv-tab" data-toggle="pill" href="#csv-upload" role="tab">
                                        <i class="fas fa-table"></i> CSV Upload
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="csv-paste-tab" data-toggle="pill" href="#csv-paste" role="tab">
                                        <i class="fas fa-clipboard"></i> CSV Paste
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="json-tab" data-toggle="pill" href="#json-upload" role="tab">
                                        <i class="fas fa-code"></i> JSON Upload
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="json-paste-tab" data-toggle="pill" href="#json-paste" role="tab">
                                        <i class="fas fa-clipboard"></i> JSON Paste
                                    </a>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="uploadTabContent">
                                
                                <!-- CSV Upload Tab -->
                                <div class="tab-pane fade show active" id="csv-upload" role="tabpanel">
                                    <form method="post" th:action="@{/employee/transaction/import/csv}" enctype="multipart/form-data" id="csvForm">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="csvFile" class="required">CSV File *</label>
                                                    <div class="custom-file">
                                                        <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                                                        <label class="custom-file-label" for="csvFile">Choose CSV file...</label>
                                                    </div>
                                                    <small class="form-text text-muted">
                                                        Upload a CSV file with transaction data. Maximum file size: 10MB
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="csvBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="csvBatchDescription" name="batchDescription" 
                                                           placeholder="e.g., Historical bank data 2023, PayProp export, etc.">
                                                    <small class="form-text text-muted">
                                                        Optional description for this import batch
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <button type="submit" class="btn btn-primary btn-lg" id="csvSubmitBtn">
                                                <i class="fas fa-file-csv"></i> Import CSV File
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="showCsvExample()">
                                                <i class="fas fa-eye"></i> View CSV Example
                                            </button>
                                        </div>

                                        <!-- CSV Import Progress -->
                                        <div id="csvImportProgress" style="display: none;">
                                            <div class="alert alert-info">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm mr-3" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <div>
                                                        <strong>Processing CSV file...</strong><br>
                                                        <small>This may take a few moments depending on file size. Please wait.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                                <!-- CSV Paste Tab -->
                                <div class="tab-pane fade" id="csv-paste" role="tabpanel">
                                    <form id="csvPasteForm">

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="csvData" class="required">CSV Data *</label>
                                                    <textarea class="form-control" id="csvData" name="csvData" rows="12" required
                                                              placeholder="Paste your CSV transaction data here (include header row)..."></textarea>
                                                    <small class="form-text text-muted">
                                                        Paste CSV rows directly - great for importing from Excel/Google Sheets
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="form-group">
                                                    <label for="csvPasteBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="csvPasteBatchDescription" name="batchDescription"
                                                           placeholder="e.g., January 2025 Old Account">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="csvBatchId">
                                                        Batch ID <i class="fas fa-question-circle" title="Optional - reuse batch ID to group multiple pastes"></i>
                                                    </label>
                                                    <input type="text" class="form-control" id="csvBatchId" name="batchId"
                                                           placeholder="Auto-generated" readonly>
                                                    <small class="form-text text-muted">
                                                        <a href="javascript:void(0)" onclick="clearBatchId()">Start new batch</a>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Batch Management Section -->
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="card bg-light mb-3">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <i class="fas fa-layer-group"></i> Batch Management
                                                            <button type="button" class="btn btn-sm btn-info float-right" onclick="loadRecentBatches()">
                                                                <i class="fas fa-sync"></i> Refresh
                                                            </button>
                                                        </h6>

                                                        <div class="form-group">
                                                            <label for="batchToDelete">Delete & Replace Existing Batch:</label>
                                                            <select class="form-control" id="batchToDelete">
                                                                <option value="">-- No batch selected --</option>
                                                            </select>
                                                            <small class="form-text text-muted">
                                                                Select a batch to delete before importing new data (useful for correcting errors)
                                                            </small>
                                                        </div>

                                                        <div id="batchDeleteInfo" style="display: none;" class="alert alert-warning">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                            <strong>Warning:</strong> This will delete <span id="batchDeleteCount">0</span> transactions
                                                            from batch <code id="batchDeleteId"></code> before importing.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <button type="button" class="btn btn-primary btn-lg" onclick="validateCsvPaste()">
                                                <i class="fas fa-check-circle"></i> Validate CSV Data
                                            </button>
                                            <button type="button" class="btn btn-warning btn-lg ml-2" onclick="reviewCsvPaste()">
                                                <i class="fas fa-user-check"></i> Review & Verify
                                            </button>
                                            <button type="button" class="btn btn-success btn-lg ml-2" id="csvPasteImportBtn" onclick="importCsvPaste()" disabled>
                                                <i class="fas fa-paste"></i> Quick Import
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="showCsvExample()">
                                                <i class="fas fa-eye"></i> View CSV Example
                                            </button>
                                        </div>
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i> <strong>Recommended:</strong>
                                            Use <strong>Review & Verify</strong> for absolute precision - allows you to confirm matches, resolve duplicates, and create missing entities.
                                        </div>

                                        <!-- Batching Info Alert -->
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> <strong>Batch Grouping:</strong>
                                            After your first paste, the Batch ID will auto-fill. Keep pasting more data to add to the same batch.
                                            This is useful for importing monthly data split across multiple chunks.
                                        </div>
                                    </form>

                                    <!-- CSV Paste Results -->
                                    <div id="csvPasteResults" style="display: none;">
                                        <hr>
                                        <h6>Import Results:</h6>
                                        <div id="csvPasteContent"></div>
                                    </div>
                                </div>

                                <!-- JSON Upload Tab -->
                                <div class="tab-pane fade" id="json-upload" role="tabpanel">
                                    <form method="post" th:action="@{/employee/transaction/import/json}" enctype="multipart/form-data" id="jsonForm">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="jsonFile" class="required">JSON File *</label>
                                                    <div class="custom-file">
                                                        <input type="file" class="custom-file-input" id="jsonFile" name="file" accept=".json" required>
                                                        <label class="custom-file-label" for="jsonFile">Choose JSON file...</label>
                                                    </div>
                                                    <small class="form-text text-muted">
                                                        Upload a JSON file with structured transaction data. Maximum file size: 10MB
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="jsonBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="jsonBatchDescription" name="batchDescription" 
                                                           placeholder="e.g., API export data, Bank statement JSON, etc.">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <button type="submit" class="btn btn-success btn-lg" id="jsonSubmitBtn">
                                                <i class="fas fa-file-code"></i> Import JSON File
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="showJsonExample()">
                                                <i class="fas fa-eye"></i> View JSON Example
                                            </button>
                                        </div>

                                        <!-- JSON Import Progress -->
                                        <div id="jsonImportProgress" style="display: none;">
                                            <div class="alert alert-info">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm mr-3" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <div>
                                                        <strong>Processing JSON file...</strong><br>
                                                        <small>This may take a few moments depending on file size. Please wait.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- JSON Paste Tab -->
                                <div class="tab-pane fade" id="json-paste" role="tabpanel">
                                    <form id="jsonPasteForm">
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="jsonData" class="required">JSON Data *</label>
                                                    <textarea class="form-control" id="jsonData" name="jsonData" rows="12" required
                                                              placeholder="Paste your JSON transaction data here..."></textarea>
                                                    <small class="form-text text-muted">
                                                        Paste JSON data directly from APIs, exports, or other sources
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="pasteBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="pasteBatchDescription" name="batchDescription" 
                                                           placeholder="e.g., Manual JSON paste, API data, etc.">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <button type="button" class="btn btn-warning btn-lg" onclick="importJsonPaste()">
                                                <i class="fas fa-paste"></i> Import JSON Data
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="validateJsonPaste()">
                                                <i class="fas fa-check-circle"></i> Validate JSON
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- JSON Paste Results -->
                                    <div id="jsonPasteResults" style="display: none;">
                                        <hr>
                                        <h6>Import Results:</h6>
                                        <div id="jsonPasteContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Help & Information Section -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-info">
                            <h5 class="mb-0 text-white">
                                <i class="fas fa-question-circle"></i> Import Guide
                            </h5>
                        </div>
                        <div class="card-body">
                            
                            <h6><strong>Supported Formats:</strong></h6>
                            <ul class="list-unstyled">
                                <li><strong>CSV:</strong> Spreadsheet format with headers</li>
                                <li><strong>JSON:</strong> Structured data format</li>
                                <li><strong>JSON Paste:</strong> Direct copy/paste from APIs</li>
                            </ul>
                            
                            <h6><strong>Required Fields:</strong></h6>
                            <ul class="list-unstyled small">
                                <li>• <code>transaction_date</code></li>
                                <li>• <code>amount</code> (negative for payments out)</li>
                                <li>• <code>description</code></li>
                                <li>• <code>transaction_type</code></li>
                            </ul>
                            
                            <h6><strong>Optional Fields:</strong></h6>
                            <ul class="list-unstyled small">
                                <li>• <code>category</code>, <code>subcategory</code></li>
                                <li>• <code>property_reference</code></li>
                                <li>• <code>customer_reference</code></li>
                                <li>• <code>bank_reference</code></li>
                                <li>• <code>payment_method</code></li>
                                <li>• <code>notes</code></li>
                            </ul>
                            
                            <h6><strong>Property Matching:</strong></h6>
                            <p class="small text-muted">
                                Properties are matched by name, address, or postcode.
                                Use exact property names for best results.
                            </p>
                            
                            <h6><strong>Customer Matching:</strong></h6>
                            <p class="small text-muted">
                                Customers are matched by email address or name.
                                Email addresses provide the most accurate matching.
                            </p>
                            
                            <h6><strong>Transaction Types:</strong></h6>
                            <div class="small">
                                <span class="badge badge-primary">payment</span>
                                <span class="badge badge-success">deposit</span>
                                <span class="badge badge-warning">fee</span>
                                <span class="badge badge-info">commission</span>
                                <span class="badge badge-secondary">maintenance</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Data Summary -->
                    <div class="card mt-3">
                        <div class="card-header bg-secondary">
                            <h6 class="mb-0 text-white">
                                <i class="fas fa-database"></i> Current Data
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h5 class="text-primary" th:text="${propertyCount != null ? propertyCount : 0}">0</h5>
                                    <small class="text-muted">Properties</small>
                                </div>
                                <div class="col-6">
                                    <h5 class="text-success" th:text="${customerCount != null ? customerCount : 0}">0</h5>
                                    <small class="text-muted">Customers</small>
                                </div>
                            </div>
                            <hr>
                            <p class="small text-muted mb-0">
                                <i class="fas fa-info-circle"></i> Import will attempt to match transactions to existing properties and customers
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Example Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalTitle">Import Example</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="exampleContent">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="copyExampleToClipboard()">
                                <i class="fas fa-copy"></i> Copy to Clipboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>

<script>
let currentExampleContent = '';

// Read CSRF tokens from meta tags
function getCsrfToken() {
    return $('meta[name="_csrf"]').attr('content');
}

function getCsrfHeader() {
    return $('meta[name="_csrf_header"]').attr('content');
}

const csrfToken = getCsrfToken();
const csrfHeader = getCsrfHeader();

console.log('CSRF Token loaded:', csrfToken ? 'Yes' : 'No');
console.log('CSRF Header loaded:', csrfHeader ? 'Yes' : 'No');
console.log('CSRF Token value:', csrfToken);
console.log('CSRF Header value:', csrfHeader);

$(document).ready(function() {

    // Force hide preloader on page load to prevent blank screen
    $(".preloader").fadeOut(100);

    // Additional safety check - hide preloader after 3 seconds if still visible
    setTimeout(function() {
        if ($(".preloader").is(":visible")) {
            console.log("Preloader was still visible - force hiding it");
            $(".preloader").hide();
        }
    }, 3000);

    // Update custom file input labels
    $('.custom-file-input').on('change', function() {
        const fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass('selected').html(fileName);
    });
    
    // Form validation and submission handling
    $('#csvForm').on('submit', function(e) {
        const file = $('#csvFile')[0].files[0];
        if (!file) {
            alert('Please select a CSV file');
            e.preventDefault();
            return false;
        }

        if (file.size > 10 * 1024 * 1024) { // 10MB
            alert('File size must be less than 10MB');
            e.preventDefault();
            return false;
        }

        // Show progress indicator
        $('#csvImportProgress').show();
        $('#csvSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Importing...');

        // Ensure preloader is hidden before form submission
        $(".preloader").fadeOut();

        // Continue with form submission
        return true;
    });
    
    $('#jsonForm').on('submit', function(e) {
        const file = $('#jsonFile')[0].files[0];
        if (!file) {
            alert('Please select a JSON file');
            e.preventDefault();
            return false;
        }

        if (file.size > 10 * 1024 * 1024) { // 10MB
            alert('File size must be less than 10MB');
            e.preventDefault();
            return false;
        }

        // Show progress indicator
        $('#jsonImportProgress').show();
        $('#jsonSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Importing...');

        // Ensure preloader is hidden before form submission
        $(".preloader").fadeOut();

        // Continue with form submission
        return true;
    });
});

// Show CSV example
function showCsvExample() {
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    fetch('/employee/transaction/import/examples', {
        method: 'GET',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        const content = `
            <h6>CSV Format Example:</h6>
            <pre class="bg-light p-3"><code>${data.csv_example}</code></pre>
            
            <h6>Required Headers:</h6>
            <ul class="small">
                ${data.csv_headers.slice(0, 4).map(header => `<li><code>${header}</code></li>`).join('')}
            </ul>
            
            <h6>Optional Headers:</h6>
            <ul class="small">
                ${data.csv_headers.slice(4).map(header => `<li><code>${header}</code></li>`).join('')}
            </ul>
        `;
        
        currentExampleContent = data.csv_example;
        $('#exampleModalTitle').text('CSV Import Example');
        $('#exampleContent').html(content);
        $('#exampleModal').modal('show');
    })
    .catch(error => {
        console.error('Error fetching CSV example:', error);
        alert('Error loading CSV example');
    });
}

// Show JSON example
function showJsonExample() {
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    fetch('/employee/transaction/import/examples', {
        method: 'GET',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        const content = `
            <h6>JSON Format Example:</h6>
            <pre class="bg-light p-3"><code>${data.json_example}</code></pre>
            
            <h6>Transaction Types:</h6>
            <div class="mb-3">
                ${data.transaction_types.map(type => `<span class="badge badge-secondary mr-1">${type}</span>`).join('')}
            </div>
            
            <h6>Supported Date Formats:</h6>
            <ul class="small">
                ${data.date_formats.map(format => `<li><code>${format}</code></li>`).join('')}
            </ul>
        `;
        
        currentExampleContent = data.json_example;
        $('#exampleModalTitle').text('JSON Import Example');
        $('#exampleContent').html(content);
        $('#exampleModal').modal('show');
    })
    .catch(error => {
        console.error('Error fetching JSON example:', error);
        alert('Error loading JSON example');
    });
}

// Copy example to clipboard
function copyExampleToClipboard() {
    if (currentExampleContent) {
        navigator.clipboard.writeText(currentExampleContent).then(function() {
            alert('Example copied to clipboard!');
        }).catch(function() {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = currentExampleContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Example copied to clipboard!');
        });
    }
}

// Validate JSON paste
function validateJsonPaste() {
    const jsonData = $('#jsonData').val().trim();
    
    if (!jsonData) {
        alert('Please enter JSON data to validate');
        return;
    }
    
    try {
        JSON.parse(jsonData);
        alert('✅ JSON is valid!');
    } catch (error) {
        alert('❌ Invalid JSON: ' + error.message);
    }
}

// Import JSON paste
function importJsonPaste() {
    const jsonData = $('#jsonData').val().trim();
    const batchDescription = $('#pasteBatchDescription').val() || 'JSON paste import';

    if (!jsonData) {
        alert('Please enter JSON data to import');
        return;
    }

    // Validate JSON first
    try {
        JSON.parse(jsonData);
    } catch (error) {
        alert('Invalid JSON: ' + error.message);
        return;
    }

    // Show loading
    $('#jsonPasteResults').show();
    $('#jsonPasteContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Importing...</div>');

    // Build headers object dynamically
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    // Submit via AJAX
    $.ajax({
        url: '/employee/transaction/import/json-string',
        method: 'POST',
        data: {
            jsonData: jsonData,
            batchDescription: batchDescription
        },
        headers: headers,
        success: function(response) {
            if (response.success) {
                $('#jsonPasteContent').html(`
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Import Successful!</h6>
                        <p><strong>Batch ID:</strong> ${response.batchId}</p>
                        <p><strong>Summary:</strong> ${response.summary}</p>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <h5 class="text-primary">${response.totalProcessed}</h5>
                                <small>Total</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-success">${response.successfulImports}</h5>
                                <small>Success</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger">${response.failedImports}</h5>
                                <small>Failed</small>
                            </div>
                        </div>
                    </div>
                `);

                // Show errors if any
                if (response.errors && response.errors.length > 0) {
                    const errorList = response.errors.slice(0, 5).map(error => `<li>${error}</li>`).join('');
                    $('#jsonPasteContent').append(`
                        <div class="alert alert-warning">
                            <h6>Import Errors (first 5):</h6>
                            <ul>${errorList}</ul>
                        </div>
                    `);
                }
            } else {
                $('#jsonPasteContent').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Import Failed</h6>
                        <p>${response.error}</p>
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            let errorMsg = 'Import failed';
            let debugInfo = '';

            console.error('JSON Import Error:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });

            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || response.message || errorMsg;
            } catch (e) {
                // Not JSON response
                if (xhr.responseText) {
                    errorMsg = xhr.responseText.substring(0, 200);
                }
            }

            debugInfo = `
                <details class="mt-2">
                    <summary>Debug Information</summary>
                    <pre class="small mt-2 bg-light p-2">
Status: ${xhr.status} ${xhr.statusText}
URL: /employee/transaction/import/json-string
Method: POST
Error: ${error}

Response Preview:
${xhr.responseText ? xhr.responseText.substring(0, 500) : 'No response'}
                    </pre>
                </details>
            `;

            $('#jsonPasteContent').html(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle"></i> Import Error</h6>
                    <p>${errorMsg}</p>
                    ${debugInfo}
                </div>
            `);
        }
    });
}

// Validate CSV paste before import
function validateCsvPaste() {
    const csvData = $('#csvData').val().trim();

    if (!csvData) {
        alert('Please enter CSV data to validate');
        return;
    }

    // Basic CSV validation - check for header row
    const lines = csvData.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
        alert('CSV must have at least a header row and one data row');
        return;
    }

    // Show loading - clear any previous error state
    $('#csvPasteResults').show();
    $('#csvPasteContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Validating CSV data...</div>');

    // Disable import button during validation
    $('#csvPasteImportBtn').prop('disabled', true).removeClass('btn-danger').addClass('btn-success');

    // Build headers object dynamically
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    // Validate via AJAX
    $.ajax({
        url: '/employee/transaction/import/validate-csv',
        method: 'POST',
        data: { csvData: csvData },
        headers: headers,
        success: function(response) {
            console.log('Validation response:', response);

            if (response.valid) {
                // Validation passed
                const totalRows = response.totalRows || 0;
                const validRows = response.validRows || 0;
                const invalidRows = response.invalidRows || 0;

                $('#csvPasteContent').html(`
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Validation Successful!</h6>
                        <p>All CSV rows are valid and ready to import.</p>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <h5 class="text-primary">${totalRows}</h5>
                                <small>Total Rows</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-success">${validRows}</h5>
                                <small>Valid</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger">${invalidRows}</h5>
                                <small>Invalid</small>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <p class="mb-0"><i class="fas fa-arrow-down"></i> <strong>Click "Import CSV Data" to proceed with import</strong></p>
                        </div>
                    </div>
                `);

                // Enable import button
                $('#csvPasteImportBtn').prop('disabled', false);
            } else {
                // Validation failed
                const errors = response.errors || [];
                const errorList = errors.length > 0
                    ? errors.map(error => `<li class="text-danger">${error || 'Unknown error'}</li>`).join('')
                    : '<li>Unknown validation error</li>';

                const totalRows = response.totalRows || 0;
                const validRows = response.validRows || 0;
                const invalidRows = response.invalidRows || 0;

                $('#csvPasteContent').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Validation Failed</h6>
                        <p>Found ${invalidRows} error(s) in ${totalRows} rows. Please fix the following errors before importing:</p>
                        <ul class="mb-0" style="max-height: 300px; overflow-y: auto;">${errorList}</ul>
                        <div class="mt-3">
                            <p class="mb-0"><i class="fas fa-edit"></i> <strong>Fix the errors in the CSV data above and click "Validate CSV Data" again</strong></p>
                        </div>
                    </div>
                `);

                // Keep import button disabled
                $('#csvPasteImportBtn').prop('disabled', true);
            }
        },
        error: function(xhr, status, error) {
            let errorMsg = 'Validation failed';

            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || response.message || errorMsg;

                // Show errors if available
                if (response.errors && response.errors.length > 0) {
                    const errorList = response.errors.map(error => `<li class="text-danger">${error}</li>`).join('');
                    $('#csvPasteContent').html(`
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-times-circle"></i> Validation Error</h6>
                            <p>${errorMsg}</p>
                            <ul>${errorList}</ul>
                        </div>
                    `);
                    return;
                }
            } catch (e) {
                if (xhr.responseText) {
                    errorMsg = xhr.responseText.substring(0, 200);
                }
            }

            $('#csvPasteContent').html(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle"></i> Validation Error</h6>
                    <p>${errorMsg}</p>
                </div>
            `);

            // Keep import button disabled
            $('#csvPasteImportBtn').prop('disabled', true);
        }
    });
}

// Review CSV paste with human verification workflow
function reviewCsvPaste() {
    const csvData = $('#csvData').val().trim();
    const batchId = $('#csvBatchId').val().trim();

    if (!csvData) {
        alert('Please enter CSV data to review');
        return;
    }

    // Basic CSV validation - check for header row
    const lines = csvData.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
        alert('CSV must have at least a header row and one data row');
        return;
    }

    // Show loading
    $('#csvPasteResults').show();
    $('#csvPasteContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Analyzing CSV data for review...</div>');

    // Build headers object
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    // Send to review validation endpoint
    console.log('🚀 Sending CSV data to review-validate endpoint...');
    console.log('📊 CSV data length:', csvData.length, 'characters');
    console.log('🆔 Batch ID:', batchId || '(none)');

    $.ajax({
        url: '/employee/transaction/import/review-validate',
        method: 'POST',
        data: {
            csvData: csvData,
            batchId: batchId || ''
        },
        headers: headers,
        success: function(response) {
            console.log('✅ Review validation response received:', response);

            if (response.success) {
                console.log('📝 Storing review data in localStorage...');
                // Store review data in localStorage
                localStorage.setItem('reviewData', JSON.stringify(response));
                console.log('✅ Review data stored successfully');

                // Show summary and redirect
                $('#csvPasteContent').html(`
                    <div class="alert alert-info">
                        <h6><i class="fas fa-clipboard-check"></i> Review Queue Created</h6>
                        <p>Analyzed ${response.totalRows} transactions:</p>
                        <ul>
                            <li><strong class="text-success">${response.perfectMatches}</strong> perfect matches (auto-import ready)</li>
                            <li><strong class="text-warning">${response.needsReview}</strong> need your review (ambiguous matches or duplicates)</li>
                            <li><strong class="text-danger">${response.hasIssues}</strong> have issues (missing entities or errors)</li>
                        </ul>
                        <div class="text-center mt-3">
                            <p><i class="fas fa-arrow-right"></i> Redirecting to review interface...</p>
                        </div>
                    </div>
                `);

                // Redirect to review page after 2 seconds
                setTimeout(() => {
                    window.location.href = '/employee/transaction/import/review?batchId=' + encodeURIComponent(response.batchId);
                }, 2000);
            } else {
                $('#csvPasteContent').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Review Validation Failed</h6>
                        <p>${response.error || 'Unknown error occurred'}</p>
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            console.error('❌ Review validation AJAX error');
            console.error('Status:', status);
            console.error('Error:', error);
            console.error('XHR:', xhr);
            console.error('Response Text:', xhr.responseText);

            let errorMsg = 'Review validation failed';

            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || response.message || errorMsg;
            } catch (e) {
                if (xhr.responseText) {
                    errorMsg += ': ' + xhr.responseText.substring(0, 200);
                } else {
                    errorMsg += ' - HTTP ' + xhr.status + ': ' + (xhr.statusText || error || 'Unknown error');
                }
            }

            console.error('Final error message:', errorMsg);

            $('#csvPasteResults').show();
            $('#csvPasteContent').html(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle"></i> Review Validation Error</h6>
                    <p>${errorMsg}</p>
                </div>
            `);
        }
    });
}

// Import CSV paste (with batch ID support)
function importCsvPaste() {
    const csvData = $('#csvData').val().trim();
    const batchDescription = $('#csvPasteBatchDescription').val() || 'CSV paste import';
    const batchId = $('#csvBatchId').val().trim();

    if (!csvData) {
        alert('Please enter CSV data to import');
        return;
    }

    // Basic CSV validation - check for header row
    const lines = csvData.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
        alert('CSV must have at least a header row and one data row');
        return;
    }

    // Check if we need to delete a batch first
    const batchToDelete = $('#batchToDelete').val();
    if (batchToDelete) {
        deleteBatchBeforeImport(function() {
            // After deletion, proceed with import
            performCsvImport(csvData, batchDescription, batchId);
        });
    } else {
        // No batch to delete, import directly
        performCsvImport(csvData, batchDescription, batchId);
    }
}

// Perform the actual CSV import
function performCsvImport(csvData, batchDescription, batchId) {
    // Show loading - clear any previous state
    $('#csvPasteResults').show();
    $('#csvPasteContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Importing...</div>');

    // Disable import button during import
    $('#csvPasteImportBtn').prop('disabled', true);

    // Build request data
    const requestData = {
        csvData: csvData,
        batchDescription: batchDescription
    };

    // Add batch ID if present (for batching multiple pastes)
    if (batchId) {
        requestData.batchId = batchId;
    }

    // Build headers object dynamically
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    console.log('CSV Import - About to send AJAX request');
    console.log('CSRF Header key:', csrfHeader);
    console.log('CSRF Token value:', csrfToken);
    console.log('Headers object:', headers);
    console.log('Request data keys:', Object.keys(requestData));

    // Submit via AJAX
    $.ajax({
        url: '/employee/transaction/import/csv-string',
        method: 'POST',
        data: requestData,
        headers: headers,
        success: function(response) {
            if (response.success) {
                // Store batch ID for next paste
                $('#csvBatchId').val(response.batchId);

                const skippedDuplicates = response.skippedDuplicates || 0;
                const skippedBreakdown = skippedDuplicates > 0 ? `
                    <div class="col-3">
                        <h5 class="text-warning">${skippedDuplicates}</h5>
                        <small>Skipped (Duplicates)</small>
                    </div>
                ` : '';

                $('#csvPasteContent').html(`
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Import ${skippedDuplicates > 0 ? 'Completed' : 'Successful'}!</h6>
                        <p><strong>Batch ID:</strong> <code>${response.batchId}</code></p>
                        <p><strong>Summary:</strong> ${response.summary}</p>
                        <div class="row text-center mt-3">
                            <div class="${skippedDuplicates > 0 ? 'col-3' : 'col-4'}">
                                <h5 class="text-primary">${response.totalProcessed}</h5>
                                <small>Total</small>
                            </div>
                            <div class="${skippedDuplicates > 0 ? 'col-3' : 'col-4'}">
                                <h5 class="text-success">${response.successfulImports}</h5>
                                <small>Success</small>
                            </div>
                            <div class="${skippedDuplicates > 0 ? 'col-3' : 'col-4'}">
                                <h5 class="text-danger">${response.failedImports}</h5>
                                <small>Failed</small>
                            </div>
                            ${skippedBreakdown}
                        </div>
                        ${batchId ? '<p class="mt-2 mb-0"><i class="fas fa-layer-group"></i> <strong>Added to existing batch.</strong> Clear the Batch ID field to start a new batch.</p>' : '<p class="mt-2 mb-0"><i class="fas fa-info-circle"></i> <strong>Batch created.</strong> Paste more CSV data to add to this batch.</p>'}
                    </div>
                `);

                // Show errors if any
                if (response.errors && response.errors.length > 0) {
                    const totalErrors = response.errors.length;
                    const errorList = response.errors.map(error => `<li class="text-danger">${error || 'Unknown error'}</li>`).join('');
                    $('#csvPasteContent').append(`
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Import Completed with ${totalErrors} Error(s):</h6>
                            <p class="mb-2"><strong>Please review and fix the following errors in your CSV data above, then re-validate and import.</strong></p>
                            <div style="max-height: 300px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 4px;">
                                <ul class="mb-0">${errorList}</ul>
                            </div>
                            <div class="mt-3">
                                <i class="fas fa-info-circle"></i> <strong>Tip:</strong> Successfully imported rows (${response.successfulImports}) have been saved.
                                Only fix and re-import the rows with errors shown above.
                            </div>
                        </div>
                    `);

                    // DON'T clear textarea when there are errors - let user fix them
                } else {
                    // Only clear textarea on complete success
                    $('#csvData').val('');
                    $('#csvData').attr('placeholder', 'Paste next batch of CSV data to add to batch ' + response.batchId);
                }

                // Show duplicate skip details if any
                if (response.skippedDuplicates && response.skippedDuplicates > 0) {
                    const skippedList = response.skippedTransactions && response.skippedTransactions.length > 0
                        ? response.skippedTransactions.map(skip => `<li class="text-muted">${skip || 'Unknown'}</li>`).join('')
                        : '<li>No details available</li>';

                    const breakdown = `
                        <div class="mt-2">
                            <strong>Duplicate Breakdown:</strong>
                            <ul class="mb-1">
                                <li>Within this upload: ${response.skippedDuplicatesInPaste || 0}</li>
                                <li>In current batch session: ${response.skippedDuplicatesInBatch || 0}</li>
                                <li>Already in database: ${response.skippedDuplicatesInDatabase || 0}</li>
                            </ul>
                        </div>
                    `;

                    $('#csvPasteContent').append(`
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> ${response.skippedDuplicates} Duplicate(s) Skipped</h6>
                            <p class="mb-2">The following transactions were skipped because they already exist:</p>
                            ${breakdown}
                            <details class="mt-2">
                                <summary style="cursor: pointer;"><strong>View Skipped Transactions</strong></summary>
                                <div style="max-height: 200px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 4px; margin-top: 10px;">
                                    <ul class="mb-0">${skippedList}</ul>
                                </div>
                            </details>
                        </div>
                    `);
                }

                // Disable import button until next validation
                $('#csvPasteImportBtn').prop('disabled', true);
            } else {
                // Handle failure case with proper null checking
                const errorMessage = response.error || response.message || 'Import failed - unknown error';
                const errorDetails = response.errors && response.errors.length > 0
                    ? '<ul class="mt-2">' + response.errors.slice(0, 5).map(e => `<li>${e || 'Unknown error'}</li>`).join('') + '</ul>'
                    : '';

                $('#csvPasteContent').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Import Failed</h6>
                        <p>${errorMessage}</p>
                        ${errorDetails}
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            let errorMsg = 'Import failed';
            let errorDetails = '';
            let debugInfo = '';

            console.error('CSV Import Error:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });

            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || response.message || 'Server returned an error';

                // Show detailed errors if available
                if (response.errors && Array.isArray(response.errors) && response.errors.length > 0) {
                    const errorList = response.errors.slice(0, 10).map(e => `<li>${e || 'Unknown error'}</li>`).join('');
                    errorDetails = `<div class="mt-2"><strong>Error Details:</strong><ul class="mb-0">${errorList}</ul></div>`;
                }
            } catch (e) {
                // Not JSON response - try to extract meaningful error
                if (xhr.status === 403) {
                    errorMsg = 'Access denied - Please refresh the page and try again';
                } else if (xhr.status === 500) {
                    errorMsg = 'Server error occurred during import';
                } else if (xhr.status === 400) {
                    errorMsg = 'Invalid request - Please check your CSV format';
                } else if (xhr.responseText) {
                    // Try to extract error from HTML response
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = xhr.responseText;
                    const errorElement = tempDiv.querySelector('.error-message, .exception-message, h1');
                    if (errorElement) {
                        errorMsg = errorElement.textContent.substring(0, 300);
                    } else {
                        errorMsg = xhr.responseText.substring(0, 300);
                    }
                }
            }

            debugInfo = `
                <details class="mt-2">
                    <summary>Technical Details (Click to expand)</summary>
                    <pre class="small mt-2 bg-light p-2">
Status: ${xhr.status} ${xhr.statusText}
URL: /employee/transaction/import/csv-string
Method: POST
Error: ${error}

Response Preview:
${xhr.responseText ? xhr.responseText.substring(0, 500) : 'No response'}
                    </pre>
                </details>
            `;

            $('#csvPasteContent').html(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle"></i> Import Error</h6>
                    <p>${errorMsg}</p>
                    ${errorDetails}
                    ${debugInfo}
                </div>
            `);
        }
    });
}

// Clear batch ID to start a new batch
function clearBatchId() {
    $('#csvBatchId').val('');
    $('#csvData').attr('placeholder', 'Paste your CSV transaction data here (include header row)...');
    // Clear validation state
    $('#csvPasteResults').hide();
    $('#csvPasteContent').html('');
    $('#csvPasteImportBtn').prop('disabled', true);
    alert('Batch ID cleared. Your next paste will create a new batch.');
}

// Reset CSV import form state
function resetCsvImportState() {
    $('#csvPasteResults').hide();
    $('#csvPasteContent').html('');
    $('#csvPasteImportBtn').prop('disabled', true).removeClass('btn-danger').addClass('btn-success');
}

// Load recent batches for deletion dropdown
function loadRecentBatches() {
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    fetch('/employee/transaction/import/batches', {
        method: 'GET',
        headers: headers
    })
    .then(response => response.json())
    .then(batches => {
        const select = $('#batchToDelete');
        select.empty();
        select.append('<option value="">-- No batch selected --</option>');

        batches.forEach(batch => {
            const dateRange = `${batch.earliestDate} to ${batch.latestDate}`;
            const option = `<option value="${batch.batchId}" data-count="${batch.count}">${batch.batchId} (${batch.count} transactions, ${dateRange})</option>`;
            select.append(option);
        });

        console.log('Loaded', batches.length, 'batches');
    })
    .catch(error => {
        console.error('Error loading batches:', error);
    });
}

// Show batch delete warning when batch selected
$('#batchToDelete').on('change', function() {
    const batchId = $(this).val();
    if (batchId) {
        const count = $(this).find(':selected').data('count');
        $('#batchDeleteId').text(batchId);
        $('#batchDeleteCount').text(count);
        $('#batchDeleteInfo').show();
    } else {
        $('#batchDeleteInfo').hide();
    }
});

// Delete batch before import
function deleteBatchBeforeImport(callback) {
    const batchId = $('#batchToDelete').val();

    if (!batchId) {
        // No batch to delete, proceed with import
        callback();
        return;
    }

    if (!confirm(`Are you sure you want to delete batch ${batchId}? This will permanently delete ${$('#batchDeleteCount').text()} transactions.`)) {
        return;
    }

    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    $.ajax({
        url: '/employee/transaction/import/delete-batch',
        method: 'POST',
        data: { batchId: batchId },
        headers: headers,
        success: function(response) {
            if (response.success) {
                alert(`✅ ${response.message}`);
                $('#batchToDelete').val('');
                $('#batchDeleteInfo').hide();
                loadRecentBatches();
                // Proceed with import
                callback();
            } else {
                alert(`❌ Failed to delete batch: ${response.error}`);
            }
        },
        error: function(xhr) {
            alert(`❌ Error deleting batch: ${xhr.responseText || 'Unknown error'}`);
        }
    });
}

// Add event listener to re-disable import button when CSV content changes
$(document).ready(function() {
    $('#csvData').on('input', function() {
        // Disable import button when CSV content changes
        $('#csvPasteImportBtn').prop('disabled', true);

        // Hide validation results
        $('#csvPasteResults').hide();
    });

    // Load batches on page load
    loadRecentBatches();
});
</script>

</body>
</html>