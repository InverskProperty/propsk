<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<!-- Form CSS -->
<link th:href="@{/css/bootstrap-datepicker.min.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>
    
    <div class="page-wrapper">
        <div class="container-fluid">
            
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-5 align-self-center">
                    <h4 class="text-themecolor">Historical Transaction Import</h4>
                </div>
                <div class="col-md-7 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0)">Financial</a></li>
                            <li class="breadcrumb-item active">Transaction Import</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                <span th:text="${success}"></span>
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                <span th:text="${error}"></span>
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
            <div th:if="${warning}" class="alert alert-warning alert-dismissible fade show">
                <span th:text="${warning}"></span>
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>

            <div class="row">
                <!-- File Upload Section -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-primary">
                            <h4 class="mb-0 text-white">
                                <i class="fas fa-file-upload"></i> Import Historical Transactions
                            </h4>
                        </div>
                        <div class="card-body">
                            
                            <!-- Upload Type Tabs -->
                            <ul class="nav nav-pills mb-4" id="uploadTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="csv-tab" data-toggle="pill" href="#csv-upload" role="tab">
                                        <i class="fas fa-table"></i> CSV Upload
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="csv-paste-tab" data-toggle="pill" href="#csv-paste" role="tab">
                                        <i class="fas fa-clipboard"></i> CSV Paste
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="json-tab" data-toggle="pill" href="#json-upload" role="tab">
                                        <i class="fas fa-code"></i> JSON Upload
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="json-paste-tab" data-toggle="pill" href="#json-paste" role="tab">
                                        <i class="fas fa-clipboard"></i> JSON Paste
                                    </a>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="uploadTabContent">
                                
                                <!-- CSV Upload Tab -->
                                <div class="tab-pane fade show active" id="csv-upload" role="tabpanel">
                                    <form method="post" th:action="@{/employee/transaction/import/csv}" enctype="multipart/form-data" id="csvForm">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="csvFile" class="required">CSV File *</label>
                                                    <div class="custom-file">
                                                        <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                                                        <label class="custom-file-label" for="csvFile">Choose CSV file...</label>
                                                    </div>
                                                    <small class="form-text text-muted">
                                                        Upload a CSV file with transaction data. Maximum file size: 10MB
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="csvBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="csvBatchDescription" name="batchDescription" 
                                                           placeholder="e.g., Historical bank data 2023, PayProp export, etc.">
                                                    <small class="form-text text-muted">
                                                        Optional description for this import batch
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <button type="submit" class="btn btn-primary btn-lg" id="csvSubmitBtn">
                                                <i class="fas fa-file-csv"></i> Import CSV File
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="showCsvExample()">
                                                <i class="fas fa-eye"></i> View CSV Example
                                            </button>
                                        </div>

                                        <!-- CSV Import Progress -->
                                        <div id="csvImportProgress" style="display: none;">
                                            <div class="alert alert-info">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm mr-3" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <div>
                                                        <strong>Processing CSV file...</strong><br>
                                                        <small>This may take a few moments depending on file size. Please wait.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                                <!-- CSV Paste Tab -->
                                <div class="tab-pane fade" id="csv-paste" role="tabpanel">
                                    <form id="csvPasteForm">

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="csvData" class="required">CSV Data *</label>
                                                    <textarea class="form-control" id="csvData" name="csvData" rows="12" required
                                                              placeholder="Paste your CSV transaction data here (include header row)..."></textarea>
                                                    <small class="form-text text-muted">
                                                        Paste CSV rows directly - great for importing from Excel/Google Sheets
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="form-group">
                                                    <label for="csvPasteBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="csvPasteBatchDescription" name="batchDescription"
                                                           placeholder="e.g., January 2025 Old Account">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="csvBatchId">
                                                        Batch ID <i class="fas fa-question-circle" title="Optional - reuse batch ID to group multiple pastes"></i>
                                                    </label>
                                                    <input type="text" class="form-control" id="csvBatchId" name="batchId"
                                                           placeholder="Auto-generated" readonly>
                                                    <small class="form-text text-muted">
                                                        <a href="javascript:void(0)" onclick="clearBatchId()">Start new batch</a>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <button type="button" class="btn btn-warning btn-lg" onclick="importCsvPaste()">
                                                <i class="fas fa-paste"></i> Import CSV Data
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="showCsvExample()">
                                                <i class="fas fa-eye"></i> View CSV Example
                                            </button>
                                        </div>

                                        <!-- Batching Info Alert -->
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> <strong>Batch Grouping:</strong>
                                            After your first paste, the Batch ID will auto-fill. Keep pasting more data to add to the same batch.
                                            This is useful for importing monthly data split across multiple chunks.
                                        </div>
                                    </form>

                                    <!-- CSV Paste Results -->
                                    <div id="csvPasteResults" style="display: none;">
                                        <hr>
                                        <h6>Import Results:</h6>
                                        <div id="csvPasteContent"></div>
                                    </div>
                                </div>

                                <!-- JSON Upload Tab -->
                                <div class="tab-pane fade" id="json-upload" role="tabpanel">
                                    <form method="post" th:action="@{/employee/transaction/import/json}" enctype="multipart/form-data" id="jsonForm">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="jsonFile" class="required">JSON File *</label>
                                                    <div class="custom-file">
                                                        <input type="file" class="custom-file-input" id="jsonFile" name="file" accept=".json" required>
                                                        <label class="custom-file-label" for="jsonFile">Choose JSON file...</label>
                                                    </div>
                                                    <small class="form-text text-muted">
                                                        Upload a JSON file with structured transaction data. Maximum file size: 10MB
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="jsonBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="jsonBatchDescription" name="batchDescription" 
                                                           placeholder="e.g., API export data, Bank statement JSON, etc.">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <button type="submit" class="btn btn-success btn-lg" id="jsonSubmitBtn">
                                                <i class="fas fa-file-code"></i> Import JSON File
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="showJsonExample()">
                                                <i class="fas fa-eye"></i> View JSON Example
                                            </button>
                                        </div>

                                        <!-- JSON Import Progress -->
                                        <div id="jsonImportProgress" style="display: none;">
                                            <div class="alert alert-info">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm mr-3" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <div>
                                                        <strong>Processing JSON file...</strong><br>
                                                        <small>This may take a few moments depending on file size. Please wait.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- JSON Paste Tab -->
                                <div class="tab-pane fade" id="json-paste" role="tabpanel">
                                    <form id="jsonPasteForm">
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="jsonData" class="required">JSON Data *</label>
                                                    <textarea class="form-control" id="jsonData" name="jsonData" rows="12" required
                                                              placeholder="Paste your JSON transaction data here..."></textarea>
                                                    <small class="form-text text-muted">
                                                        Paste JSON data directly from APIs, exports, or other sources
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="pasteBatchDescription">Batch Description</label>
                                                    <input type="text" class="form-control" id="pasteBatchDescription" name="batchDescription" 
                                                           placeholder="e.g., Manual JSON paste, API data, etc.">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <button type="button" class="btn btn-warning btn-lg" onclick="importJsonPaste()">
                                                <i class="fas fa-paste"></i> Import JSON Data
                                            </button>
                                            <button type="button" class="btn btn-info btn-lg ml-2" onclick="validateJsonPaste()">
                                                <i class="fas fa-check-circle"></i> Validate JSON
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- JSON Paste Results -->
                                    <div id="jsonPasteResults" style="display: none;">
                                        <hr>
                                        <h6>Import Results:</h6>
                                        <div id="jsonPasteContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Help & Information Section -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-info">
                            <h5 class="mb-0 text-white">
                                <i class="fas fa-question-circle"></i> Import Guide
                            </h5>
                        </div>
                        <div class="card-body">
                            
                            <h6><strong>Supported Formats:</strong></h6>
                            <ul class="list-unstyled">
                                <li><strong>CSV:</strong> Spreadsheet format with headers</li>
                                <li><strong>JSON:</strong> Structured data format</li>
                                <li><strong>JSON Paste:</strong> Direct copy/paste from APIs</li>
                            </ul>
                            
                            <h6><strong>Required Fields:</strong></h6>
                            <ul class="list-unstyled small">
                                <li>• <code>transaction_date</code></li>
                                <li>• <code>amount</code> (negative for payments out)</li>
                                <li>• <code>description</code></li>
                                <li>• <code>transaction_type</code></li>
                            </ul>
                            
                            <h6><strong>Optional Fields:</strong></h6>
                            <ul class="list-unstyled small">
                                <li>• <code>category</code>, <code>subcategory</code></li>
                                <li>• <code>property_reference</code></li>
                                <li>• <code>customer_reference</code></li>
                                <li>• <code>bank_reference</code></li>
                                <li>• <code>payment_method</code></li>
                                <li>• <code>notes</code></li>
                            </ul>
                            
                            <h6><strong>Property Matching:</strong></h6>
                            <p class="small text-muted">
                                Properties are matched by name, address, or postcode.
                                Use exact property names for best results.
                            </p>
                            
                            <h6><strong>Customer Matching:</strong></h6>
                            <p class="small text-muted">
                                Customers are matched by email address or name.
                                Email addresses provide the most accurate matching.
                            </p>
                            
                            <h6><strong>Transaction Types:</strong></h6>
                            <div class="small">
                                <span class="badge badge-primary">payment</span>
                                <span class="badge badge-success">deposit</span>
                                <span class="badge badge-warning">fee</span>
                                <span class="badge badge-info">commission</span>
                                <span class="badge badge-secondary">maintenance</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Data Summary -->
                    <div class="card mt-3">
                        <div class="card-header bg-secondary">
                            <h6 class="mb-0 text-white">
                                <i class="fas fa-database"></i> Current Data
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h5 class="text-primary" th:text="${propertyCount != null ? propertyCount : 0}">0</h5>
                                    <small class="text-muted">Properties</small>
                                </div>
                                <div class="col-6">
                                    <h5 class="text-success" th:text="${customerCount != null ? customerCount : 0}">0</h5>
                                    <small class="text-muted">Customers</small>
                                </div>
                            </div>
                            <hr>
                            <p class="small text-muted mb-0">
                                <i class="fas fa-info-circle"></i> Import will attempt to match transactions to existing properties and customers
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Example Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalTitle">Import Example</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="exampleContent">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="copyExampleToClipboard()">
                                <i class="fas fa-copy"></i> Copy to Clipboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>

<script>
let currentExampleContent = '';

// Read CSRF tokens from meta tags
function getCsrfToken() {
    return $('meta[name="_csrf"]').attr('content');
}

function getCsrfHeader() {
    return $('meta[name="_csrf_header"]').attr('content');
}

const csrfToken = getCsrfToken();
const csrfHeader = getCsrfHeader();

console.log('CSRF Token loaded:', csrfToken ? 'Yes' : 'No');
console.log('CSRF Header loaded:', csrfHeader ? 'Yes' : 'No');
console.log('CSRF Token value:', csrfToken);
console.log('CSRF Header value:', csrfHeader);

$(document).ready(function() {

    // Force hide preloader on page load to prevent blank screen
    $(".preloader").fadeOut(100);

    // Additional safety check - hide preloader after 3 seconds if still visible
    setTimeout(function() {
        if ($(".preloader").is(":visible")) {
            console.log("Preloader was still visible - force hiding it");
            $(".preloader").hide();
        }
    }, 3000);

    // Update custom file input labels
    $('.custom-file-input').on('change', function() {
        const fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass('selected').html(fileName);
    });
    
    // Form validation and submission handling
    $('#csvForm').on('submit', function(e) {
        const file = $('#csvFile')[0].files[0];
        if (!file) {
            alert('Please select a CSV file');
            e.preventDefault();
            return false;
        }

        if (file.size > 10 * 1024 * 1024) { // 10MB
            alert('File size must be less than 10MB');
            e.preventDefault();
            return false;
        }

        // Show progress indicator
        $('#csvImportProgress').show();
        $('#csvSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Importing...');

        // Ensure preloader is hidden before form submission
        $(".preloader").fadeOut();

        // Continue with form submission
        return true;
    });
    
    $('#jsonForm').on('submit', function(e) {
        const file = $('#jsonFile')[0].files[0];
        if (!file) {
            alert('Please select a JSON file');
            e.preventDefault();
            return false;
        }

        if (file.size > 10 * 1024 * 1024) { // 10MB
            alert('File size must be less than 10MB');
            e.preventDefault();
            return false;
        }

        // Show progress indicator
        $('#jsonImportProgress').show();
        $('#jsonSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Importing...');

        // Ensure preloader is hidden before form submission
        $(".preloader").fadeOut();

        // Continue with form submission
        return true;
    });
});

// Show CSV example
function showCsvExample() {
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    fetch('/employee/transaction/import/examples', {
        method: 'GET',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        const content = `
            <h6>CSV Format Example:</h6>
            <pre class="bg-light p-3"><code>${data.csv_example}</code></pre>
            
            <h6>Required Headers:</h6>
            <ul class="small">
                ${data.csv_headers.slice(0, 4).map(header => `<li><code>${header}</code></li>`).join('')}
            </ul>
            
            <h6>Optional Headers:</h6>
            <ul class="small">
                ${data.csv_headers.slice(4).map(header => `<li><code>${header}</code></li>`).join('')}
            </ul>
        `;
        
        currentExampleContent = data.csv_example;
        $('#exampleModalTitle').text('CSV Import Example');
        $('#exampleContent').html(content);
        $('#exampleModal').modal('show');
    })
    .catch(error => {
        console.error('Error fetching CSV example:', error);
        alert('Error loading CSV example');
    });
}

// Show JSON example
function showJsonExample() {
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    fetch('/employee/transaction/import/examples', {
        method: 'GET',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        const content = `
            <h6>JSON Format Example:</h6>
            <pre class="bg-light p-3"><code>${data.json_example}</code></pre>
            
            <h6>Transaction Types:</h6>
            <div class="mb-3">
                ${data.transaction_types.map(type => `<span class="badge badge-secondary mr-1">${type}</span>`).join('')}
            </div>
            
            <h6>Supported Date Formats:</h6>
            <ul class="small">
                ${data.date_formats.map(format => `<li><code>${format}</code></li>`).join('')}
            </ul>
        `;
        
        currentExampleContent = data.json_example;
        $('#exampleModalTitle').text('JSON Import Example');
        $('#exampleContent').html(content);
        $('#exampleModal').modal('show');
    })
    .catch(error => {
        console.error('Error fetching JSON example:', error);
        alert('Error loading JSON example');
    });
}

// Copy example to clipboard
function copyExampleToClipboard() {
    if (currentExampleContent) {
        navigator.clipboard.writeText(currentExampleContent).then(function() {
            alert('Example copied to clipboard!');
        }).catch(function() {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = currentExampleContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Example copied to clipboard!');
        });
    }
}

// Validate JSON paste
function validateJsonPaste() {
    const jsonData = $('#jsonData').val().trim();
    
    if (!jsonData) {
        alert('Please enter JSON data to validate');
        return;
    }
    
    try {
        JSON.parse(jsonData);
        alert('✅ JSON is valid!');
    } catch (error) {
        alert('❌ Invalid JSON: ' + error.message);
    }
}

// Import JSON paste
function importJsonPaste() {
    const jsonData = $('#jsonData').val().trim();
    const batchDescription = $('#pasteBatchDescription').val() || 'JSON paste import';

    if (!jsonData) {
        alert('Please enter JSON data to import');
        return;
    }

    // Validate JSON first
    try {
        JSON.parse(jsonData);
    } catch (error) {
        alert('Invalid JSON: ' + error.message);
        return;
    }

    // Show loading
    $('#jsonPasteResults').show();
    $('#jsonPasteContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Importing...</div>');

    // Build headers object dynamically
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    // Submit via AJAX
    $.ajax({
        url: '/employee/transaction/import/json-string',
        method: 'POST',
        data: {
            jsonData: jsonData,
            batchDescription: batchDescription
        },
        headers: headers,
        success: function(response) {
            if (response.success) {
                $('#jsonPasteContent').html(`
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Import Successful!</h6>
                        <p><strong>Batch ID:</strong> ${response.batchId}</p>
                        <p><strong>Summary:</strong> ${response.summary}</p>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <h5 class="text-primary">${response.totalProcessed}</h5>
                                <small>Total</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-success">${response.successfulImports}</h5>
                                <small>Success</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger">${response.failedImports}</h5>
                                <small>Failed</small>
                            </div>
                        </div>
                    </div>
                `);

                // Show errors if any
                if (response.errors && response.errors.length > 0) {
                    const errorList = response.errors.slice(0, 5).map(error => `<li>${error}</li>`).join('');
                    $('#jsonPasteContent').append(`
                        <div class="alert alert-warning">
                            <h6>Import Errors (first 5):</h6>
                            <ul>${errorList}</ul>
                        </div>
                    `);
                }
            } else {
                $('#jsonPasteContent').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Import Failed</h6>
                        <p>${response.error}</p>
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            let errorMsg = 'Import failed';
            let debugInfo = '';

            console.error('JSON Import Error:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });

            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || response.message || errorMsg;
            } catch (e) {
                // Not JSON response
                if (xhr.responseText) {
                    errorMsg = xhr.responseText.substring(0, 200);
                }
            }

            debugInfo = `
                <details class="mt-2">
                    <summary>Debug Information</summary>
                    <pre class="small mt-2 bg-light p-2">
Status: ${xhr.status} ${xhr.statusText}
URL: /employee/transaction/import/json-string
Method: POST
Error: ${error}

Response Preview:
${xhr.responseText ? xhr.responseText.substring(0, 500) : 'No response'}
                    </pre>
                </details>
            `;

            $('#jsonPasteContent').html(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle"></i> Import Error</h6>
                    <p>${errorMsg}</p>
                    ${debugInfo}
                </div>
            `);
        }
    });
}

// Import CSV paste (with batch ID support)
function importCsvPaste() {
    const csvData = $('#csvData').val().trim();
    const batchDescription = $('#csvPasteBatchDescription').val() || 'CSV paste import';
    const batchId = $('#csvBatchId').val().trim();

    if (!csvData) {
        alert('Please enter CSV data to import');
        return;
    }

    // Basic CSV validation - check for header row
    const lines = csvData.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
        alert('CSV must have at least a header row and one data row');
        return;
    }

    // Show loading
    $('#csvPasteResults').show();
    $('#csvPasteContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Importing...</div>');

    // Build request data
    const requestData = {
        csvData: csvData,
        batchDescription: batchDescription
    };

    // Add batch ID if present (for batching multiple pastes)
    if (batchId) {
        requestData.batchId = batchId;
    }

    // Build headers object dynamically
    const headers = {};
    if (csrfHeader && csrfToken) {
        headers[csrfHeader] = csrfToken;
    }

    console.log('CSV Import - About to send AJAX request');
    console.log('CSRF Header key:', csrfHeader);
    console.log('CSRF Token value:', csrfToken);
    console.log('Headers object:', headers);
    console.log('Request data keys:', Object.keys(requestData));

    // Submit via AJAX
    $.ajax({
        url: '/employee/transaction/import/csv-string',
        method: 'POST',
        data: requestData,
        headers: headers,
        success: function(response) {
            if (response.success) {
                // Store batch ID for next paste
                $('#csvBatchId').val(response.batchId);

                $('#csvPasteContent').html(`
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Import Successful!</h6>
                        <p><strong>Batch ID:</strong> <code>${response.batchId}</code></p>
                        <p><strong>Summary:</strong> ${response.summary}</p>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <h5 class="text-primary">${response.totalProcessed}</h5>
                                <small>Total</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-success">${response.successfulImports}</h5>
                                <small>Success</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger">${response.failedImports}</h5>
                                <small>Failed</small>
                            </div>
                        </div>
                        ${batchId ? '<p class="mt-2 mb-0"><i class="fas fa-layer-group"></i> <strong>Added to existing batch.</strong> Clear the Batch ID field to start a new batch.</p>' : '<p class="mt-2 mb-0"><i class="fas fa-info-circle"></i> <strong>Batch created.</strong> Paste more CSV data to add to this batch.</p>'}
                    </div>
                `);

                // Show errors if any
                if (response.errors && response.errors.length > 0) {
                    const errorList = response.errors.slice(0, 5).map(error => `<li>${error}</li>`).join('');
                    $('#csvPasteContent').append(`
                        <div class="alert alert-warning">
                            <h6>Import Errors (first 5):</h6>
                            <ul>${errorList}</ul>
                        </div>
                    `);
                }

                // Clear textarea for next paste
                $('#csvData').val('');
                $('#csvData').attr('placeholder', 'Paste next batch of CSV data to add to batch ' + response.batchId);
            } else {
                $('#csvPasteContent').html(`
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Import Failed</h6>
                        <p>${response.error}</p>
                    </div>
                `);
            }
        },
        error: function(xhr, status, error) {
            let errorMsg = 'Import failed';
            let debugInfo = '';

            console.error('CSV Import Error:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });

            try {
                const response = JSON.parse(xhr.responseText);
                errorMsg = response.error || response.message || errorMsg;
            } catch (e) {
                // Not JSON response
                if (xhr.responseText) {
                    errorMsg = xhr.responseText.substring(0, 200);
                }
            }

            debugInfo = `
                <details class="mt-2">
                    <summary>Debug Information</summary>
                    <pre class="small mt-2 bg-light p-2">
Status: ${xhr.status} ${xhr.statusText}
URL: /employee/transaction/import/csv-string
Method: POST
Error: ${error}

Response Preview:
${xhr.responseText ? xhr.responseText.substring(0, 500) : 'No response'}
                    </pre>
                </details>
            `;

            $('#csvPasteContent').html(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle"></i> Import Error</h6>
                    <p>${errorMsg}</p>
                    ${debugInfo}
                </div>
            `);
        }
    });
}

// Clear batch ID to start a new batch
function clearBatchId() {
    $('#csvBatchId').val('');
    $('#csvData').attr('placeholder', 'Paste your CSV transaction data here (include header row)...');
    alert('Batch ID cleared. Your next paste will create a new batch.');
}
</script>

</body>
</html>