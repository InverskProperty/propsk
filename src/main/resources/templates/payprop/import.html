<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<link th:href="@{/css/style.min.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>
<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>
    
    <div class="page-wrapper">
        <div class="container-fluid">
            <div class="row page-titles">
                <div class="col-md-5 align-self-center">
                    <h4 class="text-themecolor">PayProp Data Import</h4>
                </div>
                <div class="col-md-7 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0)">PayProp</a></li>
                            <li class="breadcrumb-item active">Data Import</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">PayProp Integration Status</h4>
                            
                            <div class="connection-status mb-4">
                                <div th:if="${paypropConnected}" class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> PayProp OAuth2 Connected
                                </div>
                                <div th:unless="${paypropConnected}" class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i> PayProp Not Connected
                                    <p class="mt-2">Please configure OAuth2 connection first.</p>
                                </div>
                            </div>

                            <div th:if="${paypropConnected}">
                                <h5 class="mb-3">Import Services</h5>
                                
                                <!-- Service Selection -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Select Import Services</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <h6>Financial Services</h6>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="payments" id="importPayments">
                                                            <label class="form-check-label" for="importPayments">Import Payments</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="invoices" id="importInvoices">
                                                            <label class="form-check-label" for="importInvoices">Import Invoices</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="bank-reconciliation" id="importBankRecon">
                                                            <label class="form-check-label" for="importBankRecon">Bank Reconciliation</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <h6>Property & Portfolio Services</h6>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="properties" id="importProperties">
                                                            <label class="form-check-label" for="importProperties">Import Properties</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="portfolios" id="importPortfolios">
                                                            <label class="form-check-label" for="importPortfolios">Import Portfolios</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="tenancy-agreements" id="importTenancies">
                                                            <label class="form-check-label" for="importTenancies">Tenancy Agreements</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <h6>Maintenance & Ticketing Services</h6>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="maintenance-categories" id="importMaintenanceCategories">
                                                            <label class="form-check-label" for="importMaintenanceCategories">Maintenance Categories</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="maintenance-tickets" id="importMaintenanceTickets">
                                                            <label class="form-check-label" for="importMaintenanceTickets">Maintenance Tickets</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="contractor-bids" id="importContractorBids">
                                                            <label class="form-check-label" for="importContractorBids">Contractor Bids</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <button id="runSelectedBtn" class="btn btn-primary me-2">
                                                            <i class="fas fa-play"></i> Run Selected Services
                                                        </button>
                                                        <button id="selectAllBtn" class="btn btn-secondary me-2">
                                                            <i class="fas fa-check-double"></i> Select All
                                                        </button>
                                                        <button id="clearAllBtn" class="btn btn-outline-secondary">
                                                            <i class="fas fa-times"></i> Clear All
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="card border-left-primary">
                                            <div class="card-body">
                                                <h6 class="card-title">Complete System Sync</h6>
                                                <p class="card-text">Import all available data from PayProp.</p>
                                                <button id="fullSyncBtn" class="btn btn-primary">
                                                    <i class="fas fa-sync"></i> Start Full Sync
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card border-left-success">
                                            <div class="card-body">
                                                <h6 class="card-title">Clear & Reimport Properties</h6>
                                                <p class="card-text">Clear existing properties and reimport from PayProp.</p>
                                                <button id="clearReimportBtn" class="btn btn-success">
                                                    <i class="fas fa-refresh"></i> Clear & Reimport
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Import Progress</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="progressContainer" style="display: none;">
                                                    <div class="progress mb-3">
                                                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                                    </div>
                                                    <div id="currentOperation" class="text-muted mb-2"></div>
                                                    <button id="cancelBtn" class="btn btn-danger btn-sm" style="display: none;">
                                                        <i class="fas fa-stop"></i> Cancel Import
                                                    </button>
                                                </div>
                                                
                                                <div id="results" class="mt-3">
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle"></i> Ready to import data from PayProp
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{general/footer.html}"></div>

<script>
let currentImportId = null;
let progressInterval = null;
let csrfToken = null;
let csrfHeader = null;

document.addEventListener('DOMContentLoaded', function() {
    csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
});

async function fetchWithCSRF(url, options = {}) {
    if (!options.headers) options.headers = {};
    if (csrfToken && csrfHeader) options.headers[csrfHeader] = csrfToken;
    options.credentials = 'include';
    return fetch(url, options);
}

// Button event listeners
document.getElementById('fullSyncBtn')?.addEventListener('click', function() {
    startImport('full');
});

document.getElementById('clearReimportBtn')?.addEventListener('click', function() {
    clearAndReimportProperties();
});

document.getElementById('runSelectedBtn')?.addEventListener('click', function() {
    runSelectedServices();
});

document.getElementById('selectAllBtn')?.addEventListener('click', function() {
    selectAllServices();
});

document.getElementById('clearAllBtn')?.addEventListener('click', function() {
    clearAllServices();
});

document.getElementById('cancelBtn')?.addEventListener('click', function() {
    cancelImport();
});

async function startImport(type) {
    const endpoint = type === 'full' 
        ? '/api/payprop/raw-import/sync-all-endpoints'
        : '/api/payprop/raw-import/sync-critical-missing';
    
    showProgress();
    updateStatus('Initializing import...', 'info');
    
    try {
        const response = await fetchWithCSRF(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.importId) {
                currentImportId = data.importId;
                document.getElementById('cancelBtn').style.display = 'inline-block';
                startProgressMonitoring();
                updateStatus('Import started successfully', 'success');
            } else {
                updateStatus('Import completed immediately: ' + JSON.stringify(data), 'success');
                hideProgress();
            }
        } else {
            updateStatus('Import failed: ' + (data.error || data.message), 'error');
            hideProgress();
        }
    } catch (error) {
        updateStatus('Import error: ' + error.message, 'error');
        hideProgress();
    }
}

function startProgressMonitoring() {
    if (!currentImportId) return;
    
    progressInterval = setInterval(async () => {
        try {
            const response = await fetchWithCSRF(`/api/payprop/raw-import/status/${currentImportId}`);
            const status = await response.json();
            
            if (response.ok) {
                updateProgressBar(status.progress || 0);
                document.getElementById('currentOperation').textContent = status.currentOperation || 'Processing...';
                
                if (status.completed) {
                    clearInterval(progressInterval);
                    hideProgress();
                    updateStatus('Import completed successfully!', 'success');
                    
                    if (status.results) {
                        displayResults(status.results);
                    }
                } else if (status.error) {
                    clearInterval(progressInterval);
                    hideProgress();
                    updateStatus('Import failed: ' + status.error, 'error');
                }
            }
        } catch (error) {
            console.error('Error monitoring progress:', error);
        }
    }, 2000);
}

async function cancelImport() {
    if (!currentImportId) return;
    
    try {
        const response = await fetchWithCSRF(`/api/payprop/raw-import/cancel/${currentImportId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            clearInterval(progressInterval);
            hideProgress();
            updateStatus('Import cancelled', 'warning');
        }
    } catch (error) {
        updateStatus('Error cancelling import: ' + error.message, 'error');
    }
}

function showProgress() {
    document.getElementById('progressContainer').style.display = 'block';
    // Disable all action buttons during progress
    const fullSyncBtn = document.getElementById('fullSyncBtn');
    const clearReimportBtn = document.getElementById('clearReimportBtn');
    const runSelectedBtn = document.getElementById('runSelectedBtn');
    
    if (fullSyncBtn) fullSyncBtn.disabled = true;
    if (clearReimportBtn) clearReimportBtn.disabled = true;
    if (runSelectedBtn) runSelectedBtn.disabled = true;
    
    updateProgressBar(0);
}

function hideProgress() {
    document.getElementById('progressContainer').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'none';
    
    // Re-enable all action buttons
    const fullSyncBtn = document.getElementById('fullSyncBtn');
    const clearReimportBtn = document.getElementById('clearReimportBtn');
    const runSelectedBtn = document.getElementById('runSelectedBtn');
    
    if (fullSyncBtn) fullSyncBtn.disabled = false;
    if (clearReimportBtn) clearReimportBtn.disabled = false;
    if (runSelectedBtn) runSelectedBtn.disabled = false;
    
    currentImportId = null;
    
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

function updateProgressBar(percent) {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
}

function updateStatus(message, type) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) {
        console.error('Results div not found');
        return;
    }
    
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const icon = type === 'error' ? 'fas fa-exclamation-circle' : 
                type === 'success' ? 'fas fa-check-circle' : 
                type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
    
    const timestamp = new Date().toLocaleTimeString();
    
    resultsDiv.innerHTML = `
        <div class="alert ${alertClass}">
            <i class="${icon}"></i> [${timestamp}] ${message}
        </div>
    `;
}

function displayResults(results) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) {
        console.error('Results div not found');
        return;
    }
    let html = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Import Summary:</div>';
    
    if (results.summary) {
        html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
        html += '<thead><tr><th>Operation</th><th>Status</th><th>Records</th></tr></thead><tbody>';
        
        Object.entries(results.summary).forEach(([operation, data]) => {
            const status = data.error ? 'Error' : 'Success';
            const statusClass = data.error ? 'text-danger' : 'text-success';
            const count = data.recordsProcessed || data.count || 0;
            
            html += `<tr>
                <td>${operation}</td>
                <td class="${statusClass}">${status}</td>
                <td>${count}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    resultsDiv.innerHTML = html;
}

async function clearAndReimportProperties() {
    showProgress();
    updateStatus('Clearing and reimporting properties...', 'info');
    
    try {
        const response = await fetchWithCSRF('/payprop/import/clear-and-reimport-properties', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            updateStatus('Properties cleared and reimported successfully!', 'success');
        } else {
            updateStatus('Import failed: ' + (data.error || data.message), 'error');
        }
    } catch (error) {
        updateStatus('Import error: ' + error.message, 'error');
    }
    
    hideProgress();
}

async function runSelectedServices() {
    const selectedServices = getSelectedServices();
    if (selectedServices.length === 0) {
        updateStatus('Please select at least one service to run', 'warning');
        return;
    }
    
    updateStatus(`Starting selected services: ${selectedServices.join(', ')}`, 'info');
    showProgress();
    
    const results = [];
    let successCount = 0;
    let errorCount = 0;
    
    for (const service of selectedServices) {
        try {
            updateStatus(`Processing ${service}...`, 'info');
            const result = await runSingleService(service);
            results.push({ service, success: result.success, message: result.message });
            
            if (result.success) {
                successCount++;
            } else {
                errorCount++;
            }
        } catch (error) {
            results.push({ service, success: false, message: error.message });
            errorCount++;
        }
    }
    
    hideProgress();
    
    // Display final results
    const overallSuccess = errorCount === 0;
    const statusType = overallSuccess ? 'success' : (successCount > 0 ? 'warning' : 'error');
    const summary = `Completed: ${successCount} successful, ${errorCount} failed`;
    
    updateStatus(summary, statusType);
    displayServiceResults(results);
}

async function runSingleService(service) {
    const serviceMap = {
        'maintenance-categories': '/api/payprop/maintenance/sync/categories',
        'maintenance-tickets': '/api/payprop/maintenance/sync/import-tickets',
        'contractor-bids': '/api/payprop/maintenance/sync/bidirectional',
        'payments': '/api/payprop/raw-import/sync-all-endpoints',
        'invoices': '/api/payprop/raw-import/sync-all-endpoints',
        'bank-reconciliation': '/api/payprop/raw-import/sync-all-endpoints',
        'properties': '/api/payprop/raw-import/sync-all-endpoints',
        'portfolios': '/api/payprop/raw-import/sync-all-endpoints',
        'tenancy-agreements': '/api/payprop/raw-import/sync-all-endpoints'
    };
    
    const endpoint = serviceMap[service];
    if (!endpoint) {
        throw new Error(`Unknown service: ${service}`);
    }
    
    console.log(`ðŸ”§ PayProp Debug: Calling service '${service}' at endpoint '${endpoint}'`);
    
    const response = await fetchWithCSRF(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    console.log(`ðŸ”§ PayProp Debug: Response status ${response.status} for service '${service}'`);
    
    const data = await response.json();
    console.log(`ðŸ”§ PayProp Debug: Response data for '${service}':`, data);
    
    if (response.ok) {
        return {
            success: data.success !== false,
            message: data.message || `${service} completed successfully`
        };
    } else {
        return {
            success: false,
            message: data.message || data.error || `Failed to run ${service}`
        };
    }
}

function displayServiceResults(results) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    
    let html = '<div class="mt-3"><h6>Service Execution Results:</h6>';
    html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
    html += '<thead><tr><th>Service</th><th>Status</th><th>Message</th></tr></thead><tbody>';
    
    results.forEach(result => {
        const statusClass = result.success ? 'text-success' : 'text-danger';
        const statusIcon = result.success ? 'fas fa-check-circle' : 'fas fa-times-circle';
        const statusText = result.success ? 'Success' : 'Failed';
        
        html += `<tr>
            <td>${result.service}</td>
            <td class="${statusClass}"><i class="${statusIcon}"></i> ${statusText}</td>
            <td>${result.message}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div></div>';
    
    const currentContent = resultsDiv.innerHTML;
    resultsDiv.innerHTML = currentContent + html;
}

function getSelectedServices() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function selectAllServices() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateStatus('All services selected', 'info');
}

function clearAllServices() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateStatus('All services cleared', 'info');
}

async function checkConnectionStatus() {
    try {
        const response = await fetchWithCSRF('/payprop/import/status', { method: 'POST' });
        const data = await response.json();
        
        if (!data.connected) {
            updateStatus('PayProp connection lost. Please reconnect.', 'error');
        }
    } catch (error) {
        console.error('Error checking connection:', error);
    }
}

// Only start checking connection status after DOM is fully loaded
$(document).ready(function() {
    // CRITICAL FIX: Hide preloader to prevent infinite loading
    $(".preloader").fadeOut();
    
    // Start checking connection status every 30 seconds
    setInterval(checkConnectionStatus, 30000);
});
</script>

<style>
.border-left-primary { border-left: 4px solid #007bff !important; }
.border-left-info { border-left: 4px solid #17a2b8 !important; }
.border-left-success { border-left: 4px solid #28a745 !important; }
.progress { height: 20px; }
.connection-status .alert { padding: 1rem; font-size: 1.1rem; }
.form-check { margin-bottom: 0.5rem; }
.card-header h6 { color: #495057; font-weight: 600; }
</style>

</body>
</html>