<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<link th:href="@{/css/style.min.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>
<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>
    
    <div class="page-wrapper">
        <div class="container-fluid">
            <div class="row page-titles">
                <div class="col-md-5 align-self-center">
                    <h4 class="text-themecolor">PayProp Data Import</h4>
                </div>
                <div class="col-md-7 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0)">PayProp</a></li>
                            <li class="breadcrumb-item active">Data Import</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">PayProp Integration Status</h4>
                            
                            <div class="connection-status mb-4">
                                <div th:if="${paypropConnected}" class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> PayProp OAuth2 Connected
                                </div>
                                <div th:unless="${paypropConnected}" class="alert alert-danger">
                                    <i class="fas fa-times-circle"></i> PayProp Not Connected
                                    <p class="mt-2">Please configure OAuth2 connection first.</p>
                                </div>
                            </div>

                            <div th:if="${paypropConnected}">
                                <!-- Import/Export Toggle -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <ul class="nav nav-pills justify-content-center" id="syncTypeTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="import-tab" data-bs-toggle="pill" data-bs-target="#import-panel" type="button" role="tab">
                                                    <i class="fas fa-download"></i> Import Services
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="export-tab" data-bs-toggle="pill" data-bs-target="#export-panel" type="button" role="tab">
                                                    <i class="fas fa-upload"></i> Export Services
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Tab Content -->
                                <div class="tab-content" id="syncTypeContent">
                                    <!-- Import Services Tab -->
                                    <div class="tab-pane fade show active" id="import-panel" role="tabpanel" aria-labelledby="import-tab">
                                        <h5 class="mb-3">Import Services</h5>
                                        
                                        <!-- Service Selection -->
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">Select Import Services</h6>
                                                    </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <h6>Financial Services</h6>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="payments" id="importPayments">
                                                            <label class="form-check-label" for="importPayments">Import Payments</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="invoices" id="importInvoices">
                                                            <label class="form-check-label" for="importInvoices">Import Invoices</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="bank-reconciliation" id="importBankRecon">
                                                            <label class="form-check-label" for="importBankRecon">Bank Reconciliation</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <h6>Property & Portfolio Services</h6>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="properties" id="importProperties">
                                                            <label class="form-check-label" for="importProperties">Import Properties</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="portfolios" id="importPortfolios">
                                                            <label class="form-check-label" for="importPortfolios">Import Portfolios</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="tenancy-agreements" id="importTenancies">
                                                            <label class="form-check-label" for="importTenancies">Tenancy Agreements</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <h6>Maintenance & Ticketing Services</h6>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="maintenance-categories" id="importMaintenanceCategories">
                                                            <label class="form-check-label" for="importMaintenanceCategories">Maintenance Categories</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="maintenance-tickets" id="importMaintenanceTickets">
                                                            <label class="form-check-label" for="importMaintenanceTickets">Maintenance Tickets</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" value="contractor-bids" id="importContractorBids">
                                                            <label class="form-check-label" for="importContractorBids">Contractor Bids</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <button id="runSelectedBtn" class="btn btn-primary me-2">
                                                            <i class="fas fa-play"></i> Run Selected Services
                                                        </button>
                                                        <button id="selectAllBtn" class="btn btn-secondary me-2">
                                                            <i class="fas fa-check-double"></i> Select All
                                                        </button>
                                                        <button id="clearAllBtn" class="btn btn-outline-secondary">
                                                            <i class="fas fa-times"></i> Clear All
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="card border-left-primary">
                                            <div class="card-body">
                                                <h6 class="card-title">Complete System Sync</h6>
                                                <p class="card-text">Import all available data from PayProp.</p>
                                                <button id="fullSyncBtn" class="btn btn-primary">
                                                    <i class="fas fa-sync"></i> Start Full Sync
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card border-left-success">
                                            <div class="card-body">
                                                <h6 class="card-title">Clear & Reimport Properties</h6>
                                                <p class="card-text">Clear existing properties and reimport from PayProp.</p>
                                                <button id="clearReimportBtn" class="btn btn-success">
                                                    <i class="fas fa-refresh"></i> Clear & Reimport
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Import Progress</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="progressContainer" style="display: none;">
                                                    <div class="progress mb-3">
                                                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                                    </div>
                                                    <div id="currentOperation" class="text-muted mb-2"></div>
                                                    <button id="cancelBtn" class="btn btn-danger btn-sm" style="display: none;">
                                                        <i class="fas fa-stop"></i> Cancel Import
                                                    </button>
                                                </div>
                                                
                                                <div id="results" class="mt-3">
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle"></i> Ready to import data from PayProp
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                    
                                    <!-- Export Services Tab -->
                                    <div class="tab-pane fade" id="export-panel" role="tabpanel" aria-labelledby="export-tab">
                                        <h5 class="mb-3">Export Services</h5>
                                        
                                        <!-- Export Service Selection -->
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">Select Export Services</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <h6>Property & Portfolio Exports</h6>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-properties" id="exportProperties">
                                                                    <label class="form-check-label" for="exportProperties">Export Properties</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-property-owners" id="exportPropertyOwners">
                                                                    <label class="form-check-label" for="exportPropertyOwners">Export Property Owners</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-tenants" id="exportTenants">
                                                                    <label class="form-check-label" for="exportTenants">Export Tenants</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-beneficiaries" id="exportBeneficiaries">
                                                                    <label class="form-check-label" for="exportBeneficiaries">Import Beneficiaries (All)</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <h6>Financial Data Exports</h6>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="invoice-categories" id="invoiceCategories">
                                                                    <label class="form-check-label" for="invoiceCategories">Invoice Categories</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="payment-categories" id="paymentCategories">
                                                                    <label class="form-check-label" for="paymentCategories">Payment Categories</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-transactions" id="exportTransactions">
                                                                    <label class="form-check-label" for="exportTransactions">Export Transactions</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-invoices" id="exportInvoices">
                                                                    <label class="form-check-label" for="exportInvoices">Export Invoice Data</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-payment-rules" id="exportPaymentRules">
                                                                    <label class="form-check-label" for="exportPaymentRules">Export Payment Rules</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <h6>Maintenance & Tickets</h6>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-maintenance-tickets" id="exportMaintenanceTickets">
                                                                    <label class="form-check-label" for="exportMaintenanceTickets">Export Maintenance Tickets</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-contractor-bids" id="exportContractorBids">
                                                                    <label class="form-check-label" for="exportContractorBids">Export Contractor Bids</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="export-maintenance-categories" id="exportMaintenanceCategories">
                                                                    <label class="form-check-label" for="exportMaintenanceCategories">Export Categories</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="row mt-3">
                                                            <div class="col-12">
                                                                <button id="runSelectedExportBtn" class="btn btn-success me-2">
                                                                    <i class="fas fa-upload"></i> Run Selected Exports
                                                                </button>
                                                                <button id="selectAllExportBtn" class="btn btn-secondary me-2">
                                                                    <i class="fas fa-check-double"></i> Select All
                                                                </button>
                                                                <button id="clearAllExportBtn" class="btn btn-outline-secondary">
                                                                    <i class="fas fa-times"></i> Clear All
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Export Quick Actions -->
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <div class="card border-left-success">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Full Export to PayProp</h6>
                                                        <p class="card-text">Export all CRM data to PayProp (properties, owners, tenants).</p>
                                                        <button id="fullExportBtn" class="btn btn-success">
                                                            <i class="fas fa-cloud-upload-alt"></i> Start Full Export
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="card border-left-info">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Sync Unsynced Data</h6>
                                                        <p class="card-text">Export only properties and data that haven't been synced to PayProp yet.</p>
                                                        <button id="syncUnsyncedBtn" class="btn btn-info">
                                                            <i class="fas fa-sync-alt"></i> Sync Unsynced Data
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h6 class="mb-0">Export Progress</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="exportProgressContainer" style="display: none;">
                                                            <div class="progress mb-3">
                                                                <div id="exportProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                                            </div>
                                                            <div id="currentExportOperation" class="text-muted mb-2"></div>
                                                            <button id="cancelExportBtn" class="btn btn-danger btn-sm" style="display: none;">
                                                                <i class="fas fa-stop"></i> Cancel Export
                                                            </button>
                                                        </div>
                                                        
                                                        <div id="exportResults" class="mt-3">
                                                            <div class="alert alert-info">
                                                                <i class="fas fa-info-circle"></i> Ready to export data to PayProp
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{general/footer.html}"></div>

<script>
let currentImportId = null;
let progressInterval = null;
let csrfToken = null;
let csrfHeader = null;

document.addEventListener('DOMContentLoaded', function() {
    csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
});

async function fetchWithCSRF(url, options = {}) {
    if (!options.headers) options.headers = {};
    if (csrfToken && csrfHeader) options.headers[csrfHeader] = csrfToken;
    options.credentials = 'include';
    return fetch(url, options);
}

// Button event listeners
document.getElementById('fullSyncBtn')?.addEventListener('click', function() {
    startImport('full');
});

document.getElementById('clearReimportBtn')?.addEventListener('click', function() {
    clearAndReimportProperties();
});

document.getElementById('runSelectedBtn')?.addEventListener('click', function() {
    runSelectedServices();
});

document.getElementById('selectAllBtn')?.addEventListener('click', function() {
    selectAllServices();
});

document.getElementById('clearAllBtn')?.addEventListener('click', function() {
    clearAllServices();
});

document.getElementById('cancelBtn')?.addEventListener('click', function() {
    cancelImport();
});

async function startImport(type) {
    const endpoint = type === 'full' 
        ? '/api/payprop/raw-import/sync-all-endpoints'
        : '/api/payprop/raw-import/sync-critical-missing';
    
    showProgress();
    updateStatus('Initializing import...', 'info');
    
    try {
        const response = await fetchWithCSRF(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.importId) {
                currentImportId = data.importId;
                document.getElementById('cancelBtn').style.display = 'inline-block';
                startProgressMonitoring();
                updateStatus('Import started successfully', 'success');
            } else {
                updateStatus('Import completed immediately: ' + JSON.stringify(data), 'success');
                hideProgress();
            }
        } else {
            updateStatus('Import failed: ' + (data.error || data.message), 'error');
            hideProgress();
        }
    } catch (error) {
        updateStatus('Import error: ' + error.message, 'error');
        hideProgress();
    }
}

function startProgressMonitoring() {
    if (!currentImportId) return;
    
    progressInterval = setInterval(async () => {
        try {
            const response = await fetchWithCSRF(`/api/payprop/raw-import/status/${currentImportId}`);
            const status = await response.json();
            
            if (response.ok) {
                updateProgressBar(status.progress || 0);
                document.getElementById('currentOperation').textContent = status.currentOperation || 'Processing...';
                
                if (status.completed) {
                    clearInterval(progressInterval);
                    hideProgress();
                    updateStatus('Import completed successfully!', 'success');
                    
                    if (status.results) {
                        displayResults(status.results);
                    }
                } else if (status.error) {
                    clearInterval(progressInterval);
                    hideProgress();
                    updateStatus('Import failed: ' + status.error, 'error');
                }
            }
        } catch (error) {
            console.error('Error monitoring progress:', error);
        }
    }, 2000);
}

async function cancelImport() {
    if (!currentImportId) return;
    
    try {
        const response = await fetchWithCSRF(`/api/payprop/raw-import/cancel/${currentImportId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            clearInterval(progressInterval);
            hideProgress();
            updateStatus('Import cancelled', 'warning');
        }
    } catch (error) {
        updateStatus('Error cancelling import: ' + error.message, 'error');
    }
}

function showProgress() {
    document.getElementById('progressContainer').style.display = 'block';
    // Disable all action buttons during progress
    const fullSyncBtn = document.getElementById('fullSyncBtn');
    const clearReimportBtn = document.getElementById('clearReimportBtn');
    const runSelectedBtn = document.getElementById('runSelectedBtn');
    
    if (fullSyncBtn) fullSyncBtn.disabled = true;
    if (clearReimportBtn) clearReimportBtn.disabled = true;
    if (runSelectedBtn) runSelectedBtn.disabled = true;
    
    updateProgressBar(0);
}

function hideProgress() {
    document.getElementById('progressContainer').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'none';
    
    // Re-enable all action buttons
    const fullSyncBtn = document.getElementById('fullSyncBtn');
    const clearReimportBtn = document.getElementById('clearReimportBtn');
    const runSelectedBtn = document.getElementById('runSelectedBtn');
    
    if (fullSyncBtn) fullSyncBtn.disabled = false;
    if (clearReimportBtn) clearReimportBtn.disabled = false;
    if (runSelectedBtn) runSelectedBtn.disabled = false;
    
    currentImportId = null;
    
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

function updateProgressBar(percent) {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
}

function updateStatus(message, type) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) {
        console.error('Results div not found');
        return;
    }
    
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const icon = type === 'error' ? 'fas fa-exclamation-circle' : 
                type === 'success' ? 'fas fa-check-circle' : 
                type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
    
    const timestamp = new Date().toLocaleTimeString();
    
    resultsDiv.innerHTML = `
        <div class="alert ${alertClass}">
            <i class="${icon}"></i> [${timestamp}] ${message}
        </div>
    `;
}

function displayResults(results) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) {
        console.error('Results div not found');
        return;
    }
    let html = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Import Summary:</div>';
    
    if (results.summary) {
        html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
        html += '<thead><tr><th>Operation</th><th>Status</th><th>Records</th></tr></thead><tbody>';
        
        Object.entries(results.summary).forEach(([operation, data]) => {
            const status = data.error ? 'Error' : 'Success';
            const statusClass = data.error ? 'text-danger' : 'text-success';
            const count = data.recordsProcessed || data.count || 0;
            
            html += `<tr>
                <td>${operation}</td>
                <td class="${statusClass}">${status}</td>
                <td>${count}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    resultsDiv.innerHTML = html;
}

async function clearAndReimportProperties() {
    showProgress();
    updateStatus('Clearing and reimporting properties...', 'info');
    
    try {
        const response = await fetchWithCSRF('/payprop/import/clear-and-reimport-properties', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            updateStatus('Properties cleared and reimported successfully!', 'success');
        } else {
            updateStatus('Import failed: ' + (data.error || data.message), 'error');
        }
    } catch (error) {
        updateStatus('Import error: ' + error.message, 'error');
    }
    
    hideProgress();
}

async function runSelectedServices() {
    const selectedServices = getSelectedServices();
    if (selectedServices.length === 0) {
        updateStatus('Please select at least one service to run', 'warning');
        return;
    }
    
    updateStatus(`Starting selected services: ${selectedServices.join(', ')}`, 'info');
    showProgress();
    
    const results = [];
    let successCount = 0;
    let errorCount = 0;
    
    for (const service of selectedServices) {
        try {
            updateStatus(`Processing ${service}...`, 'info');
            const result = await runSingleService(service);
            results.push({ service, success: result.success, message: result.message });
            
            if (result.success) {
                successCount++;
            } else {
                errorCount++;
            }
        } catch (error) {
            results.push({ service, success: false, message: error.message });
            errorCount++;
        }
    }
    
    hideProgress();
    
    // Display final results
    const overallSuccess = errorCount === 0;
    const statusType = overallSuccess ? 'success' : (successCount > 0 ? 'warning' : 'error');
    const summary = `Completed: ${successCount} successful, ${errorCount} failed`;
    
    updateStatus(summary, statusType);
    displayServiceResults(results);
}

async function runSingleService(service) {
    const serviceMap = {
        'maintenance-categories': '/api/payprop/maintenance/sync/categories',
        'maintenance-tickets': '/api/payprop/maintenance/sync/import-tickets',
        'contractor-bids': '/api/payprop/raw-import/test-complete-beneficiaries',
        'invoice-categories': '/api/payprop/raw-import/test-complete-invoice-categories',
        'payment-categories': '/api/payprop/raw-import/test-complete-payments-categories',
        'payments': '/api/payprop/raw-import/test-complete-payments',
        'invoices': '/api/payprop/raw-import/test-complete-invoices',
        'bank-reconciliation': '/api/payprop/raw-import/test-complete-all-payments',
        'properties': '/api/payprop/raw-import/test-complete-properties',
        'portfolios': '/api/payprop/raw-import/test-complete-beneficiaries',
        'tenancy-agreements': '/api/payprop/raw-import/test-complete-tenants',
        'export-beneficiaries': '/api/payprop/raw-import/test-complete-beneficiaries'
    };
    
    const endpoint = serviceMap[service];
    if (!endpoint) {
        throw new Error(`Unknown service: ${service}`);
    }
    
    console.log(`🔧 PayProp Debug: Calling service '${service}' at endpoint '${endpoint}'`);
    
    const response = await fetchWithCSRF(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    console.log(`🔧 PayProp Debug: Response status ${response.status} for service '${service}'`);
    
    const data = await response.json();
    console.log(`🔧 PayProp Debug: Response data for '${service}':`, data);
    
    if (response.ok) {
        return {
            success: data.success !== false,
            message: data.message || `${service} completed successfully`
        };
    } else {
        return {
            success: false,
            message: data.message || data.error || `Failed to run ${service}`
        };
    }
}

function displayServiceResults(results) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    
    let html = '<div class="mt-3"><h6>Service Execution Results:</h6>';
    html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
    html += '<thead><tr><th>Service</th><th>Status</th><th>Message</th></tr></thead><tbody>';
    
    results.forEach(result => {
        const statusClass = result.success ? 'text-success' : 'text-danger';
        const statusIcon = result.success ? 'fas fa-check-circle' : 'fas fa-times-circle';
        const statusText = result.success ? 'Success' : 'Failed';
        
        html += `<tr>
            <td>${result.service}</td>
            <td class="${statusClass}"><i class="${statusIcon}"></i> ${statusText}</td>
            <td>${result.message}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div></div>';
    
    const currentContent = resultsDiv.innerHTML;
    resultsDiv.innerHTML = currentContent + html;
}

function getSelectedServices() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function selectAllServices() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateStatus('All services selected', 'info');
}

function clearAllServices() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateStatus('All services cleared', 'info');
}

async function checkConnectionStatus() {
    try {
        const response = await fetchWithCSRF('/payprop/import/status', { method: 'POST' });
        const data = await response.json();
        
        if (!data.connected) {
            updateStatus('PayProp connection lost. Please reconnect.', 'error');
        }
    } catch (error) {
        console.error('Error checking connection:', error);
    }
}

// ===== EXPORT FUNCTIONS =====

let currentExportId = null;
let exportProgressInterval = null;

// Export button event listeners
document.getElementById('fullExportBtn')?.addEventListener('click', function() {
    startExport('full');
});

document.getElementById('syncUnsyncedBtn')?.addEventListener('click', function() {
    startExport('unsynced');
});

document.getElementById('runSelectedExportBtn')?.addEventListener('click', function() {
    runSelectedExportServices();
});

document.getElementById('selectAllExportBtn')?.addEventListener('click', function() {
    selectAllExportServices();
});

document.getElementById('clearAllExportBtn')?.addEventListener('click', function() {
    clearAllExportServices();
});

document.getElementById('cancelExportBtn')?.addEventListener('click', function() {
    cancelExport();
});

async function startExport(type) {
    const endpoint = type === 'full' 
        ? '/api/payprop/sync/unified-sync'
        : '/api/payprop/sync/sync-unsynced-properties';
    
    showExportProgress();
    updateExportStatus('Initializing export...', 'info');
    
    try {
        const response = await fetchWithCSRF(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.exportId || data.success) {
                if (data.exportId) {
                    currentExportId = data.exportId;
                    document.getElementById('cancelExportBtn').style.display = 'inline-block';
                    startExportProgressMonitoring();
                }
                updateExportStatus('Export started successfully', 'success');
            } else {
                updateExportStatus('Export failed: ' + JSON.stringify(data), 'error');
                hideExportProgress();
            }
        } else {
            updateExportStatus('Export failed: ' + (data.error || data.message), 'error');
            hideExportProgress();
        }
    } catch (error) {
        updateExportStatus('Export error: ' + error.message, 'error');
        hideExportProgress();
    }
}

function startExportProgressMonitoring() {
    if (!currentExportId) return;
    
    exportProgressInterval = setInterval(async () => {
        try {
            const response = await fetchWithCSRF(`/api/payprop/sync/status/${currentExportId}`);
            const status = await response.json();
            
            if (response.ok) {
                updateExportProgressBar(status.progress || 0);
                document.getElementById('currentExportOperation').textContent = status.currentOperation || 'Processing...';
                
                if (status.completed) {
                    clearInterval(exportProgressInterval);
                    hideExportProgress();
                    updateExportStatus('Export completed successfully!', 'success');
                    
                    if (status.results) {
                        displayExportResults(status.results);
                    }
                } else if (status.error) {
                    clearInterval(exportProgressInterval);
                    hideExportProgress();
                    updateExportStatus('Export failed: ' + status.error, 'error');
                }
            }
        } catch (error) {
            console.error('Error monitoring export progress:', error);
        }
    }, 2000);
}

async function cancelExport() {
    if (!currentExportId) return;
    
    try {
        const response = await fetchWithCSRF(`/api/payprop/sync/cancel/${currentExportId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            clearInterval(exportProgressInterval);
            hideExportProgress();
            updateExportStatus('Export cancelled', 'warning');
        }
    } catch (error) {
        updateExportStatus('Error cancelling export: ' + error.message, 'error');
    }
}

function showExportProgress() {
    document.getElementById('exportProgressContainer').style.display = 'block';
    // Disable all export action buttons during progress
    const fullExportBtn = document.getElementById('fullExportBtn');
    const syncUnsyncedBtn = document.getElementById('syncUnsyncedBtn');
    const runSelectedExportBtn = document.getElementById('runSelectedExportBtn');
    
    if (fullExportBtn) fullExportBtn.disabled = true;
    if (syncUnsyncedBtn) syncUnsyncedBtn.disabled = true;
    if (runSelectedExportBtn) runSelectedExportBtn.disabled = true;
    
    updateExportProgressBar(0);
}

function hideExportProgress() {
    document.getElementById('exportProgressContainer').style.display = 'none';
    document.getElementById('cancelExportBtn').style.display = 'none';
    
    // Re-enable all export action buttons
    const fullExportBtn = document.getElementById('fullExportBtn');
    const syncUnsyncedBtn = document.getElementById('syncUnsyncedBtn');
    const runSelectedExportBtn = document.getElementById('runSelectedExportBtn');
    
    if (fullExportBtn) fullExportBtn.disabled = false;
    if (syncUnsyncedBtn) syncUnsyncedBtn.disabled = false;
    if (runSelectedExportBtn) runSelectedExportBtn.disabled = false;
    
    currentExportId = null;
    
    if (exportProgressInterval) {
        clearInterval(exportProgressInterval);
        exportProgressInterval = null;
    }
}

function updateExportProgressBar(percent) {
    const progressBar = document.getElementById('exportProgressBar');
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
}

function updateExportStatus(message, type) {
    const resultsDiv = document.getElementById('exportResults');
    if (!resultsDiv) {
        console.error('Export results div not found');
        return;
    }
    
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const icon = type === 'error' ? 'fas fa-exclamation-circle' : 
                type === 'success' ? 'fas fa-check-circle' : 
                type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
    
    const timestamp = new Date().toLocaleTimeString();
    
    resultsDiv.innerHTML = `
        <div class="alert ${alertClass}">
            <i class="${icon}"></i> [${timestamp}] ${message}
        </div>
    `;
}

function displayExportResults(results) {
    const resultsDiv = document.getElementById('exportResults');
    if (!resultsDiv) return;
    
    let html = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Export Summary:</div>';
    
    if (results.summary) {
        html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
        html += '<thead><tr><th>Operation</th><th>Status</th><th>Records</th></tr></thead><tbody>';
        
        Object.entries(results.summary).forEach(([operation, data]) => {
            const status = data.error ? 'Error' : 'Success';
            const statusClass = data.error ? 'text-danger' : 'text-success';
            const count = data.recordsProcessed || data.count || 0;
            
            html += `<tr>
                <td>${operation}</td>
                <td class="${statusClass}">${status}</td>
                <td>${count}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
    }
    
    resultsDiv.innerHTML = html;
}

async function runSelectedExportServices() {
    const selectedServices = getSelectedExportServices();
    if (selectedServices.length === 0) {
        updateExportStatus('Please select at least one export service to run', 'warning');
        return;
    }
    
    updateExportStatus(`Starting selected exports: ${selectedServices.join(', ')}`, 'info');
    showExportProgress();
    
    const results = [];
    let successCount = 0;
    let errorCount = 0;
    
    for (const service of selectedServices) {
        try {
            updateExportStatus(`Processing ${service}...`, 'info');
            const result = await runSingleExportService(service);
            results.push({ service, success: result.success, message: result.message });
            
            if (result.success) {
                successCount++;
            } else {
                errorCount++;
            }
        } catch (error) {
            results.push({ service, success: false, message: error.message });
            errorCount++;
        }
    }
    
    hideExportProgress();
    
    // Display final results
    const overallSuccess = errorCount === 0;
    const statusType = overallSuccess ? 'success' : (successCount > 0 ? 'warning' : 'error');
    const summary = `Export completed: ${successCount} successful, ${errorCount} failed`;
    
    updateExportStatus(summary, statusType);
    displayExportServiceResults(results);
}

async function runSingleExportService(service) {
    const serviceMap = {
        'export-properties': '/api/payprop/raw-import/test-complete-properties',
        'export-property-owners': '/api/payprop/raw-import/test-complete-beneficiaries',
        'export-tenants': '/api/payprop/raw-import/test-complete-tenants',
        'export-beneficiaries': '/api/payprop/raw-import/test-complete-beneficiaries',
        'export-transactions': '/api/payprop/raw-import/test-complete-all-payments',
        'export-invoices': '/api/payprop/raw-import/test-complete-invoices',
        'export-payment-rules': '/api/payprop/raw-import/test-complete-payments',
        'export-maintenance-tickets': '/api/payprop/maintenance/sync/export-tickets',
        'export-contractor-bids': '/api/payprop/raw-import/test-complete-beneficiaries',
        'export-maintenance-categories': '/api/payprop/maintenance/sync/export-categories'
    };
    
    const endpoint = serviceMap[service];
    if (!endpoint) {
        throw new Error(`Unknown export service: ${service}`);
    }
    
    console.log(`🔧 PayProp Export Debug: Calling service '${service}' at endpoint '${endpoint}'`);
    
    const response = await fetchWithCSRF(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    const data = await response.json();
    
    if (response.ok) {
        return {
            success: data.success !== false,
            message: data.message || `${service} exported successfully`
        };
    } else {
        return {
            success: false,
            message: data.message || data.error || `Failed to export ${service}`
        };
    }
}

function displayExportServiceResults(results) {
    const resultsDiv = document.getElementById('exportResults');
    if (!resultsDiv) return;
    
    let html = '<div class="mt-3"><h6>Export Service Results:</h6>';
    html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
    html += '<thead><tr><th>Service</th><th>Status</th><th>Message</th></tr></thead><tbody>';
    
    results.forEach(result => {
        const statusClass = result.success ? 'text-success' : 'text-danger';
        const statusIcon = result.success ? 'fas fa-check-circle' : 'fas fa-times-circle';
        const statusText = result.success ? 'Success' : 'Failed';
        
        html += `<tr>
            <td>${result.service}</td>
            <td class="${statusClass}"><i class="${statusIcon}"></i> ${statusText}</td>
            <td>${result.message}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div></div>';
    
    const currentContent = resultsDiv.innerHTML;
    resultsDiv.innerHTML = currentContent + html;
}

function getSelectedExportServices() {
    const checkboxes = document.querySelectorAll('#export-panel input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function selectAllExportServices() {
    const checkboxes = document.querySelectorAll('#export-panel input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateExportStatus('All export services selected', 'info');
}

function clearAllExportServices() {
    const checkboxes = document.querySelectorAll('#export-panel input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateExportStatus('All export services cleared', 'info');
}

// Only start checking connection status after DOM is fully loaded
$(document).ready(function() {
    // CRITICAL FIX: Hide preloader to prevent infinite loading
    $(".preloader").fadeOut();
    
    // Start checking connection status every 30 seconds
    setInterval(checkConnectionStatus, 30000);
});
</script>

<style>
.border-left-primary { border-left: 4px solid #007bff !important; }
.border-left-info { border-left: 4px solid #17a2b8 !important; }
.border-left-success { border-left: 4px solid #28a745 !important; }
.progress { height: 20px; }
.connection-status .alert { padding: 1rem; font-size: 1.1rem; }
.form-check { margin-bottom: 0.5rem; }
.card-header h6 { color: #495057; font-weight: 600; }
</style>

</body>
</html>