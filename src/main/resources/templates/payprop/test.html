<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayProp Comprehensive API Test Suite</title>
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0066cc;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), #004499);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .test-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .test-card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0;
        }
        
        .test-card-body {
            padding: 1.5rem;
        }
        
        .result-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .result-success {
            border-left: 4px solid var(--success-color);
            background-color: #d4edda;
        }
        
        .result-error {
            border-left: 4px solid var(--danger-color);
            background-color: #f8d7da;
        }
        
        .result-warning {
            border-left: 4px solid var(--warning-color);
            background-color: #fff3cd;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-success { background: var(--success-color); color: white; }
        .status-error { background: var(--danger-color); color: white; }
        .status-warning { background: var(--warning-color); color: #856404; }
        .status-info { background: var(--info-color); color: white; }
        
        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .search-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .quick-action-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 20px;
        }
        
        .highlight-match {
            background: yellow;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .data-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .comparison-panel {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
        }
        
        .api-panel {
            border-left: 4px solid var(--info-color);
        }
        
        .database-panel {
            border-left: 4px solid var(--primary-color);
        }
        
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-link {
            border: none;
            color: #666;
            font-weight: 500;
        }
        
        .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-radius: 6px 6px 0 0;
        }
        
        .endpoint-tree {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .endpoint-item {
            transition: background-color 0.2s;
        }
        
        .endpoint-item:hover {
            background-color: #f8f9fa;
        }
        
        .endpoint-category {
            border-left: 3px solid var(--primary-color);
            padding-left: 1rem;
        }
        
        .bulk-test-progress {
            position: sticky;
            top: 20px;
            z-index: 10;
        }
        
        .test-worker-info {
            font-size: 0.8rem;
            color: #666;
        }
        
        .parameter-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3"><strong>Processing Request...</strong></div>
            <div class="text-muted">This may take a few seconds</div>
        </div>
    </div>

    <div class="dashboard-header">
        <div class="container">
            <h1><i class="fas fa-cogs"></i> PayProp Enhanced Test Dashboard</h1>
            <p class="lead mb-0">Comprehensive PayProp API testing, data investigation, and sync management</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="test-card">
                    <div class="test-card-header">
                        <h5><i class="fas fa-tachometer-alt"></i> System Status Overview</h5>
                    </div>
                    <div class="test-card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100" onclick="checkOAuthStatus()">
                                    <i class="fas fa-key"></i> Check OAuth Status
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100" onclick="getSyncDashboard()">
                                    <i class="fas fa-chart-bar"></i> Sync Dashboard
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100" onclick="discoverEndpoints()">
                                    <i class="fas fa-search"></i> Discover Endpoints
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100" onclick="testAllConnections()">
                                    <i class="fas fa-plug"></i> Test All Connections
                                </button>
                            </div>
                        </div>
                        <div id="statusOverviewResult" class="result-display d-none"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Testing Interface -->
        <div class="row">
            <div class="col-12">
                <div class="test-card">
                    <div class="test-card-header">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#searchTab">
                                    <i class="fas fa-search"></i> Smart Search
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#compareTab">
                                    <i class="fas fa-balance-scale"></i> Compare Endpoints
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#analyzeTab">
                                    <i class="fas fa-microscope"></i> Analyze Transaction
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#batchTab">
                                    <i class="fas fa-layer-group"></i> Batch Analysis
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#syncTab">
                                    <i class="fas fa-sync"></i> Sync Testing
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#blocksTab">
                                    <i class="fas fa-building"></i> Block Testing
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#endpointDiscoveryTab">
                                    <i class="fas fa-globe"></i> Endpoint Discovery
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#bulkTestTab">
                                    <i class="fas fa-rocket"></i> Bulk Testing
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#invoiceInvestigationTab">
                                    <i class="fas fa-file-invoice-dollar text-warning"></i> Invoice Investigation
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#comprehensiveTab">
                                    <i class="fas fa-clipboard-list text-primary"></i> Comprehensive Tests
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#testDataTab">
                                    <i class="fas fa-database text-info"></i> Test Data
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#endpointTestTab">
                                    <i class="fas fa-network-wired text-success"></i> Endpoint Testing
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#rawTab">
                                    <i class="fas fa-code"></i> Raw API
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="test-card-body">
                        <div class="tab-content">
                            
                            <!-- Smart Search Tab -->
                            <div class="tab-pane fade show active" id="searchTab">
                                <h5><i class="fas fa-search"></i> Smart Payment Search</h5>
                                <p class="text-muted">Search across PayProp API and local database with flexible criteria</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">Amount (£)</label>
                                            <input type="number" id="searchAmount" class="form-control" placeholder="e.g., 542.75" step="0.01">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" id="searchFromDate" class="form-control" value="">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" id="searchToDate" class="form-control" value="">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Property ID</label>
                                            <input type="text" id="searchPropertyId" class="form-control" placeholder="PayProp Property ID">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Beneficiary Name</label>
                                            <input type="text" id="searchBeneficiaryName" class="form-control" placeholder="e.g., Christopher Booth">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Batch ID</label>
                                            <input type="text" id="searchBatchId" class="form-control" placeholder="PayProp Batch ID">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Transaction ID</label>
                                            <input type="text" id="searchTransactionId" class="form-control" placeholder="PayProp Transaction ID">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Specific Endpoint</label>
                                            <select id="searchEndpoint" class="form-select">
                                                <option value="">Search All Endpoints</option>
                                                <option value="/export/payments">Export Payments</option>
                                                <option value="/report/all-payments">Report All-Payments</option>
                                                <option value="/report/icdn">ICDN Transactions</option>
                                                <option value="/export/invoices">Export Invoices</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-primary quick-action-btn" onclick="smartSearch()">
                                        <i class="fas fa-search"></i> Smart Search
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setDateRange('7days')">Last 7 Days</button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setDateRange('30days')">Last 30 Days</button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setDateRange('3months')">Last 3 Months</button>
                                    <button class="btn btn-outline-warning quick-action-btn" onclick="setChristopherBoothExample()">
                                        <i class="fas fa-bug"></i> Christopher Booth Example
                                    </button>
                                    <button class="btn btn-outline-secondary quick-action-btn" onclick="clearSearchForm()">
                                        <i class="fas fa-eraser"></i> Clear
                                    </button>
                                </div>
                                
                                <div id="smartSearchResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Compare Endpoints Tab -->
                            <div class="tab-pane fade" id="compareTab">
                                <h5><i class="fas fa-balance-scale"></i> Endpoint Comparison</h5>
                                <p class="text-muted">Compare multiple PayProp endpoints with identical criteria</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" id="compareFromDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" id="compareToDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Property ID</label>
                                            <input type="text" id="comparePropertyId" class="form-control" placeholder="Optional">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Filter By</label>
                                            <select id="compareFilterBy" class="form-select">
                                                <option value="">Default</option>
                                                <option value="reconciliation_date">Reconciliation Date</option>
                                                <option value="remittance_date">Remittance Date</option>
                                                <option value="payment_date">Payment Date</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Max Rows Per Endpoint</label>
                                            <input type="number" id="compareMaxRows" class="form-control" value="10" min="1" max="1000">
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" onclick="compareEndpoints()">
                                                <i class="fas fa-balance-scale"></i> Compare All Endpoints
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="compareEndpointsResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Analyze Transaction Tab -->
                            <div class="tab-pane fade" id="analyzeTab">
                                <h5><i class="fas fa-microscope"></i> Transaction Deep Analysis</h5>
                                <p class="text-muted">Detailed analysis of specific transactions with field-by-field comparison</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">PayProp Transaction ID</label>
                                            <input type="text" id="analyzeTransactionId" class="form-control" 
                                                   placeholder="e.g., G1OBKg9aXM (Christopher Booth payment)">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Search Endpoint</label>
                                            <select id="analyzeEndpoint" class="form-select">
                                                <option value="">Search All</option>
                                                <option value="/export/payments">Export Payments</option>
                                                <option value="/report/all-payments">Report All-Payments</option>
                                                <option value="/report/icdn">ICDN</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" onclick="analyzeTransaction()">
                                                <i class="fas fa-microscope"></i> Deep Analyze
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setAnalyzeExample('G1OBKg9aXM')">
                                        Christopher Booth Payment
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setAnalyzeExample('32874683')">
                                        PayProp UI Payment ID
                                    </button>
                                </div>
                                
                                <div id="analyzeTransactionResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Batch Analysis Tab -->
                            <div class="tab-pane fade" id="batchTab">
                                <h5><i class="fas fa-layer-group"></i> Batch Payment Analysis</h5>
                                <p class="text-muted">Analyze batch payments and identify grouping issues</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">Batch ID</label>
                                            <input type="text" id="batchAnalyzeBatchId" class="form-control" placeholder="Specific Batch ID">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" id="batchAnalyzeFromDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" id="batchAnalyzeToDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Property ID</label>
                                            <input type="text" id="batchAnalyzePropertyId" class="form-control" placeholder="Optional">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button class="btn btn-primary" onclick="analyzeBatch()">
                                                <i class="fas fa-layer-group"></i> Analyze Batches
                                            </button>
                                            <button class="btn btn-outline-info" onclick="findMissingBatches()">
                                                <i class="fas fa-exclamation-triangle"></i> Find Missing Batches
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <strong>Batch Analysis Features:</strong>
                                    <ul class="mb-0">
                                        <li>Compare PayProp batch groupings vs database records</li>
                                        <li>Identify missing batch IDs in database</li>
                                        <li>Verify batch payment counts and totals</li>
                                        <li>Find the 6-payment batch totaling £2,957.47 (Christopher Booth case)</li>
                                    </ul>
                                </div>
                                
                                <div id="batchAnalysisResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Sync Testing Tab -->
                            <div class="tab-pane fade" id="syncTab">
                                <h5><i class="fas fa-sync"></i> Sync Service Testing</h5>
                                <p class="text-muted">Test your existing sync services and monitor performance</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Sync Type</label>
                                            <select id="syncType" class="form-select">
                                                <option value="COMPREHENSIVE_FINANCIAL">Comprehensive Financial Sync</option>
                                                <option value="DUAL_FINANCIAL">Dual Financial Sync (Instructions vs Actuals)</option>
                                                <option value="PROPERTIES_ONLY">Properties Only</option>
                                                <option value="BENEFICIARIES_ONLY">Beneficiaries Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="syncDryRun" checked>
                                                <label class="form-check-label" for="syncDryRun">Dry Run (Test Only)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-success w-100" onclick="triggerSync()">
                                                <i class="fas fa-rocket"></i> Trigger Sync
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-outline-primary quick-action-btn" onclick="checkSyncHealth()">
                                        <i class="fas fa-heart"></i> Check Sync Health
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="viewRecentSyncs()">
                                        <i class="fas fa-history"></i> Recent Syncs
                                    </button>
                                    <button class="btn btn-outline-warning quick-action-btn" onclick="testRealTimeSync()">
                                        <i class="fas fa-bolt"></i> Test Real-Time Sync
                                    </button>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <strong>Sync Testing Notes:</strong>
                                    <ul class="mb-0">
                                        <li><strong>Dry Run:</strong> Tests sync logic without saving data</li>
                                        <li><strong>Comprehensive Financial:</strong> Tests your full financial sync process</li>
                                        <li><strong>Dual Financial:</strong> Tests instructions vs actual payments sync</li>
                                    </ul>
                                </div>
                                
                                <div id="syncTestResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Block Testing Tab -->
                            <div class="tab-pane fade" id="blocksTab">
                                <h5><i class="fas fa-building"></i> Portfolio-Block System Testing</h5>
                                <p class="text-muted">Test the new Portfolio-Block system with hierarchical PayProp integration</p>
                                
                                <!-- Block Management Section -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-cubes"></i> Block Management</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Portfolio ID</label>
                                                <input type="number" id="blockPortfolioId" class="form-control" placeholder="Portfolio ID for testing">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Block Name</label>
                                                <input type="text" id="blockName" class="form-control" placeholder="e.g., Building A">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Block Description</label>
                                                <input type="text" id="blockDescription" class="form-control" placeholder="Optional description">
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions mt-3">
                                            <button class="btn btn-success quick-action-btn" onclick="createBlock()">
                                                <i class="fas fa-plus"></i> Create Block
                                            </button>
                                            <button class="btn btn-primary quick-action-btn" onclick="listPortfolioBlocks()">
                                                <i class="fas fa-list"></i> List Blocks
                                            </button>
                                            <button class="btn btn-info quick-action-btn" onclick="getBlocksWithCounts()">
                                                <i class="fas fa-chart-bar"></i> Blocks with Counts
                                            </button>
                                            <button class="btn btn-secondary quick-action-btn" onclick="getPortfolioStatistics()">
                                                <i class="fas fa-analytics"></i> Portfolio Statistics
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Property Assignment Section -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-home"></i> Property Assignment</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Block ID</label>
                                                <input type="number" id="assignBlockId" class="form-control" placeholder="Block ID">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Property IDs (comma-separated)</label>
                                                <input type="text" id="assignPropertyIds" class="form-control" placeholder="e.g., 1,2,3,4">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Source Block ID (for moves)</label>
                                                <input type="number" id="sourceBlockId" class="form-control" placeholder="Source Block">
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions mt-3">
                                            <button class="btn btn-success quick-action-btn" onclick="assignPropertiesToBlock()">
                                                <i class="fas fa-arrow-right"></i> Assign Properties
                                            </button>
                                            <button class="btn btn-warning quick-action-btn" onclick="movePropertiesBetweenBlocks()">
                                                <i class="fas fa-exchange-alt"></i> Move Between Blocks
                                            </button>
                                            <button class="btn btn-danger quick-action-btn" onclick="removePropertiesFromBlock()">
                                                <i class="fas fa-minus"></i> Remove from Block
                                            </button>
                                            <button class="btn btn-info quick-action-btn" onclick="getBlocksView()">
                                                <i class="fas fa-sitemap"></i> Hierarchical View
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- PayProp Sync Section -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-sync"></i> PayProp Block Sync</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Block ID for Sync</label>
                                                <input type="number" id="syncBlockId" class="form-control" placeholder="Block ID">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Portfolio ID for Sync</label>
                                                <input type="number" id="syncPortfolioId" class="form-control" placeholder="Portfolio ID">
                                            </div>
                                            <div class="col-md-4 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" onclick="syncBlockToPayProp()">
                                                    <i class="fas fa-cloud-upload-alt"></i> Sync Block
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions mt-3">
                                            <button class="btn btn-primary quick-action-btn" onclick="syncAllBlocksInPortfolio()">
                                                <i class="fas fa-cloud-upload-alt"></i> Sync All in Portfolio
                                            </button>
                                            <button class="btn btn-warning quick-action-btn" onclick="syncBlocksNeedingSync()">
                                                <i class="fas fa-exclamation-circle"></i> Sync Blocks Needing Sync
                                            </button>
                                            <button class="btn btn-info quick-action-btn" onclick="syncPortfolioHierarchical()">
                                                <i class="fas fa-layer-group"></i> Hierarchical Sync
                                            </button>
                                            <button class="btn btn-success quick-action-btn" onclick="getBlockSyncStatus()">
                                                <i class="fas fa-check-circle"></i> Check Sync Status
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Migration Section -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-database"></i> Enhanced Migration & Health</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <button class="btn btn-info w-100 mb-2" onclick="getEnhancedMigrationSummary()">
                                                    <i class="fas fa-chart-line"></i> Enhanced Migration Summary
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <button class="btn btn-warning w-100 mb-2" onclick="fixBrokenPortfoliosAndBlocks()">
                                                    <i class="fas fa-wrench"></i> Fix Portfolios & Blocks
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions">
                                            <button class="btn btn-outline-warning quick-action-btn" onclick="fixBrokenBlocks()">
                                                <i class="fas fa-tools"></i> Fix Blocks Only
                                            </button>
                                            <button class="btn btn-outline-info quick-action-btn" onclick="getBlocksNeedingSync()">
                                                <i class="fas fa-search"></i> Find Blocks Needing Sync
                                            </button>
                                            <button class="btn btn-outline-success quick-action-btn" onclick="testBlockValidation()">
                                                <i class="fas fa-check"></i> Test Block Validation
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Test Data Section -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-vial"></i> Quick Test Data</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <strong>Sample Test Data:</strong> Use these values to quickly test block functionality
                                        </div>
                                        <div class="quick-actions">
                                            <button class="btn btn-outline-secondary quick-action-btn" onclick="loadTestData('small')">
                                                <i class="fas fa-flask"></i> Small Test (Portfolio 1)
                                            </button>
                                            <button class="btn btn-outline-secondary quick-action-btn" onclick="loadTestData('medium')">
                                                <i class="fas fa-vials"></i> Medium Test (Portfolio 2)
                                            </button>
                                            <button class="btn btn-outline-secondary quick-action-btn" onclick="loadTestData('large')">
                                                <i class="fas fa-industry"></i> Large Test (Portfolio 3)
                                            </button>
                                            <button class="btn btn-outline-danger quick-action-btn" onclick="clearBlockTestData()">
                                                <i class="fas fa-eraser"></i> Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="blockTestResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Endpoint Discovery Tab -->
                            <div class="tab-pane fade" id="endpointDiscoveryTab">
                                <h5><i class="fas fa-globe"></i> Comprehensive Endpoint Discovery</h5>
                                <p class="text-muted">Automatically discover and test all available PayProp API endpoints</p>
                                
                                <!-- Discovery Controls -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-search"></i> Endpoint Discovery</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Discovery Method</label>
                                                <select id="discoveryMethod" class="form-select">
                                                    <option value="api_spec">From API Specification</option>
                                                    <option value="live_probe">Live API Probing</option>
                                                    <option value="combined">Combined (Spec + Probe)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Test Depth</label>
                                                <select id="testDepth" class="form-select">
                                                    <option value="basic">Basic (GET only)</option>
                                                    <option value="standard">Standard (GET + POST)</option>
                                                    <option value="comprehensive">Comprehensive (All methods)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Response Detail</label>
                                                <select id="responseDetail" class="form-select">
                                                    <option value="summary">Summary Only</option>
                                                    <option value="headers">Include Headers</option>
                                                    <option value="full">Full Response Body</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions mt-3">
                                            <button class="btn btn-primary" onclick="discoverAllEndpoints()">
                                                <i class="fas fa-search"></i> Discover All Endpoints
                                            </button>
                                            <button class="btn btn-info" onclick="loadKnownEndpoints()">
                                                <i class="fas fa-list"></i> Load Known Endpoints
                                            </button>
                                            <button class="btn btn-success" onclick="testAllDiscovered()">
                                                <i class="fas fa-play"></i> Test All Discovered
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Endpoint Categories -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-tags"></i> Endpoint Categories</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catPayments" checked>
                                                    <label class="form-check-label" for="catPayments">Payments</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catInvoices" checked>
                                                    <label class="form-check-label" for="catInvoices">Invoices</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catProperties" checked>
                                                    <label class="form-check-label" for="catProperties">Properties</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catBeneficiaries" checked>
                                                    <label class="form-check-label" for="catBeneficiaries">Beneficiaries</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catReports" checked>
                                                    <label class="form-check-label" for="catReports">Reports</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="catMeta" checked>
                                                    <label class="form-check-label" for="catMeta">Meta/Admin</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Live Endpoint Tree -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-sitemap"></i> Discovered Endpoints</h6>
                                        <div class="float-end">
                                            <span class="badge bg-primary" id="endpointCount">0</span> endpoints found
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="endpointTree" class="endpoint-tree">
                                            <div class="text-muted text-center py-4">
                                                <i class="fas fa-search fa-2x mb-2"></i><br>
                                                Click "Discover All Endpoints" to begin
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="endpointDiscoveryResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Bulk Testing Tab -->
                            <div class="tab-pane fade" id="bulkTestTab">
                                <h5><i class="fas fa-rocket"></i> Bulk Endpoint Testing</h5>
                                <p class="text-muted">Run comprehensive tests across multiple endpoints with various parameters</p>
                                
                                <!-- Test Configuration -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-cog"></i> Test Configuration</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label class="form-label">Test Suite</label>
                                                <select id="bulkTestSuite" class="form-select">
                                                    <option value="payment_full">Payment Endpoints (Full)</option>
                                                    <option value="payment_core">Payment Endpoints (Core)</option>
                                                    <option value="invoice_full">Invoice Endpoints (Full)</option>
                                                    <option value="transaction_full">Transaction Endpoints (Full)</option>
                                                    <option value="all_readonly">All Read-Only Endpoints</option>
                                                    <option value="all_safe">All Safe Endpoints</option>
                                                    <option value="custom">Custom Selection</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Parameter Strategy</label>
                                                <select id="parameterStrategy" class="form-select">
                                                    <option value="minimal">Minimal Parameters</option>
                                                    <option value="common">Common Parameters</option>
                                                    <option value="comprehensive">Comprehensive Parameters</option>
                                                    <option value="edge_cases">Edge Cases</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Concurrency</label>
                                                <select id="bulkConcurrency" class="form-select">
                                                    <option value="1">Sequential (1 at a time)</option>
                                                    <option value="3">Low (3 concurrent)</option>
                                                    <option value="5" selected>Medium (5 concurrent)</option>
                                                    <option value="10">High (10 concurrent)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Timeout (seconds)</label>
                                                <input type="number" id="bulkTimeout" class="form-control" value="30" min="5" max="300">
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="includeErrorTest" checked>
                                                    <label class="form-check-label" for="includeErrorTest">
                                                        Include Error Condition Testing
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="validateResponseSchema" checked>
                                                    <label class="form-check-label" for="validateResponseSchema">
                                                        Validate Response Schema
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions mt-3">
                                            <button class="btn btn-success" onclick="startBulkTest()">
                                                <i class="fas fa-rocket"></i> Start Bulk Test
                                            </button>
                                            <button class="btn btn-info" onclick="previewBulkTest()">
                                                <i class="fas fa-eye"></i> Preview Test Plan
                                            </button>
                                            <button class="btn btn-warning" onclick="pauseBulkTest()" id="pauseBulkBtn" disabled>
                                                <i class="fas fa-pause"></i> Pause
                                            </button>
                                            <button class="btn btn-danger" onclick="stopBulkTest()" id="stopBulkBtn" disabled>
                                                <i class="fas fa-stop"></i> Stop
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Test Progress -->
                                <div class="card mb-4" id="bulkTestProgress" style="display: none;">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-line"></i> Test Progress</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-primary" id="testsCompleted">0</h4>
                                                    <small>Completed</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-success" id="testsSucceeded">0</h4>
                                                    <small>Succeeded</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-danger" id="testsFailed">0</h4>
                                                    <small>Failed</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center">
                                                    <h4 class="text-info" id="testsRemaining">0</h4>
                                                    <small>Remaining</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="progress mt-3">
                                            <div class="progress-bar" id="bulkTestProgressBar" style="width: 0%"></div>
                                        </div>
                                        <div class="mt-2 text-center" id="currentTestInfo">
                                            <small class="text-muted">Ready to start...</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Results Summary -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-bar"></i> Results Summary</h6>
                                        <div class="float-end">
                                            <button class="btn btn-sm btn-outline-primary" onclick="exportBulkResults()">
                                                <i class="fas fa-download"></i> Export
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="bulkTestSummary" class="d-none">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <canvas id="endpointStatusChart" width="300" height="200"></canvas>
                                                </div>
                                                <div class="col-md-6">
                                                    <canvas id="responseTimeChart" width="300" height="200"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="bulkTestResults" class="mt-3">
                                            <div class="text-muted text-center py-4">
                                                <i class="fas fa-rocket fa-2x mb-2"></i><br>
                                                Start a bulk test to see results
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="bulkTestResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Invoice Investigation Tab -->
                            <div class="tab-pane fade" id="invoiceInvestigationTab">
                                <div class="alert alert-warning">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Critical Data Gap Identified</h5>
                                    <p><strong>Your system is missing invoice instruction data from <code>/export/invoices</code></strong></p>
                                    <p>You're currently only getting completed invoices from ICDN, not the underlying recurring instructions.</p>
                                </div>
                                
                                <h5><i class="fas fa-file-invoice-dollar"></i> Invoice Data Investigation</h5>
                                <p class="text-muted">Test and compare invoice instruction data vs current ICDN transaction data</p>
                                
                                <!-- Invoice Instructions Test -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-search"></i> Invoice Instructions Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Test Invoice Instructions Endpoint</h6>
                                                <p class="small text-muted">This should show recurring rent, parking charges, etc.</p>
                                                <button class="btn btn-primary" onclick="testInvoiceInstructions()">
                                                    <i class="fas fa-play"></i> Test /export/invoices
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Compare with Current ICDN Data</h6>
                                                <p class="small text-muted">Compare instruction vs completed invoice data</p>
                                                <button class="btn btn-info" onclick="compareInvoiceData()">
                                                    <i class="fas fa-balance-scale"></i> Compare Data Sources
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <h6>Invoice Categories</h6>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-outline-secondary btn-sm" onclick="testInvoiceCategories()">
                                                        <i class="fas fa-tags"></i> Test /invoices/categories
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" onclick="testInvoiceInstructionsExport()">
                                                        <i class="fas fa-download"></i> Test /export/invoice-instructions
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Data Gap Analysis -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-line"></i> Data Gap Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="text-center p-3 border rounded">
                                                    <h5 class="text-primary">Current System</h5>
                                                    <p class="small">ICDN "invoice" transactions</p>
                                                    <p class="text-muted">✅ What WAS invoiced<br>❌ What SHOULD BE invoiced</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center p-3 border rounded">
                                                    <h5 class="text-warning">Missing Data</h5>
                                                    <p class="small">Invoice instructions</p>
                                                    <p class="text-muted">❌ Monthly rent rules<br>❌ Parking charges<br>❌ Service charges</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center p-3 border rounded">
                                                    <h5 class="text-success">With Fix</h5>
                                                    <p class="small">Complete invoice lifecycle</p>
                                                    <p class="text-muted">✅ Instruction → Invoice → Payment<br>✅ Gap detection</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button class="btn btn-warning" onclick="generateInvoiceGapReport()">
                                                <i class="fas fa-exclamation-triangle"></i> Generate Gap Analysis Report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Commission Accuracy Check -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6><i class="fas fa-calculator"></i> Commission Calculation Audit</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info">
                                            <strong>Concern:</strong> Are commissions calculated on instruction amounts or completed invoice amounts?
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <button class="btn btn-outline-primary" onclick="auditCommissionCalculation()">
                                                    <i class="fas fa-audit"></i> Audit Commission Logic
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <button class="btn btn-outline-warning" onclick="findCommissionVariances()">
                                                    <i class="fas fa-search-dollar"></i> Find Variances
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="invoiceInvestigationResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Comprehensive Tests Tab -->
                            <div class="tab-pane fade" id="comprehensiveTab">
                                <h5><i class="fas fa-clipboard-list"></i> Comprehensive PayProp API Tests</h5>
                                <p class="text-muted">Execute all critical PayProp API tests to identify missing capabilities</p>
                                
                                <!-- Test Categories -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-file-invoice"></i> Invoice & Instruction Tests</h6>
                                            </div>
                                            <div class="card-body">
                                                <button class="btn btn-outline-warning btn-sm mb-2" onclick="testInvoiceInstructions()">
                                                    <i class="fas fa-file-contract"></i> Test Invoice Instructions
                                                </button><br>
                                                <button class="btn btn-outline-warning btn-sm mb-2" onclick="testInvoiceCategories()">
                                                    <i class="fas fa-tags"></i> Test Invoice Categories  
                                                </button><br>
                                                <button class="btn btn-outline-info btn-sm mb-2" onclick="testRecurringInvoices()">
                                                    <i class="fas fa-repeat"></i> Test Recurring Invoices
                                                </button><br>
                                                <button class="btn btn-outline-success btn-sm" onclick="testInvoiceToPaymentLinking()">
                                                    <i class="fas fa-link"></i> Test Invoice-Payment Links
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-credit-card"></i> Advanced Payment Tests</h6>
                                            </div>
                                            <div class="card-body">
                                                <button class="btn btn-outline-primary btn-sm mb-2" onclick="testAdhocPayments()">
                                                    <i class="fas fa-hand-holding-usd"></i> Test Adhoc Payments
                                                </button><br>
                                                <button class="btn btn-outline-primary btn-sm mb-2" onclick="testSecondaryPayments()">
                                                    <i class="fas fa-exchange-alt"></i> Test Secondary Payments
                                                </button><br>
                                                <button class="btn btn-outline-danger btn-sm mb-2" onclick="testPostedPayments()">
                                                    <i class="fas fa-mail-bulk"></i> Test Posted Payments (UK)
                                                </button><br>
                                                <button class="btn btn-outline-info btn-sm" onclick="testBulkPaymentInstructions()">
                                                    <i class="fas fa-layer-group"></i> Test Bulk Instructions
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-chart-bar"></i> Reporting & Analytics Tests</h6>
                                            </div>
                                            <div class="card-body">
                                                <button class="btn btn-outline-success btn-sm mb-2" onclick="testCommissionSummaryReport()">
                                                    <i class="fas fa-percentage"></i> Commission Summary
                                                </button><br>
                                                <button class="btn btn-outline-warning btn-sm mb-2" onclick="testPaymentVarianceReport()">
                                                    <i class="fas fa-exclamation-triangle"></i> Payment Variance
                                                </button><br>
                                                <button class="btn btn-outline-info btn-sm mb-2" onclick="testTenantArrearsReport()">
                                                    <i class="fas fa-clock"></i> Tenant Arrears
                                                </button><br>
                                                <button class="btn btn-outline-primary btn-sm" onclick="testCashFlowReport()">
                                                    <i class="fas fa-chart-line"></i> Cash Flow Forecast
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-broadcast-tower"></i> Real-time & Webhook Tests</h6>
                                            </div>
                                            <div class="card-body">
                                                <button class="btn btn-outline-info btn-sm mb-2" onclick="testWebhookConfiguration()">
                                                    <i class="fas fa-cog"></i> Webhook Configuration
                                                </button><br>
                                                <button class="btn btn-outline-success btn-sm mb-2" onclick="testRealTimeReporting()">
                                                    <i class="fas fa-satellite-dish"></i> Real-time Reports
                                                </button><br>
                                                <button class="btn btn-outline-warning btn-sm mb-2" onclick="testNotificationEndpoints()">
                                                    <i class="fas fa-bell"></i> Notification Endpoints
                                                </button><br>
                                                <button class="btn btn-outline-primary btn-sm" onclick="testWebhookPayload()">
                                                    <i class="fas fa-paper-plane"></i> Test Webhook Payload
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Run All Tests -->
                                <div class="text-center mb-3">
                                    <button class="btn btn-primary btn-lg" onclick="runAllComprehensiveTests()">
                                        <i class="fas fa-play-circle"></i> Run All Comprehensive Tests
                                    </button>
                                    <button class="btn btn-secondary btn-lg ms-2" onclick="exportTestResults()">
                                        <i class="fas fa-download"></i> Export Results
                                    </button>
                                </div>
                                
                                <div id="comprehensiveTestResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Test Data Tab -->
                            <div class="tab-pane fade" id="testDataTab">
                                <h5><i class="fas fa-database"></i> Test Data & Property References</h5>
                                <p class="text-muted">Use real property data from your system for comprehensive testing</p>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-building"></i> Sample Properties with PayProp IDs</h6>
                                            </div>
                                            <div class="card-body">
                                                <small class="text-muted">Properties from your database with PayProp integration:</small>
                                                <div class="mt-2">
                                                    <div class="test-property mb-2">
                                                        <strong>PYZ2VG9VZQ</strong> - 10 Ditton Court Road, Westcliff (£1,200/month)
                                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="testWithProperty('PYZ2VG9VZQ')">Test</button>
                                                    </div>
                                                    <div class="test-property mb-2">
                                                        <strong>K3Jwqg8W1E</strong> - 71b Shrubbery Road, Croydon (£995/month)
                                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="testWithProperty('K3Jwqg8W1E')">Test</button>
                                                    </div>
                                                    <div class="test-property mb-2">
                                                        <strong>WzJBxGM1QB</strong> - 88a Satchwell Road, Canterbury (£960/month)
                                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="testWithProperty('WzJBxGM1QB')">Test</button>
                                                    </div>
                                                    <div class="test-property mb-2">
                                                        <strong>mLZdRPLPXn</strong> - Tregothnan, Adams Mews, Wandsworth (£925/month)
                                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="testWithProperty('mLZdRPLPXn')">Test</button>
                                                    </div>
                                                    <div class="test-property mb-2">
                                                        <strong>z2JkP6BpXb</strong> - 79 Alie Street, Barking (£1,875/month)
                                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="testWithProperty('z2JkP6BpXb')">Test</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6><i class="fas fa-users"></i> Multi-Property Owners for Testing</h6>
                                            </div>
                                            <div class="card-body">
                                                <small class="text-muted">Test bulk operations with these property groups:</small>
                                                <div class="mt-2">
                                                    <div class="test-owner mb-3">
                                                        <strong>Owner Portfolio A:</strong><br>
                                                        <code>PYZ2VG9VZQ,K3Jwqg8W1E,WzJBxGM1QB</code><br>
                                                        <button class="btn btn-sm btn-outline-success ms-2" onclick="testWithPropertyGroup('PYZ2VG9VZQ,K3Jwqg8W1E,WzJBxGM1QB')">Test Group</button>
                                                    </div>
                                                    <div class="test-owner mb-3">
                                                        <strong>Owner Portfolio B:</strong><br>
                                                        <code>mLZdRPLPXn,z2JkP6BpXb,aLJMv0ljXq</code><br>
                                                        <button class="btn btn-sm btn-outline-success ms-2" onclick="testWithPropertyGroup('mLZdRPLPXn,z2JkP6BpXb,aLJMv0ljXq')">Test Group</button>
                                                    </div>
                                                    <div class="test-owner mb-3">
                                                        <strong>High-Value Properties:</strong><br>
                                                        <code>z2JkP6BpXb,DyZqowklXV,08JLmY3eXR</code> (£1,600+ rent)<br>
                                                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="testWithPropertyGroup('z2JkP6BpXb,DyZqowklXV,08JLmY3eXR')">Test High-Value</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- SQL Queries for Testing -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-database"></i> SQL Queries for Additional Test Data</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted">Run these queries to get more test data from your database:</p>
                                        
                                        <div class="mb-3">
                                            <strong>Properties with PayProp IDs and Commission Rates:</strong>
                                            <pre class="bg-light p-2 mt-2"><code>SELECT p.pay_prop_id, p.property_name, p.monthly_payment, p.commission_percentage, c.customer_id, c.first_name, c.last_name
FROM properties p 
JOIN customers c ON p.property_owner_id = c.customer_id
WHERE p.pay_prop_id IS NOT NULL 
AND p.commission_percentage > 0
ORDER BY p.monthly_payment DESC
LIMIT 10;</code></pre>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>Multi-Property Owners:</strong>
                                            <pre class="bg-light p-2 mt-2"><code>SELECT c.customer_id, c.first_name, c.last_name, 
       COUNT(p.id) as property_count,
       GROUP_CONCAT(p.pay_prop_id) as payprop_ids
FROM customers c 
JOIN properties p ON c.customer_id = p.property_owner_id
WHERE p.pay_prop_id IS NOT NULL
GROUP BY c.customer_id 
HAVING property_count >= 2
ORDER BY property_count DESC;</code></pre>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>Properties with Recent Financial Activity:</strong>
                                            <pre class="bg-light p-2 mt-2"><code>SELECT p.pay_prop_id, p.property_name, 
       COUNT(ft.id) as transaction_count,
       SUM(ft.amount) as total_amount
FROM properties p 
LEFT JOIN financial_transactions ft ON p.pay_prop_id = ft.property_id
WHERE p.pay_prop_id IS NOT NULL
GROUP BY p.pay_prop_id
HAVING transaction_count > 0
ORDER BY transaction_count DESC;</code></pre>
                                        </div>
                                        
                                        <button class="btn btn-info" onclick="loadDynamicTestData()">
                                            <i class="fas fa-sync"></i> Load Fresh Test Data from Database
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="testDataResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Endpoint Testing Tab -->
                            <div class="tab-pane fade" id="endpointTestTab">
                                <h5><i class="fas fa-network-wired"></i> PayProp API Endpoint Testing</h5>
                                <p class="text-muted">Test all 37+ PayProp endpoints to identify available capabilities and permissions</p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Quick Tests</h6>
                                        <button class="btn btn-danger mb-2" onclick="testCriticalMissingEndpoints()">
                                            <i class="fas fa-exclamation-triangle"></i> Test Critical Missing Endpoints
                                        </button>
                                        <button class="btn btn-warning mb-2" onclick="testAllEndpoints()">
                                            <i class="fas fa-globe"></i> Test ALL 37+ Endpoints
                                        </button>
                                        <button class="btn btn-info mb-2" onclick="listAllEndpoints()">
                                            <i class="fas fa-list"></i> List All Available Endpoints
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Individual Endpoint Testing</h6>
                                        <div class="mb-2">
                                            <select id="endpointSelect" class="form-select">
                                                <option value="">Select an endpoint to test...</option>
                                                <option value="export-invoices">🚨 /export/invoices (CRITICAL MISSING)</option>
                                                <option value="export-payments">🚨 /export/payments (Payment Distribution)</option>
                                                <option value="export-properties">✅ /export/properties (Currently Used)</option>
                                                <option value="export-properties-archived">🗃️ /export/properties (ARCHIVED)</option>
                                                <option value="export-beneficiaries">📊 /export/beneficiaries</option>
                                                <option value="export-tenants">📊 /export/tenants</option>
                                                <option value="report-all-payments">✅ /report/all-payments (Currently Used)</option>
                                                <option value="report-icdn">✅ /report/icdn (Currently Used)</option>
                                                <option value="invoices-categories">🔍 /invoices/categories</option>
                                                <option value="payments-categories">🔍 /payments/categories</option>
                                                <option value="report-commission-summary">💰 /reports/commission-summary</option>
                                                <option value="report-payment-variance">⚠️ /reports/payment-variance</option>
                                                <option value="report-tenant-arrears">📈 /reports/tenant-arrears</option>
                                                <option value="payments-adhoc">💳 /payments/adhoc</option>
                                                <option value="payments-secondary">🔄 /payments/secondary</option>
                                                <option value="webhooks-configuration">📡 /webhooks/configuration</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-outline-primary" onclick="testSingleEndpoint()">
                                            <i class="fas fa-play"></i> Test Selected Endpoint
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="endpointTestResults" class="result-display mt-3" style="display: none;"></div>
                                
                                <!-- Raw Import System Testing -->
                                <div class="mt-4">
                                    <h6><i class="fas fa-database"></i> Raw Import System (Enhanced)</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button class="btn btn-success mb-2" onclick="testRawImportSystem()">
                                                <i class="fas fa-download"></i> Test Enhanced Raw Import
                                            </button>
                                            <button class="btn btn-primary mb-2 ms-2" onclick="checkImportStatus()">
                                                <i class="fas fa-info-circle"></i> Check Status
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-warning mb-2" onclick="cancelImport()" id="cancelBtn" disabled>
                                                <i class="fas fa-stop-circle"></i> Cancel Import
                                            </button>
                                            <button class="btn btn-secondary mb-2 ms-2" onclick="resetImport()">
                                                <i class="fas fa-refresh"></i> Reset
                                            </button>
                                            <button class="btn btn-warning mb-2" onclick="fixAllPaymentsPagination()">
                                                <i class="fas fa-wrench"></i> Fix All-Payments (Get ALL not 60)
                                            </button>
                                            <button class="btn btn-outline-info mb-2" onclick="testLimitedAllPayments()">
                                                <i class="fas fa-vial"></i> Test All-Payments (Limited + Output)
                                            </button>
                                            <button class="btn btn-success mb-2" onclick="testCompleteBeneficiariesImport()">
                                                <i class="fas fa-users"></i> Test Complete Beneficiaries Import
                                            </button>
                                            <button class="btn btn-primary mb-2" onclick="testCompleteTenantsImport()">
                                                <i class="fas fa-user-friends"></i> Test Complete Tenants Import
                                            </button>
                                            <button class="btn btn-warning mb-2" onclick="testCompletePropertiesImport()">
                                                <i class="fas fa-home"></i> Test Complete Properties Import
                                            </button>
                                            <button class="btn btn-danger mb-2" onclick="testCompleteInvoicesImport()">
                                                <i class="fas fa-receipt"></i> Test Complete Invoices Import (£1,075 DATA)
                                            </button>
                                            <button class="btn btn-success mb-2" onclick="testCompletePaymentsImport()">
                                                <i class="fas fa-credit-card"></i> Test Complete Payments Import
                                            </button>
                                            <button class="btn btn-info mb-2" onclick="testCompleteAllPaymentsImport()">
                                                <i class="fas fa-money-bill-wave"></i> Test Complete All-Payments Import (7,414 Transactions)
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-info mb-2" onclick="getSampleDataFromEndpoint()">
                                                <i class="fas fa-eye"></i> Get Sample Data
                                            </button>
                                            <button class="btn btn-outline-primary mb-2" onclick="testCurrentFinancialSync()">
                                                <i class="fas fa-sync"></i> Test Current Financial Sync
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <select id="sampleEndpointSelect" class="form-select">
                                            <option value="">Select endpoint for sample data...</option>
                                            <option value="export-invoices">🚨 export-invoices (Critical Missing)</option>
                                            <option value="export-payments">🚨 export-payments (Payment Distribution)</option>
                                            <option value="report-all-payments">🔧 report-all-payments (Fixed Pagination)</option>
                                            <option value="export-properties">✅ export-properties</option>
                                            <option value="export-properties-archived">🗃️ export-properties (ARCHIVED)</option>
                                            <option value="export-beneficiaries">📊 export-beneficiaries</option>
                                            <option value="export-tenants">📊 export-tenants</option>
                                            <option value="invoices-categories">🏷️ invoices-categories</option>
                                            <option value="payments-categories">🏷️ payments-categories</option>
                                            <option value="report-icdn">📈 report-icdn</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Endpoint Testing Results Summary -->
                                <div class="mt-4" id="endpointSummarySection" style="display: none;">
                                    <h6><i class="fas fa-chart-bar"></i> Testing Summary</h6>
                                    <div class="row" id="endpointSummaryCards">
                                        <!-- Summary cards will be populated by JavaScript -->
                                    </div>
                                    <div id="endpointDetailedResults" class="mt-3"></div>
                                </div>
                            </div>
                            
                            <!-- Raw API Tab -->
                            <div class="tab-pane fade" id="rawTab">
                                <h5><i class="fas fa-code"></i> Raw API Testing</h5>
                                <p class="text-muted">Make direct API calls to PayProp with custom parameters</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Endpoint</label>
                                            <input type="text" id="rawEndpoint" class="form-control" 
                                                   placeholder="/export/payments" value="/export/payments">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Method</label>
                                            <select id="rawMethod" class="form-select">
                                                <option value="GET">GET</option>
                                                <option value="POST">POST</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Parameters</label>
                                            <input type="text" id="rawParameters" class="form-control" 
                                                   placeholder="from_date=2025-05-01&to_date=2025-06-01&rows=10">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button class="btn btn-primary" onclick="makeRawApiCall()">
                                                <i class="fas fa-paper-plane"></i> Make API Call
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('payments')">
                                        Export Payments Example
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('reports')">
                                        All-Payments Report Example
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('icdn')">
                                        ICDN Example
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('meta')">
                                        Meta/Me (Check Scopes)
                                    </button>
                                </div>
                                
                                <div id="rawApiResult" class="result-display d-none"></div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Analysis -->
        <div class="row">
            <div class="col-12">
                <div class="test-card">
                    <div class="test-card-header">
                        <h5><i class="fas fa-chart-line"></i> Investigation Results</h5>
                        <small class="text-muted">Last updated: <span id="lastUpdated">Never</span></small>
                    </div>
                    <div class="test-card-body">
                        <div id="investigationSummary" class="d-none">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">PayProp API Results</h6>
                                            <h3 class="text-primary" id="apiResultCount">-</h3>
                                            <small class="text-muted">Records Found</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Database Results</h6>
                                            <h3 class="text-info" id="dbResultCount">-</h3>
                                            <small class="text-muted">Records Found</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success" id="syncHealthCard">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Sync Health</h6>
                                            <h3 id="syncHealthStatus">-</h3>
                                            <small class="text-muted" id="syncHealthDetails">-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let csrfToken = null;
        let csrfHeader = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
            
            // Set default dates
            setDateRange('30days');
            setDateRangeForCompare('30days');
            setDateRangeForBatch('30days');
        });
        
        // Utility Functions
        async function fetchWithCSRF(url, options = {}) {
            if (!options.headers) options.headers = {};
            if (csrfToken && csrfHeader) options.headers[csrfHeader] = csrfToken;
            options.credentials = 'include';
            
            showLoading(true);
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function showResult(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            element.classList.remove('d-none', 'result-success', 'result-error', 'result-warning');
            
            let statusClass = 'result-success';
            if (data && data.status === 'ERROR') statusClass = 'result-error';
            else if (data && data.status === 'WARNING') statusClass = 'result-warning';
            
            element.classList.add(statusClass);
            
            let html = title ? `<h6>${title}</h6>` : '';
            html += `<div class="json-viewer">${JSON.stringify(data, null, 2)}</div>`;
            
            element.innerHTML = html;
            
            // Update investigation summary if relevant
            updateInvestigationSummary(data);
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }
        
        function updateInvestigationSummary(data) {
            const summaryElement = document.getElementById('investigationSummary');
            
            if (data && (data.payprop_api_results || data.database_results || data.comparison_analysis)) {
                summaryElement.classList.remove('d-none');
                
                // Update API results count
                let apiCount = 0;
                if (data.payprop_api_results) {
                    Object.values(data.payprop_api_results).forEach(result => {
                        if (result.matches_found) apiCount += result.matches_found;
                    });
                }
                document.getElementById('apiResultCount').textContent = apiCount;
                
                // Update database results count
                let dbCount = 0;
                if (data.database_results && data.database_results.total_matches) {
                    dbCount = data.database_results.total_matches;
                }
                document.getElementById('dbResultCount').textContent = dbCount;
                
                // Update sync health
                const healthCard = document.getElementById('syncHealthCard');
                const healthStatus = document.getElementById('syncHealthStatus');
                const healthDetails = document.getElementById('syncHealthDetails');
                
                if (data.comparison_analysis && data.comparison_analysis.summary) {
                    const summary = data.comparison_analysis.summary;
                    const syncHealth = summary.sync_health;
                    
                    healthCard.className = 'card border-' + (syncHealth === 'PERFECT' ? 'success' : 'warning');
                    healthStatus.textContent = syncHealth === 'PERFECT' ? '✅ PERFECT' : '⚠️ ISSUES';
                    healthStatus.className = syncHealth === 'PERFECT' ? 'text-success' : 'text-warning';
                    healthDetails.textContent = `Difference: ${summary.difference} records`;
                }
            }
        }
        
        // Date Range Helpers
        function setDateRange(range) {
            const today = new Date();
            const toDate = today.toISOString().split('T')[0];
            let fromDate;
            
            switch(range) {
                case '7days':
                    fromDate = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '30days':
                    fromDate = new Date(today.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '3months':
                    fromDate = new Date(today.getTime() - 90*24*60*60*1000).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('searchFromDate').value = fromDate;
            document.getElementById('searchToDate').value = toDate;
        }
        
        function setDateRangeForCompare(range) {
            const today = new Date();
            const toDate = today.toISOString().split('T')[0];
            let fromDate;
            
            switch(range) {
                case '7days':
                    fromDate = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '30days':
                    fromDate = new Date(today.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '3months':
                    fromDate = new Date(today.getTime() - 90*24*60*60*1000).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('compareFromDate').value = fromDate;
            document.getElementById('compareToDate').value = toDate;
        }
        
        function setDateRangeForBatch(range) {
            const today = new Date();
            const toDate = today.toISOString().split('T')[0];
            let fromDate;
            
            switch(range) {
                case '7days':
                    fromDate = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '30days':
                    fromDate = new Date(today.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '3months':
                    fromDate = new Date(today.getTime() - 90*24*60*60*1000).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('batchAnalyzeFromDate').value = fromDate;
            document.getElementById('batchAnalyzeToDate').value = toDate;
        }
        
        function setChristopherBoothExample() {
            document.getElementById('searchAmount').value = '542.75';
            document.getElementById('searchFromDate').value = '2025-05-25';
            document.getElementById('searchToDate').value = '2025-06-05';
            document.getElementById('searchBeneficiaryName').value = 'Christopher Booth';
            document.getElementById('searchPropertyId').value = ''; // Let it search all properties
        }
        
        function clearSearchForm() {
            document.getElementById('searchAmount').value = '';
            document.getElementById('searchBeneficiaryName').value = '';
            document.getElementById('searchBatchId').value = '';
            document.getElementById('searchTransactionId').value = '';
            document.getElementById('searchPropertyId').value = '';
            document.getElementById('searchEndpoint').value = '';
            setDateRange('30days');
        }
        
        function setAnalyzeExample(transactionId) {
            document.getElementById('analyzeTransactionId').value = transactionId;
        }
        
        function setRawExample(type) {
            const endpoint = document.getElementById('rawEndpoint');
            const parameters = document.getElementById('rawParameters');
            
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            switch(type) {
                case 'payments':
                    endpoint.value = '/export/payments';
                    parameters.value = 'include_beneficiary_info=true&rows=10';
                    break;
                case 'reports':
                    endpoint.value = '/report/all-payments';
                    parameters.value = `from_date=${monthAgo}&to_date=${today}&filter_by=reconciliation_date&rows=10`;
                    break;
                case 'icdn':
                    endpoint.value = '/report/icdn';
                    parameters.value = `from_date=${monthAgo}&to_date=${today}&rows=10`;
                    break;
                case 'meta':
                    endpoint.value = '/meta/me';
                    parameters.value = '';
                    break;
            }
        }
        
        // Main Test Functions
        async function smartSearch() {
            const searchCriteria = {
                amount: document.getElementById('searchAmount').value,
                fromDate: document.getElementById('searchFromDate').value,
                toDate: document.getElementById('searchToDate').value,
                propertyId: document.getElementById('searchPropertyId').value,
                beneficiaryName: document.getElementById('searchBeneficiaryName').value,
                batchId: document.getElementById('searchBatchId').value,
                transactionId: document.getElementById('searchTransactionId').value,
                endpoint: document.getElementById('searchEndpoint').value,
                includeBeneficiaryInfo: true
            };
            
            const result = await fetchWithCSRF('/api/payprop/oauth/smart-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchCriteria)
            });
            
            showResult('smartSearchResult', result.data, '🔍 Smart Search Results');
        }
        
        async function compareEndpoints() {
            const params = new URLSearchParams({
                fromDate: document.getElementById('compareFromDate').value,
                toDate: document.getElementById('compareToDate').value,
                propertyId: document.getElementById('comparePropertyId').value,
                filterBy: document.getElementById('compareFilterBy').value,
                maxRows: document.getElementById('compareMaxRows').value
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/compare-endpoints?${params}`, {
                method: 'POST'
            });
            
            showResult('compareEndpointsResult', result.data, '📊 Endpoint Comparison Results');
        }
        
        async function analyzeTransaction() {
            const transactionId = document.getElementById('analyzeTransactionId').value;
            if (!transactionId) {
                alert('Please enter a PayProp Transaction ID');
                return;
            }
            
            const params = new URLSearchParams({
                transactionId: transactionId,
                endpoint: document.getElementById('analyzeEndpoint').value
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/analyze-transaction?${params}`, {
                method: 'POST'
            });
            
            showResult('analyzeTransactionResult', result.data, '🔬 Transaction Analysis Results');
        }
        
        async function analyzeBatch() {
            const params = new URLSearchParams({
                batchId: document.getElementById('batchAnalyzeBatchId').value,
                fromDate: document.getElementById('batchAnalyzeFromDate').value,
                toDate: document.getElementById('batchAnalyzeToDate').value,
                propertyId: document.getElementById('batchAnalyzePropertyId').value
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/analyze-batch?${params}`, {
                method: 'POST'
            });
            
            showResult('batchAnalysisResult', result.data, '📦 Batch Analysis Results');
        }
        
        async function triggerSync() {
            const syncType = document.getElementById('syncType').value;
            const dryRun = document.getElementById('syncDryRun').checked;
            
            const params = new URLSearchParams({
                syncType: syncType,
                dryRun: dryRun
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/trigger-sync?${params}`, {
                method: 'POST'
            });
            
            showResult('syncTestResult', result.data, '🚀 Sync Test Results');
        }
        
        async function makeRawApiCall() {
            const endpoint = document.getElementById('rawEndpoint').value;
            const method = document.getElementById('rawMethod').value;
            const parameters = document.getElementById('rawParameters').value;
            
            if (!endpoint) {
                alert('Please enter an endpoint');
                return;
            }
            
            const params = new URLSearchParams({
                endpoint: endpoint,
                method: method,
                parameters: parameters
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/raw-api-call?${params}`, {
                method: 'POST'
            });
            
            showResult('rawApiResult', result.data, `🔧 Raw API Call: ${method} ${endpoint}`);
        }
        
        // Status Check Functions
        async function checkOAuthStatus() {
            const result = await fetchWithCSRF('/api/payprop/oauth/token-status');
            showResult('statusOverviewResult', result.data, '🔐 OAuth Status');
        }
        
        async function getSyncDashboard() {
            const result = await fetchWithCSRF('/api/payprop/oauth/sync-dashboard');
            showResult('statusOverviewResult', result.data, '📊 Sync Dashboard');
        }
        
        async function discoverEndpoints() {
            const result = await fetchWithCSRF('/api/payprop/oauth/discover-endpoints', { method: 'POST' });
            showResult('statusOverviewResult', result.data, '🔍 Endpoint Discovery');
        }
        
        async function testAllConnections() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-connection', { method: 'POST' });
            showResult('statusOverviewResult', result.data, '🔌 Connection Test');
        }
        
        // Additional Helper Functions
        async function findMissingBatches() {
            // Set specific criteria to find the missing Christopher Booth batch
            document.getElementById('batchAnalyzeFromDate').value = '2025-05-25';
            document.getElementById('batchAnalyzeToDate').value = '2025-06-05';
            document.getElementById('batchAnalyzeBatchId').value = '';
            document.getElementById('batchAnalyzePropertyId').value = '';
            
            await analyzeBatch();
        }
        
        async function checkSyncHealth() {
            if (confirm('This will check the health of your sync services. Continue?')) {
                const result = await fetchWithCSRF('/api/payprop/oauth/sync-dashboard');
                showResult('syncTestResult', result.data, '💊 Sync Health Check');
            }
        }
        
        async function viewRecentSyncs() {
            // This would show recent sync logs - you could add this endpoint if needed
            showResult('syncTestResult', {
                message: 'Recent sync logs would be displayed here',
                note: 'Add /recent-syncs endpoint to view sync history'
            }, '📜 Recent Syncs');
        }
        
        async function testRealTimeSync() {
            const result = await fetchWithCSRF('/api/payprop/oauth/sync-dashboard');
            
            if (result.data && result.data.sync_monitoring) {
                showResult('syncTestResult', result.data.sync_monitoring, '⚡ Real-Time Sync Status');
            } else {
                showResult('syncTestResult', {
                    message: 'Real-time sync monitoring not available',
                    note: 'Check if PayPropSyncMonitoringService is enabled'
                }, '⚡ Real-Time Sync Test');
            }
        }
        
        // Advanced Search Functions
        async function investigateSpecificCase() {
            // Pre-fill the Christopher Booth case
            setChristopherBoothExample();
            await smartSearch();
        }
        
        async function findDateDiscrepancies() {
            // Search for records that might have date mapping issues
            const searchCriteria = {
                fromDate: '2025-05-01',
                toDate: '2025-06-30',
                endpoint: '', // Search all
                includeBeneficiaryInfo: true
            };
            
            const result = await fetchWithCSRF('/api/payprop/oauth/smart-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchCriteria)
            });
            
            showResult('smartSearchResult', result.data, '📅 Date Discrepancy Investigation');
        }
        
        // Debugging helpers
        function exportResults(elementId) {
            const element = document.getElementById(elementId);
            if (element && !element.classList.contains('d-none')) {
                const content = element.querySelector('.json-viewer').textContent;
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payprop-test-results-${new Date().toISOString().slice(0,19)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (document.querySelector('#searchTab').classList.contains('active')) {
                            smartSearch();
                        }
                        break;
                    case 'k':
                        e.preventDefault();
                        document.getElementById('searchAmount').focus();
                        break;
                }
            }
        });
        
        // Auto-save form state
        function saveFormState() {
            const formData = {
                searchAmount: document.getElementById('searchAmount').value,
                searchFromDate: document.getElementById('searchFromDate').value,
                searchToDate: document.getElementById('searchToDate').value,
                searchPropertyId: document.getElementById('searchPropertyId').value,
                searchBeneficiaryName: document.getElementById('searchBeneficiaryName').value
            };
            localStorage.setItem('paypropTestFormState', JSON.stringify(formData));
        }
        
        function loadFormState() {
            try {
                const saved = localStorage.getItem('paypropTestFormState');
                if (saved) {
                    const formData = JSON.parse(saved);
                    Object.entries(formData).forEach(([key, value]) => {
                        const element = document.getElementById(key);
                        if (element && value) element.value = value;
                    });
                }
            } catch (e) {
                // Ignore localStorage errors
            }
        }
        
        // Auto-save on form changes
        document.addEventListener('change', function(e) {
            if (e.target.id.startsWith('search')) {
                saveFormState();
            }
        });
        
        // Load saved state on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadFormState, 100);
        });
        
        // Performance monitoring
        let requestStartTime;
        
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            requestStartTime = performance.now();
            return originalFetch.apply(this, args).then(response => {
                const duration = Math.round(performance.now() - requestStartTime);
                console.log(`API Request completed in ${duration}ms:`, args[0]);
                return response;
            });
        };
        
        // Enhanced error handling
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showResult('statusOverviewResult', {
                status: 'ERROR',
                error: 'Unhandled error: ' + e.reason,
                timestamp: new Date().toISOString()
            }, '❌ Application Error');
        });
        
        // Quick test buttons for common scenarios
        async function quickTestScenario(scenario) {
            switch(scenario) {
                case 'missing_payments':
                    setChristopherBoothExample();
                    await smartSearch();
                    break;
                    
                case 'batch_integrity':
                    document.getElementById('batchAnalyzeFromDate').value = '2025-05-25';
                    document.getElementById('batchAnalyzeToDate').value = '2025-06-05';
                    await analyzeBatch();
                    break;
                    
                case 'sync_health':
                    await getSyncDashboard();
                    break;
                    
                case 'endpoint_health':
                    await discoverEndpoints();
                    break;
            }
        }
        
        // Add quick test buttons to UI
        document.addEventListener('DOMContentLoaded', function() {
            // Add quick test section if not exists
            const quickTestsHtml = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>Quick Tests:</strong>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-warning me-2" onclick="quickTestScenario('missing_payments')">
                                    🐛 Test Missing Payments Issue
                                </button>
                                <button class="btn btn-sm btn-outline-info me-2" onclick="quickTestScenario('batch_integrity')">
                                    📦 Test Batch Integrity
                                </button>
                                <button class="btn btn-sm btn-outline-success me-2" onclick="quickTestScenario('sync_health')">
                                    💊 Check Sync Health
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="quickTestScenario('endpoint_health')">
                                    🔍 Check Endpoint Health
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert after dashboard header
            const container = document.querySelector('.container-fluid');
            const firstRow = container.querySelector('.row');
            firstRow.insertAdjacentHTML('beforebegin', quickTestsHtml);
        });
        
        // ===== BLOCK TESTING FUNCTIONS =====
        
        // Block Management Functions
        async function createBlock() {
            const portfolioId = document.getElementById('blockPortfolioId').value;
            const name = document.getElementById('blockName').value;
            const description = document.getElementById('blockDescription').value;
            
            if (!portfolioId || !name) {
                alert('Portfolio ID and Block Name are required');
                return;
            }
            
            const blockData = {
                portfolioId: parseInt(portfolioId),
                name: name,
                description: description,
                blockType: 'BUILDING'
            };
            
            const result = await fetchWithCSRF('/portfolio/internal/blocks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(blockData)
            });
            
            showResult('blockTestResult', result.data, '🏗️ Create Block Result');
        }
        
        async function listPortfolioBlocks() {
            const portfolioId = document.getElementById('blockPortfolioId').value;
            
            if (!portfolioId) {
                alert('Portfolio ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/blocks/portfolio/${portfolioId}`);
            showResult('blockTestResult', result.data, '📋 Portfolio Blocks List');
        }
        
        async function getBlocksWithCounts() {
            const portfolioId = document.getElementById('blockPortfolioId').value;
            
            if (!portfolioId) {
                alert('Portfolio ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/blocks/portfolio/${portfolioId}/with-counts`);
            showResult('blockTestResult', result.data, '📊 Blocks with Property Counts');
        }
        
        async function getPortfolioStatistics() {
            const portfolioId = document.getElementById('blockPortfolioId').value;
            
            if (!portfolioId) {
                alert('Portfolio ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/blocks/portfolio/${portfolioId}/statistics`);
            showResult('blockTestResult', result.data, '📈 Portfolio Block Statistics');
        }
        
        // Property Assignment Functions
        async function assignPropertiesToBlock() {
            const blockId = document.getElementById('assignBlockId').value;
            const propertyIds = document.getElementById('assignPropertyIds').value;
            
            if (!blockId || !propertyIds) {
                alert('Block ID and Property IDs are required');
                return;
            }
            
            const propertyIdArray = propertyIds.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            
            const params = new URLSearchParams();
            propertyIdArray.forEach(id => params.append('propertyIds', id));
            
            const result = await fetchWithCSRF(`/portfolio/internal/assignment/blocks/${blockId}/assign-properties`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
            
            showResult('blockTestResult', result.data, '➡️ Assign Properties to Block Result');
        }
        
        async function movePropertiesBetweenBlocks() {
            const sourceBlockId = document.getElementById('sourceBlockId').value;
            const targetBlockId = document.getElementById('assignBlockId').value;
            const propertyIds = document.getElementById('assignPropertyIds').value;
            
            if (!sourceBlockId || !targetBlockId || !propertyIds) {
                alert('Source Block ID, Target Block ID, and Property IDs are required');
                return;
            }
            
            const propertyIdArray = propertyIds.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            
            const params = new URLSearchParams();
            params.append('sourceBlockId', sourceBlockId);
            params.append('targetBlockId', targetBlockId);
            propertyIdArray.forEach(id => params.append('propertyIds', id));
            
            const result = await fetchWithCSRF('/portfolio/internal/assignment/blocks/move-properties', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
            
            showResult('blockTestResult', result.data, '🔄 Move Properties Between Blocks Result');
        }
        
        async function removePropertiesFromBlock() {
            const blockId = document.getElementById('assignBlockId').value;
            const propertyIds = document.getElementById('assignPropertyIds').value;
            
            if (!blockId || !propertyIds) {
                alert('Block ID and Property IDs are required');
                return;
            }
            
            const propertyIdArray = propertyIds.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            
            const params = new URLSearchParams();
            propertyIdArray.forEach(id => params.append('propertyIds', id));
            
            const result = await fetchWithCSRF(`/portfolio/internal/assignment/blocks/${blockId}/remove-properties`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
            
            showResult('blockTestResult', result.data, '❌ Remove Properties from Block Result');
        }
        
        async function getBlocksView() {
            const portfolioId = document.getElementById('blockPortfolioId').value;
            
            if (!portfolioId) {
                alert('Portfolio ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/assignment/${portfolioId}/blocks-view`);
            showResult('blockTestResult', result.data, '🏗️ Hierarchical Blocks View');
        }
        
        // PayProp Sync Functions
        async function syncBlockToPayProp() {
            const blockId = document.getElementById('syncBlockId').value;
            
            if (!blockId) {
                alert('Block ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/blocks/payprop/${blockId}/sync`, {
                method: 'POST'
            });
            
            showResult('blockTestResult', result.data, '☁️ Sync Block to PayProp Result');
        }
        
        async function syncAllBlocksInPortfolio() {
            const portfolioId = document.getElementById('syncPortfolioId').value || document.getElementById('blockPortfolioId').value;
            
            if (!portfolioId) {
                alert('Portfolio ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/blocks/payprop/portfolio/${portfolioId}/sync-all`, {
                method: 'POST'
            });
            
            showResult('blockTestResult', result.data, '☁️ Sync All Blocks in Portfolio Result');
        }
        
        async function syncBlocksNeedingSync() {
            const result = await fetchWithCSRF('/portfolio/internal/blocks/payprop/sync-needed', {
                method: 'POST'
            });
            
            showResult('blockTestResult', result.data, '⚠️ Sync Blocks Needing Sync Result');
        }
        
        async function syncPortfolioHierarchical() {
            const portfolioId = document.getElementById('syncPortfolioId').value || document.getElementById('blockPortfolioId').value;
            
            if (!portfolioId) {
                alert('Portfolio ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/blocks/payprop/portfolio/${portfolioId}/sync-hierarchical`, {
                method: 'POST'
            });
            
            showResult('blockTestResult', result.data, '🏗️ Hierarchical Portfolio+Blocks Sync Result');
        }
        
        async function getBlockSyncStatus() {
            const blockId = document.getElementById('syncBlockId').value;
            
            if (!blockId) {
                alert('Block ID is required');
                return;
            }
            
            const result = await fetchWithCSRF(`/portfolio/internal/blocks/payprop/${blockId}/status`);
            showResult('blockTestResult', result.data, '📊 Block Sync Status');
        }
        
        async function getBlocksNeedingSync() {
            const portfolioId = document.getElementById('syncPortfolioId').value || document.getElementById('blockPortfolioId').value;
            
            if (portfolioId) {
                const result = await fetchWithCSRF(`/portfolio/internal/blocks/payprop/portfolio/${portfolioId}/needing-sync`);
                showResult('blockTestResult', result.data, '🔍 Blocks Needing Sync in Portfolio');
            } else {
                const result = await fetchWithCSRF('/portfolio/internal/blocks/payprop/needing-sync');
                showResult('blockTestResult', result.data, '🔍 All Blocks Needing Sync');
            }
        }
        
        // Migration Functions
        async function getEnhancedMigrationSummary() {
            const result = await fetchWithCSRF('/portfolio/internal/payprop/migration/enhanced-summary');
            showResult('blockTestResult', result.data, '📊 Enhanced Migration Summary (Portfolios + Blocks)');
        }
        
        async function fixBrokenPortfoliosAndBlocks() {
            if (confirm('This will attempt to fix broken portfolios and blocks. Continue?')) {
                const result = await fetchWithCSRF('/portfolio/internal/payprop/migration/fix-portfolios-and-blocks', {
                    method: 'POST'
                });
                showResult('blockTestResult', result.data, '🔧 Fix Broken Portfolios and Blocks Result');
            }
        }
        
        async function fixBrokenBlocks() {
            if (confirm('This will attempt to fix broken blocks only. Continue?')) {
                const result = await fetchWithCSRF('/portfolio/internal/payprop/migration/fix-blocks', {
                    method: 'POST'
                });
                showResult('blockTestResult', result.data, '🔧 Fix Broken Blocks Result');
            }
        }
        
        async function testBlockValidation() {
            const portfolioId = document.getElementById('blockPortfolioId').value;
            const blockName = document.getElementById('blockName').value;
            
            if (!portfolioId || !blockName) {
                alert('Portfolio ID and Block Name are required');
                return;
            }
            
            const validationData = {
                portfolioId: parseInt(portfolioId),
                blockName: blockName
            };
            
            const result = await fetchWithCSRF('/portfolio/internal/blocks/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(validationData)
            });
            
            showResult('blockTestResult', result.data, '✅ Block Validation Result');
        }
        
        // Test Data Functions
        function loadTestData(size) {
            switch(size) {
                case 'small':
                    document.getElementById('blockPortfolioId').value = '1';
                    document.getElementById('blockName').value = 'Test Block Small';
                    document.getElementById('blockDescription').value = 'Small test block for basic testing';
                    document.getElementById('assignBlockId').value = '1';
                    document.getElementById('assignPropertyIds').value = '1,2';
                    document.getElementById('syncBlockId').value = '1';
                    document.getElementById('syncPortfolioId').value = '1';
                    break;
                    
                case 'medium':
                    document.getElementById('blockPortfolioId').value = '2';
                    document.getElementById('blockName').value = 'Test Block Medium';
                    document.getElementById('blockDescription').value = 'Medium test block for advanced testing';
                    document.getElementById('assignBlockId').value = '2';
                    document.getElementById('assignPropertyIds').value = '3,4,5,6';
                    document.getElementById('syncBlockId').value = '2';
                    document.getElementById('syncPortfolioId').value = '2';
                    break;
                    
                case 'large':
                    document.getElementById('blockPortfolioId').value = '3';
                    document.getElementById('blockName').value = 'Test Block Large';
                    document.getElementById('blockDescription').value = 'Large test block for performance testing';
                    document.getElementById('assignBlockId').value = '3';
                    document.getElementById('assignPropertyIds').value = '7,8,9,10,11,12';
                    document.getElementById('syncBlockId').value = '3';
                    document.getElementById('syncPortfolioId').value = '3';
                    break;
            }
            
            showResult('blockTestResult', {
                message: `Loaded ${size} test data`,
                portfolioId: document.getElementById('blockPortfolioId').value,
                blockName: document.getElementById('blockName').value,
                note: `Ready to test ${size} scenario with Portfolio ${document.getElementById('blockPortfolioId').value}`
            }, `📝 ${size.toUpperCase()} Test Data Loaded`);
        }
        
        function clearBlockTestData() {
            document.getElementById('blockPortfolioId').value = '';
            document.getElementById('blockName').value = '';
            document.getElementById('blockDescription').value = '';
            document.getElementById('assignBlockId').value = '';
            document.getElementById('assignPropertyIds').value = '';
            document.getElementById('sourceBlockId').value = '';
            document.getElementById('syncBlockId').value = '';
            document.getElementById('syncPortfolioId').value = '';
            
            showResult('blockTestResult', {
                message: 'All block test data cleared',
                status: 'SUCCESS'
            }, '🧹 Test Data Cleared');
        }
        
        // Auto-populate functions for block testing
        function autoFillFromBlockResult(data) {
            if (data && data.block && data.block.id) {
                // Auto-fill sync fields when a block is created
                document.getElementById('syncBlockId').value = data.block.id;
                if (data.block.portfolioId) {
                    document.getElementById('syncPortfolioId').value = data.block.portfolioId;
                }
                if (data.block.id && !document.getElementById('assignBlockId').value) {
                    document.getElementById('assignBlockId').value = data.block.id;
                }
            }
        }
        
        // Enhanced result display for block testing - Fixed recursion issue
        function enhanceBlockTestingResults() {
            // Override the showResult function for block testing specifically
            const originalShowResult = window.showResult;
            
            window.showResult = function(elementId, data, title = '') {
                // Call the original function
                originalShowResult.call(this, elementId, data, title);
                
                // Auto-populate fields if this is a block creation result
                if (elementId === 'blockTestResult' && data && data.block) {
                    autoFillFromBlockResult(data);
                }
            };
        }
        
        // Initialize the enhanced block testing when page loads
        enhanceBlockTestingResults();
        
        // ===== COMPREHENSIVE ENDPOINT DISCOVERY FUNCTIONS =====
        
        // Known PayProp endpoints from API specification
        const KNOWN_ENDPOINTS = {
            payments: [
                { path: '/export/payments', method: 'GET', category: 'payments', description: 'Export payment data' },
                { path: '/entity/payment', method: 'GET', category: 'payments', description: 'List payments' },
                { path: '/entity/payment', method: 'POST', category: 'payments', description: 'Create payment' },
                { path: '/entity/payment/{external_id}', method: 'GET', category: 'payments', description: 'Get payment by ID' },
                { path: '/entity/payment/{external_id}', method: 'PUT', category: 'payments', description: 'Update payment' },
                { path: '/entity/adhoc-payment', method: 'POST', category: 'payments', description: 'Create adhoc payment' },
                { path: '/entity/secondary-payment', method: 'POST', category: 'payments', description: 'Create secondary payment' },
                { path: '/entity/secondary-payment/{external_id}', method: 'GET', category: 'payments', description: 'Get secondary payment' },
                { path: '/entity/secondary-payment/{external_id}', method: 'PUT', category: 'payments', description: 'Update secondary payment' },
                { path: '/posted-payments', method: 'POST', category: 'payments', description: 'Create posted payment' },
                { path: '/posted-payments/types', method: 'GET', category: 'payments', description: 'Get posted payment types' },
                { path: '/payments/categories', method: 'GET', category: 'payments', description: 'Get payment categories' },
                { path: '/payments/categories', method: 'POST', category: 'payments', description: 'Create payment category' },
                { path: '/payments/categories/{external_id}', method: 'PUT', category: 'payments', description: 'Update payment category' },
                { path: '/report/all-payments', method: 'GET', category: 'payments', description: 'All payments report' }
            ],
            invoices: [
                { path: '/export/invoices', method: 'GET', category: 'invoices', description: '🚨 CRITICAL MISSING: Invoice instructions (rent, parking, etc)', priority: 'HIGH' },
                { path: '/export/invoice-instructions', method: 'GET', category: 'invoices', description: 'Export invoice instructions' },
                { path: '/entity/invoice', method: 'GET', category: 'invoices', description: 'List invoices' },
                { path: '/entity/invoice', method: 'POST', category: 'invoices', description: 'Create invoice' },
                { path: '/entity/invoice/{external_id}', method: 'GET', category: 'invoices', description: 'Get invoice by ID' },
                { path: '/entity/invoice/{external_id}', method: 'PUT', category: 'invoices', description: 'Update invoice' },
                { path: '/entity/adhoc-invoice', method: 'POST', category: 'invoices', description: 'Create adhoc invoice' },
                { path: '/invoices/categories', method: 'GET', category: 'invoices', description: 'Get invoice categories' },
                { path: '/invoices/categories', method: 'POST', category: 'invoices', description: 'Create invoice category' },
                { path: '/invoices/categories/{external_id}', method: 'PUT', category: 'invoices', description: 'Update invoice category' },
                { path: '/documents/pdf/agency-invoice', method: 'GET', category: 'invoices', description: 'Generate agency invoice PDF' }
            ],
            properties: [
                { path: '/export/properties', method: 'GET', category: 'properties', description: 'Export property data' },
                { path: '/entity/property', method: 'GET', category: 'properties', description: 'List properties' },
                { path: '/entity/property', method: 'POST', category: 'properties', description: 'Create property' },
                { path: '/entity/property/{external_id}', method: 'GET', category: 'properties', description: 'Get property by ID' },
                { path: '/entity/property/{external_id}', method: 'PUT', category: 'properties', description: 'Update property' }
            ],
            beneficiaries: [
                { path: '/export/beneficiaries', method: 'GET', category: 'beneficiaries', description: 'Export beneficiary data' },
                { path: '/entity/beneficiary', method: 'GET', category: 'beneficiaries', description: 'List beneficiaries' },
                { path: '/entity/beneficiary', method: 'POST', category: 'beneficiaries', description: 'Create beneficiary' },
                { path: '/entity/beneficiary/{external_id}', method: 'GET', category: 'beneficiaries', description: 'Get beneficiary by ID' },
                { path: '/entity/beneficiary/{external_id}', method: 'PUT', category: 'beneficiaries', description: 'Update beneficiary' }
            ],
            reports: [
                { path: '/report/icdn', method: 'GET', category: 'reports', description: 'ICDN transactions report' },
                { path: '/documents/pdf/owner-statement', method: 'GET', category: 'reports', description: 'Generate owner statement PDF' }
            ],
            meta: [
                { path: '/meta/me', method: 'GET', category: 'meta', description: 'Get current user info and scopes' },
                { path: '/meta/scopes', method: 'GET', category: 'meta', description: 'Get available scopes' }
            ]
        };
        
        // Global variables for endpoint discovery
        let discoveredEndpoints = [];
        let bulkTestQueue = [];
        let bulkTestResults = [];
        let bulkTestRunning = false;
        let bulkTestPaused = false;
        
        // Endpoint Discovery Functions
        async function discoverAllEndpoints() {
            const method = document.getElementById('discoveryMethod').value;
            const testDepth = document.getElementById('testDepth').value;
            
            showResult('endpointDiscoveryResult', { status: 'INFO', message: 'Starting endpoint discovery...' }, '🔍 Discovery Progress');
            
            try {
                if (method === 'api_spec' || method === 'combined') {
                    await discoverFromApiSpec();
                }
                
                if (method === 'live_probe' || method === 'combined') {
                    await discoverByProbing();
                }
                
                displayEndpointTree();
                updateEndpointCount();
                
                showResult('endpointDiscoveryResult', {
                    status: 'SUCCESS',
                    discovered_count: discoveredEndpoints.length,
                    endpoints: discoveredEndpoints,
                    categories: getEndpointCategories()
                }, '✅ Discovery Complete');
                
            } catch (error) {
                showResult('endpointDiscoveryResult', {
                    status: 'ERROR',
                    error: error.message,
                    partial_results: discoveredEndpoints
                }, '❌ Discovery Error');
            }
        }
        
        async function discoverFromApiSpec() {
            const categories = getSelectedCategories();
            discoveredEndpoints = [];
            
            categories.forEach(category => {
                if (KNOWN_ENDPOINTS[category]) {
                    discoveredEndpoints.push(...KNOWN_ENDPOINTS[category]);
                }
            });
            
            // Test accessibility of known endpoints
            for (let endpoint of discoveredEndpoints) {
                try {
                    const testResult = await testEndpointAccessibility(endpoint);
                    endpoint.accessible = testResult.accessible;
                    endpoint.status_code = testResult.status_code;
                    endpoint.response_time = testResult.response_time;
                } catch (error) {
                    endpoint.accessible = false;
                    endpoint.error = error.message;
                }
            }
        }
        
        async function discoverByProbing() {
            // Live API probing - try common endpoint patterns
            const basePatterns = [
                '/api', '/v1', '/v1.1', '/v2',
                '/entity', '/export', '/report', '/documents',
                '/meta', '/auth', '/oauth'
            ];
            
            const entityTypes = [
                'payment', 'invoice', 'property', 'beneficiary', 'tenant',
                'maintenance', 'batch', 'transaction', 'category'
            ];
            
            for (let pattern of basePatterns) {
                for (let entity of entityTypes) {
                    const endpoints = [
                        { path: `${pattern}/${entity}`, method: 'GET' },
                        { path: `${pattern}/${entity}s`, method: 'GET' },
                        { path: `${pattern}/${entity}/categories`, method: 'GET' }
                    ];
                    
                    for (let endpoint of endpoints) {
                        try {
                            const result = await testEndpointAccessibility(endpoint);
                            if (result.accessible) {
                                endpoint.category = guessCategory(endpoint.path);
                                endpoint.description = `Discovered: ${endpoint.path}`;
                                endpoint.accessible = true;
                                endpoint.status_code = result.status_code;
                                discoveredEndpoints.push(endpoint);
                            }
                        } catch (error) {
                            // Ignore failed probes
                        }
                    }
                }
            }
        }
        
        async function testEndpointAccessibility(endpoint) {
            const startTime = performance.now();
            
            try {
                const response = await fetch(`/api/payprop/oauth/test-endpoint`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({
                        endpoint: endpoint.path,
                        method: endpoint.method
                    }),
                    credentials: 'include'
                });
                
                const responseTime = Math.round(performance.now() - startTime);
                const accessible = response.status < 500; // 2xx, 3xx, 4xx are accessible
                
                return {
                    accessible,
                    status_code: response.status,
                    response_time: responseTime
                };
            } catch (error) {
                return {
                    accessible: false,
                    status_code: null,
                    response_time: null,
                    error: error.message
                };
            }
        }
        
        function loadKnownEndpoints() {
            const categories = getSelectedCategories();
            discoveredEndpoints = [];
            
            categories.forEach(category => {
                if (KNOWN_ENDPOINTS[category]) {
                    discoveredEndpoints.push(...KNOWN_ENDPOINTS[category].map(ep => ({
                        ...ep,
                        accessible: null, // Unknown until tested
                        source: 'known'
                    })));
                }
            });
            
            displayEndpointTree();
            updateEndpointCount();
            
            showResult('endpointDiscoveryResult', {
                status: 'SUCCESS',
                message: 'Loaded known endpoints from API specification',
                count: discoveredEndpoints.length,
                endpoints: discoveredEndpoints
            }, '📋 Known Endpoints Loaded');
        }
        
        async function testAllDiscovered() {
            if (discoveredEndpoints.length === 0) {
                alert('No endpoints discovered. Please run discovery first.');
                return;
            }
            
            const testDepth = document.getElementById('testDepth').value;
            const responseDetail = document.getElementById('responseDetail').value;
            
            const testResults = [];
            
            for (let endpoint of discoveredEndpoints) {
                try {
                    const result = await testSingleEndpoint(endpoint, testDepth, responseDetail);
                    testResults.push(result);
                    
                    // Update endpoint with test results
                    endpoint.test_result = result;
                    endpoint.last_tested = new Date().toISOString();
                } catch (error) {
                    testResults.push({
                        endpoint: endpoint.path,
                        method: endpoint.method,
                        error: error.message,
                        success: false
                    });
                }
            }
            
            displayEndpointTree(); // Refresh with test results
            
            showResult('endpointDiscoveryResult', {
                status: 'SUCCESS',
                message: 'Completed testing all discovered endpoints',
                test_results: testResults,
                summary: generateTestSummary(testResults)
            }, '🧪 All Endpoints Tested');
        }
        
        async function testSingleEndpoint(endpoint, testDepth, responseDetail) {
            const params = new URLSearchParams({
                endpoint: endpoint.path,
                method: endpoint.method,
                testDepth: testDepth,
                responseDetail: responseDetail
            });
            
            const response = await fetchWithCSRF(`/api/payprop/oauth/test-single-endpoint?${params}`, {
                method: 'POST'
            });
            
            return response.data;
        }
        
        // Bulk Testing Functions
        async function startBulkTest() {
            const testSuite = document.getElementById('bulkTestSuite').value;
            const paramStrategy = document.getElementById('parameterStrategy').value;
            const concurrency = parseInt(document.getElementById('bulkConcurrency').value);
            const timeout = parseInt(document.getElementById('bulkTimeout').value) * 1000;
            
            // Build test queue based on selected suite
            bulkTestQueue = buildTestQueue(testSuite, paramStrategy);
            bulkTestResults = [];
            bulkTestRunning = true;
            bulkTestPaused = false;
            
            // Update UI
            document.getElementById('bulkTestProgress').style.display = 'block';
            document.getElementById('pauseBulkBtn').disabled = false;
            document.getElementById('stopBulkBtn').disabled = false;
            updateBulkTestProgress();
            
            // Start testing with specified concurrency
            const workers = [];
            for (let i = 0; i < concurrency; i++) {
                workers.push(runBulkTestWorker(i, timeout));
            }
            
            try {
                await Promise.all(workers);
                
                if (bulkTestRunning) {
                    showBulkTestResults();
                    showResult('bulkTestResult', {
                        status: 'SUCCESS',
                        message: 'Bulk testing completed successfully',
                        total_tests: bulkTestResults.length,
                        summary: generateBulkTestSummary()
                    }, '🎉 Bulk Test Complete');
                }
            } catch (error) {
                showResult('bulkTestResult', {
                    status: 'ERROR',
                    error: error.message,
                    partial_results: bulkTestResults
                }, '❌ Bulk Test Error');
            } finally {
                bulkTestRunning = false;
                document.getElementById('pauseBulkBtn').disabled = true;
                document.getElementById('stopBulkBtn').disabled = true;
            }
        }
        
        async function runBulkTestWorker(workerId, timeout) {
            while (bulkTestRunning && bulkTestQueue.length > 0) {
                if (bulkTestPaused) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    continue;
                }
                
                const testCase = bulkTestQueue.shift();
                if (!testCase) break;
                
                document.getElementById('currentTestInfo').innerHTML = 
                    `<small class="text-muted">Worker ${workerId}: Testing ${testCase.method} ${testCase.endpoint}</small>`;
                
                try {
                    const startTime = performance.now();
                    
                    const result = await Promise.race([
                        executeBulkTestCase(testCase),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), timeout)
                        )
                    ]);
                    
                    const duration = Math.round(performance.now() - startTime);
                    
                    bulkTestResults.push({
                        ...testCase,
                        success: true,
                        result: result,
                        duration: duration,
                        worker_id: workerId,
                        timestamp: new Date().toISOString()
                    });
                    
                } catch (error) {
                    bulkTestResults.push({
                        ...testCase,
                        success: false,
                        error: error.message,
                        worker_id: workerId,
                        timestamp: new Date().toISOString()
                    });
                }
                
                updateBulkTestProgress();
            }
        }
        
        async function executeBulkTestCase(testCase) {
            const params = new URLSearchParams();
            params.append('endpoint', testCase.endpoint);
            params.append('method', testCase.method);
            
            if (testCase.parameters) {
                Object.entries(testCase.parameters).forEach(([key, value]) => {
                    params.append(key, value);
                });
            }
            
            const response = await fetchWithCSRF(`/api/payprop/oauth/raw-api-call?${params}`, {
                method: 'POST'
            });
            
            return response.data;
        }
        
        function buildTestQueue(testSuite, paramStrategy) {
            const queue = [];
            let endpoints = [];
            
            // Select endpoints based on test suite
            switch (testSuite) {
                case 'payment_full':
                    endpoints = KNOWN_ENDPOINTS.payments;
                    break;
                case 'payment_core':
                    endpoints = KNOWN_ENDPOINTS.payments.filter(ep => 
                        ['GET', 'POST'].includes(ep.method) && 
                        !ep.path.includes('{external_id}')
                    );
                    break;
                case 'invoice_full':
                    endpoints = KNOWN_ENDPOINTS.invoices;
                    break;
                case 'transaction_full':
                    endpoints = [...KNOWN_ENDPOINTS.payments, ...KNOWN_ENDPOINTS.invoices];
                    break;
                case 'all_readonly':
                    endpoints = Object.values(KNOWN_ENDPOINTS).flat().filter(ep => ep.method === 'GET');
                    break;
                case 'all_safe':
                    endpoints = Object.values(KNOWN_ENDPOINTS).flat().filter(ep => 
                        ['GET'].includes(ep.method)
                    );
                    break;
                case 'custom':
                    endpoints = discoveredEndpoints.filter(ep => ep.selected);
                    break;
                default:
                    endpoints = Object.values(KNOWN_ENDPOINTS).flat();
            }
            
            // Generate test cases with different parameter combinations
            endpoints.forEach(endpoint => {
                const paramSets = generateParameterSets(endpoint, paramStrategy);
                
                paramSets.forEach(paramSet => {
                    queue.push({
                        endpoint: endpoint.path,
                        method: endpoint.method,
                        category: endpoint.category,
                        description: endpoint.description,
                        parameters: paramSet,
                        test_name: `${endpoint.method} ${endpoint.path} (${paramSet.name || 'default'})`
                    });
                });
            });
            
            return queue;
        }
        
        function generateParameterSets(endpoint, strategy) {
            const baseSets = [{ name: 'minimal' }];
            
            if (strategy === 'minimal') return baseSets;
            
            const commonParams = [];
            
            // Add common parameters based on endpoint type
            if (endpoint.path.includes('export') || endpoint.path.includes('report')) {
                commonParams.push(
                    { name: 'with_dates', from_date: '2025-01-01', to_date: '2025-12-31' },
                    { name: 'with_pagination', rows: 10, page: 1 },
                    { name: 'comprehensive', from_date: '2025-01-01', to_date: '2025-12-31', rows: 5 }
                );
            }
            
            if (endpoint.path.includes('payment')) {
                commonParams.push(
                    { name: 'with_beneficiary_info', include_beneficiary_info: true },
                    { name: 'with_property_filter', property_id: 'test123' }
                );
            }
            
            if (strategy === 'edge_cases') {
                commonParams.push(
                    { name: 'edge_large_page', rows: 1000 },
                    { name: 'edge_future_date', from_date: '2030-01-01', to_date: '2030-12-31' },
                    { name: 'edge_invalid_property', property_id: 'invalid_id_12345' }
                );
            }
            
            return [...baseSets, ...commonParams];
        }
        
        // Helper Functions
        function getSelectedCategories() {
            const categories = [];
            if (document.getElementById('catPayments').checked) categories.push('payments');
            if (document.getElementById('catInvoices').checked) categories.push('invoices');
            if (document.getElementById('catProperties').checked) categories.push('properties');
            if (document.getElementById('catBeneficiaries').checked) categories.push('beneficiaries');
            if (document.getElementById('catReports').checked) categories.push('reports');
            if (document.getElementById('catMeta').checked) categories.push('meta');
            return categories;
        }
        
        function guessCategory(path) {
            if (path.includes('payment')) return 'payments';
            if (path.includes('invoice')) return 'invoices';
            if (path.includes('property')) return 'properties';
            if (path.includes('beneficiary')) return 'beneficiaries';
            if (path.includes('report')) return 'reports';
            if (path.includes('meta') || path.includes('auth')) return 'meta';
            return 'unknown';
        }
        
        function displayEndpointTree() {
            const tree = document.getElementById('endpointTree');
            const categorized = {};
            
            discoveredEndpoints.forEach(endpoint => {
                const category = endpoint.category || 'uncategorized';
                if (!categorized[category]) categorized[category] = [];
                categorized[category].push(endpoint);
            });
            
            let html = '';
            Object.entries(categorized).forEach(([category, endpoints]) => {
                html += `
                    <div class="endpoint-category mb-3">
                        <h6 class="text-primary">
                            <i class="fas fa-folder"></i> ${category.charAt(0).toUpperCase() + category.slice(1)}
                            <span class="badge bg-secondary ms-2">${endpoints.length}</span>
                        </h6>
                        <div class="endpoint-list ms-3">
                `;
                
                endpoints.forEach(endpoint => {
                    const statusIcon = getEndpointStatusIcon(endpoint);
                    const statusClass = getEndpointStatusClass(endpoint);
                    
                    html += `
                        <div class="endpoint-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div class="endpoint-info">
                                <span class="badge bg-${getMethodColor(endpoint.method)} me-2">${endpoint.method}</span>
                                <code class="text-muted">${endpoint.path}</code>
                                <small class="text-muted ms-2">${endpoint.description || ''}</small>
                            </div>
                            <div class="endpoint-status">
                                ${statusIcon}
                                ${endpoint.response_time ? `<small class="text-muted ms-1">${endpoint.response_time}ms</small>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            tree.innerHTML = html || '<div class="text-muted text-center py-4">No endpoints discovered</div>';
        }
        
        function getEndpointStatusIcon(endpoint) {
            if (endpoint.accessible === true) return '<i class="fas fa-check-circle text-success"></i>';
            if (endpoint.accessible === false) return '<i class="fas fa-times-circle text-danger"></i>';
            if (endpoint.test_result?.success === true) return '<i class="fas fa-check-circle text-success"></i>';
            if (endpoint.test_result?.success === false) return '<i class="fas fa-exclamation-circle text-warning"></i>';
            return '<i class="fas fa-question-circle text-muted"></i>';
        }
        
        function getEndpointStatusClass(endpoint) {
            if (endpoint.accessible === true || endpoint.test_result?.success === true) return 'text-success';
            if (endpoint.accessible === false || endpoint.test_result?.success === false) return 'text-danger';
            return 'text-muted';
        }
        
        function getMethodColor(method) {
            switch (method) {
                case 'GET': return 'primary';
                case 'POST': return 'success';
                case 'PUT': return 'warning';
                case 'DELETE': return 'danger';
                default: return 'secondary';
            }
        }
        
        function updateEndpointCount() {
            document.getElementById('endpointCount').textContent = discoveredEndpoints.length;
        }
        
        function updateBulkTestProgress() {
            const completed = bulkTestResults.length;
            const total = completed + bulkTestQueue.length;
            const succeeded = bulkTestResults.filter(r => r.success).length;
            const failed = bulkTestResults.filter(r => !r.success).length;
            const remaining = bulkTestQueue.length;
            
            document.getElementById('testsCompleted').textContent = completed;
            document.getElementById('testsSucceeded').textContent = succeeded;
            document.getElementById('testsFailed').textContent = failed;
            document.getElementById('testsRemaining').textContent = remaining;
            
            const progressPercent = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('bulkTestProgressBar').style.width = `${progressPercent}%`;
        }
        
        function generateTestSummary(testResults) {
            const total = testResults.length;
            const successful = testResults.filter(r => r.success !== false).length;
            const failed = total - successful;
            
            return {
                total,
                successful,
                failed,
                success_rate: total > 0 ? Math.round((successful / total) * 100) : 0
            };
        }
        
        function generateBulkTestSummary() {
            const total = bulkTestResults.length;
            const successful = bulkTestResults.filter(r => r.success).length;
            const failed = total - successful;
            const avgDuration = bulkTestResults.reduce((sum, r) => sum + (r.duration || 0), 0) / total;
            
            return {
                total,
                successful,
                failed,
                success_rate: Math.round((successful / total) * 100),
                average_response_time: Math.round(avgDuration),
                categories_tested: [...new Set(bulkTestResults.map(r => r.category))],
                endpoints_tested: [...new Set(bulkTestResults.map(r => r.endpoint))]
            };
        }
        
        function showBulkTestResults() {
            document.getElementById('bulkTestSummary').classList.remove('d-none');
            
            const resultsDiv = document.getElementById('bulkTestResults');
            const summary = generateBulkTestSummary();
            
            let html = `
                <div class="row">
                    <div class="col-md-12">
                        <h6>Test Summary</h6>
                        <p class="mb-1"><strong>Total Tests:</strong> ${summary.total}</p>
                        <p class="mb-1"><strong>Success Rate:</strong> ${summary.success_rate}%</p>
                        <p class="mb-1"><strong>Average Response Time:</strong> ${summary.average_response_time}ms</p>
                        <p class="mb-3"><strong>Categories:</strong> ${summary.categories_tested.join(', ')}</p>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Method</th>
                                <th>Endpoint</th>
                                <th>Duration</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            bulkTestResults.forEach(result => {
                const statusIcon = result.success ? 
                    '<i class="fas fa-check-circle text-success"></i>' : 
                    '<i class="fas fa-times-circle text-danger"></i>';
                const statusClass = result.success ? 'table-success' : 'table-danger';
                
                html += `
                    <tr class="${statusClass}">
                        <td>${statusIcon}</td>
                        <td><span class="badge bg-${getMethodColor(result.method)}">${result.method}</span></td>
                        <td><code>${result.endpoint}</code></td>
                        <td>${result.duration || '-'}ms</td>
                        <td>${result.success ? 'Success' : result.error || 'Failed'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
        }
        
        // Control Functions
        function previewBulkTest() {
            const testSuite = document.getElementById('bulkTestSuite').value;
            const paramStrategy = document.getElementById('parameterStrategy').value;
            
            const previewQueue = buildTestQueue(testSuite, paramStrategy);
            
            showResult('bulkTestResult', {
                status: 'INFO',
                message: 'Bulk test preview',
                test_suite: testSuite,
                parameter_strategy: paramStrategy,
                total_tests: previewQueue.length,
                test_cases: previewQueue.slice(0, 10), // Show first 10
                note: previewQueue.length > 10 ? `Showing first 10 of ${previewQueue.length} tests` : ''
            }, '👀 Bulk Test Preview');
        }
        
        function pauseBulkTest() {
            bulkTestPaused = !bulkTestPaused;
            const btn = document.getElementById('pauseBulkBtn');
            btn.innerHTML = bulkTestPaused ? 
                '<i class="fas fa-play"></i> Resume' : 
                '<i class="fas fa-pause"></i> Pause';
        }
        
        function stopBulkTest() {
            bulkTestRunning = false;
            bulkTestPaused = false;
            bulkTestQueue = [];
            
            document.getElementById('pauseBulkBtn').disabled = true;
            document.getElementById('stopBulkBtn').disabled = true;
            document.getElementById('currentTestInfo').innerHTML = '<small class="text-muted">Stopped</small>';
        }
        
        function exportBulkResults() {
            if (bulkTestResults.length === 0) {
                alert('No test results to export');
                return;
            }
            
            const exportData = {
                summary: generateBulkTestSummary(),
                test_results: bulkTestResults,
                export_timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payprop-bulk-test-results-${new Date().toISOString().slice(0,19)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function getEndpointCategories() {
            const categories = {};
            discoveredEndpoints.forEach(endpoint => {
                const category = endpoint.category || 'uncategorized';
                if (!categories[category]) categories[category] = 0;
                categories[category]++;
            });
            return categories;
        }
        
        // ===== INVOICE INVESTIGATION FUNCTIONS =====
        
        async function testInvoiceInstructions() {
            try {
                showResult('invoiceInvestigationResult', { status: 'INFO', message: 'Testing /export/invoices endpoint...' }, '🔍 Invoice Instructions Test');
                
                const response = await fetchWithCSRF('/api/payprop/oauth/raw-api-call?endpoint=/export/invoices&rows=10', {
                    method: 'POST'
                });
                
                const invoiceInstructions = response.data;
                
                // Analyze the data
                const analysis = analyzeInvoiceInstructions(invoiceInstructions);
                
                showResult('invoiceInvestigationResult', {
                    status: 'SUCCESS',
                    endpoint: '/export/invoices',
                    total_instructions: invoiceInstructions.length,
                    analysis: analysis,
                    sample_data: invoiceInstructions.slice(0, 3),
                    critical_finding: invoiceInstructions.length > 0 ? 
                        'FOUND INVOICE INSTRUCTIONS - This data is missing from your sync!' :
                        'No invoice instructions found - check endpoint availability'
                }, '📋 Invoice Instructions Found');
                
            } catch (error) {
                showResult('invoiceInvestigationResult', {
                    status: 'ERROR',
                    error: error.message,
                    note: 'This might indicate the endpoint is not available or requires different parameters'
                }, '❌ Invoice Instructions Test Failed');
            }
        }
        
        async function compareInvoiceData() {
            try {
                showResult('invoiceInvestigationResult', { status: 'INFO', message: 'Comparing invoice instructions vs ICDN data...' }, '🔍 Data Comparison');
                
                // Get invoice instructions
                const instructionsResponse = await fetchWithCSRF('/api/payprop/oauth/raw-api-call?endpoint=/export/invoices&rows=25', {
                    method: 'POST'
                });
                
                // Get ICDN data for comparison
                const icdnResponse = await fetchWithCSRF('/api/payprop/oauth/raw-api-call?endpoint=/report/icdn&rows=25&type=invoice', {
                    method: 'POST'
                });
                
                const comparison = {
                    instructions: {
                        count: instructionsResponse.data.length,
                        sample: instructionsResponse.data.slice(0, 2),
                        analysis: analyzeInvoiceInstructions(instructionsResponse.data)
                    },
                    icdn: {
                        count: icdnResponse.data.length,
                        sample: icdnResponse.data.slice(0, 2),
                        analysis: analyzeICDNData(icdnResponse.data)
                    },
                    critical_gaps: identifyDataGaps(instructionsResponse.data, icdnResponse.data)
                };
                
                showResult('invoiceInvestigationResult', {
                    status: 'WARNING',
                    comparison: comparison,
                    recommendation: 'Add /export/invoices to your sync process to capture instruction data'
                }, '⚠️ Data Comparison Results');
                
            } catch (error) {
                showResult('invoiceInvestigationResult', {
                    status: 'ERROR',
                    error: error.message
                }, '❌ Comparison Failed');
            }
        }
        
        async function testInvoiceCategories() {
            try {
                const response = await fetchWithCSRF('/api/payprop/oauth/raw-api-call?endpoint=/invoices/categories', {
                    method: 'POST'
                });
                
                showResult('invoiceInvestigationResult', {
                    status: 'SUCCESS',
                    endpoint: '/invoices/categories',
                    categories: response.data,
                    note: 'These categories classify different types of invoices (rent, parking, services, etc.)'
                }, '🏷️ Invoice Categories');
                
            } catch (error) {
                showResult('invoiceInvestigationResult', {
                    status: 'ERROR',
                    error: error.message
                }, '❌ Invoice Categories Test Failed');
            }
        }
        
        async function testInvoiceInstructionsExport() {
            try {
                const response = await fetchWithCSRF('/api/payprop/oauth/raw-api-call?endpoint=/export/invoice-instructions&rows=10', {
                    method: 'POST'
                });
                
                showResult('invoiceInvestigationResult', {
                    status: 'SUCCESS',
                    endpoint: '/export/invoice-instructions',
                    instructions: response.data,
                    note: 'This endpoint may provide detailed instruction history'
                }, '📤 Invoice Instructions Export');
                
            } catch (error) {
                showResult('invoiceInvestigationResult', {
                    status: 'ERROR',
                    error: error.message
                }, '❌ Instructions Export Failed');
            }
        }
        
        async function auditCommissionCalculation() {
            try {
                showResult('invoiceInvestigationResult', { status: 'INFO', message: 'Auditing commission calculation logic...' }, '🔍 Commission Audit');
                
                // Get some ICDN invoice data to analyze
                const response = await fetchWithCSRF('/api/payprop/oauth/raw-api-call?endpoint=/report/icdn&type=invoice&rows=10', {
                    method: 'POST'
                });
                
                const auditResults = analyzeCommissionCalculation(response.data);
                
                showResult('invoiceInvestigationResult', {
                    status: auditResults.concerns.length > 0 ? 'WARNING' : 'SUCCESS',
                    audit_results: auditResults,
                    recommendation: auditResults.concerns.length > 0 ? 
                        'Review commission calculation logic - potential issues found' :
                        'Commission calculation appears consistent'
                }, '📊 Commission Audit Results');
                
            } catch (error) {
                showResult('invoiceInvestigationResult', {
                    status: 'ERROR',
                    error: error.message
                }, '❌ Commission Audit Failed');
            }
        }
        
        async function generateInvoiceGapReport() {
            try {
                showResult('invoiceInvestigationResult', { status: 'INFO', message: 'Generating comprehensive gap analysis...' }, '🔍 Gap Analysis');
                
                const gapReport = {
                    timestamp: new Date().toISOString(),
                    critical_findings: [
                        {
                            issue: 'Missing Invoice Instructions',
                            severity: 'HIGH',
                            description: 'System not importing from /export/invoices - missing recurring rent, parking charges, service charges',
                            impact: 'Cannot detect missing invoices, payment variances, or forecast cash flow',
                            recommendation: 'Add /export/invoices to PayPropFinancialSyncService.syncComprehensiveFinancialData()'
                        },
                        {
                            issue: 'Invoice vs Payment Gap',
                            severity: 'MEDIUM', 
                            description: 'No validation that ICDN invoices match original instructions',
                            impact: 'Commission may be calculated on wrong amounts',
                            recommendation: 'Implement instruction vs completed invoice variance checking'
                        },
                        {
                            issue: 'Missing Invoice Categories',
                            severity: 'MEDIUM',
                            description: 'Not syncing /invoices/categories for proper categorization',
                            impact: 'Cannot properly classify different charge types',
                            recommendation: 'Add invoice category sync to workflow'
                        }
                    ],
                    current_data_sources: [
                        'ICDN (/report/icdn) - Completed invoices only',
                        'Batch Payments (/report/all-payments) - Payment records',
                        'Properties (/export/properties) - Commission rates'
                    ],
                    missing_data_sources: [
                        '/export/invoices - Invoice instructions (CRITICAL)',
                        '/invoices/categories - Invoice categorization',
                        '/export/invoice-instructions - Detailed instruction history'
                    ],
                    business_impact: {
                        missing_payments_detection: 'Cannot identify when invoices should have been generated but weren\'t',
                        amount_variance_detection: 'Cannot detect when invoice amounts differ from instructions',
                        cash_flow_forecasting: 'Cannot predict future invoice generation based on recurring rules',
                        aging_analysis: 'Cannot determine how long invoices remain outstanding'
                    }
                };
                
                showResult('invoiceInvestigationResult', {
                    status: 'WARNING',
                    gap_report: gapReport
                }, '🚨 Critical Gap Analysis Report');
                
            } catch (error) {
                showResult('invoiceInvestigationResult', {
                    status: 'ERROR',
                    error: error.message
                }, '❌ Gap Analysis Failed');
            }
        }
        
        // Helper functions for invoice analysis
        function analyzeInvoiceInstructions(instructions) {
            if (!instructions || instructions.length === 0) return { note: 'No instructions found' };
            
            const analysis = {
                total_instructions: instructions.length,
                frequencies: {},
                categories: {},
                amount_ranges: { min: null, max: null, total: 0 },
                enabled_count: 0,
                recurring_count: 0
            };
            
            instructions.forEach(instruction => {
                // Analyze frequency
                const freq = instruction.frequency || 'unknown';
                analysis.frequencies[freq] = (analysis.frequencies[freq] || 0) + 1;
                
                // Analyze categories
                const category = instruction.category || 'unknown';
                analysis.categories[category] = (analysis.categories[category] || 0) + 1;
                
                // Analyze amounts
                const amount = parseFloat(instruction.amount) || 0;
                if (amount > 0) {
                    analysis.amount_ranges.min = analysis.amount_ranges.min === null ? amount : Math.min(analysis.amount_ranges.min, amount);
                    analysis.amount_ranges.max = analysis.amount_ranges.max === null ? amount : Math.max(analysis.amount_ranges.max, amount);
                    analysis.amount_ranges.total += amount;
                }
                
                // Count enabled and recurring
                if (instruction.enabled) analysis.enabled_count++;
                if (freq !== 'O' && freq !== 'unknown') analysis.recurring_count++;
            });
            
            return analysis;
        }
        
        function analyzeICDNData(icdnData) {
            if (!icdnData || icdnData.length === 0) return { note: 'No ICDN data found' };
            
            const analysis = {
                total_records: icdnData.length,
                types: {},
                amount_total: 0,
                date_range: { earliest: null, latest: null }
            };
            
            icdnData.forEach(record => {
                const type = record.type || 'unknown';
                analysis.types[type] = (analysis.types[type] || 0) + 1;
                
                const amount = parseFloat(record.amount) || 0;
                analysis.amount_total += amount;
                
                const date = record.date;
                if (date) {
                    if (!analysis.date_range.earliest || date < analysis.date_range.earliest) {
                        analysis.date_range.earliest = date;
                    }
                    if (!analysis.date_range.latest || date > analysis.date_range.latest) {
                        analysis.date_range.latest = date;
                    }
                }
            });
            
            return analysis;
        }
        
        function identifyDataGaps(instructions, icdnData) {
            const gaps = [];
            
            if (instructions.length === 0) {
                gaps.push({
                    type: 'CRITICAL',
                    issue: 'No invoice instructions found',
                    description: 'Cannot compare instruction vs completion data'
                });
            } else if (icdnData.length === 0) {
                gaps.push({
                    type: 'WARNING', 
                    issue: 'No ICDN data found',
                    description: 'Cannot validate invoice completion'
                });
            } else {
                // Could implement more sophisticated matching here
                gaps.push({
                    type: 'INFO',
                    issue: 'Data comparison needs enhancement',
                    description: `Found ${instructions.length} instructions vs ${icdnData.length} ICDN records - need property/tenant matching logic`
                });
            }
            
            return gaps;
        }
        
        function analyzeCommissionCalculation(invoiceData) {
            const analysis = {
                total_invoices: invoiceData.length,
                commission_concerns: [],
                amount_distribution: {},
                recommendations: []
            };
            
            invoiceData.forEach((invoice, index) => {
                const amount = parseFloat(invoice.amount) || 0;
                
                // Check for potential commission calculation issues
                if (amount > 0) {
                    // Round amounts might indicate calculated values vs actual
                    if (amount % 1 === 0) {
                        analysis.commission_concerns.push({
                            invoice_id: invoice.id,
                            issue: 'Round number amount',
                            amount: amount,
                            note: 'May indicate calculated rather than actual invoice amount'
                        });
                    }
                    
                    // Group by amount ranges
                    const range = Math.floor(amount / 100) * 100;
                    const rangeKey = `${range}-${range + 99}`;
                    analysis.amount_distribution[rangeKey] = (analysis.amount_distribution[rangeKey] || 0) + 1;
                }
            });
            
            // Generate recommendations
            if (analysis.commission_concerns.length > 0) {
                analysis.recommendations.push('Review commission calculation - some amounts appear calculated rather than from original invoices');
            }
            
            if (Object.keys(analysis.amount_distribution).length > 10) {
                analysis.recommendations.push('Wide amount distribution suggests diverse invoice types - ensure commission rates vary by property');
            }
            
            return {
                analysis: analysis,
                concerns: analysis.commission_concerns,
                recommendations: analysis.recommendations
            };
        }
        
        // Add quick test scenarios for blocks
        async function runQuickBlockTest(scenario) {
            switch(scenario) {
                case 'create_and_sync':
                    loadTestData('small');
                    await createBlock();
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                    await syncBlockToPayProp();
                    break;
                    
                case 'assign_and_move':
                    loadTestData('medium');
                    await assignPropertiesToBlock();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    // Change target block and move properties
                    document.getElementById('sourceBlockId').value = document.getElementById('assignBlockId').value;
                    document.getElementById('assignBlockId').value = '4';
                    await movePropertiesBetweenBlocks();
                    break;
                    
                case 'full_migration':
                    await getEnhancedMigrationSummary();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    if (confirm('Run full migration test?')) {
                        await fixBrokenPortfoliosAndBlocks();
                    }
                    break;
                    
                case 'sync_health':
                    await getBlocksNeedingSync();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    await syncBlocksNeedingSync();
                    break;
            }
        }
        
        // ===== COMPREHENSIVE TEST FUNCTIONS =====
        
        async function testInvoiceInstructions() {
            try {
                showResult('comprehensiveTestResult', { status: 'INFO', message: 'Testing /export/invoices endpoint...' }, '🔍 Invoice Instructions Test');
                
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=export/invoices?include_categories=true&rows=25', {
                    method: 'GET'
                });
                
                if (response.success && response.payPropResponse && response.payPropResponse.items) {
                    const instructions = response.payPropResponse.items;
                    showResult('comprehensiveTestResult', {
                        status: 'SUCCESS',
                        endpoint: '/export/invoices',
                        total_instructions: instructions.length,
                        sample_instruction: instructions[0],
                        missing_from_system: 'This data is NOT currently synced to your database!',
                        impact: 'Missing recurring rent schedules, parking fees, service charges'
                    }, '🚨 CRITICAL: Invoice Instructions Found');
                } else {
                    showResult('comprehensiveTestResult', {
                        status: 'WARNING',
                        message: 'No invoice instructions returned or endpoint not accessible',
                        note: 'This could indicate missing permissions or no invoice data'
                    }, '⚠️ Invoice Instructions Test');
                }
            } catch (error) {
                showResult('comprehensiveTestResult', {
                    status: 'ERROR',
                    error: error.message
                }, '❌ Invoice Instructions Test Failed');
            }
        }
        
        async function testInvoiceCategories() {
            try {
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=categories?type=invoice', {
                    method: 'GET'
                });
                
                showResult('comprehensiveTestResult', {
                    status: response.success ? 'SUCCESS' : 'ERROR',
                    endpoint: '/categories?type=invoice',
                    data: response
                }, response.success ? '✅ Invoice Categories' : '❌ Invoice Categories Failed');
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Invoice Categories Test Failed');
            }
        }
        
        async function testAdhocPayments() {
            try {
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=payments/adhoc', {
                    method: 'GET'
                });
                
                showResult('comprehensiveTestResult', {
                    status: response.success ? 'SUCCESS' : 'WARNING',
                    endpoint: '/payments/adhoc',
                    data: response,
                    note: 'Adhoc payments allow one-time payment processing outside regular schedules'
                }, response.success ? '✅ Adhoc Payments Available' : '⚠️ Adhoc Payments Not Available');
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Adhoc Payments Test Failed');
            }
        }
        
        async function testSecondaryPayments() {
            try {
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=payments/secondary', {
                    method: 'GET'
                });
                
                showResult('comprehensiveTestResult', {
                    status: response.success ? 'SUCCESS' : 'WARNING',
                    endpoint: '/payments/secondary',
                    data: response,
                    note: 'Secondary payments provide alternative payment methods for tenants'
                }, response.success ? '✅ Secondary Payments Available' : '⚠️ Secondary Payments Not Available');
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Secondary Payments Test Failed');
            }
        }
        
        async function testPostedPayments() {
            try {
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=payments/posted', {
                    method: 'GET'
                });
                
                showResult('comprehensiveTestResult', {
                    status: response.success ? 'SUCCESS' : 'WARNING',
                    endpoint: '/payments/posted',
                    data: response,
                    note: 'Posted payments (UK restricted) - may not be available in your region'
                }, response.success ? '✅ Posted Payments Available' : '⚠️ Posted Payments Restricted');
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Posted Payments Test Failed');
            }
        }
        
        async function testCommissionSummaryReport() {
            try {
                const fromDate = new Date();
                fromDate.setMonth(fromDate.getMonth() - 3);
                
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=reports/commission-summary?from_date=' + fromDate.toISOString().split('T')[0], {
                    method: 'GET'
                });
                
                showResult('comprehensiveTestResult', {
                    status: response.success ? 'SUCCESS' : 'WARNING',
                    endpoint: '/reports/commission-summary',
                    data: response,
                    missing_capability: 'Advanced commission analytics not currently used'
                }, response.success ? '✅ Commission Analytics Available' : '⚠️ Commission Analytics Limited');
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Commission Report Test Failed');
            }
        }
        
        async function testWebhookConfiguration() {
            try {
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=webhooks/configuration', {
                    method: 'GET'
                });
                
                showResult('comprehensiveTestResult', {
                    status: response.success ? 'SUCCESS' : 'WARNING',
                    endpoint: '/webhooks/configuration',
                    data: response,
                    real_time_opportunity: 'Webhooks could provide instant payment status updates'
                }, response.success ? '✅ Webhook Configuration Available' : '⚠️ Webhooks Not Configured');
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Webhook Test Failed');
            }
        }
        
        async function testWithProperty(propertyId) {
            try {
                showResult('comprehensiveTestResult', { status: 'INFO', message: 'Testing with property: ' + propertyId }, '🏠 Property-Specific Test');
                
                // Test multiple endpoints with this property
                const tests = [
                    { name: 'ICDN Transactions', endpoint: `report/icdn?property_id=${propertyId}&rows=10` },
                    { name: 'All Payments Report', endpoint: `report/all-payments?property_id=${propertyId}&rows=10` },
                    { name: 'Property Details', endpoint: `properties/${propertyId}` },
                    { name: 'Tenants', endpoint: `export/tenants?property_id=${propertyId}` }
                ];
                
                const results = {};
                for (const test of tests) {
                    try {
                        const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=' + encodeURIComponent(test.endpoint), {
                            method: 'GET'
                        });
                        results[test.name] = {
                            success: response.success,
                            hasData: response.payPropResponse && response.payPropResponse.items && response.payPropResponse.items.length > 0
                        };
                    } catch (error) {
                        results[test.name] = { success: false, error: error.message };
                    }
                }
                
                showResult('comprehensiveTestResult', {
                    status: 'SUCCESS',
                    property_id: propertyId,
                    test_results: results,
                    summary: 'Multi-endpoint property test completed'
                }, '🏠 Property Test Results: ' + propertyId);
                
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Property Test Failed');
            }
        }
        
        async function testWithPropertyGroup(propertyIds) {
            try {
                const ids = propertyIds.split(',');
                showResult('comprehensiveTestResult', { 
                    status: 'INFO', 
                    message: 'Testing bulk operations with ' + ids.length + ' properties...',
                    property_ids: ids
                }, '🏘️ Bulk Property Test');
                
                const results = {};
                for (const propertyId of ids) {
                    try {
                        const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=' + encodeURIComponent(`report/all-payments?property_id=${propertyId.trim()}&rows=5`), {
                            method: 'GET'
                        });
                        results[propertyId.trim()] = {
                            success: response.success,
                            payments: response.payPropResponse && response.payPropResponse.items ? response.payPropResponse.items.length : 0
                        };
                    } catch (error) {
                        results[propertyId.trim()] = { success: false, error: error.message };
                    }
                }
                
                showResult('comprehensiveTestResult', {
                    status: 'SUCCESS',
                    property_group: propertyIds,
                    individual_results: results,
                    bulk_recommendation: 'Consider using bulk API endpoints for better performance'
                }, '🏘️ Bulk Test Results');
                
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Bulk Test Failed');
            }
        }
        
        async function runAllComprehensiveTests() {
            try {
                showResult('comprehensiveTestResult', { status: 'INFO', message: 'Starting comprehensive API capability analysis...' }, '🚀 Comprehensive Test Suite');
                
                const testSuite = [
                    { name: 'Invoice Instructions', func: testInvoiceInstructions },
                    { name: 'Invoice Categories', func: testInvoiceCategories },
                    { name: 'Adhoc Payments', func: testAdhocPayments },
                    { name: 'Secondary Payments', func: testSecondaryPayments },
                    { name: 'Posted Payments', func: testPostedPayments },
                    { name: 'Commission Analytics', func: testCommissionSummaryReport },
                    { name: 'Webhook Configuration', func: testWebhookConfiguration }
                ];
                
                const results = {};
                for (const test of testSuite) {
                    try {
                        showResult('comprehensiveTestResult', { status: 'INFO', message: 'Running: ' + test.name }, '🔄 Testing: ' + test.name);
                        await test.func();
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limiting
                        results[test.name] = 'completed';
                    } catch (error) {
                        results[test.name] = 'failed: ' + error.message;
                    }
                }
                
                showResult('comprehensiveTestResult', {
                    status: 'SUCCESS',
                    comprehensive_results: results,
                    timestamp: new Date().toISOString(),
                    next_steps: [
                        'Review individual test results above',
                        'Identify missing API capabilities', 
                        'Prioritize implementation based on business value',
                        'Consider webhook integration for real-time updates'
                    ]
                }, '✅ Comprehensive Test Suite Complete');
                
            } catch (error) {
                showResult('comprehensiveTestResult', { status: 'ERROR', error: error.message }, '❌ Comprehensive Test Failed');
            }
        }
        
        async function loadDynamicTestData() {
            try {
                showResult('testDataResult', { status: 'INFO', message: 'Loading fresh test data from database...' }, '🔄 Loading Test Data');
                
                // This would call a new endpoint to get fresh test data
                const response = await fetchWithCSRF('/employee/property/1/financial-summary', {
                    method: 'GET'
                });
                
                showResult('testDataResult', {
                    status: 'INFO',
                    message: 'Use the SQL queries above to get fresh test data from your database',
                    sample_response: response,
                    note: 'Create a new controller endpoint to fetch dynamic test data if needed'
                }, '📊 Test Data Helper');
                
            } catch (error) {
                showResult('testDataResult', { status: 'WARNING', message: 'Use the provided SQL queries to get test data manually' }, '💡 Test Data Instructions');
            }
        }
        
        // Additional test functions for remaining capabilities
        async function testRecurringInvoices() {
            await testEndpointHelper('export/invoices?type=recurring', 'Recurring Invoices', 'Monthly rent schedules and recurring charges');
        }
        
        async function testInvoiceToPaymentLinking() {
            await testEndpointHelper('invoices/12345/payments', 'Invoice-Payment Links', 'Links between invoice instructions and actual payments');
        }
        
        async function testBulkPaymentInstructions() {
            await testEndpointHelper('payments/bulk-instructions', 'Bulk Payment Instructions', 'Process multiple payment instructions in single API call');
        }
        
        async function testPaymentVarianceReport() {
            await testEndpointHelper('reports/payment-variance', 'Payment Variance Report', 'Differences between instructed vs actual payments');
        }
        
        async function testTenantArrearsReport() {
            await testEndpointHelper('reports/tenant-arrears', 'Tenant Arrears Report', 'Overdue payment tracking and management');
        }
        
        async function testCashFlowReport() {
            await testEndpointHelper('reports/cash-flow', 'Cash Flow Forecast', 'Future cash flow projections based on instructions');
        }
        
        async function testRealTimeReporting() {
            await testEndpointHelper('reports/real-time', 'Real-time Reports', 'Live financial data and status updates');
        }
        
        async function testNotificationEndpoints() {
            await testEndpointHelper('notifications/configure', 'Notification Configuration', 'Custom notification setup and management');
        }
        
        async function testWebhookPayload() {
            await testEndpointHelper('webhooks/test-payload', 'Webhook Payload Test', 'Test webhook data structure and delivery');
        }
        
        async function testEndpointHelper(endpoint, name, description) {
            try {
                const response = await fetchWithCSRF('/api/payprop/test/custom-endpoint?endpoint=' + encodeURIComponent(endpoint), {
                    method: 'GET'
                });
                
                showResult('comprehensiveTestResult', {
                    status: response.success ? 'SUCCESS' : 'WARNING',
                    endpoint: endpoint,
                    description: description,
                    available: response.success,
                    data: response
                }, (response.success ? '✅ ' : '⚠️ ') + name);
            } catch (error) {
                showResult('comprehensiveTestResult', { 
                    status: 'ERROR', 
                    endpoint: endpoint,
                    error: error.message 
                }, '❌ ' + name + ' Failed');
            }
        }
        
        function exportTestResults() {
            const resultElement = document.getElementById('comprehensiveTestResult');
            if (resultElement) {
                const content = resultElement.textContent || resultElement.innerText;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'payprop-test-results-' + new Date().toISOString().split('T')[0] + '.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // ===== PayProp Endpoint Testing JavaScript Functions =====

        let allEndpointResults = {};

        async function testCriticalMissingEndpoints() {
            showLoadingState('endpointTestResults', 'Testing critical missing endpoints...');
            
            try {
                const response = await fetch('/api/payprop/endpoint-test/test-critical-missing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayEndpointResults(result, 'Critical Missing Endpoints Test');
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing critical endpoints: ' + error.message);
            }
        }

        async function testAllEndpoints() {
            showLoadingState('endpointTestResults', 'Testing all 37+ PayProp endpoints... This may take 2-3 minutes with rate limiting.');
            
            try {
                const response = await fetch('/api/payprop/endpoint-test/test-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                allEndpointResults = result;
                displayComprehensiveResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing all endpoints: ' + error.message);
            }
        }

        async function testSingleEndpoint() {
            const selectedEndpoint = document.getElementById('endpointSelect').value;
            
            if (!selectedEndpoint) {
                alert('Please select an endpoint to test');
                return;
            }
            
            showLoadingState('endpointTestResults', `Testing ${selectedEndpoint}...`);
            
            try {
                const response = await fetch('/api/payprop/endpoint-test/test-single', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({
                        endpointKey: selectedEndpoint
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displaySingleEndpointResult(result, selectedEndpoint);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing endpoint: ' + error.message);
            }
        }

        async function listAllEndpoints() {
            showLoadingState('endpointTestResults', 'Loading endpoint list...');
            
            try {
                const response = await fetch('/api/payprop/endpoint-test/list-endpoints', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayEndpointList(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error loading endpoint list: ' + error.message);
            }
        }

        function displayEndpointResults(result, title) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>${title} - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                    </div>
                `;
                return;
            }
            
            let html = `<div class="result-success">
                <h5>${title} - Results</h5>
                <p><strong>Endpoints Tested:</strong> ${result.critical_endpoints_tested || Object.keys(result.results || {}).length}</p>
            `;
            
            if (result.results) {
                html += '<div class="mt-3"><h6>Individual Results:</h6>';
                
                for (const [endpointKey, endpointResult] of Object.entries(result.results)) {
                    const statusClass = endpointResult.success ? 'text-success' : 'text-danger';
                    const statusIcon = endpointResult.success ? '✅' : '❌';
                    
                    html += `
                        <div class="border-bottom pb-2 mb-2">
                            <strong class="${statusClass}">${statusIcon} ${endpointKey}</strong><br>
                            <small class="text-muted">Endpoint: ${endpointResult.endpoint || 'N/A'}</small><br>
                            <small class="text-muted">Permission: ${endpointResult.expected_permission || 'N/A'}</small>
                    `;
                    
                    if (endpointResult.success) {
                        html += `<br><small class="text-success">Status: ${endpointResult.status_code}, Response Time: ${endpointResult.response_time_ms}ms</small>`;
                        if (endpointResult.has_data_array || endpointResult.has_data_object) {
                            html += `<br><small class="text-info">✅ Contains Data</small>`;
                        }
                    } else {
                        html += `<br><small class="text-danger">Error: ${endpointResult.error}</small>`;
                        if (endpointResult.suggestion) {
                            html += `<br><small class="text-warning">💡 ${endpointResult.suggestion}</small>`;
                        }
                    }
                    
                    html += '</div>';
                }
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayComprehensiveResults(result) {
            // Show summary section
            document.getElementById('endpointSummarySection').style.display = 'block';
            
            // Update summary cards
            const summaryContainer = document.getElementById('endpointSummaryCards');
            summaryContainer.innerHTML = `
                <div class="col-md-3">
                    <div class="card text-center bg-success text-white">
                        <div class="card-body">
                            <h4>${result.successful || 0}</h4>
                            <p>Successful</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-warning text-dark">
                        <div class="card-body">
                            <h4>${result.unauthorized || 0}</h4>
                            <p>Unauthorized</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-info text-white">
                        <div class="card-body">
                            <h4>${result.not_found || 0}</h4>
                            <p>Not Found</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-danger text-white">
                        <div class="card-body">
                            <h4>${result.errors || 0}</h4>
                            <p>Other Errors</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Show detailed results
            displayEndpointResults(result, 'Comprehensive Endpoint Test');
            
            // Create analysis
            const analysisHtml = generateEndpointAnalysis(result);
            const detailedContainer = document.getElementById('endpointDetailedResults');
            detailedContainer.innerHTML = analysisHtml;
        }

        function displaySingleEndpointResult(result, endpointKey) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            const statusClass = result.success ? 'result-success' : 'result-error';
            const statusIcon = result.success ? '✅' : '❌';
            
            let html = `<div class="${statusClass}">
                <h5>${statusIcon} ${endpointKey} Test Result</h5>
                <p><strong>Endpoint:</strong> ${result.endpoint || 'N/A'}</p>
                <p><strong>Expected Permission:</strong> ${result.expected_permission || 'N/A'}</p>
            `;
            
            if (result.success) {
                html += `
                    <p><strong>Status Code:</strong> ${result.status_code}</p>
                    <p><strong>Response Time:</strong> ${result.response_time_ms}ms</p>
                    <p><strong>Has Data:</strong> ${result.has_data ? 'Yes' : 'No'}</p>
                `;
                
                if (result.sample_response) {
                    html += `
                        <details class="mt-3">
                            <summary><strong>Sample Response</strong></summary>
                            <pre class="mt-2" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-size: 0.8rem;">${result.sample_response}</pre>
                        </details>
                    `;
                }
            } else {
                html += `
                    <p><strong>Error:</strong> ${result.error}</p>
                    <p><strong>Error Type:</strong> ${result.error_type || 'Unknown'}</p>
                `;
                
                if (result.suggestion) {
                    html += `<p><strong>💡 Suggestion:</strong> ${result.suggestion}</p>`;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayEndpointList(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>Error Loading Endpoints</h5>
                        <p>${result.error}</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>Available PayProp Endpoints (${result.total_endpoints})</h5>
                    <div class="table-responsive mt-3">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Endpoint</th>
                                    <th>Method</th>
                                    <th>Description</th>
                                    <th>Permission</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            for (const [key, endpoint] of Object.entries(result.endpoints)) {
                const criticalClass = key.includes('export-invoices') || key.includes('export-payments') ? 'table-warning' : '';
                
                html += `
                    <tr class="${criticalClass}">
                        <td><code>${key}</code></td>
                        <td><code>${endpoint.path}</code></td>
                        <td><span class="badge bg-secondary">${endpoint.method}</span></td>
                        <td>${endpoint.description}</td>
                        <td><small>${endpoint.permission}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="testSpecificEndpoint('${key}')">
                                Test
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function testSpecificEndpoint(endpointKey) {
            // Set the select dropdown and trigger test
            document.getElementById('endpointSelect').value = endpointKey;
            await testSingleEndpoint();
        }

        function generateEndpointAnalysis(result) {
            if (!result.results) return '';
            
            const successfulEndpoints = [];
            const failedEndpoints = [];
            const criticalMissing = [];
            
            for (const [key, endpointResult] of Object.entries(result.results)) {
                if (endpointResult.success) {
                    successfulEndpoints.push(key);
                } else {
                    failedEndpoints.push({ key, error: endpointResult.error, suggestion: endpointResult.suggestion });
                }
                
                // Check for critical endpoints
                if ((key.includes('export-invoices') || key.includes('export-payments') || key.includes('invoices-categories')) && !endpointResult.success) {
                    criticalMissing.push(key);
                }
            }
            
            let html = `
                <div class="mt-4">
                    <h6>🔍 Analysis & Recommendations</h6>
            `;
            
            if (criticalMissing.length > 0) {
                html += `
                    <div class="alert alert-danger">
                        <h6>🚨 Critical Missing Capabilities</h6>
                        <p>These endpoints are essential for complete PayProp integration:</p>
                        <ul>
                            ${criticalMissing.map(key => `<li><strong>${key}</strong> - Required for missing data gap identified in documentation</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (successfulEndpoints.length > 0) {
                html += `
                    <div class="alert alert-success">
                        <h6>✅ Available Capabilities (${successfulEndpoints.length})</h6>
                        <p>These endpoints are working and can be implemented:</p>
                        <div class="row">
                            ${successfulEndpoints.map(key => `<div class="col-md-6"><code>${key}</code></div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (failedEndpoints.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <h6>⚠️ Issues Found (${failedEndpoints.length})</h6>
                        <p>These endpoints may require additional permissions or don't exist in your PayProp setup:</p>
                `;
                
                failedEndpoints.forEach(item => {
                    html += `<div class="mb-2"><strong>${item.key}:</strong> ${item.error}`;
                    if (item.suggestion) {
                        html += `<br><small class="text-muted">💡 ${item.suggestion}</small>`;
                    }
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function showLoadingState(containerId, message) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">${message}</p>
                </div>
            `;
        }

        function showErrorResult(containerId, errorMessage) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.innerHTML = `
                <div class="result-error">
                    <h5>❌ Error</h5>
                    <p>${errorMessage}</p>
                </div>
            `;
        }

        // ===== Enhanced Raw Import System Functions =====

        async function testRawImportSystem() {
            showLoadingState('endpointTestResults', 'Testing enhanced raw import system with all working endpoints...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/sync-all-endpoints', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayRawImportResults(result, 'Enhanced Raw Import System Test');
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing raw import system: ' + error.message);
            }
        }

        // Import control functions
        async function checkImportStatus() {
            try {
                const response = await fetch('/api/payprop/raw-import/status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Update UI based on status
                const cancelBtn = document.getElementById('cancelBtn');
                const isRunning = result.import_status !== 'idle';
                cancelBtn.disabled = !isRunning;
                
                // Show status
                const statusHtml = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Import Status</h6>
                        <p><strong>Status:</strong> ${result.import_status}</p>
                        <p><strong>Cancel Available:</strong> ${result.cancel_available ? 'Yes' : 'No'}</p>
                        <p><strong>Working Endpoints:</strong> ${result.working_endpoints}</p>
                    </div>
                `;
                
                document.getElementById('endpointTestResults').innerHTML = statusHtml;
                document.getElementById('endpointTestResults').style.display = 'block';
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error checking import status: ' + error.message);
            }
        }

        async function cancelImport() {
            if (!confirm('Are you sure you want to cancel the running import?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/payprop/raw-import/cancel-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                const statusHtml = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-stop-circle"></i> Import Cancellation</h6>
                        <p>${result.message}</p>
                        <p><strong>Status:</strong> ${result.status}</p>
                    </div>
                `;
                
                document.getElementById('endpointTestResults').innerHTML = statusHtml;
                document.getElementById('endpointTestResults').style.display = 'block';
                
                // Disable cancel button
                document.getElementById('cancelBtn').disabled = true;
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error cancelling import: ' + error.message);
            }
        }

        async function resetImport() {
            try {
                const response = await fetch('/api/payprop/raw-import/reset-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                const statusHtml = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-refresh"></i> Import Reset</h6>
                        <p>${result.message}</p>
                        <p><strong>Status:</strong> ${result.status}</p>
                    </div>
                `;
                
                document.getElementById('endpointTestResults').innerHTML = statusHtml;
                document.getElementById('endpointTestResults').style.display = 'block';
                
                // Disable cancel button
                document.getElementById('cancelBtn').disabled = true;
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error resetting import: ' + error.message);
            }
        }

        async function fixAllPaymentsPagination() {
            showLoadingState('endpointTestResults', 'Fixing all-payments pagination to get ALL payments (not just 60)...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/fix-all-payments-pagination', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayRawImportResults(result, 'All-Payments Pagination Fix');
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error fixing all-payments pagination: ' + error.message);
            }
        }

        async function testLimitedAllPayments() {
            showLoadingState('endpointTestResults', 'Testing all-payments with limited records for structure inspection...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-limited-all-payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayLimitedAllPaymentsResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing limited all-payments: ' + error.message);
            }
        }

        async function testCompleteBeneficiariesImport() {
            showLoadingState('endpointTestResults', 'Testing complete beneficiaries import with new table structure...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-complete-beneficiaries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayCompleteBeneficiariesResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing complete beneficiaries import: ' + error.message);
            }
        }

        async function testCompleteTenantsImport() {
            showLoadingState('endpointTestResults', 'Testing complete tenants import with new table structure...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-complete-tenants', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayCompleteTenantsResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing complete tenants import: ' + error.message);
            }
        }

        async function testCompletePropertiesImport() {
            showLoadingState('endpointTestResults', 'Testing complete properties import - resolving tenant foreign key constraints...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-complete-properties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayCompletePropertiesResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing complete properties import: ' + error.message);
            }
        }

        async function testCompleteInvoicesImport() {
            showLoadingState('endpointTestResults', 'Testing complete invoices import - CRITICAL £1,075 DATA...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-complete-invoices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayCompleteInvoicesResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing complete invoices import: ' + error.message);
            }
        }

        async function testCompletePaymentsImport() {
            showLoadingState('endpointTestResults', 'Testing complete payments import - Transaction data...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-complete-payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayCompletePaymentsResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing complete payments import: ' + error.message);
            }
        }

        async function testCompleteAllPaymentsImport() {
            showLoadingState('endpointTestResults', 'Testing complete all-payments import - 7,414+ transaction records with historical chunking...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-complete-all-payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayCompleteAllPaymentsResults(result);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing complete all-payments import: ' + error.message);
            }
        }

        async function getSampleDataFromEndpoint() {
            const selectedEndpoint = document.getElementById('sampleEndpointSelect').value;
            
            if (!selectedEndpoint) {
                alert('Please select an endpoint to get sample data from');
                return;
            }
            
            showLoadingState('endpointTestResults', `Getting sample data from ${selectedEndpoint}...`);
            
            try {
                const response = await fetch(`/api/payprop/raw-import/sample-data/${selectedEndpoint}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displaySampleDataResults(result, selectedEndpoint);
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error getting sample data: ' + error.message);
            }
        }

        async function testCurrentFinancialSync() {
            showLoadingState('endpointTestResults', 'Testing current PayProp financial sync service...');
            
            try {
                const response = await fetch('/api/payprop/raw-import/test-current-financial-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                displayRawImportResults(result, 'Current Financial Sync Test');
                
            } catch (error) {
                showErrorResult('endpointTestResults', 'Error testing current financial sync: ' + error.message);
            }
        }

        function displayRawImportResults(result, title) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>${title} - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.note ? `<p><strong>Note:</strong> ${result.note}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `<div class="result-success">
                <h5>${title} - Results</h5>
                <p><strong>Status:</strong> ${result.message}</p>
            `;
            
            // Show summary if available
            if (result.summary) {
                html += `
                    <div class="mt-3">
                        <h6>📊 Summary:</h6>
                        <ul>
                            <li><strong>Total Endpoints:</strong> ${result.summary.total_endpoints || 'N/A'}</li>
                            <li><strong>Successful:</strong> ${result.summary.successful || 'N/A'}</li>
                            <li><strong>Errors:</strong> ${result.summary.errors || 'N/A'}</li>
                            <li><strong>Duration:</strong> ${result.summary.duration_ms || 'N/A'}ms</li>
                        </ul>
                    </div>
                `;
            }
            
            // Show endpoint results if available
            if (result.endpoint_results) {
                html += '<div class="mt-3"><h6>📋 Endpoint Results:</h6>';
                
                for (const [endpointKey, endpointResult] of Object.entries(result.endpoint_results)) {
                    const statusClass = endpointResult.success ? 'text-success' : 'text-danger';
                    const statusIcon = endpointResult.success ? '✅' : '❌';
                    
                    html += `
                        <div class="border-bottom pb-2 mb-2">
                            <strong class="${statusClass}">${statusIcon} ${endpointKey}</strong><br>
                            <small class="text-muted">Endpoint: ${endpointResult.endpoint || 'N/A'}</small><br>
                            <small class="text-muted">Description: ${endpointResult.description || 'N/A'}</small>
                    `;
                    
                    if (endpointResult.success) {
                        html += `<br><small class="text-success">Items: ${endpointResult.total_items}</small>`;
                    } else {
                        html += `<br><small class="text-danger">Error: ${endpointResult.error}</small>`;
                    }
                    
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Show special results for all-payments fix
            if (result.all_payments_result) {
                html += `
                    <div class="mt-3 alert alert-info">
                        <h6>🔧 All-Payments Fix Results:</h6>
                        <p><strong>Total Payments Retrieved:</strong> ${result.all_payments_result.totalProcessed || 'N/A'}</p>
                        <p><strong>Note:</strong> ${result.note || 'All payments pagination has been fixed'}</p>
                    </div>
                `;
            }
            
            // Show sample records and structure if available
            if (result.sample_records && result.sample_records.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6>📊 Sample Records (${result.sample_records.length} of ${result.all_payments_result?.totalProcessed || 'N/A'}):</h6>
                        <div class="alert alert-secondary">
                            <p><strong>Record Structure:</strong> ${result.total_fields_in_record || 'N/A'} fields per record</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleSampleData('sampleRecordsDiv')">Show/Hide Sample Data</button>
                        </div>
                        <div id="sampleRecordsDiv" style="display:none;" class="mt-2">
                            <div class="json-viewer">
                                <pre>${JSON.stringify(result.sample_records, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show sample record structure if available
            if (result.sample_record_structure) {
                html += `
                    <div class="mt-3">
                        <h6>🏗️ Record Structure Example:</h6>
                        <div class="alert alert-secondary">
                            <button class="btn btn-sm btn-outline-info" onclick="toggleSampleData('recordStructureDiv')">Show/Hide Record Structure</button>
                        </div>
                        <div id="recordStructureDiv" style="display:none;" class="mt-2">
                            <div class="json-viewer">
                                <pre>${JSON.stringify(result.sample_record_structure, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Show additional data notes
            if (result.note_about_data) {
                html += `
                    <div class="mt-3 alert alert-warning">
                        <p><strong>📝 Data Note:</strong> ${result.note_about_data}</p>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displaySampleDataResults(result, endpointKey) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>Sample Data Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        <p><strong>Endpoint:</strong> ${endpointKey}</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>📊 Sample Data: ${endpointKey}</h5>
                    <p><strong>Description:</strong> ${result.description}</p>
                    <p><strong>Items Retrieved:</strong> ${result.sample_data.totalProcessed || 'N/A'}</p>
            `;
            
            // Show first few items if available
            if (result.sample_data.items && result.sample_data.items.length > 0) {
                html += `
                    <details class="mt-3">
                        <summary><strong>Sample Items (${result.sample_data.items.length})</strong></summary>
                        <pre class="mt-2" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-size: 0.8rem; max-height: 400px; overflow-y: auto;">${JSON.stringify(result.sample_data.items.slice(0, 3), null, 2)}</pre>
                    </details>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayLimitedAllPaymentsResults(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>🧪 Limited All-Payments Test - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>🧪 Limited All-Payments Test Results</h5>
                    <p><strong>Total Records Available:</strong> ${result.totalRecords || 'N/A'}</p>
                    <p><strong>Limited To:</strong> ${result.limitedCount || 'N/A'} records for inspection</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'N/A'}ms</p>
                    <p><strong>Data Structure:</strong> ${result.fieldsPerRecord || 'N/A'} fields per record</p>
            `;
            
            // Show the actual records with detailed structure
            if (result.sampleRecords && result.sampleRecords.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6>📋 Sample Records (${result.sampleRecords.length}):</h6>
                        <div class="alert alert-info">
                            <p><strong>Note:</strong> Import stopped after ${result.limitedCount} records to examine structure without timeout.</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleSampleData('limitedPaymentRecords')">Show/Hide Raw Data Structure</button>
                        </div>
                        <div id="limitedPaymentRecords" style="display:none;" class="mt-2">
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 4px; font-size: 0.8rem; max-height: 500px; overflow-y: auto;">${JSON.stringify(result.sampleRecords, null, 2)}</pre>
                        </div>
                    </div>
                `;
            }
            
            // Show field analysis if available
            if (result.fieldAnalysis) {
                html += `
                    <div class="mt-3">
                        <h6>🔍 Field Analysis:</h6>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-size: 0.9rem;">
                            <pre>${JSON.stringify(result.fieldAnalysis, null, 2)}</pre>
                        </div>
                    </div>
                `;
            }
            
            // Show any nested structure warnings
            if (result.nestedStructureWarning) {
                html += `
                    <div class="alert alert-warning mt-3">
                        <h6>⚠️ Nested Structure Detected:</h6>
                        <p>${result.nestedStructureWarning}</p>
                    </div>
                `;
            }
            
            // Show troubleshooting information if no data found
            if (result.troubleshooting) {
                html += `
                    <div class="alert alert-info mt-3">
                        <h6>🔍 No Data Found - Troubleshooting:</h6>
                        <p><strong>Issue:</strong> ${result.troubleshooting.issue}</p>
                        
                        <p><strong>Possible Causes:</strong></p>
                        <ul>
                            ${result.troubleshooting.possibleCauses.map(cause => `<li>${cause}</li>`).join('')}
                        </ul>
                        
                        <p><strong>Suggested Actions:</strong></p>
                        <ul>
                            ${result.troubleshooting.suggestedActions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                        
                        <p><strong>Endpoint Tested:</strong> <code>${result.endpointTested || 'N/A'}</code></p>
                        ${result.dateRangeUsed ? `<p><strong>Date Range:</strong> ${result.actualDateRange} (${result.dateRangeUsed})</p>` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayCompleteBeneficiariesResults(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>🏦 Complete Beneficiaries Import - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>🏦 Complete Beneficiaries Import Results</h5>
                    <p><strong>Endpoint:</strong> ${result.endpoint || '/export/beneficiaries'}</p>
                    <p><strong>Total Fetched:</strong> ${result.totalFetched || 'N/A'} beneficiaries</p>
                    <p><strong>Total Imported:</strong> ${result.totalImported || 'N/A'} beneficiaries</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'N/A'}ms</p>
                    <p><strong>Import Status:</strong> <span class="badge bg-success">Complete</span></p>
            `;
            
            // Show success details
            if (result.details) {
                html += `
                    <div class="mt-3">
                        <h6>📋 Import Summary:</h6>
                        <div class="alert alert-success">
                            <p>${result.details}</p>
                        </div>
                    </div>
                `;
            }
            
            // Show table information
            html += `
                <div class="mt-3">
                    <h6>🗄️ Database Table:</h6>
                    <div class="alert alert-info">
                        <p><strong>Table:</strong> <code>payprop_export_beneficiaries_complete</code></p>
                        <p><strong>Features:</strong> 40+ fields with nested address flattening, properties JSON, complete contact details</p>
                        <p><strong>Method:</strong> Proof of concept using new complete import service pattern</p>
                    </div>
                </div>
            `;
            
            // Show next steps
            html += `
                <div class="mt-3">
                    <h6>🚀 Proof of Concept Success:</h6>
                    <div class="alert alert-primary">
                        <ul class="mb-0">
                            <li>✅ New table structure working</li>
                            <li>✅ Nested object flattening working</li>
                            <li>✅ Clean import service pattern validated</li>
                            <li>🎯 Ready to scale to other 8 endpoints</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Add verification query
            html += `
                <div class="mt-3">
                    <h6>🔍 Verify Results:</h6>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                        <p><strong>Check imported data:</strong></p>
                        <code>SELECT COUNT(*) FROM payprop_export_beneficiaries_complete;</code><br>
                        <code>SELECT display_name, email_address, address_city, total_properties FROM payprop_export_beneficiaries_complete LIMIT 5;</code>
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayCompleteTenantsResults(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>👥 Complete Tenants Import - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>👥 Complete Tenants Import Results</h5>
                    <p><strong>Endpoint:</strong> ${result.endpoint || '/export/tenants'}</p>
                    <p><strong>Total Fetched:</strong> ${result.totalFetched || 'N/A'} tenants</p>
                    <p><strong>Total Imported:</strong> ${result.totalImported || 'N/A'} tenants</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'N/A'}ms</p>
                    <p><strong>Import Status:</strong> <span class="badge bg-success">Complete</span></p>
            `;
            
            // Show success details
            if (result.details) {
                html += `
                    <div class="mt-3">
                        <h6>📋 Import Summary:</h6>
                        <div class="alert alert-success">
                            <p>${result.details}</p>
                        </div>
                    </div>
                `;
            }
            
            // Show table information
            html += `
                <div class="mt-3">
                    <h6>🗄️ Database Table:</h6>
                    <div class="alert alert-info">
                        <p><strong>Table:</strong> <code>payprop_export_tenants_complete</code></p>
                        <p><strong>Features:</strong> 35+ fields with nested address flattening, property relationships, tenancy details</p>
                        <p><strong>Method:</strong> Scaling proven beneficiaries import pattern</p>
                    </div>
                </div>
            `;
            
            // Show scaling progress
            html += `
                <div class="mt-3">
                    <h6>🚀 Scaling Progress:</h6>
                    <div class="alert alert-primary">
                        <ul class="mb-0">
                            <li>✅ Beneficiaries complete import working (173/174)</li>
                            <li>✅ Tenants complete import pattern validated</li>
                            <li>🎯 Template ready for remaining 7 endpoints</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Add verification query
            html += `
                <div class="mt-3">
                    <h6>🔍 Verify Results:</h6>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                        <p><strong>Check imported tenants:</strong></p>
                        <code>SELECT COUNT(*) FROM payprop_export_tenants_complete;</code><br>
                        <code>SELECT first_name, last_name, email, current_property_id, monthly_rent_amount FROM payprop_export_tenants_complete LIMIT 5;</code>
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayCompletePropertiesResults(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>🏠 Complete Properties Import - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>🏠 Complete Properties Import Results</h5>
                    <p><strong>Endpoint:</strong> ${result.endpoint || '/export/properties'}</p>
                    <p><strong>Total Fetched:</strong> ${result.totalFetched || 'N/A'} properties</p>
                    <p><strong>Total Imported:</strong> ${result.totalImported || 'N/A'} properties</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'N/A'}ms</p>
                    <p><strong>Import Status:</strong> <span class="badge bg-success">Complete</span></p>
            `;
            
            // Show success details
            if (result.details) {
                html += `
                    <div class="mt-3">
                        <h6>📋 Import Summary:</h6>
                        <div class="alert alert-success">
                            <p>${result.details}</p>
                        </div>
                    </div>
                `;
            }
            
            // Show table information
            html += `
                <div class="mt-3">
                    <h6>🗄️ Database Table:</h6>
                    <div class="alert alert-info">
                        <p><strong>Table:</strong> <code>payprop_export_properties</code></p>
                        <p><strong>Features:</strong> 35+ fields with nested address/settings flattening, monthly payment data</p>
                        <p><strong>Method:</strong> Using proven beneficiaries import pattern</p>
                        <p><strong>Purpose:</strong> Resolves tenant foreign key constraints</p>
                    </div>
                </div>
            `;
            
            // Show scaling progress
            html += `
                <div class="mt-3">
                    <h6>🚀 Next Steps:</h6>
                    <div class="alert alert-warning">
                        <p><strong>Order Matters:</strong> Properties must be imported before tenants</p>
                        <p><strong>After this import:</strong> Re-run tenants import to resolve foreign key failures</p>
                        <p><strong>Check imported properties:</strong></p>
                        <code>SELECT COUNT(*) FROM payprop_export_properties;</code><br>
                        <code>SELECT name, settings_monthly_payment, address_city FROM payprop_export_properties LIMIT 5;</code>
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayCompleteInvoicesResults(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>🧾 Complete Invoices Import - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>🧾 Complete Invoices Import Results - CRITICAL £1,075 DATA</h5>
                    <p><strong>Endpoint:</strong> ${result.endpoint || '/export/invoices'}</p>
                    <p><strong>Total Fetched:</strong> ${result.totalFetched || 'N/A'} invoices</p>
                    <p><strong>Total Imported:</strong> ${result.totalImported || 'N/A'} invoices</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'N/A'}ms</p>
                    <p><strong>Import Status:</strong> <span class="badge bg-success">Complete</span></p>
            `;
            
            // Show success details
            if (result.details) {
                html += `
                    <div class="mt-3">
                        <h6>📋 Import Summary:</h6>
                        <div class="alert alert-success">
                            <p>${result.details}</p>
                        </div>
                    </div>
                `;
            }
            
            // Show table information
            html += `
                <div class="mt-3">
                    <h6>🗄️ Database Table:</h6>
                    <div class="alert alert-info">
                        <p><strong>Table:</strong> <code>payprop_export_invoices</code></p>
                        <p><strong>Features:</strong> 26 fields with property/tenant foreign keys</p>
                        <p><strong>Critical Field:</strong> <code>gross_amount</code> - Contains the authoritative £1,075 rent amount</p>
                        <p><strong>Purpose:</strong> Source of missing rent amounts for business logic</p>
                    </div>
                </div>
            `;
            
            // Show verification query
            html += `
                <div class="mt-3">
                    <h6>🔍 Verify Results:</h6>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                        <p><strong>Check imported data:</strong></p>
                        <code>SELECT COUNT(*) FROM payprop_export_invoices;</code><br>
                        <code>SELECT description, gross_amount, property_name, tenant_display_name FROM payprop_export_invoices LIMIT 5;</code><br>
                        <code>SELECT * FROM payprop_export_invoices WHERE gross_amount = 1075.00;</code>
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayCompletePaymentsResults(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>💳 Complete Payments Import - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>💳 Complete Payments Import Results - Transaction Data</h5>
                    <p><strong>Endpoint:</strong> ${result.endpoint || '/export/payments'}</p>
                    <p><strong>Total Fetched:</strong> ${result.totalFetched || 'N/A'} payments</p>
                    <p><strong>Total Imported:</strong> ${result.totalImported || 'N/A'} payments</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'N/A'}ms</p>
                    <p><strong>Import Status:</strong> <span class="badge bg-success">Complete</span></p>
            `;
            
            // Show success details
            if (result.details) {
                html += `
                    <div class="mt-3">
                        <h6>📋 Import Summary:</h6>
                        <div class="alert alert-success">
                            <p>${result.details}</p>
                        </div>
                    </div>
                `;
            }
            
            // Show table information
            html += `
                <div class="mt-3">
                    <h6>🗄️ Database Table:</h6>
                    <div class="alert alert-info">
                        <p><strong>Table:</strong> <code>payprop_export_payments</code></p>
                        <p><strong>Features:</strong> 22 fields with property/tenant foreign keys</p>
                        <p><strong>Critical Fields:</strong> <code>amount</code>, <code>payment_date</code>, <code>payment_type</code></p>
                        <p><strong>Purpose:</strong> Source of actual payment transactions and amounts</p>
                    </div>
                </div>
            `;
            
            // Show verification query
            html += `
                <div class="mt-3">
                    <h6>🔍 Verify Results:</h6>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                        <p><strong>Check imported data:</strong></p>
                        <code>SELECT COUNT(*) FROM payprop_export_payments;</code><br>
                        <code>SELECT description, amount, payment_type, property_name, tenant_display_name FROM payprop_export_payments LIMIT 5;</code><br>
                        <code>SELECT SUM(amount) as total_payments FROM payprop_export_payments;</code>
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayCompleteAllPaymentsResults(result) {
            const container = document.getElementById('endpointTestResults');
            container.style.display = 'block';
            
            if (!result.success) {
                container.innerHTML = `
                    <div class="result-error">
                        <h5>💰 Complete All-Payments Import - Error</h5>
                        <p><strong>Error:</strong> ${result.error}</p>
                        ${result.details ? `<p><strong>Details:</strong> ${result.details}</p>` : ''}
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="result-success">
                    <h5>💰 Complete All-Payments Import Results - 7,414+ Transaction Records</h5>
                    <p><strong>Endpoint:</strong> ${result.endpoint || '/report/all-payments'}</p>
                    <p><strong>Total Fetched:</strong> ${result.totalFetched || 'N/A'} transactions</p>
                    <p><strong>Total Imported:</strong> ${result.totalImported || 'N/A'} transactions</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'N/A'}ms</p>
                    <p><strong>Import Status:</strong> <span class="badge bg-success">Complete</span></p>
                    <p><strong>Historical Coverage:</strong> <span class="badge bg-info">93-day chunked import</span></p>
            `;
            
            // Show success details
            if (result.details) {
                html += `
                    <div class="mt-3">
                        <h6>📋 Import Summary:</h6>
                        <div class="alert alert-success">
                            <p>${result.details}</p>
                        </div>
                    </div>
                `;
            }
            
            // Show table information
            html += `
                <div class="mt-3">
                    <h6>🗄️ Database Table:</h6>
                    <div class="alert alert-info">
                        <p><strong>Table:</strong> <code>payprop_report_all_payments</code></p>
                        <p><strong>Features:</strong> 37 fields with complete transaction lifecycle</p>
                        <p><strong>Critical Fields:</strong> <code>amount</code>, <code>reconciliation_date</code>, <code>incoming_transaction_amount</code></p>
                        <p><strong>Purpose:</strong> Complete historical payment transaction data (THE BIG ONE)</p>
                        <p><strong>Chunking:</strong> Historical import using 93-day periods to overcome PayProp API limits</p>
                    </div>
                </div>
            `;
            
            // Show verification query
            html += `
                <div class="mt-3">
                    <h6>🔍 Verify Results:</h6>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.9rem;">
                        <p><strong>Check imported data:</strong></p>
                        <code>SELECT COUNT(*) FROM payprop_report_all_payments;</code><br>
                        <code>SELECT description, amount, reconciliation_date, beneficiary_name, incoming_property_name FROM payprop_report_all_payments LIMIT 5;</code><br>
                        <code>SELECT SUM(amount) as total_amount FROM payprop_report_all_payments;</code><br>
                        <code>SELECT COUNT(*) as chunk_count FROM payprop_report_all_payments GROUP BY DATE(reconciliation_date);</code>
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleSampleData(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>
</body>
</html>