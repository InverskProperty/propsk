<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayProp Enhanced Test Dashboard</title>
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0066cc;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), #004499);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .test-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .test-card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0;
        }
        
        .test-card-body {
            padding: 1.5rem;
        }
        
        .result-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .result-success {
            border-left: 4px solid var(--success-color);
            background-color: #d4edda;
        }
        
        .result-error {
            border-left: 4px solid var(--danger-color);
            background-color: #f8d7da;
        }
        
        .result-warning {
            border-left: 4px solid var(--warning-color);
            background-color: #fff3cd;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-success { background: var(--success-color); color: white; }
        .status-error { background: var(--danger-color); color: white; }
        .status-warning { background: var(--warning-color); color: #856404; }
        .status-info { background: var(--info-color); color: white; }
        
        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .search-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .quick-action-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 20px;
        }
        
        .highlight-match {
            background: yellow;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .data-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .comparison-panel {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
        }
        
        .api-panel {
            border-left: 4px solid var(--info-color);
        }
        
        .database-panel {
            border-left: 4px solid var(--primary-color);
        }
        
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-link {
            border: none;
            color: #666;
            font-weight: 500;
        }
        
        .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-radius: 6px 6px 0 0;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3"><strong>Processing Request...</strong></div>
            <div class="text-muted">This may take a few seconds</div>
        </div>
    </div>

    <div class="dashboard-header">
        <div class="container">
            <h1><i class="fas fa-cogs"></i> PayProp Enhanced Test Dashboard</h1>
            <p class="lead mb-0">Comprehensive PayProp API testing, data investigation, and sync management</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="test-card">
                    <div class="test-card-header">
                        <h5><i class="fas fa-tachometer-alt"></i> System Status Overview</h5>
                    </div>
                    <div class="test-card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100" onclick="checkOAuthStatus()">
                                    <i class="fas fa-key"></i> Check OAuth Status
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100" onclick="getSyncDashboard()">
                                    <i class="fas fa-chart-bar"></i> Sync Dashboard
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100" onclick="discoverEndpoints()">
                                    <i class="fas fa-search"></i> Discover Endpoints
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100" onclick="testAllConnections()">
                                    <i class="fas fa-plug"></i> Test All Connections
                                </button>
                            </div>
                        </div>
                        <div id="statusOverviewResult" class="result-display d-none"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Testing Interface -->
        <div class="row">
            <div class="col-12">
                <div class="test-card">
                    <div class="test-card-header">
                        <ul class="nav nav-tabs card-header-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#searchTab">
                                    <i class="fas fa-search"></i> Smart Search
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#compareTab">
                                    <i class="fas fa-balance-scale"></i> Compare Endpoints
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#analyzeTab">
                                    <i class="fas fa-microscope"></i> Analyze Transaction
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#batchTab">
                                    <i class="fas fa-layer-group"></i> Batch Analysis
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#syncTab">
                                    <i class="fas fa-sync"></i> Sync Testing
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#rawTab">
                                    <i class="fas fa-code"></i> Raw API
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="test-card-body">
                        <div class="tab-content">
                            
                            <!-- Smart Search Tab -->
                            <div class="tab-pane fade show active" id="searchTab">
                                <h5><i class="fas fa-search"></i> Smart Payment Search</h5>
                                <p class="text-muted">Search across PayProp API and local database with flexible criteria</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">Amount (¬£)</label>
                                            <input type="number" id="searchAmount" class="form-control" placeholder="e.g., 542.75" step="0.01">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" id="searchFromDate" class="form-control" value="">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" id="searchToDate" class="form-control" value="">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Property ID</label>
                                            <input type="text" id="searchPropertyId" class="form-control" placeholder="PayProp Property ID">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Beneficiary Name</label>
                                            <input type="text" id="searchBeneficiaryName" class="form-control" placeholder="e.g., Christopher Booth">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Batch ID</label>
                                            <input type="text" id="searchBatchId" class="form-control" placeholder="PayProp Batch ID">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Transaction ID</label>
                                            <input type="text" id="searchTransactionId" class="form-control" placeholder="PayProp Transaction ID">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Specific Endpoint</label>
                                            <select id="searchEndpoint" class="form-select">
                                                <option value="">Search All Endpoints</option>
                                                <option value="/export/payments">Export Payments</option>
                                                <option value="/report/all-payments">Report All-Payments</option>
                                                <option value="/report/icdn">ICDN Transactions</option>
                                                <option value="/export/invoices">Export Invoices</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-primary quick-action-btn" onclick="smartSearch()">
                                        <i class="fas fa-search"></i> Smart Search
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setDateRange('7days')">Last 7 Days</button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setDateRange('30days')">Last 30 Days</button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setDateRange('3months')">Last 3 Months</button>
                                    <button class="btn btn-outline-warning quick-action-btn" onclick="setChristopherBoothExample()">
                                        <i class="fas fa-bug"></i> Christopher Booth Example
                                    </button>
                                    <button class="btn btn-outline-secondary quick-action-btn" onclick="clearSearchForm()">
                                        <i class="fas fa-eraser"></i> Clear
                                    </button>
                                </div>
                                
                                <div id="smartSearchResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Compare Endpoints Tab -->
                            <div class="tab-pane fade" id="compareTab">
                                <h5><i class="fas fa-balance-scale"></i> Endpoint Comparison</h5>
                                <p class="text-muted">Compare multiple PayProp endpoints with identical criteria</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" id="compareFromDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" id="compareToDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Property ID</label>
                                            <input type="text" id="comparePropertyId" class="form-control" placeholder="Optional">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Filter By</label>
                                            <select id="compareFilterBy" class="form-select">
                                                <option value="">Default</option>
                                                <option value="reconciliation_date">Reconciliation Date</option>
                                                <option value="remittance_date">Remittance Date</option>
                                                <option value="payment_date">Payment Date</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Max Rows Per Endpoint</label>
                                            <input type="number" id="compareMaxRows" class="form-control" value="10" min="1" max="1000">
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" onclick="compareEndpoints()">
                                                <i class="fas fa-balance-scale"></i> Compare All Endpoints
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="compareEndpointsResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Analyze Transaction Tab -->
                            <div class="tab-pane fade" id="analyzeTab">
                                <h5><i class="fas fa-microscope"></i> Transaction Deep Analysis</h5>
                                <p class="text-muted">Detailed analysis of specific transactions with field-by-field comparison</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">PayProp Transaction ID</label>
                                            <input type="text" id="analyzeTransactionId" class="form-control" 
                                                   placeholder="e.g., G1OBKg9aXM (Christopher Booth payment)">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Search Endpoint</label>
                                            <select id="analyzeEndpoint" class="form-select">
                                                <option value="">Search All</option>
                                                <option value="/export/payments">Export Payments</option>
                                                <option value="/report/all-payments">Report All-Payments</option>
                                                <option value="/report/icdn">ICDN</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" onclick="analyzeTransaction()">
                                                <i class="fas fa-microscope"></i> Deep Analyze
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setAnalyzeExample('G1OBKg9aXM')">
                                        Christopher Booth Payment
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setAnalyzeExample('32874683')">
                                        PayProp UI Payment ID
                                    </button>
                                </div>
                                
                                <div id="analyzeTransactionResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Batch Analysis Tab -->
                            <div class="tab-pane fade" id="batchTab">
                                <h5><i class="fas fa-layer-group"></i> Batch Payment Analysis</h5>
                                <p class="text-muted">Analyze batch payments and identify grouping issues</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">Batch ID</label>
                                            <input type="text" id="batchAnalyzeBatchId" class="form-control" placeholder="Specific Batch ID">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" id="batchAnalyzeFromDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" id="batchAnalyzeToDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Property ID</label>
                                            <input type="text" id="batchAnalyzePropertyId" class="form-control" placeholder="Optional">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button class="btn btn-primary" onclick="analyzeBatch()">
                                                <i class="fas fa-layer-group"></i> Analyze Batches
                                            </button>
                                            <button class="btn btn-outline-info" onclick="findMissingBatches()">
                                                <i class="fas fa-exclamation-triangle"></i> Find Missing Batches
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <strong>Batch Analysis Features:</strong>
                                    <ul class="mb-0">
                                        <li>Compare PayProp batch groupings vs database records</li>
                                        <li>Identify missing batch IDs in database</li>
                                        <li>Verify batch payment counts and totals</li>
                                        <li>Find the 6-payment batch totaling ¬£2,957.47 (Christopher Booth case)</li>
                                    </ul>
                                </div>
                                
                                <div id="batchAnalysisResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Sync Testing Tab -->
                            <div class="tab-pane fade" id="syncTab">
                                <h5><i class="fas fa-sync"></i> Sync Service Testing</h5>
                                <p class="text-muted">Test your existing sync services and monitor performance</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Sync Type</label>
                                            <select id="syncType" class="form-select">
                                                <option value="COMPREHENSIVE_FINANCIAL">Comprehensive Financial Sync</option>
                                                <option value="DUAL_FINANCIAL">Dual Financial Sync (Instructions vs Actuals)</option>
                                                <option value="PROPERTIES_ONLY">Properties Only</option>
                                                <option value="BENEFICIARIES_ONLY">Beneficiaries Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="syncDryRun" checked>
                                                <label class="form-check-label" for="syncDryRun">Dry Run (Test Only)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-flex align-items-end">
                                            <button class="btn btn-success w-100" onclick="triggerSync()">
                                                <i class="fas fa-rocket"></i> Trigger Sync
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-outline-primary quick-action-btn" onclick="checkSyncHealth()">
                                        <i class="fas fa-heart"></i> Check Sync Health
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="viewRecentSyncs()">
                                        <i class="fas fa-history"></i> Recent Syncs
                                    </button>
                                    <button class="btn btn-outline-warning quick-action-btn" onclick="testRealTimeSync()">
                                        <i class="fas fa-bolt"></i> Test Real-Time Sync
                                    </button>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <strong>Sync Testing Notes:</strong>
                                    <ul class="mb-0">
                                        <li><strong>Dry Run:</strong> Tests sync logic without saving data</li>
                                        <li><strong>Comprehensive Financial:</strong> Tests your full financial sync process</li>
                                        <li><strong>Dual Financial:</strong> Tests instructions vs actual payments sync</li>
                                    </ul>
                                </div>
                                
                                <div id="syncTestResult" class="result-display d-none"></div>
                            </div>
                            
                            <!-- Raw API Tab -->
                            <div class="tab-pane fade" id="rawTab">
                                <h5><i class="fas fa-code"></i> Raw API Testing</h5>
                                <p class="text-muted">Make direct API calls to PayProp with custom parameters</p>
                                
                                <div class="search-form">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Endpoint</label>
                                            <input type="text" id="rawEndpoint" class="form-control" 
                                                   placeholder="/export/payments" value="/export/payments">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Method</label>
                                            <select id="rawMethod" class="form-select">
                                                <option value="GET">GET</option>
                                                <option value="POST">POST</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Parameters</label>
                                            <input type="text" id="rawParameters" class="form-control" 
                                                   placeholder="from_date=2025-05-01&to_date=2025-06-01&rows=10">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button class="btn btn-primary" onclick="makeRawApiCall()">
                                                <i class="fas fa-paper-plane"></i> Make API Call
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="quick-actions">
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('payments')">
                                        Export Payments Example
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('reports')">
                                        All-Payments Report Example
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('icdn')">
                                        ICDN Example
                                    </button>
                                    <button class="btn btn-outline-info quick-action-btn" onclick="setRawExample('meta')">
                                        Meta/Me (Check Scopes)
                                    </button>
                                </div>
                                
                                <div id="rawApiResult" class="result-display d-none"></div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Analysis -->
        <div class="row">
            <div class="col-12">
                <div class="test-card">
                    <div class="test-card-header">
                        <h5><i class="fas fa-chart-line"></i> Investigation Results</h5>
                        <small class="text-muted">Last updated: <span id="lastUpdated">Never</span></small>
                    </div>
                    <div class="test-card-body">
                        <div id="investigationSummary" class="d-none">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">PayProp API Results</h6>
                                            <h3 class="text-primary" id="apiResultCount">-</h3>
                                            <small class="text-muted">Records Found</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Database Results</h6>
                                            <h3 class="text-info" id="dbResultCount">-</h3>
                                            <small class="text-muted">Records Found</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success" id="syncHealthCard">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Sync Health</h6>
                                            <h3 id="syncHealthStatus">-</h3>
                                            <small class="text-muted" id="syncHealthDetails">-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let csrfToken = null;
        let csrfHeader = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
            
            // Set default dates
            setDateRange('30days');
            setDateRangeForCompare('30days');
            setDateRangeForBatch('30days');
        });
        
        // Utility Functions
        async function fetchWithCSRF(url, options = {}) {
            if (!options.headers) options.headers = {};
            if (csrfToken && csrfHeader) options.headers[csrfHeader] = csrfToken;
            options.credentials = 'include';
            
            showLoading(true);
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function showResult(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            element.classList.remove('d-none', 'result-success', 'result-error', 'result-warning');
            
            let statusClass = 'result-success';
            if (data && data.status === 'ERROR') statusClass = 'result-error';
            else if (data && data.status === 'WARNING') statusClass = 'result-warning';
            
            element.classList.add(statusClass);
            
            let html = title ? `<h6>${title}</h6>` : '';
            html += `<div class="json-viewer">${JSON.stringify(data, null, 2)}</div>`;
            
            element.innerHTML = html;
            
            // Update investigation summary if relevant
            updateInvestigationSummary(data);
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }
        
        function updateInvestigationSummary(data) {
            const summaryElement = document.getElementById('investigationSummary');
            
            if (data && (data.payprop_api_results || data.database_results || data.comparison_analysis)) {
                summaryElement.classList.remove('d-none');
                
                // Update API results count
                let apiCount = 0;
                if (data.payprop_api_results) {
                    Object.values(data.payprop_api_results).forEach(result => {
                        if (result.matches_found) apiCount += result.matches_found;
                    });
                }
                document.getElementById('apiResultCount').textContent = apiCount;
                
                // Update database results count
                let dbCount = 0;
                if (data.database_results && data.database_results.total_matches) {
                    dbCount = data.database_results.total_matches;
                }
                document.getElementById('dbResultCount').textContent = dbCount;
                
                // Update sync health
                const healthCard = document.getElementById('syncHealthCard');
                const healthStatus = document.getElementById('syncHealthStatus');
                const healthDetails = document.getElementById('syncHealthDetails');
                
                if (data.comparison_analysis && data.comparison_analysis.summary) {
                    const summary = data.comparison_analysis.summary;
                    const syncHealth = summary.sync_health;
                    
                    healthCard.className = 'card border-' + (syncHealth === 'PERFECT' ? 'success' : 'warning');
                    healthStatus.textContent = syncHealth === 'PERFECT' ? '‚úÖ PERFECT' : '‚ö†Ô∏è ISSUES';
                    healthStatus.className = syncHealth === 'PERFECT' ? 'text-success' : 'text-warning';
                    healthDetails.textContent = `Difference: ${summary.difference} records`;
                }
            }
        }
        
        // Date Range Helpers
        function setDateRange(range) {
            const today = new Date();
            const toDate = today.toISOString().split('T')[0];
            let fromDate;
            
            switch(range) {
                case '7days':
                    fromDate = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '30days':
                    fromDate = new Date(today.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '3months':
                    fromDate = new Date(today.getTime() - 90*24*60*60*1000).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('searchFromDate').value = fromDate;
            document.getElementById('searchToDate').value = toDate;
        }
        
        function setDateRangeForCompare(range) {
            const today = new Date();
            const toDate = today.toISOString().split('T')[0];
            let fromDate;
            
            switch(range) {
                case '7days':
                    fromDate = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '30days':
                    fromDate = new Date(today.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '3months':
                    fromDate = new Date(today.getTime() - 90*24*60*60*1000).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('compareFromDate').value = fromDate;
            document.getElementById('compareToDate').value = toDate;
        }
        
        function setDateRangeForBatch(range) {
            const today = new Date();
            const toDate = today.toISOString().split('T')[0];
            let fromDate;
            
            switch(range) {
                case '7days':
                    fromDate = new Date(today.getTime() - 7*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '30days':
                    fromDate = new Date(today.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
                    break;
                case '3months':
                    fromDate = new Date(today.getTime() - 90*24*60*60*1000).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('batchAnalyzeFromDate').value = fromDate;
            document.getElementById('batchAnalyzeToDate').value = toDate;
        }
        
        function setChristopherBoothExample() {
            document.getElementById('searchAmount').value = '542.75';
            document.getElementById('searchFromDate').value = '2025-05-25';
            document.getElementById('searchToDate').value = '2025-06-05';
            document.getElementById('searchBeneficiaryName').value = 'Christopher Booth';
            document.getElementById('searchPropertyId').value = ''; // Let it search all properties
        }
        
        function clearSearchForm() {
            document.getElementById('searchAmount').value = '';
            document.getElementById('searchBeneficiaryName').value = '';
            document.getElementById('searchBatchId').value = '';
            document.getElementById('searchTransactionId').value = '';
            document.getElementById('searchPropertyId').value = '';
            document.getElementById('searchEndpoint').value = '';
            setDateRange('30days');
        }
        
        function setAnalyzeExample(transactionId) {
            document.getElementById('analyzeTransactionId').value = transactionId;
        }
        
        function setRawExample(type) {
            const endpoint = document.getElementById('rawEndpoint');
            const parameters = document.getElementById('rawParameters');
            
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            switch(type) {
                case 'payments':
                    endpoint.value = '/export/payments';
                    parameters.value = 'include_beneficiary_info=true&rows=10';
                    break;
                case 'reports':
                    endpoint.value = '/report/all-payments';
                    parameters.value = `from_date=${monthAgo}&to_date=${today}&filter_by=reconciliation_date&rows=10`;
                    break;
                case 'icdn':
                    endpoint.value = '/report/icdn';
                    parameters.value = `from_date=${monthAgo}&to_date=${today}&rows=10`;
                    break;
                case 'meta':
                    endpoint.value = '/meta/me';
                    parameters.value = '';
                    break;
            }
        }
        
        // Main Test Functions
        async function smartSearch() {
            const searchCriteria = {
                amount: document.getElementById('searchAmount').value,
                fromDate: document.getElementById('searchFromDate').value,
                toDate: document.getElementById('searchToDate').value,
                propertyId: document.getElementById('searchPropertyId').value,
                beneficiaryName: document.getElementById('searchBeneficiaryName').value,
                batchId: document.getElementById('searchBatchId').value,
                transactionId: document.getElementById('searchTransactionId').value,
                endpoint: document.getElementById('searchEndpoint').value,
                includeBeneficiaryInfo: true
            };
            
            const result = await fetchWithCSRF('/api/payprop/oauth/smart-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchCriteria)
            });
            
            showResult('smartSearchResult', result.data, 'üîç Smart Search Results');
        }
        
        async function compareEndpoints() {
            const params = new URLSearchParams({
                fromDate: document.getElementById('compareFromDate').value,
                toDate: document.getElementById('compareToDate').value,
                propertyId: document.getElementById('comparePropertyId').value,
                filterBy: document.getElementById('compareFilterBy').value,
                maxRows: document.getElementById('compareMaxRows').value
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/compare-endpoints?${params}`, {
                method: 'POST'
            });
            
            showResult('compareEndpointsResult', result.data, 'üìä Endpoint Comparison Results');
        }
        
        async function analyzeTransaction() {
            const transactionId = document.getElementById('analyzeTransactionId').value;
            if (!transactionId) {
                alert('Please enter a PayProp Transaction ID');
                return;
            }
            
            const params = new URLSearchParams({
                transactionId: transactionId,
                endpoint: document.getElementById('analyzeEndpoint').value
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/analyze-transaction?${params}`, {
                method: 'POST'
            });
            
            showResult('analyzeTransactionResult', result.data, 'üî¨ Transaction Analysis Results');
        }
        
        async function analyzeBatch() {
            const params = new URLSearchParams({
                batchId: document.getElementById('batchAnalyzeBatchId').value,
                fromDate: document.getElementById('batchAnalyzeFromDate').value,
                toDate: document.getElementById('batchAnalyzeToDate').value,
                propertyId: document.getElementById('batchAnalyzePropertyId').value
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/analyze-batch?${params}`, {
                method: 'POST'
            });
            
            showResult('batchAnalysisResult', result.data, 'üì¶ Batch Analysis Results');
        }
        
        async function triggerSync() {
            const syncType = document.getElementById('syncType').value;
            const dryRun = document.getElementById('syncDryRun').checked;
            
            const params = new URLSearchParams({
                syncType: syncType,
                dryRun: dryRun
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/trigger-sync?${params}`, {
                method: 'POST'
            });
            
            showResult('syncTestResult', result.data, 'üöÄ Sync Test Results');
        }
        
        async function makeRawApiCall() {
            const endpoint = document.getElementById('rawEndpoint').value;
            const method = document.getElementById('rawMethod').value;
            const parameters = document.getElementById('rawParameters').value;
            
            if (!endpoint) {
                alert('Please enter an endpoint');
                return;
            }
            
            const params = new URLSearchParams({
                endpoint: endpoint,
                method: method,
                parameters: parameters
            });
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/raw-api-call?${params}`, {
                method: 'POST'
            });
            
            showResult('rawApiResult', result.data, `üîß Raw API Call: ${method} ${endpoint}`);
        }
        
        // Status Check Functions
        async function checkOAuthStatus() {
            const result = await fetchWithCSRF('/api/payprop/oauth/token-status');
            showResult('statusOverviewResult', result.data, 'üîê OAuth Status');
        }
        
        async function getSyncDashboard() {
            const result = await fetchWithCSRF('/api/payprop/oauth/sync-dashboard');
            showResult('statusOverviewResult', result.data, 'üìä Sync Dashboard');
        }
        
        async function discoverEndpoints() {
            const result = await fetchWithCSRF('/api/payprop/oauth/discover-endpoints', { method: 'POST' });
            showResult('statusOverviewResult', result.data, 'üîç Endpoint Discovery');
        }
        
        async function testAllConnections() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-connection', { method: 'POST' });
            showResult('statusOverviewResult', result.data, 'üîå Connection Test');
        }
        
        // Additional Helper Functions
        async function findMissingBatches() {
            // Set specific criteria to find the missing Christopher Booth batch
            document.getElementById('batchAnalyzeFromDate').value = '2025-05-25';
            document.getElementById('batchAnalyzeToDate').value = '2025-06-05';
            document.getElementById('batchAnalyzeBatchId').value = '';
            document.getElementById('batchAnalyzePropertyId').value = '';
            
            await analyzeBatch();
        }
        
        async function checkSyncHealth() {
            if (confirm('This will check the health of your sync services. Continue?')) {
                const result = await fetchWithCSRF('/api/payprop/oauth/sync-dashboard');
                showResult('syncTestResult', result.data, 'üíä Sync Health Check');
            }
        }
        
        async function viewRecentSyncs() {
            // This would show recent sync logs - you could add this endpoint if needed
            showResult('syncTestResult', {
                message: 'Recent sync logs would be displayed here',
                note: 'Add /recent-syncs endpoint to view sync history'
            }, 'üìú Recent Syncs');
        }
        
        async function testRealTimeSync() {
            const result = await fetchWithCSRF('/api/payprop/oauth/sync-dashboard');
            
            if (result.data && result.data.sync_monitoring) {
                showResult('syncTestResult', result.data.sync_monitoring, '‚ö° Real-Time Sync Status');
            } else {
                showResult('syncTestResult', {
                    message: 'Real-time sync monitoring not available',
                    note: 'Check if PayPropSyncMonitoringService is enabled'
                }, '‚ö° Real-Time Sync Test');
            }
        }
        
        // Advanced Search Functions
        async function investigateSpecificCase() {
            // Pre-fill the Christopher Booth case
            setChristopherBoothExample();
            await smartSearch();
        }
        
        async function findDateDiscrepancies() {
            // Search for records that might have date mapping issues
            const searchCriteria = {
                fromDate: '2025-05-01',
                toDate: '2025-06-30',
                endpoint: '', // Search all
                includeBeneficiaryInfo: true
            };
            
            const result = await fetchWithCSRF('/api/payprop/oauth/smart-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchCriteria)
            });
            
            showResult('smartSearchResult', result.data, 'üìÖ Date Discrepancy Investigation');
        }
        
        // Debugging helpers
        function exportResults(elementId) {
            const element = document.getElementById(elementId);
            if (element && !element.classList.contains('d-none')) {
                const content = element.querySelector('.json-viewer').textContent;
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payprop-test-results-${new Date().toISOString().slice(0,19)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (document.querySelector('#searchTab').classList.contains('active')) {
                            smartSearch();
                        }
                        break;
                    case 'k':
                        e.preventDefault();
                        document.getElementById('searchAmount').focus();
                        break;
                }
            }
        });
        
        // Auto-save form state
        function saveFormState() {
            const formData = {
                searchAmount: document.getElementById('searchAmount').value,
                searchFromDate: document.getElementById('searchFromDate').value,
                searchToDate: document.getElementById('searchToDate').value,
                searchPropertyId: document.getElementById('searchPropertyId').value,
                searchBeneficiaryName: document.getElementById('searchBeneficiaryName').value
            };
            localStorage.setItem('paypropTestFormState', JSON.stringify(formData));
        }
        
        function loadFormState() {
            try {
                const saved = localStorage.getItem('paypropTestFormState');
                if (saved) {
                    const formData = JSON.parse(saved);
                    Object.entries(formData).forEach(([key, value]) => {
                        const element = document.getElementById(key);
                        if (element && value) element.value = value;
                    });
                }
            } catch (e) {
                // Ignore localStorage errors
            }
        }
        
        // Auto-save on form changes
        document.addEventListener('change', function(e) {
            if (e.target.id.startsWith('search')) {
                saveFormState();
            }
        });
        
        // Load saved state on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadFormState, 100);
        });
        
        // Performance monitoring
        let requestStartTime;
        
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            requestStartTime = performance.now();
            return originalFetch.apply(this, args).then(response => {
                const duration = Math.round(performance.now() - requestStartTime);
                console.log(`API Request completed in ${duration}ms:`, args[0]);
                return response;
            });
        };
        
        // Enhanced error handling
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showResult('statusOverviewResult', {
                status: 'ERROR',
                error: 'Unhandled error: ' + e.reason,
                timestamp: new Date().toISOString()
            }, '‚ùå Application Error');
        });
        
        // Quick test buttons for common scenarios
        async function quickTestScenario(scenario) {
            switch(scenario) {
                case 'missing_payments':
                    setChristopherBoothExample();
                    await smartSearch();
                    break;
                    
                case 'batch_integrity':
                    document.getElementById('batchAnalyzeFromDate').value = '2025-05-25';
                    document.getElementById('batchAnalyzeToDate').value = '2025-06-05';
                    await analyzeBatch();
                    break;
                    
                case 'sync_health':
                    await getSyncDashboard();
                    break;
                    
                case 'endpoint_health':
                    await discoverEndpoints();
                    break;
            }
        }
        
        // Add quick test buttons to UI
        document.addEventListener('DOMContentLoaded', function() {
            // Add quick test section if not exists
            const quickTestsHtml = `
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>Quick Tests:</strong>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-warning me-2" onclick="quickTestScenario('missing_payments')">
                                    üêõ Test Missing Payments Issue
                                </button>
                                <button class="btn btn-sm btn-outline-info me-2" onclick="quickTestScenario('batch_integrity')">
                                    üì¶ Test Batch Integrity
                                </button>
                                <button class="btn btn-sm btn-outline-success me-2" onclick="quickTestScenario('sync_health')">
                                    üíä Check Sync Health
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="quickTestScenario('endpoint_health')">
                                    üîç Check Endpoint Health
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert after dashboard header
            const container = document.querySelector('.container-fluid');
            const firstRow = container.querySelector('.row');
            firstRow.insertAdjacentHTML('beforebegin', quickTestsHtml);
        });
    </script>
</body>
</html>