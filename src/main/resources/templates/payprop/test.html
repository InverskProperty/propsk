<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayProp Integration Test Dashboard</title>
    
    <!-- CSRF tokens for Spring Security -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255,255,255,0.9);
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            background: #fff;
        }
        .success-highlight {
            background-color: #d1ecf1 !important;
            border-color: #bee5eb !important;
        }
        .error-highlight {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
        }
        .batch-found {
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.375rem;
            font-weight: bold;
        }
        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 1rem 0;
        }
        .json-display {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e9ecef;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-3">üîß PayProp Integration Test Dashboard</h1>
                <p class="lead">Test PayProp API endpoints and diagnose integration issues</p>
                
                <!-- CSRF Status -->
                <div class="alert alert-info">
                    <h5>üîê Security Status</h5>
                    <div id="csrfStatus">Checking CSRF configuration...</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Core Tests -->
            <div class="col-lg-6">
                
                <!-- OAuth Connection Test -->
                <div class="test-section">
                    <h4>1. üîå OAuth Connection Test</h4>
                    <p class="text-muted">Test PayProp OAuth2 authentication status</p>
                    <button class="btn btn-primary" onclick="testConnection()">Test OAuth Connection</button>
                    <button class="btn btn-outline-secondary" onclick="getTokenStatus()">Check Token Status</button>
                    <div id="connectionResult" class="result-box d-none"></div>
                </div>

                <!-- API Endpoint Discovery -->
                <div class="test-section">
                    <h4>2. üîç API Endpoint Discovery</h4>
                    <p class="text-muted">Discover which PayProp API endpoints are available</p>
                    <button class="btn btn-primary" onclick="discoverEndpoints()">Discover Available Endpoints</button>
                    <div id="discoveryResult" class="result-box d-none"></div>
                </div>

                <!-- Export Payments Test -->
                <div class="test-section">
                    <h4>3. üí∞ Export Payments Test</h4>
                    <p class="text-muted">Test PayProp payments export with detailed analysis</p>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Property ID (optional):</label>
                            <input type="text" id="exportPropertyId" class="form-control" placeholder="Leave empty for all">
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="includeBeneficiaryInfo" checked>
                                <label class="form-check-label" for="includeBeneficiaryInfo">Include Beneficiary Info</label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="testExportPayments()">Test Export Payments</button>
                    <button class="btn btn-outline-info" onclick="testPropertyPayments()">Test Property-Specific</button>
                    <div id="exportResult" class="result-box d-none"></div>
                </div>

                <!-- Batch Payments Analysis -->
                <div class="test-section">
                    <h4>4. üì¶ Batch Payments Analysis</h4>
                    <p class="text-muted">Test batch payment functionality and data structure</p>
                    <button class="btn btn-primary" onclick="testBatchPayments()">Test Batch Payments</button>
                    <button class="btn btn-outline-warning" onclick="testBatchSync()">Test Batch Sync</button>
                    <div id="batchResult" class="result-box d-none"></div>
                </div>

            </div>

            <!-- Right Column: Advanced Tests -->
            <div class="col-lg-6">

                <!-- Report All Payments -->
                <div class="test-section">
                    <h4>5. üìä Report All-Payments</h4>
                    <p class="text-muted">Test the report/all-payments endpoint with real transactions</p>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Property ID (optional):</label>
                            <input type="text" id="reportPropertyId" class="form-control" placeholder="Leave empty for all">
                        </div>
                        <div class="col-md-6">
                            <label>Batch ID (optional):</label>
                            <input type="text" id="reportBatchId" class="form-control" placeholder="Test specific batch">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="testReportAllPayments()">Test All-Payments Report</button>
                    <button class="btn btn-outline-info" onclick="testRecentPayments()">Test Recent (30 days)</button>
                    <div id="reportResult" class="result-box d-none"></div>
                </div>

                <!-- Commission Data Sources -->
                <div class="test-section">
                    <h4>6. üíº Commission Data Sources</h4>
                    <p class="text-muted">Test commission and financial data endpoints</p>
                    <button class="btn btn-primary" onclick="testCommissionData()">Test Commission Data</button>
                    <button class="btn btn-outline-info" onclick="testFinancialData()">Test Financial Data</button>
                    <div id="commissionResult" class="result-box d-none"></div>
                </div>

                <!-- Detailed Transaction Analysis -->
                <div class="test-section">
                    <h4>7. üî¨ Detailed Transaction Analysis</h4>
                    <p class="text-muted">Deep dive into transaction data structure and fields</p>
                    <button class="btn btn-primary" onclick="testDetailedTransactions()">Analyze Transaction Fields</button>
                    <button class="btn btn-outline-info" onclick="testFieldLocations()">Test Field Locations</button>
                    <div id="detailedResult" class="result-box d-none"></div>
                </div>

                <!-- Diagnostic Tools -->
                <div class="test-section">
                    <h4>8. üö® Diagnostic Tools</h4>
                    <p class="text-muted">Advanced diagnostics for payment data sources</p>
                    <button class="btn btn-warning" onclick="diagnosePaymentSources()">Diagnose Payment Sources</button>
                    <button class="btn btn-outline-danger" onclick="testSyncSingleProperty()">Test Single Property Sync</button>
                    <div id="diagnosticResult" class="result-box d-none"></div>
                </div>

            </div>
        </div>

        <!-- Full Width: Comprehensive Testing -->
        <div class="row">
            <div class="col-12">
                
                <!-- Comprehensive Sync Test -->
                <div class="test-section">
                    <h4>9. üöÄ Comprehensive Sync Test</h4>
                    <p class="text-muted">Test sync functionality with real data and validation</p>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label>Property ID:</label>
                            <input type="text" id="syncPropertyId" class="form-control" value="K3Jwqg8W1E" placeholder="Test property ID">
                        </div>
                        <div class="col-md-3">
                            <label>From Date:</label>
                            <input type="date" id="syncFromDate" class="form-control" value="2025-04-01">
                        </div>
                        <div class="col-md-3">
                            <label>To Date:</label>
                            <input type="date" id="syncToDate" class="form-control" value="2025-07-01">
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="actuallySync">
                                <label class="form-check-label" for="actuallySync">Actually Save Data</label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-lg" onclick="testComprehensiveSync()">üöÄ Test Comprehensive Sync</button>
                    <button class="btn btn-outline-primary" onclick="testSyncValidation()">Test Sync Validation</button>
                    <div id="syncResult" class="result-box d-none"></div>
                </div>

                <!-- Raw API Response Viewer -->
                <div class="test-section">
                    <h4>10. üîß Raw API Response Viewer</h4>
                    <p class="text-muted">Test custom endpoints and view raw responses</p>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label>Custom Endpoint (relative to /api/payprop/oauth/):</label>
                            <input type="text" id="customEndpoint" class="form-control" 
                                   placeholder="e.g., test-batch-payments-api-only or diagnose-payment-data-sources">
                        </div>
                        <div class="col-md-4">
                            <label>&nbsp;</label><br>
                            <button class="btn btn-primary" onclick="testCustomEndpoint()">Test Custom Endpoint</button>
                        </div>
                    </div>
                    <div class="warning-box">
                        <strong>Available Endpoints:</strong> test-batch-payments-api-only, test-export-payments-detailed, 
                        diagnose-payment-data-sources, test-commission-data-sources, test-detailed-transactions
                    </div>
                    <div id="customResult" class="result-box d-none"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">Processing request...</div>
    </div>

    <script>
        // Global variables
        let csrfToken = null;
        let csrfHeader = null;
        
        // Initialize CSRF tokens
        document.addEventListener('DOMContentLoaded', function() {
            csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
            
            const csrfStatus = document.getElementById('csrfStatus');
            if (csrfToken && csrfHeader && !csrfToken.includes('${')) {
                csrfStatus.innerHTML = `
                    <span class="status-badge status-success">‚úÖ CSRF Configured</span><br>
                    Token: ${csrfToken.substring(0, 20)}...<br>
                    Header: ${csrfHeader}
                `;
            } else {
                csrfStatus.innerHTML = '<span class="status-badge status-error">‚ùå CSRF Not Configured</span>';
            }
        });
        
        // Helper function for API calls with CSRF
        async function fetchWithCSRF(url, options = {}) {
            if (!options.headers) {
                options.headers = {};
            }
            
            if (csrfToken && csrfHeader) {
                options.headers[csrfHeader] = csrfToken;
            }
            
            options.credentials = 'include';
            
            showLoading(true);
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            } finally {
                showLoading(false);
            }
        }
        
        // Show/hide loading spinner
        function showLoading(show) {
            document.querySelector('.loading').style.display = show ? 'block' : 'none';
        }
        
        // Enhanced display results function
        function showResult(elementId, data, title = '') {
            const element = document.getElementById(elementId);
            element.classList.remove('d-none', 'success-highlight', 'error-highlight');
            
            let html = title ? `<h5>${title}</h5>` : '';
            
            // Check for success/error status
            if (data && data.success === false) {
                element.classList.add('error-highlight');
                html += `<div class="status-badge status-error">‚ùå FAILED</div>`;
            } else if (data && data.success === true) {
                element.classList.add('success-highlight');
                html += `<div class="status-badge status-success">‚úÖ SUCCESS</div>`;
            }
            
            // Check for batch data discovery
            if (data && data.has_payment_batch_field) {
                html += `<div class="batch-found">üéâ BATCH DATA DISCOVERED! Has payment_batch field: ${data.has_payment_batch_field}</div>`;
            }
            
            // Check for specific discoveries
            if (data && data.total_items > 0) {
                html += `<div class="status-badge status-success">üìä Found ${data.total_items} items</div>`;
            }
            
            if (typeof data === 'object') {
                html += `<div class="json-display">${JSON.stringify(data, null, 2)}</div>`;
            } else {
                html += `<div>${data}</div>`;
            }
            
            element.innerHTML = html;
        }
        
        // ======================
        // TEST FUNCTIONS
        // ======================
        
        // 1. OAuth Connection Test
        async function testConnection() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-connection', { 
                method: 'POST' 
            });
            showResult('connectionResult', result.data, 'üîå OAuth Connection Test');
        }
        
        async function getTokenStatus() {
            const result = await fetchWithCSRF('/api/payprop/oauth/token-status');
            showResult('connectionResult', result.data, 'üîê Token Status');
        }
        
        // 2. API Endpoint Discovery
        async function discoverEndpoints() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-available-payment-endpoints', { 
                method: 'POST' 
            });
            showResult('discoveryResult', result.data, 'üîç API Endpoint Discovery');
        }
        
        // 3. Export Payments Test
        async function testExportPayments() {
            const propertyId = document.getElementById('exportPropertyId').value;
            const includeBeneficiaryInfo = document.getElementById('includeBeneficiaryInfo').checked;
            
            const result = await fetchWithCSRF('/api/payprop/oauth/test-export-payments-detailed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    propertyId: propertyId || '', 
                    includeBeneficiaryInfo 
                })
            });
            
            showResult('exportResult', result.data, 'üí∞ Export Payments Test');
        }
        
        async function testPropertyPayments() {
            const propertyId = document.getElementById('exportPropertyId').value || 'K3Jwqg8W1E';
            
            const result = await fetchWithCSRF('/api/payprop/oauth/test-property-payments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ propertyId })
            });
            
            showResult('exportResult', result.data, 'üè† Property-Specific Payments');
        }
        
        // 4. Batch Payments Analysis
        async function testBatchPayments() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-batch-payments-api-only', { 
                method: 'POST' 
            });
            showResult('batchResult', result.data, 'üì¶ Batch Payments Analysis');
        }
        
        async function testBatchSync() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-simple-batch-payments', { 
                method: 'POST' 
            });
            showResult('batchResult', result.data, 'üîÑ Batch Sync Test');
        }
        
        // 5. Report All Payments
        async function testReportAllPayments() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-all-payments-report', { 
                method: 'POST' 
            });
            showResult('reportResult', result.data, 'üìä Report All-Payments');
        }
        
        async function testRecentPayments() {
            // Use the batch payment test which uses recent dates
            await testBatchPayments();
            showResult('reportResult', document.getElementById('batchResult').innerHTML, 'üìÖ Recent Payments (30 days)');
        }
        
        // 6. Commission Data Sources
        async function testCommissionData() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-commission-data-sources', { 
                method: 'POST' 
            });
            showResult('commissionResult', result.data, 'üíº Commission Data Sources');
        }
        
        async function testFinancialData() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-financial-data', { 
                method: 'POST' 
            });
            showResult('commissionResult', result.data, 'üí∞ Financial Data Test');
        }
        
        // 7. Detailed Transaction Analysis
        async function testDetailedTransactions() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-detailed-transactions', { 
                method: 'POST' 
            });
            showResult('detailedResult', result.data, 'üî¨ Detailed Transaction Analysis');
        }
        
        async function testFieldLocations() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-field-locations');
            showResult('detailedResult', result.data, 'üìç Field Locations Test');
        }
        
        // 8. Diagnostic Tools
        async function diagnosePaymentSources() {
            const result = await fetchWithCSRF('/api/payprop/oauth/diagnose-payment-data-sources', { 
                method: 'POST' 
            });
            showResult('diagnosticResult', result.data, 'üö® Payment Sources Diagnosis');
        }
        
        async function testSyncSingleProperty() {
            const result = await fetchWithCSRF('/api/payprop/oauth/test-sync-single-property-exact-match', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    propertyId: 'K3Jwqg8W1E',
                    fromDate: '2025-04-01',
                    toDate: '2025-07-01'
                })
            });
            showResult('diagnosticResult', result.data, 'üîç Single Property Sync Test');
        }
        
        // 9. Comprehensive Sync Test
        async function testComprehensiveSync() {
            const propertyId = document.getElementById('syncPropertyId').value;
            const fromDate = document.getElementById('syncFromDate').value;
            const toDate = document.getElementById('syncToDate').value;
            const actuallySync = document.getElementById('actuallySync').checked;
            
            const result = await fetchWithCSRF('/api/payprop/oauth/test-sync-single-property-with-save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    propertyId,
                    fromDate,
                    toDate,
                    actuallySync: actuallySync.toString()
                })
            });
            
            showResult('syncResult', result.data, 'üöÄ Comprehensive Sync Test');
        }
        
        async function testSyncValidation() {
            // Use the exact match test for validation
            await testSyncSingleProperty();
            showResult('syncResult', document.getElementById('diagnosticResult').innerHTML, '‚úÖ Sync Validation Test');
        }
        
        // 10. Raw API Response Viewer
        async function testCustomEndpoint() {
            const endpoint = document.getElementById('customEndpoint').value;
            if (!endpoint) {
                alert('Please enter an endpoint');
                return;
            }
            
            const result = await fetchWithCSRF(`/api/payprop/oauth/${endpoint}`, { method: 'POST' });
            showResult('customResult', result, `üîß Custom Endpoint: ${endpoint}`);
        }
        
        // Utility function to set today's date in date inputs
        function setTodayDates() {
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('syncFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('syncToDate').value = today;
        }
        
        // Initialize with reasonable dates
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(setTodayDates, 100);
        });
    </script>
</body>
</html>