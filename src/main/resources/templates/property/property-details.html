<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" content="${_csrf.token}"/>
<meta name="_csrf_header" content="${_csrf.headerName}"/>

<!-- CSS -->
<link th:href="@{/css/style.min.css}" rel="stylesheet">
<link th:href="@{/css/pages/inbox.css}" rel="stylesheet">

<!-- Custom Maintenance Styles -->
<style>
.maintenance-alert {
    border-left: 4px solid #dc3545;
    background: linear-gradient(45deg, #fff5f5, #ffffff);
    animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
    0% { border-left-color: #dc3545; }
    50% { border-left-color: #ff6b6b; }
    100% { border-left-color: #dc3545; }
}

.maintenance-card {
    transition: all 0.3s ease;
    border-radius: 8px;
}

.maintenance-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.maintenance-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
}

.maintenance-timeline {
    max-height: 400px;
    overflow-y: auto;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    z-index: 1;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 3px solid #007bff;
}

.timeline-title {
    margin: 0 0 5px 0;
    font-size: 14px;
    font-weight: 600;
}

.timeline-text {
    margin: 0 0 5px 0;
    font-size: 13px;
    color: #6c757d;
}

.timeline-date {
    font-size: 12px;
    color: #999;
}

.tags .badge {
    font-size: 12px;
    padding: 5px 8px;
}

.emergency-indicator {
    animation: blink 1s infinite;
    background: linear-gradient(45deg, #dc3545, #ff6b6b);
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.7; }
}

.maintenance-category-badge {
    font-size: 0.75em;
    padding: 3px 8px;
    border-radius: 12px;
}

.financial-chart {
    height: 300px;
    margin: 20px 0;
}
</style>

</head>

<body class="skin-blue fixed-layout" th:data-property-id="${property.id}">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>
    
    <div class="page-wrapper">
        <div class="container-fluid">
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h4 class="text-themecolor" th:text="${property.propertyName}">Property Name</h4>
                    <p class="text-muted" th:text="${property.fullAddress}">Property Address</p>
                </div>
                <div class="col-md-4 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                            <li class="breadcrumb-item"><a th:href="${home + 'employee/property/all-properties'}">Properties</a></li>
                            <li class="breadcrumb-item active">Property Details</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Emergency Maintenance Alert -->
            <div th:if="${emergencyMaintenanceCount > 0}" class="alert maintenance-alert">
                <h4 class="alert-heading">
                    <i class="fas fa-exclamation-triangle emergency-indicator"></i> 
                    URGENT: Emergency Maintenance Required
                </h4>
                <p class="mb-3">
                    This property has <strong th:text="${emergencyMaintenanceCount}">0</strong> active emergency maintenance ticket(s) requiring immediate attention.
                </p>
                <div class="d-flex">
                    <a th:href="@{'/employee/ticket/pending-bids?propertyId=' + ${property.id} + '&urgency=emergency'}" 
                       class="btn btn-danger mr-2">
                        <i class="fas fa-bolt"></i> View Emergency Tickets
                    </a>
                    <a th:href="@{'/employee/ticket/create-ticket?propertyId=' + ${property.id} + '&type=emergency'}" 
                       class="btn btn-warning">
                        <i class="fas fa-plus-circle"></i> Create Emergency Ticket
                    </a>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="btn-group" role="group">
                        <a th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}" 
                           th:href="${home + 'employee/property/update/' + property.id}" 
                           class="btn btn-warning">
                            <i class="fas fa-edit"></i> Edit Property
                        </a>
                        <a th:href="${home + 'employee/tenant/create-tenant?propertyId=' + property.id}" 
                           class="btn btn-success">
                            <i class="fas fa-user-plus"></i> Add Tenant
                        </a>
                        <a th:href="${home + 'employee/ticket/create-ticket?propertyId=' + property.id + '&type=maintenance'}" 
                           class="btn btn-info">
                            <i class="fas fa-wrench"></i> Create Maintenance
                        </a>
                        <a th:href="${home + 'employee/ticket/create-ticket?propertyId=' + property.id + '&type=emergency'}" 
                           class="btn btn-danger">
                            <i class="fas fa-bolt"></i> Emergency Ticket
                        </a>
                        <a th:href="${home + 'employee/drive/property-files/' + property.id}"
                        class="btn btn-primary">
                            <i class="fas fa-folder"></i> View Documents
                        </a>
                        <a th:href="${home + 'expense-documents/property/' + property.id}"
                           class="btn btn-outline-danger">
                            <i class="fas fa-file-invoice-dollar"></i> Expense Documents
                        </a>
                        <!-- Delete Property Button (Manager Only) -->
                        <form th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}"
                              th:action="@{/employee/property/delete/{id}(id=${property.id})}"
                              method="post" style="display: inline;"
                              onsubmit="return confirm('Are you sure you want to delete this property? This action cannot be undone.')">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Delete Property
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Enhanced Property Status Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-row">
                                <div class="round round-lg align-self-center round-success">
                                    <i class="fas fa-pound-sign"></i>
                                </div>
                                <div class="m-l-10 align-self-center">
                                    <h3 class="m-b-0 font-light">£<span th:text="${#numbers.formatDecimal(property.monthlyPayment, 0, 'COMMA', 0, 'POINT')}">1200</span></h3>
                                    <h5 class="text-muted m-b-0">Monthly Rent</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-row">
                                <div th:class="${property.isActive() ? 'round round-lg align-self-center round-info' : 'round round-lg align-self-center round-danger'}">
                                    <i th:class="${property.isActive() ? 'fas fa-check-circle' : 'fas fa-archive'}"></i>
                                </div>
                                <div class="m-l-10 align-self-center">
                                    <h3 class="m-b-0 font-light" th:text="${property.isActive() ? 'Active' : 'Archived'}">Active</h3>
                                    <h5 class="text-muted m-b-0">Property Status</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-row">
                                <div class="round round-lg align-self-center round-primary">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="m-l-10 align-self-center">
                                    <h3 class="m-b-0 font-light" th:text="${tenantCount ?: 0}">0</h3>
                                    <h5 class="text-muted m-b-0">Active Tenants</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Maintenance Status Card -->
                <div class="col-md-3">
                    <div class="card maintenance-stats">
                        <div class="card-body text-center text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="m-b-0 font-light" th:text="${activeMaintenanceCount ?: 0}">0</h3>
                                    <h6 class="m-b-0">Active Issues</h6>
                                </div>
                                <div>
                                    <i class="fas fa-wrench fa-2x"></i>
                                </div>
                            </div>
                            <div class="row mt-2 text-center">
                                <div class="col-4">
                                    <small th:text="${emergencyMaintenanceCount ?: 0}">0</small><br>
                                    <small>Emergency</small>
                                </div>
                                <div class="col-4">
                                    <small th:text="${urgentMaintenanceCount ?: 0}">0</small><br>
                                    <small>Urgent</small>
                                </div>
                                <div class="col-4">
                                    <small th:text="${routineMaintenanceCount ?: 0}">0</small><br>
                                    <small>Routine</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Property Information -->
            <div class="row">
                <div class="col-lg-8">
                    <!-- Basic Information -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Property Information</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td><strong>Property Name:</strong></td>
                                                <td th:text="${property.propertyName}">Property Name</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Type:</strong></td>
                                                <td th:text="${property.propertyType ?: 'Not specified'}">Flat</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Bedrooms:</strong></td>
                                                <td th:text="${property.bedrooms ?: 'Not specified'}">2</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Bathrooms:</strong></td>
                                                <td th:text="${property.bathrooms ?: 'Not specified'}">1</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Furnished:</strong></td>
                                                <td th:text="${property.furnished ?: 'Not specified'}">Furnished</td>
                                            </tr>
                                            <tr>
                                                <td><strong>EPC Rating:</strong></td>
                                                <td>
                                                    <span th:if="${property.epcRating}" 
                                                          th:class="'badge badge-' + ${property.epcRating == 'A' || property.epcRating == 'B' ? 'success' : 
                                                                                        property.epcRating == 'C' || property.epcRating == 'D' ? 'warning' : 'danger'}"
                                                          th:text="${property.epcRating}">C</span>
                                                    <span th:unless="${property.epcRating}" class="text-muted">Not specified</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td><strong>Monthly Rent:</strong></td>
                                                <td class="text-success font-weight-bold">
                                                    £<span th:text="${#numbers.formatDecimal(property.monthlyPayment, 0, 'COMMA', 0, 'POINT')}">1200</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Deposit Amount:</strong></td>
                                                <td th:text="${property.depositAmount != null ? '£' + #numbers.formatDecimal(property.depositAmount, 0, 'COMMA', 0, 'POINT') : 'Not specified'}">£1200</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Available From:</strong></td>
                                                <td th:text="${property.listedFrom != null ? #temporals.format(property.listedFrom, 'dd/MM/yyyy') : 'Not specified'}">01/01/2025</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Available Until:</strong></td>
                                                <td th:text="${property.listedUntil != null ? #temporals.format(property.listedUntil, 'dd/MM/yyyy') : 'Open-ended'}">Open-ended</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Managing Agent:</strong></td>
                                                <td th:text="${property.agentName ?: 'Not specified'}">Agent Name</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Council Tax Band:</strong></td>
                                                <td th:text="${property.councilTaxBand ?: 'Not specified'}">C</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FIXED: Maintenance History Section -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="card-title">
                                    <i class="fas fa-wrench text-primary"></i> Maintenance History
                                </h4>
                                <div>
                                    <button class="btn btn-sm btn-info" onclick="refreshMaintenanceData()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                    <a th:href="@{'/employee/ticket/create-ticket?propertyId=' + ${property.id} + '&type=maintenance'}" 
                                       class="btn btn-sm btn-success">
                                        <i class="fas fa-plus"></i> New Ticket
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Maintenance Statistics -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-danger" th:text="${emergencyMaintenanceCount ?: 0}">0</h4>
                                        <p class="text-muted">Emergency</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-warning" th:text="${urgentMaintenanceCount ?: 0}">0</h4>
                                        <p class="text-muted">Urgent</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-info" th:text="${routineMaintenanceCount ?: 0}">0</h4>
                                        <p class="text-muted">Routine</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-success" th:text="${completedMaintenanceCount ?: 0}">0</h4>
                                        <p class="text-muted">Completed</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Maintenance Tickets - FIXED SpringEL EXPRESSION -->
                            <div class="maintenance-timeline" th:if="${!#lists.isEmpty(maintenanceTickets)}">
                                <h6 class="mb-3">Recent Maintenance Activity</h6>
                                <div th:each="ticket : ${maintenanceTickets}" class="maintenance-card card mb-3"
                                     th:classappend="${ticket.urgencyLevel == 'emergency'} ? 'border-danger' : 
                                                    (${ticket.urgencyLevel == 'urgent'} ? 'border-warning' : 'border-light')">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title">
                                                    <a th:href="@{'/employee/ticket/show-ticket/' + ${ticket.ticketId}}" 
                                                       class="text-decoration-none">
                                                        Ticket #<span th:text="${ticket.ticketId}">123</span>: 
                                                        <span th:text="${ticket.subject}">Subject</span>
                                                    </a>
                                                </h6>
                                                
                                                <div class="mb-2">
                                                    <span th:if="${ticket.maintenanceCategory}" 
                                                          class="maintenance-category-badge badge badge-primary text-capitalize"
                                                          th:text="${ticket.maintenanceCategory}">Category</span>
                                                    
                                                    <span th:if="${ticket.urgencyLevel == 'emergency'}" 
                                                          class="badge badge-danger emergency-indicator">
                                                        <i class="fas fa-exclamation-triangle"></i> EMERGENCY
                                                    </span>
                                                    <span th:if="${ticket.urgencyLevel == 'urgent'}" 
                                                          class="badge badge-warning">
                                                        <i class="fas fa-exclamation"></i> URGENT
                                                    </span>
                                                    <span th:if="${ticket.urgencyLevel == 'routine'}" 
                                                          class="badge badge-info">
                                                        <i class="fas fa-calendar"></i> ROUTINE
                                                    </span>
                                                    
                                                    <span th:if="${ticket.payPropTicketId}" 
                                                          class="badge badge-secondary">
                                                        <i class="fas fa-sync"></i> PayProp
                                                    </span>
                                                </div>
                                                
                                                <p class="card-text text-muted mb-2" 
                                                   th:text="${#strings.abbreviate(ticket.description, 150)}">Description...</p>
                                                
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">
                                                            <i class="fas fa-calendar"></i> 
                                                            Created: <span th:text="${#temporals.format(ticket.createdAt, 'dd/MM/yyyy')}">Date</span>
                                                        </small>
                                                    </div>
                                                    <div class="col-md-6" th:if="${ticket.employee}">
                                                        <small class="text-muted">
                                                            <i class="fas fa-user"></i>
                                                            Assigned: <span th:text="${ticket.employee.name}">Employee</span>
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                <!-- Access Requirements -->
                                                <div th:if="${ticket.accessRequired or ticket.tenantPresentRequired}" class="mt-2">
                                                    <small class="text-info">
                                                        <span th:if="${ticket.accessRequired}">
                                                            <i class="fas fa-key"></i> Property Access Required
                                                        </span>
                                                        <span th:if="${ticket.tenantPresentRequired}" class="ml-3">
                                                            <i class="fas fa-user"></i> Tenant Must Be Present
                                                        </span>
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <div class="text-right">
                                                <div class="mb-2">
                                                    <span th:if="${ticket.status == 'open'}" class="badge badge-primary">Open</span>
                                                    <span th:if="${ticket.status == 'in-progress'}" class="badge badge-warning">In Progress</span>
                                                    <span th:if="${ticket.status == 'bidding'}" class="badge badge-info">Awaiting Bids</span>
                                                    <span th:if="${ticket.status == 'contractor-selected'}" class="badge badge-success">Contractor Selected</span>
                                                    <span th:if="${ticket.status == 'work-in-progress'}" class="badge badge-warning">Work In Progress</span>
                                                    <span th:if="${ticket.status == 'work-completed'}" class="badge badge-success">Work Completed</span>
                                                    <span th:if="${ticket.status == 'closed'}" class="badge badge-secondary">Closed</span>
                                                </div>
                                                
                                                <div th:if="${ticket.approvedAmount}" class="text-success font-weight-bold">
                                                    £<span th:text="${#numbers.formatDecimal(ticket.approvedAmount, 0, 2)}">500.00</span>
                                                </div>
                                                
                                                <div class="btn-group-vertical" role="group">
                                                    <a th:href="@{'/employee/ticket/show-ticket/' + ${ticket.ticketId}}" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a th:if="${ticket.status == 'open' or ticket.status == 'in-progress'}"
                                                       th:href="@{'/employee/ticket/pending-bids?ticketId=' + ${ticket.ticketId}}" 
                                                       class="btn btn-sm btn-outline-success">
                                                        <i class="fas fa-gavel"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- No Maintenance History -->
                            <div th:if="${#lists.isEmpty(maintenanceTickets)}" class="text-center py-5">
                                <i class="fas fa-wrench fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Maintenance History</h5>
                                <p class="text-muted">This property has no maintenance tickets yet.</p>
                                <a th:href="@{'/employee/ticket/create-ticket?propertyId=' + ${property.id} + '&type=maintenance'}" 
                                   class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Create First Maintenance Ticket
                                </a>
                            </div>
                            
                            <!-- View All Link -->
                            <div th:if="${#lists.size(maintenanceTickets) >= 5}" class="text-center mt-3">
                                <a th:href="@{'/employee/ticket/property/' + ${property.id} + '/maintenance-history'}" 
                                class="btn btn-outline-primary">
                                    <i class="fas fa-list"></i> View All Maintenance History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary Section -->
                    <div class="row" id="financialSection" style="display: none;">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">
                                        <i class="fas fa-pound-sign"></i> Financial Summary
                                        <button class="btn btn-sm btn-primary float-right" onclick="refreshFinancialData()">
                                            <i class="fas fa-sync"></i> Refresh
                                        </button>
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <!-- Data Source Toggle -->
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-0">Data Source:</h6>
                                                </div>
                                                <div class="btn-group" role="group" id="dataSourceToggle">
                                                    <button type="button" class="btn btn-outline-primary active" onclick="switchDataSource('auto')" id="sourceAuto">
                                                        <i class="fas fa-magic"></i> Auto
                                                    </button>
                                                    <button type="button" class="btn btn-outline-success" onclick="switchDataSource('historical')" id="sourceHistorical">
                                                        <i class="fas fa-history"></i> Historical
                                                        <span class="badge badge-light ml-1" id="historicalCount">0</span>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-info" onclick="switchDataSource('payprop')" id="sourcePayProp">
                                                        <i class="fas fa-cloud"></i> PayProp
                                                        <span class="badge badge-light ml-1" id="paypropCount">0</span>
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="dataSourceMessage" class="alert alert-info alert-sm mt-2" style="display: none;">
                                                <small id="dataSourceMessageText"></small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row" id="financialMetrics">
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h4 class="text-success" id="totalIncome">£0</h4>
                                                    <p class="text-muted">Total Income</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h4 class="text-warning" id="totalCommissions">£0</h4>
                                                    <p class="text-muted">Total Commissions</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h4 class="text-primary" id="netOwnerIncome">£0</h4>
                                                    <p class="text-muted">Net to Owner</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card">
                                                <div class="card-body text-center">
                                                    <h4 class="text-info" id="transactionCount">0</h4>
                                                    <p class="text-muted">Transactions</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Recent Transactions -->
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6>Recent Transactions</h6>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-outline-primary active" onclick="filterTransactions('all')" id="filterAll">All</button>
                                                    <button class="btn btn-outline-success" onclick="filterTransactions('actual')" id="filterActual">Actual</button>
                                                    <button class="btn btn-outline-info" onclick="filterTransactions('calculated')" id="filterCalculated">Calculated</button>
                                                    <button class="btn btn-outline-warning" onclick="filterTransactions('grouped')" id="filterGrouped">Grouped</button>
                                                </div>
                                            </div>
                                            <div class="alert alert-info alert-sm mt-2">
                                                <small><strong>Data Sources:</strong> 
                                                    <span class="badge bg-success">ACTUAL</span> Real PayProp data | 
                                                    <span class="badge bg-info">CALCULATED</span> System generated | 
                                                    <span class="badge bg-warning">SYNTHETIC</span> Derived data
                                                </small>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-striped" id="recentTransactionsTable">
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 100px;">Date</th>
                                                            <th>Description</th>
                                                            <th style="width: 120px;">Type</th>
                                                            <th style="width: 120px;" class="text-end">Amount</th>
                                                            <th style="width: 100px;" class="text-center">Source</th>
                                                            <th style="width: 80px;" class="text-center">Invoice</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="recentTransactionsBody">
                                                        <tr>
                                                            <td colspan="6" class="text-center text-muted">Loading financial data...</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Address Details</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <p class="lead" th:text="${property.fullAddress}">Full Address</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr th:if="${property.addressLine1}">
                                                <td><strong>Address Line 1:</strong></td>
                                                <td th:text="${property.addressLine1}">123 Oak Street</td>
                                            </tr>
                                            <tr th:if="${property.addressLine2}">
                                                <td><strong>Address Line 2:</strong></td>
                                                <td th:text="${property.addressLine2}">City Centre</td>
                                            </tr>
                                            <tr th:if="${property.addressLine3}">
                                                <td><strong>Address Line 3:</strong></td>
                                                <td th:text="${property.addressLine3}">District</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr th:if="${property.city}">
                                                <td><strong>City:</strong></td>
                                                <td th:text="${property.city}">Manchester</td>
                                            </tr>
                                            <tr th:if="${property.county}">
                                                <td><strong>County:</strong></td>
                                                <td th:text="${property.county}">Greater Manchester</td>
                                            </tr>
                                            <tr th:if="${property.postcode}">
                                                <td><strong>Postcode:</strong></td>
                                                <td th:text="${property.postcode}">M1 1AA</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tenant Occupancy Timeline -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="card-title">
                                    <i class="fas fa-users text-primary"></i> Tenant Occupancy Timeline
                                </h4>
                                <a th:href="@{'/employee/assignment?propertyId=' + ${property.id}}"
                                   class="btn btn-sm btn-success">
                                    <i class="fas fa-user-plus"></i> Manage Assignments
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Current Tenants -->
                            <div th:if="${!#lists.isEmpty(currentTenants)}" class="mb-4">
                                <h6 class="text-success"><i class="fas fa-check-circle"></i> Current Tenants</h6>
                                <div th:each="assignment : ${currentTenants}" class="card mb-2 border-success">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    <span th:text="${assignment.customer.name}">Tenant Name</span>
                                                    <span class="badge badge-success ml-2">Active</span>
                                                </h6>
                                                <p class="text-muted mb-2" th:if="${assignment.customer.email}">
                                                    <i class="fas fa-envelope"></i>
                                                    <span th:text="${assignment.customer.email}">email@example.com</span>
                                                </p>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">
                                                            <i class="fas fa-sign-in-alt text-success"></i>
                                                            Moved In:
                                                            <strong th:text="${assignment.startDate != null ? #temporals.format(assignment.startDate, 'dd/MM/yyyy') : 'Not specified'}">
                                                                01/01/2025
                                                            </strong>
                                                        </small>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <small class="text-success">
                                                            <i class="fas fa-calendar-check"></i>
                                                            Currently Occupied
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Past Tenants -->
                            <div th:if="${!#lists.isEmpty(pastTenants)}">
                                <h6 class="text-muted"><i class="fas fa-history"></i> Previous Tenants</h6>
                                <div th:each="assignment : ${pastTenants}" class="card mb-2 border-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    <span th:text="${assignment.customer.name}">Tenant Name</span>
                                                    <span class="badge badge-secondary ml-2">Past</span>
                                                </h6>
                                                <p class="text-muted mb-2" th:if="${assignment.customer.email}">
                                                    <i class="fas fa-envelope"></i>
                                                    <span th:text="${assignment.customer.email}">email@example.com</span>
                                                </p>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">
                                                            <i class="fas fa-sign-in-alt"></i>
                                                            Moved In:
                                                            <strong th:text="${assignment.startDate != null ? #temporals.format(assignment.startDate, 'dd/MM/yyyy') : 'Not specified'}">
                                                                01/01/2024
                                                            </strong>
                                                        </small>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <small class="text-muted">
                                                            <i class="fas fa-sign-out-alt"></i>
                                                            Moved Out:
                                                            <strong th:text="${assignment.endDate != null ? #temporals.format(assignment.endDate, 'dd/MM/yyyy') : 'Unknown'}">
                                                                31/12/2024
                                                            </strong>
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- No Tenants -->
                            <div th:if="${#lists.isEmpty(tenantAssignments)}" class="text-center py-4">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No Tenant History</h6>
                                <p class="text-muted mb-3">This property has no tenant assignment records yet.</p>
                                <a th:href="@{'/employee/assignment'}" class="btn btn-primary">
                                    <i class="fas fa-user-plus"></i> Add First Tenant
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- PayProp Integration -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">PayProp Integration</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td><strong>PayProp ID:</strong></td>
                                                <td>
                                                    <span th:if="${property.payPropId}" 
                                                          class="badge badge-success" 
                                                          th:text="${property.payPropId}">PP123456</span>
                                                    <span th:unless="${property.payPropId}" 
                                                          class="badge badge-warning">Pending Sync</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Customer ID:</strong></td>
                                                <td th:text="${property.customerId ?: 'Auto-generated'}">PROP_123456</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Payments Enabled:</strong></td>
                                                <td>
                                                    <span th:if="${property.enablePaymentsAsBoolean}" class="badge badge-success">Yes</span>
                                                    <span th:unless="${property.enablePaymentsAsBoolean}" class="badge badge-danger">No</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td><strong>Hold Owner Funds:</strong></td>
                                                <td>
                                                    <span th:if="${property.holdOwnerFundsAsBoolean}" class="badge badge-info">Yes</span>
                                                    <span th:unless="${property.holdOwnerFundsAsBoolean}" class="badge badge-secondary">No</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Minimum Balance:</strong></td>
                                                <td>£<span th:text="${#numbers.formatDecimal(property.propertyAccountMinimumBalance ?: 0, 0, 'COMMA', 0, 'POINT')}">0</span></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Sync Status:</strong></td>
                                                <td>
                                                    <span th:if="${property.payPropId}" class="badge badge-success">
                                                        <i class="fas fa-check-circle"></i> Synced
                                                    </span>
                                                    <span th:unless="${property.payPropId}" class="badge badge-warning">
                                                        <i class="fas fa-clock"></i> Awaiting Sync (June 17, 2025)
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div th:unless="${property.payPropId}" class="alert alert-info mt-3">
                                <h6><i class="fas fa-info-circle"></i> PayProp Integration Status</h6>
                                <p class="mb-2">This property will be automatically synced to PayProp on <strong>June 17, 2025</strong>.</p>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 95%" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100">95%</div>
                                </div>
                                <small class="text-muted">All required fields are complete. Ready for sync.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Comments and Notes -->
                    <div th:if="${property.comment}" class="card">
                        <div class="card-header">
                            <h4 class="card-title">Notes & Comments</h4>
                        </div>
                        <div class="card-body">
                            <p th:text="${property.comment}">Property comments and notes...</p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Sidebar -->
                <div class="col-lg-4">
                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Quick Actions</h4>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                <a th:href="@{'/employee/customer/tenants?propertyId=' + ${property.id}}" 
                                class="list-group-item list-group-item-action">
                                    <i class="fas fa-users text-primary"></i> View Tenants
                                </a>
                                <a th:href="@{'/employee/ticket/property/' + ${property.id} + '/maintenance-history'}" 
                                class="list-group-item list-group-item-action">
                                    <i class="fas fa-wrench text-info"></i> Maintenance History
                                </a>
                                <a th:href="${home + 'employee/ticket/pending-bids?propertyId=' + property.id}" 
                                   class="list-group-item list-group-item-action">
                                    <i class="fas fa-gavel text-warning"></i> Pending Maintenance Bids
                                </a>
                                <a th:href="${home + 'employee/drive/list-files?folder=' + property.propertyName}" 
                                   class="list-group-item list-group-item-action">
                                    <i class="fas fa-folder text-warning"></i> Property Documents
                                </a>
                                <a th:href="@{'/employee/customer/property-owners?propertyId=' + ${property.id}}" 
                                class="list-group-item list-group-item-action">
                                    <i class="fas fa-user-tie text-success"></i> Property Owners
                                </a>
                                <a href="#financialSection" class="btn btn-success mt-2" onclick="$('#financialSection').show(); loadFinancialData();">
                                    <i class="fas fa-chart-line"></i> View Financials
                                </a>
                                <a th:href="${home + 'employee/property/portfolio-overview'}" 
                                   class="list-group-item list-group-item-action">
                                    <i class="fas fa-chart-bar text-purple"></i> Portfolio Overview
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Recent Activity</h4>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-success"></div>
                                    <div class="timeline-content">
                                        <h6 class="timeline-title">Property Created</h6>
                                        <p class="timeline-text">Property added to system</p>
                                        <span class="timeline-date" th:text="${property.createdAt != null ? #temporals.format(property.createdAt, 'dd/MM/yyyy HH:mm') : 'Unknown'}">15/06/2025 14:30</span>
                                    </div>
                                </div>
                                
                                <!-- Recent Maintenance Activity -->
                                <div th:if="${recentMaintenanceActivity}" th:each="activity : ${recentMaintenanceActivity}" class="timeline-item">
                                    <div class="timeline-marker" 
                                         th:classappend="${activity.urgencyLevel == 'emergency'} ? 'bg-danger' : 
                                                        (${activity.urgencyLevel == 'urgent'} ? 'bg-warning' : 'bg-info')"></div>
                                    <div class="timeline-content">
                                        <h6 class="timeline-title" th:text="${activity.title}">Maintenance Event</h6>
                                        <p class="timeline-text" th:text="${activity.description}">Event description</p>
                                        <span class="timeline-date" th:text="${#temporals.format(activity.timestamp, 'dd/MM/yyyy HH:mm')}">Date</span>
                                    </div>
                                </div>
                                
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-info"></div>
                                    <div class="timeline-content">
                                        <h6 class="timeline-title">PayProp Ready</h6>
                                        <p class="timeline-text">All required fields completed</p>
                                        <span class="timeline-date">15/06/2025 14:35</span>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-warning"></div>
                                    <div class="timeline-content">
                                        <h6 class="timeline-title">Pending Sync</h6>
                                        <p class="timeline-text">Awaiting PayProp integration</p>
                                        <span class="timeline-date">Goes live 17/06/2025</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Property Tags -->
                    <div th:if="${property.tags}" class="card">
                        <div class="card-header">
                            <h4 class="card-title">Tags</h4>
                        </div>
                        <div class="card-body">
                            <div class="tags">
                                <span th:each="tag : ${#strings.listSplit(property.tags, ',')}" 
                                      class="badge badge-light mr-1 mb-1" 
                                      th:text="${#strings.trim(tag)}">Tag</span>
                            </div>
                        </div>
                    </div>

                    <!-- Archive/Unarchive Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Property Management</h4>
                        </div>
                        <div class="card-body">
                            <div th:if="${property.isActive()}">
                                <form th:action="@{/employee/property/archive/{id}(id=${property.id})}" method="post" class="mb-2">
                                    <button type="submit" class="btn btn-warning btn-block" 
                                            onclick="return confirm('Are you sure you want to archive this property?')">
                                        <i class="fas fa-archive"></i> Archive Property
                                    </button>
                                </form>
                                <small class="text-muted">Archiving will hide this property from active listings.</small>
                            </div>
                            <div th:unless="${property.isActive()}">
                                <form th:action="@{/employee/property/unarchive/{id}(id=${property.id})}" method="post" class="mb-2">
                                    <button type="submit" class="btn btn-success btn-block">
                                        <i class="fas fa-undo"></i> Restore Property
                                    </button>
                                </form>
                                <small class="text-muted">Restore this property to active status.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div th:insert="~{general/right-sidebar.html}"></div>
        </div>
    </div>
    
    <div th:replace="~{general/footer.html}"></div>
</div>

<!-- Scripts -->
<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/popper.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/library/waves.js}"></script>
<script th:src="@{/js/library/sidebarmenu.js}"></script>
<script th:src="@{/js/library/custom.min.js}"></script>

<script>
// Load financial data when page loads
$(document).ready(function() {
    loadFinancialData();
    loadMaintenanceData();
});

function loadFinancialData(source) {
    // Check if jQuery is available
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded yet, retrying in 500ms...');
        setTimeout(() => loadFinancialData(source), 500);
        return;
    }

    // Default to current source if not specified
    if (!source) {
        source = currentDataSource || 'auto';
    }

    const propertyId = $('body').data('property-id');
    console.log('Property ID:', propertyId, 'Source:', source);

    // Validate property ID
    if (!propertyId || propertyId === 'null' || propertyId < 0) {
        console.error('Invalid property ID:', propertyId);
        $('#recentTransactionsBody').html('<tr><td colspan="8" class="text-center text-danger">Invalid property ID</td></tr>');
        return;
    }

    const url = `/employee/property/${propertyId}/financial-summary?source=${source}`;
    console.log('URL:', url);

    // Show loading indicator
    $('#recentTransactionsBody').html('<tr><td colspan="8" class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading financial data...</td></tr>');

    $.ajax({
        url: url,
        method: 'GET',
        success: function(data) {
            console.log('Financial data loaded:', data);
            updateFinancialDisplay(data);
            $('#financialSection').show();
        },
        error: function(xhr, status, error) {
            console.error('Error loading financial data:', error);
            $('#financialSection').show();
            $('#dataSourceMessage').show().addClass('alert-danger');
            $('#dataSourceMessageText').html('<i class="fas fa-exclamation-triangle"></i> Error loading financial data: ' + (xhr.responseJSON?.message || error));
            $('#recentTransactionsBody').html(
                '<tr><td colspan="8" class="text-center text-danger">Error loading financial data</td></tr>'
            );
        }
    });
}

function loadMaintenanceData() {
    const propertyId = $('body').data('property-id');
    
    $.ajax({
        url: `/employee/property/${propertyId}/maintenance-summary`,
        method: 'GET',
        success: function(data) {
            updateMaintenanceDisplay(data);
        },
        error: function(xhr, status, error) {
            console.error('Error loading maintenance data:', error);
        }
    });
}

// Global variables to store transaction data and current source
let allTransactionsData = [];
let currentDataSource = 'auto';

function updateFinancialDisplay(data) {
    // Update data availability indicators
    if (data.dataAvailability) {
        updateDataAvailability(data.dataAvailability);
    }

    // Show message about which data source is being displayed
    if (data.message) {
        $('#dataSourceMessage').show();
        $('#dataSourceMessageText').html('<i class="fas fa-info-circle"></i> ' + data.message);

        // Update alert class based on selected source
        $('#dataSourceMessage').removeClass('alert-info alert-success alert-warning');
        if (data.selectedSource === 'historical') {
            $('#dataSourceMessage').addClass('alert-success');
        } else if (data.selectedSource === 'payprop') {
            $('#dataSourceMessage').addClass('alert-info');
        } else {
            $('#dataSourceMessage').addClass('alert-warning');
        }
    }

    // Update metrics with data from selected source
    $('#totalIncome').text('£' + formatNumber(data.totalIncome || 0));
    $('#totalCommissions').text('£' + formatNumber(data.totalCommissions || 0));
    $('#netOwnerIncome').text('£' + formatNumber(data.netOwnerIncome || 0));
    $('#transactionCount').text(data.transactionCount || 0);

    // Add expenses card if data is available
    if (data.totalExpenses !== undefined && data.totalExpenses > 0) {
        if ($('#totalExpenses').length === 0) {
            const expensesCard = `
                <div class="col-md-3" id="expensesCardContainer">
                    <div class="card">
                        <div class="card-body text-center">
                            <h4 class="text-danger" id="totalExpenses">£${formatNumber(data.totalExpenses)}</h4>
                            <p class="text-muted">Total Expenses</p>
                        </div>
                    </div>
                </div>
            `;
            $('#transactionCount').closest('.col-md-3').after(expensesCard);
        } else {
            $('#totalExpenses').text('£' + formatNumber(data.totalExpenses));
        }
    }

    // Store transaction data globally for filtering
    allTransactionsData = data.recentTransactions || [];

    // Display transactions with enhanced formatting
    displayTransactions(allTransactionsData, 'all');
}

function updateDataAvailability(availability) {
    // Update badge counts
    $('#historicalCount').text(availability.historicalCount || 0);
    $('#paypropCount').text(availability.payPropCount || 0);

    // Enable/disable buttons based on data availability
    if (!availability.hasHistoricalData) {
        $('#sourceHistorical').prop('disabled', true).addClass('disabled');
        $('#sourceHistorical').attr('title', 'No historical data available');
    } else {
        $('#sourceHistorical').prop('disabled', false).removeClass('disabled');
        $('#sourceHistorical').attr('title', availability.historicalCount + ' historical transactions');
    }

    if (!availability.hasPayPropData) {
        $('#sourcePayProp').prop('disabled', true).addClass('disabled');
        $('#sourcePayProp').attr('title', 'No PayProp data available');
    } else {
        $('#sourcePayProp').prop('disabled', false).removeClass('disabled');
        $('#sourcePayProp').attr('title', availability.payPropCount + ' PayProp transactions');
    }
}

function switchDataSource(source) {
    // Update current source
    currentDataSource = source;

    // Update active button
    $('#dataSourceToggle .btn').removeClass('active');
    $('#source' + source.charAt(0).toUpperCase() + source.slice(1)).addClass('active');

    // Reload data with new source
    loadFinancialData(source);
}

function updateCurrentBalance(balance) {
    // Add current balance display if not already present
    if ($('#currentBalance').length === 0) {
        const balanceCard = `
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h4 class="text-info" id="currentBalance">£${formatNumber(balance)}</h4>
                        <p class="text-muted">Current Balance</p>
                    </div>
                </div>
            </div>
        `;
        $('#financialMetrics .row').append(balanceCard);
    } else {
        $('#currentBalance').text('£' + formatNumber(balance));
    }
}

function updateMonthlyMetrics(data) {
    // Add monthly metrics section if not present
    if ($('#monthlyMetrics').length === 0) {
        const monthlySection = `
            <div class="row mt-3" id="monthlyMetrics">
                <div class="col-12">
                    <h6 class="text-muted mb-2">This Month</h6>
                </div>
                <div class="col-md-4">
                    <div class="card card-sm">
                        <div class="card-body text-center p-2">
                            <h6 class="text-success mb-0" id="monthlyIncoming">£${formatNumber(data.monthlyIncoming || 0)}</h6>
                            <small class="text-muted">Income</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-sm">
                        <div class="card-body text-center p-2">
                            <h6 class="text-danger mb-0" id="monthlyOutgoing">£${formatNumber(data.monthlyOutgoing || 0)}</h6>
                            <small class="text-muted">Expenses</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-sm">
                        <div class="card-body text-center p-2">
                            <h6 class="text-primary mb-0" id="monthlyNet">£${formatNumber(data.monthlyNet || 0)}</h6>
                            <small class="text-muted">Net</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        $('#financialMetrics').after(monthlySection);
    } else {
        $('#monthlyIncoming').text('£' + formatNumber(data.monthlyIncoming || 0));
        $('#monthlyOutgoing').text('£' + formatNumber(data.monthlyOutgoing || 0));
        $('#monthlyNet').text('£' + formatNumber(data.monthlyNet || 0));
    }
}

function updateCategoryBreakdown(data) {
    // Add category breakdown if data is available
    if (data.incomeByCategory || data.expensesByCategory) {
        const hasIncomeCategories = data.incomeByCategory && Object.keys(data.incomeByCategory).length > 0;
        const hasExpenseCategories = data.expensesByCategory && Object.keys(data.expensesByCategory).length > 0;
        
        if ((hasIncomeCategories || hasExpenseCategories) && $('#categoryBreakdown').length === 0) {
            let categoriesHtml = `
                <div class="row mt-4" id="categoryBreakdown">
                    <div class="col-12">
                        <h6 class="text-muted mb-2">Category Breakdown</h6>
                    </div>
            `;
            
            if (hasIncomeCategories) {
                categoriesHtml += `
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header p-2">
                                <h6 class="mb-0 text-success">Income Categories</h6>
                            </div>
                            <div class="card-body p-2">
                                <ul class="list-unstyled mb-0" id="incomeCategories">
                `;
                
                Object.entries(data.incomeByCategory).forEach(([category, amount]) => {
                    categoriesHtml += `<li class="d-flex justify-content-between"><span>${category}:</span><span class="text-success">£${formatNumber(amount)}</span></li>`;
                });
                
                categoriesHtml += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (hasExpenseCategories) {
                categoriesHtml += `
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header p-2">
                                <h6 class="mb-0 text-danger">Expense Categories</h6>
                            </div>
                            <div class="card-body p-2">
                                <ul class="list-unstyled mb-0" id="expenseCategories">
                `;
                
                Object.entries(data.expensesByCategory).forEach(([category, amount]) => {
                    categoriesHtml += `<li class="d-flex justify-content-between"><span>${category}:</span><span class="text-danger">£${formatNumber(amount)}</span></li>`;
                });
                
                categoriesHtml += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            categoriesHtml += `</div>`;
            
            $('#recentTransactionsTable').closest('.row').before(categoriesHtml);
        }
    }
}

function displayTransactions(transactions, filterType) {
    const tbody = $('#recentTransactionsBody');
    tbody.empty();

    if (!transactions || transactions.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center text-muted">No recent transactions</td></tr>');
        return;
    }

    // Display all transactions (simple display for both historical and PayProp)
    transactions.forEach(function(transaction) {
        // Common transaction structure from both sources
        const transactionDate = transaction.date;
        const description = transaction.description || '';
        const category = transaction.category || '';
        const type = transaction.type || '';
        const amount = transaction.amount || 0;

        // Determine styling based on amount (positive = income, negative = expense)
        const isExpense = amount < 0;
        const amountClass = isExpense ? 'text-danger' : 'text-success';
        const amountPrefix = isExpense ? '' : '+';

        // Determine category badge color
        let categoryClass = 'badge-secondary';
        if (category === 'rent' || category.toLowerCase().includes('income')) {
            categoryClass = 'badge-success';
        } else if (category === 'commission' || category.toLowerCase().includes('commission')) {
            categoryClass = 'badge-warning';
        } else if (category.toLowerCase().includes('expense') || isExpense) {
            categoryClass = 'badge-danger';
        }

        // Get transaction ID for invoice generation (expenses only)
        const transactionId = transaction.id || transaction.transactionId;
        const showInvoiceBtn = isExpense && transactionId;

        const row = `
            <tr class="transaction-row">
                <td>${formatDate(transactionDate)}</td>
                <td>
                    <div>
                        ${description}
                        ${category ? `<br><span class="badge ${categoryClass} badge-sm">${category}</span>` : ''}
                    </div>
                </td>
                <td>
                    <small class="text-muted">${type || '-'}</small>
                </td>
                <td class="${amountClass} fw-bold text-end">${amountPrefix}£${formatNumber(Math.abs(amount))}</td>
                <td class="text-center">
                    <span class="badge badge-info badge-sm">${currentDataSource === 'historical' ? 'Historical' : (currentDataSource === 'payprop' ? 'PayProp' : 'Auto')}</span>
                </td>
                <td class="text-center">
                    ${showInvoiceBtn ? `
                        <a href="/expense-documents/invoice/${transactionId}/pdf"
                           class="btn btn-sm btn-outline-danger" title="Download Expense Invoice">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                    ` : '<span class="text-muted">-</span>'}
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function displayGroupedTransactions(transactions) {
    const tbody = $('#recentTransactionsBody');
    tbody.empty();
    
    // Group transactions by date and related transactions
    const groupedByDate = {};
    transactions.forEach(transaction => {
        const dateKey = transaction.transactionDate;
        if (!groupedByDate[dateKey]) {
            groupedByDate[dateKey] = [];
        }
        groupedByDate[dateKey].push(transaction);
    });
    
    // Display grouped transactions
    Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
        const dayTransactions = groupedByDate[date];
        
        // Calculate daily totals
        const totalInvoices = dayTransactions.filter(t => t.transactionType === 'invoice').reduce((sum, t) => sum + (t.amount || 0), 0);
        const totalPayments = dayTransactions.filter(t => t.transactionType.includes('payment_to_')).reduce((sum, t) => sum + (t.amount || 0), 0);
        const totalCommissions = dayTransactions.filter(t => t.transactionType === 'commission_payment').reduce((sum, t) => sum + (t.amount || 0), 0);
        
        // Add group header
        const variance = Math.abs(totalInvoices - totalPayments - totalCommissions);
        const varianceClass = variance > 1 ? 'text-danger' : 'text-success';
        
        tbody.append(`
            <tr class="table-secondary group-header">
                <td colspan="8">
                    <strong>${formatDate(date)}</strong> - 
                    Invoiced: £${formatNumber(totalInvoices)} | 
                    Paid: £${formatNumber(totalPayments)} | 
                    Commission: £${formatNumber(totalCommissions)} 
                    <span class="${varianceClass}">
                        ${variance > 1 ? `(Variance: £${formatNumber(variance)})` : '✓'}
                    </span>
                </td>
            </tr>
        `);
        
        // Add individual transactions with indentation
        dayTransactions.forEach(function(transaction) {
            const sourceInfo = getDataSourceInfo(transaction);
            
            tbody.append(`
                <tr class="transaction-row grouped-row">
                    <td class="ps-4">↳</td>
                    <td>
                        <span class="badge ${sourceInfo.badgeClass}">
                            ${formatTransactionType(transaction.transactionType)}
                        </span>
                    </td>
                    <td>£${formatNumber(transaction.amount)}</td>
                    <td>£${formatNumber(transaction.commissionAmount || 0)}</td>
                    <td>£${formatNumber(transaction.netToOwnerAmount || 0)}</td>
                    <td>${transaction.categoryName || 'N/A'}</td>
                    <td>
                        <span class="badge ${sourceInfo.sourceBadgeClass}">
                            ${sourceInfo.sourceLabel}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${sourceInfo.statusBadgeClass || 'bg-secondary'}">
                            ${getTransactionPurpose(transaction)}
                        </span>
                    </td>
                </tr>
            `);
        });
    });
}

// Enhanced helper functions
function getDataSourceInfo(transaction) {
    const dataSource = transaction.dataSource || 'UNKNOWN';
    
    switch(dataSource) {
        case 'ICDN_ACTUAL':
            return {
                sourceLabel: 'ACTUAL',
                sourceBadgeClass: 'bg-success',
                badgeClass: 'bg-success',
                rowClass: 'table-light',
                description: 'Real invoice/transaction from PayProp ICDN'
            };
        case 'COMMISSION_PAYMENT':
            return {
                sourceLabel: 'CALCULATED',
                sourceBadgeClass: 'bg-info',
                badgeClass: 'bg-info',
                rowClass: '',
                description: 'System-calculated commission based on property rates'
            };
        case 'BATCH_PAYMENT':
            return {
                sourceLabel: 'ACTUAL',
                sourceBadgeClass: 'bg-success',
                badgeClass: 'bg-primary',
                rowClass: 'table-light',
                description: 'Real payment from PayProp batch payments'
            };
        case 'PAYMENT_INSTRUCTION':
            return {
                sourceLabel: 'INSTRUCTION',
                sourceBadgeClass: 'bg-warning',
                badgeClass: 'bg-warning',
                rowClass: '',
                description: 'Payment instruction (what should be paid)'
            };
        default:
            return {
                sourceLabel: 'UNKNOWN',
                sourceBadgeClass: 'bg-secondary',
                badgeClass: 'bg-secondary',
                rowClass: '',
                description: 'Unknown data source'
            };
    }
}

function getTransactionStatus(transaction) {
    const isActual = transaction.isActualTransaction;
    const isInstruction = transaction.isInstruction;
    
    if (transaction.dataSource === 'COMMISSION_PAYMENT') {
        return {
            label: 'SYNTHETIC',
            badgeClass: 'bg-warning',
            description: 'System-generated commission calculation'
        };
    }
    
    if (isActual) {
        return {
            label: 'COMPLETED',
            badgeClass: 'bg-success',
            description: 'Real transaction completed in PayProp'
        };
    }
    
    if (isInstruction) {
        return {
            label: 'INSTRUCTION',
            badgeClass: 'bg-info',
            description: 'Payment instruction awaiting completion'
        };
    }
    
    return {
        label: 'PROCESSED',
        badgeClass: 'bg-secondary',
        description: 'Transaction processed'
    };
}

function getReconciliationStatus(transaction) {
    const hasReconciliationDate = transaction.reconciliationDate;
    const hasInstructionDate = transaction.instructionDate;
    
    if (hasReconciliationDate && hasInstructionDate) {
        const reconDate = new Date(transaction.reconciliationDate);
        const instrDate = new Date(transaction.instructionDate);
        const daysDiff = Math.abs((reconDate - instrDate) / (1000 * 60 * 60 * 24));
        
        if (daysDiff > 7) {
            return { icon: '<i class="fas fa-exclamation-triangle text-warning ms-1" title="Delayed reconciliation"></i>' };
        }
    }
    
    if (hasReconciliationDate) {
        return { icon: '<i class="fas fa-check-circle text-success ms-1" title="Reconciled"></i>' };
    }
    
    return { icon: '' };
}

function getAmountClass(amount) {
    if (!amount) return '';
    return amount > 1000 ? 'fw-bold' : '';
}

function getTransactionPurpose(transaction) {
    if (transaction.transactionType === 'commission_payment') {
        return 'Commission';
    }
    if (transaction.transactionType === 'invoice') {
        return transaction.categoryName === 'Deposit' ? 'Deposit' : 'Income';
    }
    if (transaction.transactionType.includes('payment_to_')) {
        return 'Outgoing';
    }
    return 'Other';
}

// Filter button functions
function filterTransactions(filterType) {
    // Update active button
    $('.btn-group .btn').removeClass('active');
    $(`#filter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`).addClass('active');
    
    // Display filtered transactions
    displayTransactions(allTransactionsData, filterType);
}

// Enhanced formatting functions  
function formatTransactionType(type) {
    const typeMap = {
        'invoice': 'Invoice',
        'commission_payment': 'Commission',
        'payment_to_beneficiary': 'To Beneficiary',
        'payment_to_agency': 'To Agency',
        'payment_to_contractor': 'To Contractor',
        'payment_property_account': 'Property Account',
        'payment_deposit_account': 'Deposit Account',
        'credit_note': 'Credit Note',
        'debit_note': 'Debit Note',
        'deposit': 'Deposit',
        'refund': 'Refund',
        'adjustment': 'Adjustment',
        'transfer': 'Transfer'
    };
    
    return typeMap[type] || type;
}

function updateMaintenanceDisplay(data) {
    // Update maintenance statistics if received
    if (data) {
        // Update counters dynamically
        $('.maintenance-stats h3').eq(0).text(data.activeMaintenanceCount || 0);
        // Additional maintenance display updates can go here
    }
}

function formatNumber(number) {
    if (!number) return '0.00';
    return parseFloat(number).toLocaleString('en-GB', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString('en-GB');
}

function getTransactionTypeClass(type) {
    switch(type) {
        case 'invoice': return 'success';
        case 'credit_note': return 'info';
        case 'debit_note': return 'warning';
        default: return 'secondary';
    }
}

// PayProp-specific helper functions
function getPayPropDataSourceInfo(transaction) {
    const isIncoming = transaction.is_incoming;
    const transactionType = transaction.transaction_type || '';
    
    return {
        rowClass: isIncoming ? 'table-success-light' : 'table-danger-light',
        badgeClass: isIncoming ? 'badge-success' : 'badge-danger',
        sourceBadgeClass: 'badge-info',
        sourceLabel: 'PayProp',
        description: 'PayProp API Data'
    };
}

function getPayPropTransactionStatus(transaction) {
    // For PayProp transactions, status is generally 'Active' since they're from live API
    return {
        badgeClass: 'badge-success',
        label: 'Active',
        description: 'Live PayProp Data'
    };
}

function refreshFinancialData() {
    loadFinancialData(currentDataSource);
}

function refreshMaintenanceData() {
    loadMaintenanceData();
}
</script>

</body>
</html>