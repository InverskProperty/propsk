<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" content="${_csrf.token}"/>
<meta name="_csrf_header" content="${_csrf.headerName}"/>

<!-- Dashboard CSS -->
<link th:href="@{/css/dataTables.bootstrap4.css}" rel="stylesheet">
<link th:href="@{/css/fullcalendar.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">Property Viewings</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>

    <div class="page-wrapper">
        <div class="container-fluid">
            <!-- Page Title -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h3 class="text-themecolor">Property Viewing Management</h3>
                    <p class="text-muted">Schedule and manage property viewings</p>
                </div>
                <div class="col-md-4 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <button class="btn btn-success" data-toggle="modal" data-target="#scheduleViewingModal">
                            <i class="fas fa-calendar-plus"></i> Schedule New Viewing
                        </button>
                    </div>
                </div>
            </div>

            <!-- Viewing Statistics -->
            <div class="row">
                <div class="col-md-3 col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-row">
                                <div class="round round-lg align-self-center round-info">
                                    <i class="fas fa-calendar"></i>
                                </div>
                                <div class="m-l-10 align-self-center">
                                    <h3 class="m-b-0 font-light" th:text="${scheduledViewings != null ? #lists.size(scheduledViewings) : 0}">0</h3>
                                    <h5 class="text-muted m-b-0">Scheduled</h5>
                                    <small class="text-info">Upcoming</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-row">
                                <div class="round round-lg align-self-center round-success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="m-l-10 align-self-center">
                                    <h3 class="m-b-0 font-light" th:text="${completedViewings != null ? #lists.size(completedViewings) : 0}">0</h3>
                                    <h5 class="text-muted m-b-0">Completed</h5>
                                    <small class="text-success">This month</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-row">
                                <div class="round round-lg align-self-center round-warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="m-l-10 align-self-center">
                                    <h3 class="m-b-0 font-light" th:text="${todayViewings != null ? #lists.size(todayViewings) : 0}">0</h3>
                                    <h5 class="text-muted m-b-0">Today</h5>
                                    <small class="text-warning">Action needed</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-row">
                                <div class="round round-lg align-self-center round-danger">
                                    <i class="fas fa-undo"></i>
                                </div>
                                <div class="m-l-10 align-self-center">
                                    <h3 class="m-b-0 font-light" th:text="${needsFollowUp != null ? #lists.size(needsFollowUp) : 0}">0</h3>
                                    <h5 class="text-muted m-b-0">Needs Follow-up</h5>
                                    <small class="text-danger">Pending</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Viewings -->
            <div class="row" th:if="${!#lists.isEmpty(todayViewings)}">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h4 class="card-title text-warning">
                                <i class="fas fa-clock"></i> Today's Viewings
                            </h4>
                            <h6 class="card-subtitle">Viewings scheduled for today</h6>
                            <div class="table-responsive m-t-20">
                                <table class="table table-hover stylish-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Property</th>
                                            <th>Lead Name</th>
                                            <th>Contact</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="viewing : ${todayViewings}">
                                            <td>
                                                <strong th:text="${#temporals.format(viewing.scheduledDatetime, 'HH:mm')}">14:00</strong>
                                                <br>
                                                <small class="text-muted" th:text="${viewing.durationMinutes + ' mins'}">30 mins</small>
                                            </td>
                                            <td>
                                                <h6 class="m-b-0" th:text="${viewing.property.addressLine1}">Property</h6>
                                                <small class="text-muted" th:text="${viewing.property.city}">City</small>
                                            </td>
                                            <td th:text="${viewing.lead.name}">Lead Name</td>
                                            <td>
                                                <span th:text="${viewing.lead.phone}">Phone</span>
                                            </td>
                                            <td>
                                                <span class="badge badge-info" th:text="${viewing.viewingType}">IN_PERSON</span>
                                            </td>
                                            <td>
                                                <span class="badge"
                                                      th:classappend="${viewing.status == 'COMPLETED' ? 'badge-success' : (viewing.status == 'CONFIRMED' ? 'badge-info' : 'badge-warning')}"
                                                      th:text="${viewing.status}">SCHEDULED</span>
                                            </td>
                                            <td>
                                                <button th:if="${viewing.status == 'SCHEDULED' || viewing.status == 'CONFIRMED'}"
                                                        class="btn btn-sm btn-success complete-viewing-btn"
                                                        th:attr="data-viewing-id=${viewing.id}">
                                                    <i class="fas fa-check"></i> Complete
                                                </button>
                                                <button class="btn btn-sm btn-info record-feedback-btn"
                                                        th:attr="data-viewing-id=${viewing.id}">
                                                    <i class="fas fa-comment"></i> Feedback
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Viewings -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">
                                <i class="fas fa-calendar text-info"></i> Upcoming Viewings
                            </h4>
                            <h6 class="card-subtitle">Scheduled property viewings</h6>
                            <div class="table-responsive m-t-20">
                                <table class="table table-hover stylish-table" id="upcomingViewingsTable">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>Property</th>
                                            <th>Lead Name</th>
                                            <th>Contact</th>
                                            <th>Type</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:if="${#lists.isEmpty(scheduledViewings)}">
                                            <td colspan="8" class="text-center text-muted">
                                                <i class="fas fa-info-circle"></i> No upcoming viewings scheduled
                                            </td>
                                        </tr>
                                        <tr th:each="viewing : ${scheduledViewings}">
                                            <td>
                                                <strong th:text="${#temporals.format(viewing.scheduledDatetime, 'dd MMM yyyy')}">15 Jan 2024</strong>
                                                <br>
                                                <span th:text="${#temporals.format(viewing.scheduledDatetime, 'HH:mm')}">14:00</span>
                                            </td>
                                            <td>
                                                <h6 class="m-b-0" th:text="${viewing.property.addressLine1}">Property</h6>
                                                <small class="text-muted" th:text="${viewing.property.city}">City</small>
                                            </td>
                                            <td th:text="${viewing.lead.name}">Lead Name</td>
                                            <td>
                                                <small th:text="${viewing.lead.phone}">Phone</small>
                                            </td>
                                            <td>
                                                <span class="badge badge-info" th:text="${viewing.viewingType}">IN_PERSON</span>
                                            </td>
                                            <td th:text="${viewing.durationMinutes + ' mins'}">30 mins</td>
                                            <td>
                                                <span class="badge"
                                                      th:classappend="${viewing.status == 'CONFIRMED' ? 'badge-success' : 'badge-info'}"
                                                      th:text="${viewing.status}">SCHEDULED</span>
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    <button th:if="${viewing.status == 'SCHEDULED'}"
                                                            class="btn btn-sm btn-success confirm-viewing-btn"
                                                            th:attr="data-viewing-id=${viewing.id}">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-warning reschedule-viewing-btn"
                                                            th:attr="data-viewing-id=${viewing.id}">
                                                        <i class="fas fa-calendar-alt"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger cancel-viewing-btn"
                                                            th:attr="data-viewing-id=${viewing.id}">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Completed Viewings Needing Follow-up -->
            <div class="row" th:if="${!#lists.isEmpty(needsFollowUp)}">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-body">
                            <h4 class="card-title text-danger">
                                <i class="fas fa-undo"></i> Viewings Needing Follow-up
                            </h4>
                            <h6 class="card-subtitle">These viewings have been completed but need follow-up action</h6>
                            <div class="table-responsive m-t-20">
                                <table class="table table-hover stylish-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Property</th>
                                            <th>Lead Name</th>
                                            <th>Outcome</th>
                                            <th>Feedback</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="viewing : ${needsFollowUp}">
                                            <td th:text="${#temporals.format(viewing.scheduledDatetime, 'dd MMM yyyy')}">15 Jan 2024</td>
                                            <td>
                                                <span th:text="${viewing.property.addressLine1}">Property</span>
                                            </td>
                                            <td th:text="${viewing.lead.name}">Lead Name</td>
                                            <td>
                                                <span class="badge"
                                                      th:classappend="${viewing.outcome == 'INTERESTED' ? 'badge-success' : (viewing.outcome == 'NOT_INTERESTED' ? 'badge-danger' : 'badge-warning')}"
                                                      th:text="${viewing.outcome}">INTERESTED</span>
                                            </td>
                                            <td>
                                                <small th:text="${viewing.leadFeedback != null ? viewing.leadFeedback : 'No feedback'}">Feedback</small>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-primary send-follow-up-btn"
                                                        th:attr="data-viewing-id=${viewing.id}">
                                                    <i class="fas fa-envelope"></i> Send Follow-up
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div th:replace="~{general/footer.html}"></div>
    </div>
</div>

<!-- Schedule Viewing Modal -->
<div class="modal fade" id="scheduleViewingModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus"></i> Schedule Property Viewing
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="scheduleViewingForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Property <span class="text-danger">*</span></label>
                                <select class="form-control" id="viewingPropertyId" name="propertyId" required>
                                    <option value="">Select Property</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Lead <span class="text-danger">*</span></label>
                                <select class="form-control" id="viewingLeadId" name="leadId" required>
                                    <option value="">Select Lead</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Date & Time <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="scheduledDatetime" name="scheduledDatetime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Duration (minutes) <span class="text-danger">*</span></label>
                                <select class="form-control" id="durationMinutes" name="durationMinutes" required>
                                    <option value="15">15 minutes</option>
                                    <option value="30" selected>30 minutes</option>
                                    <option value="45">45 minutes</option>
                                    <option value="60">1 hour</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Viewing Type <span class="text-danger">*</span></label>
                                <select class="form-control" id="viewingType" name="viewingType" required>
                                    <option value="IN_PERSON" selected>In Person</option>
                                    <option value="VIRTUAL">Virtual</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control" id="viewingNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmScheduleBtn">
                    <i class="fas fa-calendar-plus"></i> Schedule Viewing
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Record Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-comment"></i> Record Viewing Feedback
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <input type="hidden" id="feedbackViewingId" name="viewingId">

                    <div class="form-group">
                        <label>Outcome <span class="text-danger">*</span></label>
                        <select class="form-control" id="outcome" name="outcome" required>
                            <option value="">Select Outcome</option>
                            <option value="INTERESTED">Interested - Wants to Apply</option>
                            <option value="MAYBE">Maybe - Needs to Think</option>
                            <option value="NOT_INTERESTED">Not Interested</option>
                            <option value="NO_SHOW">No Show</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Lead Feedback</label>
                        <textarea class="form-control" id="leadFeedback" name="leadFeedback" rows="3"
                                  placeholder="What did the lead think about the property?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Agent Notes</label>
                        <textarea class="form-control" id="agentNotes" name="agentNotes" rows="3"
                                  placeholder="Internal notes about the viewing"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="confirmFeedbackBtn">
                    <i class="fas fa-save"></i> Save Feedback
                </button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{general/scripts.html}"></div>

<script th:inline="javascript">
$(document).ready(function() {
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");

    // Initialize DataTable
    $('#upcomingViewingsTable').DataTable({
        "paging": true,
        "pageLength": 25,
        "order": [[0, "asc"]] // Sort by date/time
    });

    // Load properties and leads for scheduling
    $('#scheduleViewingModal').on('show.bs.modal', function() {
        // Load available properties
        $.ajax({
            url: '/employee/property-viewing/api/available-properties',
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(properties) {
                const select = $('#viewingPropertyId');
                select.empty().append('<option value="">Select Property</option>');
                properties.forEach(function(property) {
                    select.append('<option value="' + property.id + '">' +
                        property.addressLine1 + ', ' + property.city + '</option>');
                });
            }
        });

        // Load active leads
        $.ajax({
            url: '/employee/property-viewing/api/active-leads',
            type: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(leads) {
                const select = $('#viewingLeadId');
                select.empty().append('<option value="">Select Lead</option>');
                leads.forEach(function(lead) {
                    select.append('<option value="' + lead.leadId + '">' +
                        lead.name + ' - ' + lead.phone + '</option>');
                });
            }
        });
    });

    // Schedule Viewing
    $('#confirmScheduleBtn').click(function() {
        const formData = {
            propertyId: $('#viewingPropertyId').val(),
            leadId: $('#viewingLeadId').val(),
            scheduledDatetime: $('#scheduledDatetime').val(),
            durationMinutes: $('#durationMinutes').val(),
            viewingType: $('#viewingType').val(),
            notes: $('#viewingNotes').val()
        };

        if (!formData.propertyId || !formData.leadId || !formData.scheduledDatetime) {
            toastr.error('Please fill in all required fields');
            return;
        }

        $.ajax({
            url: '/employee/property-viewing/api/schedule',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                toastr.success('Viewing scheduled successfully');
                $('#scheduleViewingModal').modal('hide');
                setTimeout(() => location.reload(), 1500);
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to schedule viewing';
                toastr.error(error);
            }
        });
    });

    // Confirm Viewing
    $('.confirm-viewing-btn').click(function() {
        const viewingId = $(this).data('viewing-id');

        $.ajax({
            url: '/employee/property-viewing/api/confirm/' + viewingId,
            type: 'POST',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                toastr.success('Viewing confirmed');
                setTimeout(() => location.reload(), 1000);
            },
            error: function(xhr) {
                toastr.error('Failed to confirm viewing');
            }
        });
    });

    // Complete Viewing
    $('.complete-viewing-btn').click(function() {
        const viewingId = $(this).data('viewing-id');

        $.ajax({
            url: '/employee/property-viewing/api/complete/' + viewingId,
            type: 'POST',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                toastr.success('Viewing marked as completed');
                setTimeout(() => location.reload(), 1000);
            },
            error: function(xhr) {
                toastr.error('Failed to complete viewing');
            }
        });
    });

    // Cancel Viewing
    $('.cancel-viewing-btn').click(function() {
        const viewingId = $(this).data('viewing-id');

        if (confirm('Are you sure you want to cancel this viewing?')) {
            $.ajax({
                url: '/employee/property-viewing/api/cancel/' + viewingId,
                type: 'POST',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader(header, token);
                },
                success: function(response) {
                    toastr.success('Viewing cancelled');
                    setTimeout(() => location.reload(), 1000);
                },
                error: function(xhr) {
                    toastr.error('Failed to cancel viewing');
                }
            });
        }
    });

    // Record Feedback
    $('.record-feedback-btn').click(function() {
        const viewingId = $(this).data('viewing-id');
        $('#feedbackViewingId').val(viewingId);
        $('#feedbackModal').modal('show');
    });

    // Save Feedback
    $('#confirmFeedbackBtn').click(function() {
        const viewingId = $('#feedbackViewingId').val();
        const formData = {
            outcome: $('#outcome').val(),
            leadFeedback: $('#leadFeedback').val(),
            agentNotes: $('#agentNotes').val()
        };

        if (!formData.outcome) {
            toastr.error('Please select an outcome');
            return;
        }

        $.ajax({
            url: '/employee/property-viewing/api/feedback/' + viewingId,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                toastr.success('Feedback saved successfully');
                $('#feedbackModal').modal('hide');
                setTimeout(() => location.reload(), 1000);
            },
            error: function(xhr) {
                toastr.error('Failed to save feedback');
            }
        });
    });

    // Send Follow-up
    $('.send-follow-up-btn').click(function() {
        const viewingId = $(this).data('viewing-id');

        $.ajax({
            url: '/employee/property-viewing/api/send-follow-up/' + viewingId,
            type: 'POST',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                toastr.success('Follow-up email sent');
                setTimeout(() => location.reload(), 1000);
            },
            error: function(xhr) {
                toastr.error('Failed to send follow-up');
            }
        });
    });
});
</script>

</body>
</html>
