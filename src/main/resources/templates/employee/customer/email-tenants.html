<!-- employee/customer/email-tenants.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" content="${_csrf.token}"/>
<meta name="_csrf_header" content="${_csrf.headerName}"/>

<!-- Custom CSS -->
<link th:href="@{/css/style.min.css}" rel="stylesheet">
<!-- page css -->
<link th:href="@{/css/pages/inbox.css}" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<style>
.tenant-item {
    padding: 8px;
    border-bottom: 1px solid #f0f0f0;
}
.tenant-item:hover {
    background-color: #f8f9fa;
}
</style>
</head>

<body class="skin-blue fixed-layout">
<!-- ============================================================== -->
<!-- Preloader - style you can find in spinners.css -->
<!-- ============================================================== -->
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>
<!-- ============================================================== -->
<!-- Main wrapper - style you can find in pages.scss -->
<!-- ============================================================== -->
<div id="main-wrapper">
    <!-- ============================================================== -->
    <!-- Topbar header - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div th:replace="~{general/header.html}"></div>
    <!-- ============================================================== -->
    <!-- End Topbar header -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Left Sidebar - style you can find in sidebar.scss  -->
    <!-- ============================================================== -->
    <div th:replace="~{general/left-sidebar.html}"></div>
    <!-- ============================================================== -->
    <!-- End Left Sidebar - style you can find in sidebar.scss  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Page wrapper  -->
    <!-- ============================================================== -->
    <div class="page-wrapper">
        <!-- ============================================================== -->
        <!-- Container fluid  -->
        <!-- ============================================================== -->
        <div class="container-fluid">
            <!-- ============================================================== -->
            <!-- Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <div th:insert="~{general/page-titles.html}"></div>
            <!-- ============================================================== -->
            <!-- End Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Start Page Content -->
            <!-- ============================================================== -->
            <div class="row">
                <div class="col-lg-12">
                    <!-- Success/Error Messages -->
                    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h3 class="text-success"><i class="fa fa-check-circle"></i> Success</h3>
                        <span th:text="${successMessage}"></span>
                    </div>
                    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h3 class="text-danger"><i class="fa fa-exclamation-circle"></i> Error</h3>
                        <span th:text="${errorMessage}"></span>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">
                                <i class="fa fa-envelope"></i> Email Tenants
                                <span class="badge badge-primary ml-2">
                                    <span id="selectedCount">0</span> selected
                                </span>
                            </h4>
                            <h6 class="card-subtitle">Send bulk emails to tenants with personalized document attachments</h6>

                            <form th:action="@{/employee/gmail/send}" method="post" class="m-t-40" id="emailForm">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                                <!-- FILTERING SECTION -->
                                <div class="card border-info m-b-20">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fa fa-filter"></i> Filter Tenants</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Filter by Block</label>
                                                    <select class="form-control" id="blockFilter" onchange="filterTenants()">
                                                        <option value="">All Blocks</option>
                                                        <option th:each="block : ${blocks}" th:value="${block.blockName}" th:text="${block.blockName}">Block Name</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Search Tenants</label>
                                                    <input type="text" class="form-control" id="searchBox"
                                                           placeholder="Search by name or email..."
                                                           onkeyup="filterTenants()">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>&nbsp;</label>
                                                    <div>
                                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAll()">
                                                            <i class="fa fa-check-square"></i> Select All
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAll()">
                                                            <i class="fa fa-square"></i> Deselect All
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- RECIPIENTS SELECTION -->
                                <div class="form-group">
                                    <label class="control-label">Select Recipients:</label>
                                    <div id="tenantList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 3px;">
                                        <div th:each="tenant : ${tenants}" class="tenant-item form-check"
                                             th:attr="data-name=${tenant.name?.toLowerCase()}, data-email=${tenant.email?.toLowerCase()}, data-block=${tenant.block?.blockName}">
                                            <input class="form-check-input tenant-checkbox" type="checkbox"
                                                   th:id="'tenant_' + ${tenant.customerId}"
                                                   name="selectedIds"
                                                   th:value="${tenant.customerId}"
                                                   onchange="updateSelectedCount()">
                                            <label class="form-check-label" th:for="'tenant_' + ${tenant.customerId}">
                                                <strong th:text="${tenant.name}">Tenant Name</strong>
                                                <small class="text-muted" th:text="' (' + ${tenant.email} + ')'">email</small>
                                                <span th:if="${tenant.block != null}" class="badge badge-secondary ml-1" th:text="${tenant.block.blockName}">Block</span>
                                            </label>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">
                                        Select tenants to receive this email
                                    </small>
                                </div>

                                <!-- EMAIL TEMPLATE SELECTION -->
                                <div class="card border-info m-b-20" th:if="${emailTemplates != null && !emailTemplates.isEmpty()}">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fa fa-file-text"></i> Email Template (Optional)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <select class="form-control" id="emailTemplateId" name="emailTemplateId" onchange="loadEmailTemplate()">
                                                    <option value="">-- No Template --</option>
                                                    <option th:each="template : ${emailTemplates}"
                                                            th:value="${template.templateId}"
                                                            th:text="${template.name}"
                                                            th:attr="data-subject=${template.subject}, data-body=${template.body}">
                                                        Template Name
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearEmailTemplate()">
                                                    <i class="fa fa-times"></i> Clear Template
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- DOCUMENT TEMPLATE SELECTION -->
                                <div class="card border-success m-b-20" th:if="${documentTemplates != null && !documentTemplates.isEmpty()}">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fa fa-file-pdf-o"></i> Document Templates (Optional)</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small">
                                            Select document templates to generate personalized PDF attachments for each tenant
                                        </p>
                                        <div class="row">
                                            <div th:each="docTemplate : ${documentTemplates}" class="col-md-6 m-b-10">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox"
                                                           name="documentTemplateIds"
                                                           th:value="${docTemplate.templateId}"
                                                           th:id="'docTemplate_' + ${docTemplate.templateId}">
                                                    <label class="form-check-label" th:for="'docTemplate_' + ${docTemplate.templateId}">
                                                        <strong th:text="${docTemplate.name}">Template Name</strong>
                                                        <span class="badge badge-success ml-1" th:text="${docTemplate.category}">Category</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- EMAIL SUBJECT -->
                                <div class="form-group">
                                    <label class="control-label" for="subject">Subject *</label>
                                    <input type="text" class="form-control" id="subject" name="subject" required
                                           placeholder="Enter email subject">
                                    <small class="form-text text-muted">
                                        Use {{field_name}} for personalization. Available fields:
                                        <span th:each="field, iterStat : ${mergeFields}">
                                            <code th:text="'{{' + ${field} + '}}'" style="font-size: 0.8rem;">{{field}}</code><span th:unless="${iterStat.last}">, </span>
                                        </span>
                                    </small>
                                </div>

                                <!-- EMAIL MESSAGE -->
                                <div class="form-group">
                                    <label class="control-label" for="message">Message *</label>
                                    <textarea class="form-control" id="message" name="message" rows="12" required
                                              placeholder="Enter your message here..."></textarea>
                                    <small class="form-text text-muted">
                                        Available merge fields:
                                        <span th:each="field, iterStat : ${mergeFields}">
                                            <code th:text="'{{' + ${field} + '}}'" style="font-size: 0.8rem;">{{field}}</code><span th:unless="${iterStat.last}">, </span>
                                        </span>
                                    </small>
                                    <small id="charCount" class="form-text text-muted">0 / 5000 characters</small>
                                </div>

                                <!-- SUBMIT BUTTON -->
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fa fa-paper-plane"></i> Send Email
                                    </button>
                                    <a href="/employee/customer/tenants" class="btn btn-secondary btn-lg m-l-10">
                                        <i class="fa fa-times"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Page Content -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Right sidebar -->
            <!-- ============================================================== -->
            <div th:insert="~{general/right-sidebar.html}"></div>
            <!-- ============================================================== -->
            <!-- End Right sidebar -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Container fluid  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Page wrapper  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- footer -->
    <!-- ============================================================== -->
    <div th:replace="~{general/footer.html}"></div>
    <!-- ============================================================== -->
    <!-- End footer -->
    <!-- ============================================================== -->
</div>
<!-- ============================================================== -->
<!-- End Wrapper -->
<!-- ============================================================== -->
<!-- ============================================================== -->
<!-- All Jquery -->
<!-- ============================================================== -->
<script th:inline="javascript">
    var home = /*[[${home}]]*/ null;
</script>
<script th:src="@{/js/library/jquery-3.2.1.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/popper.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/waves.js}" type="text/javascript"></script>
<script th:src="@{/js/library/sidebarmenu.js}" type="text/javascript"></script>
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/jquery.sparkline.min.js}" type="text/javascript"></script>
<script th:src="@{/js/library/custom.min.js}" type="text/javascript"></script>

<script>
// Filter tenants by block and search
function filterTenants() {
    const blockFilter = document.getElementById('blockFilter').value;
    const searchValue = document.getElementById('searchBox').value.toLowerCase();
    const tenantItems = document.querySelectorAll('.tenant-item');

    tenantItems.forEach(item => {
        const name = item.getAttribute('data-name') || '';
        const email = item.getAttribute('data-email') || '';
        const block = item.getAttribute('data-block') || '';

        let matchesBlock = true;
        let matchesSearch = true;

        if (blockFilter) {
            matchesBlock = block === blockFilter;
        }

        if (searchValue) {
            matchesSearch = name.includes(searchValue) || email.includes(searchValue);
        }

        if (matchesBlock && matchesSearch) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Select all visible tenants
function selectAll() {
    const checkboxes = document.querySelectorAll('.tenant-checkbox');
    checkboxes.forEach(checkbox => {
        const item = checkbox.closest('.tenant-item');
        if (item.style.display !== 'none') {
            checkbox.checked = true;
        }
    });
    updateSelectedCount();
}

// Deselect all tenants
function deselectAll() {
    const checkboxes = document.querySelectorAll('.tenant-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

// Update selected count
function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.tenant-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selectedCount;
}

// Load email template
function loadEmailTemplate() {
    const select = document.getElementById('emailTemplateId');
    const selectedOption = select.options[select.selectedIndex];

    if (selectedOption.value) {
        const subject = selectedOption.getAttribute('data-subject');
        const body = selectedOption.getAttribute('data-body');

        document.getElementById('subject').value = subject || '';
        document.getElementById('message').value = body || '';
    }
}

// Clear email template
function clearEmailTemplate() {
    document.getElementById('emailTemplateId').value = '';
    document.getElementById('subject').value = '';
    document.getElementById('message').value = '';
}

// Character count
function updateCharCount() {
    const message = document.getElementById('message');
    const charCount = document.getElementById('charCount');
    const count = message.value.length;
    const maxLength = 5000;

    charCount.textContent = count + ' / ' + maxLength + ' characters';

    if (maxLength - count < 100) {
        charCount.className = 'form-text text-warning';
    } else {
        charCount.className = 'form-text text-muted';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Character count listener
    document.getElementById('message').addEventListener('input', updateCharCount);

    // Form validation
    document.getElementById('emailForm').addEventListener('submit', function(e) {
        const subject = document.getElementById('subject').value.trim();
        const message = document.getElementById('message').value.trim();
        const selectedTenants = document.querySelectorAll('.tenant-checkbox:checked').length;

        if (!subject || !message) {
            e.preventDefault();
            alert('Please fill in both subject and message fields.');
            return false;
        }

        if (selectedTenants === 0) {
            e.preventDefault();
            alert('Please select at least one tenant to send the email to.');
            return false;
        }

        // Confirmation dialog
        let confirmMessage = 'Are you sure you want to send this email to ' + selectedTenants + ' tenant(s)?';

        const selectedDocTemplates = document.querySelectorAll('input[name="documentTemplateIds"]:checked').length;
        if (selectedDocTemplates > 0) {
            confirmMessage += '\n\n' + selectedDocTemplates + ' document template(s) will be generated for each tenant as PDF attachments.';
        }

        if (!confirm(confirmMessage)) {
            e.preventDefault();
            return false;
        }

        // Disable submit button
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Sending...';
    });
});
</script>
</body>
</html>
