<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" content="${_csrf.token}"/>
<meta name="_csrf_header" content="${_csrf.headerName}"/>
<!-- Editable CSS -->

<!-- Custom CSS -->
<link th:href="@{/css/style.min.css}" rel="stylesheet">
<!-- page css -->
<link th:href="@{/css/pages/inbox.css}" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body class="skin-blue fixed-layout">
<!-- ============================================================== -->
<!-- Preloader - style you can find in spinners.css -->
<!-- ============================================================== -->
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>
<!-- ============================================================== -->
<!-- Main wrapper - style you can find in pages.scss -->
<!-- ============================================================== -->
<div id="main-wrapper">
    <!-- ============================================================== -->
    <!-- Topbar header - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div th:replace="~{general/header.html}"></div>
    <!-- ============================================================== -->
    <!-- End Topbar header -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Left Sidebar - style you can find in sidebar.scss  -->
    <!-- ============================================================== -->
    <div th:replace="~{general/left-sidebar.html}"></div>
    <!-- ============================================================== -->
    <!-- End Left Sidebar - style you can find in sidebar.scss  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Page wrapper  -->
    <!-- ============================================================== -->
    <div class="page-wrapper">
        <!-- ============================================================== -->
        <!-- Container fluid  -->
        <!-- ============================================================== -->
        <div class="container-fluid">
            <!-- ============================================================== -->
            <!-- Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <div th:insert="~{general/page-titles.html}"></div>
            <!-- ============================================================== -->
            <!-- End Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Start Page Content -->
            <!-- ============================================================== -->
            <div class="row">
                <!-- Lead Summary Card -->
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="card-title mb-0">
                                    <i class="fas fa-user-tie text-primary"></i>
                                    <span th:text="${lead.name}"></span>
                                </h3>
                                <div>
                                    <span class="badge badge-lg"
                                          th:classappend="${lead.status == 'converted' ? 'badge-success' : (lead.status == 'lost' ? 'badge-danger' : 'badge-info')}"
                                          th:text="${lead.status}"></span>
                                    <span class="badge badge-secondary badge-lg ml-2"
                                          th:text="${lead.leadType != null ? lead.leadType.toString() : 'BUSINESS'}"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="col-lg-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0"><i class="fas fa-bolt text-warning"></i> Quick Actions</h5>
                                </div>
                                <div class="col-md-6 text-right">
                                    <button class="btn btn-primary btn-sm" onclick="showStatusUpdateModal()">
                                        <i class="fas fa-exchange-alt"></i> Change Status
                                    </button>
                                    <a th:href="@{'/employee/lead/pipeline'}" class="btn btn-info btn-sm">
                                        <i class="fas fa-columns"></i> View Pipeline
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title"><i class="fas fa-address-card text-info"></i> Contact Information</h4>
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td class="font-weight-bold" style="width: 40%"><i class="fas fa-user"></i> Customer</td>
                                        <td th:text="${lead.customer != null ? lead.customer.name : 'Prospect (No Customer)'}"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold"><i class="fas fa-envelope"></i> Email</td>
                                        <td>
                                            <a th:if="${lead.email != null}" th:href="'mailto:' + ${lead.email}" th:text="${lead.email}"></a>
                                            <span th:if="${lead.email == null}" class="text-muted">Not provided</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold"><i class="fas fa-phone"></i> Phone</td>
                                        <td>
                                            <a th:if="${lead.phone != null}" th:href="'tel:' + ${lead.phone}" th:text="${lead.phone}"></a>
                                            <span th:if="${lead.phone == null}" class="text-muted">Not provided</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold"><i class="fas fa-user-tie"></i> Assigned To</td>
                                        <td th:text="${lead.employee != null ? lead.employee.username : 'Unassigned'}"></td>
                                    </tr>
                                    <tr th:if="${lead.manager != null}">
                                        <td class="font-weight-bold"><i class="fas fa-user-shield"></i> Manager</td>
                                        <td th:text="${lead.manager.username}"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-weight-bold"><i class="fas fa-calendar-plus"></i> Created</td>
                                        <td th:text="${#temporals.format(lead.createdAt, 'dd MMM yyyy HH:mm')}"></td>
                                    </tr>
                                    <tr th:if="${lead.convertedAt != null}">
                                        <td class="font-weight-bold"><i class="fas fa-check-circle"></i> Converted</td>
                                        <td th:text="${#temporals.format(lead.convertedAt, 'dd MMM yyyy HH:mm')}"></td>
                                    </tr>
                                    <tr th:if="${lead.leadSource != null}">
                                        <td class="font-weight-bold"><i class="fas fa-bullseye"></i> Lead Source</td>
                                        <td th:text="${lead.leadSource}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Property Rental Details (if applicable) -->
                <div class="col-lg-6" th:if="${lead.leadType != null && lead.leadType.toString() == 'PROPERTY_RENTAL'}">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title"><i class="fas fa-home text-success"></i> Rental Requirements</h4>
                            <table class="table table-borderless">
                                <tbody>
                                    <tr th:if="${lead.property != null}">
                                        <td class="font-weight-bold" style="width: 40%"><i class="fas fa-building"></i> Property</td>
                                        <td th:text="${lead.property.propertyName}"></td>
                                    </tr>
                                    <tr th:if="${lead.lettingInstruction != null}">
                                        <td class="font-weight-bold"><i class="fas fa-file-contract"></i> Instruction</td>
                                        <td>
                                            <a th:href="@{'/employee/letting-instruction/' + ${lead.lettingInstruction.id}}"
                                               th:text="'Instruction #' + ${lead.lettingInstruction.id}"></a>
                                        </td>
                                    </tr>
                                    <tr th:if="${lead.budgetMin != null || lead.budgetMax != null}">
                                        <td class="font-weight-bold"><i class="fas fa-pound-sign"></i> Budget</td>
                                        <td>
                                            <span th:if="${lead.budgetMin != null}">£<span th:text="${#numbers.formatDecimal(lead.budgetMin, 1, 2)}"></span></span>
                                            <span th:if="${lead.budgetMin != null && lead.budgetMax != null}"> - </span>
                                            <span th:if="${lead.budgetMax != null}">£<span th:text="${#numbers.formatDecimal(lead.budgetMax, 1, 2)}"></span></span>
                                            <span class="text-muted">/month</span>
                                        </td>
                                    </tr>
                                    <tr th:if="${lead.desiredMoveInDate != null}">
                                        <td class="font-weight-bold"><i class="fas fa-calendar-alt"></i> Move-in Date</td>
                                        <td th:text="${#temporals.format(lead.desiredMoveInDate, 'dd MMM yyyy')}"></td>
                                    </tr>
                                    <tr th:if="${lead.numberOfOccupants != null}">
                                        <td class="font-weight-bold"><i class="fas fa-users"></i> Occupants</td>
                                        <td th:text="${lead.numberOfOccupants}"></td>
                                    </tr>
                                    <tr th:if="${lead.hasPets != null}">
                                        <td class="font-weight-bold"><i class="fas fa-paw"></i> Pets</td>
                                        <td>
                                            <span th:if="${lead.hasPets}" class="badge badge-info">Yes</span>
                                            <span th:if="${!lead.hasPets}" class="badge badge-secondary">No</span>
                                        </td>
                                    </tr>
                                    <tr th:if="${lead.hasGuarantor != null}">
                                        <td class="font-weight-bold"><i class="fas fa-user-check"></i> Guarantor</td>
                                        <td>
                                            <span th:if="${lead.hasGuarantor}" class="badge badge-success">Yes</span>
                                            <span th:if="${!lead.hasGuarantor}" class="badge badge-secondary">No</span>
                                        </td>
                                    </tr>
                                    <tr th:if="${lead.employmentStatus != null}">
                                        <td class="font-weight-bold"><i class="fas fa-briefcase"></i> Employment</td>
                                        <td th:text="${lead.employmentStatus}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Actions/Activity Timeline -->
                <div class="col-lg-12" th:if="${lead.leadActions != null && !lead.leadActions.isEmpty()}">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title"><i class="fas fa-history text-warning"></i> Activity Timeline</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                            <th>By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="action : ${lead.leadActions}">
                                            <td th:text="${#temporals.format(action.createdAt, 'dd MMM yyyy HH:mm')}"></td>
                                            <td th:text="${action.actionType}"></td>
                                            <td th:text="${action.notes ?: '-'}"></td>
                                            <td th:text="${action.user != null ? action.user.username : '-'}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Property Viewings -->
                <div class="col-lg-12" th:if="${lead.propertyViewings != null && !lead.propertyViewings.isEmpty()}">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title"><i class="fas fa-eye text-primary"></i> Property Viewings</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Scheduled Date</th>
                                            <th>Status</th>
                                            <th>Feedback</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="viewing : ${lead.propertyViewings}">
                                            <td th:text="${viewing.property != null ? viewing.property.propertyName : '-'}"></td>
                                            <td th:text="${viewing.scheduledDate != null ? #temporals.format(viewing.scheduledDate, 'dd MMM yyyy HH:mm') : '-'}"></td>
                                            <td>
                                                <span class="badge"
                                                      th:classappend="${viewing.status == 'COMPLETED' ? 'badge-success' : (viewing.status == 'CANCELLED' ? 'badge-danger' : 'badge-info')}"
                                                      th:text="${viewing.status}"></span>
                                            </td>
                                            <td th:text="${viewing.feedback ?: '-'}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attachments -->
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">
                                <i class="fas fa-paperclip text-secondary"></i>
                                Attachments <span class="badge badge-pill badge-secondary" th:text="${attachments.size()}"></span>
                            </h4>
                            <div class="row" th:if="${!attachments.isEmpty()}">
                                <div class="col-md-3 mb-3" th:each="attachment : ${attachments}">
                                    <div class="card border">
                                        <a th:href="@{'data:' + ${attachment.mimeType} + ';base64,' + ${attachment.data}}" th:download="${attachment.name}" class="text-decoration-none">
                                            <img th:if="${attachment.mimeType.startsWith('image')}"
                                                 class="card-img-top"
                                                 alt="attachment"
                                                 th:src="@{'data:' + ${attachment.mimeType} + ';base64,' + ${attachment.data}}"
                                                 style="max-height: 200px; object-fit: cover;" />
                                            <div class="card-body text-center">
                                                <i th:if="${!attachment.mimeType.startsWith('image')}"
                                                   class="fas fa-file fa-3x mb-2 text-muted"></i>
                                                <p class="card-text small" th:text="${attachment.name}"></p>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <p th:if="${attachments.isEmpty()}" class="text-muted">No attachments</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Page Content -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Right sidebar -->
            <!-- ============================================================== -->
            <!-- .right-sidebar -->
            <div th:insert="~{general/right-sidebar.html}"></div>
            <!-- ============================================================== -->
            <!-- End Right sidebar -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Container fluid  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Page wrapper  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- footer -->
    <!-- ============================================================== -->
    <div th:replace="~{general/footer.html}"></div>
    <!-- ============================================================== -->
    <!-- End footer -->
    <!-- ============================================================== -->
</div>
<!-- ============================================================== -->
<!-- End Wrapper -->
<!-- ============================================================== -->
<!-- ============================================================== -->
<!-- All Jquery -->
<!-- ============================================================== -->
<script th:inline="javascript">
    var home = /*[[${home}]]*/ null;
</script>
<script th:src="@{/js/library/jquery-3.2.1.min.js}" type="text/javascript">></script>
<!--    &lt;!&ndash; Bootstrap tether Core JavaScript &ndash;&gt;-->
<script th:src="@{/js/library/popper.min.js}" type="text/javascript">></script>
<script th:src="@{/js/library/bootstrap.min.js}" type="text/javascript">></script>
<!--    &lt;!&ndash; slimscrollbar scrollbar JavaScript &ndash;&gt;-->
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}" type="text/javascript">></script>
<!--Wave Effects -->
<script th:src="@{/js/library/waves.js}" type="text/javascript">></script>
<!--Menu sidebar -->
<script th:src="@{/js/library/sidebarmenu.js}" type="text/javascript">></script>
<!--stickey kit -->
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/jquery.sparkline.min.js}" type="text/javascript">></script>
<!--Custom JavaScript -->
<script th:src="@{/js/library/custom.min.js}" type="text/javascript">></script>
<!-- Editable -->

<!-- Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt"></i> Update Lead Status
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="statusUpdateForm">
                    <div class="form-group">
                        <label for="newStatus">New Status <span class="text-danger">*</span></label>
                        <select class="form-control" id="newStatus" required>
                            <option value="">-- Select Status --</option>
                            <option value="enquiry">Enquiry</option>
                            <option value="viewing-scheduled">Viewing Scheduled</option>
                            <option value="viewing-completed">Viewing Completed</option>
                            <option value="interested">Interested</option>
                            <option value="application-submitted">Application Submitted</option>
                            <option value="referencing">Referencing</option>
                            <option value="in-contracts">In Contracts</option>
                            <option value="contracts-complete">Contracts Complete</option>
                            <option value="converted">Converted</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statusNotes">Notes (optional)</label>
                        <textarea class="form-control" id="statusNotes" rows="3"
                                  placeholder="Add any relevant notes about this status change..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">
                    <i class="fas fa-save"></i> Update Status
                </button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const leadId = /*[[${lead.leadId}]]*/ null;
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    const currentStatus = /*[[${lead.status}]]*/ '';

    function showStatusUpdateModal() {
        // Set current status as selected
        $('#newStatus').val(currentStatus);
        $('#statusNotes').val('');
        $('#statusUpdateModal').modal('show');
    }

    function submitStatusUpdate() {
        const form = document.getElementById('statusUpdateForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const newStatus = $('#newStatus').val();
        const notes = $('#statusNotes').val();

        if (newStatus === currentStatus) {
            alert('Status is already set to ' + newStatus);
            return;
        }

        // Use the same endpoint as the Kanban pipeline
        fetch('/employee/lead/' + leadId + '/status', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                status: newStatus,
                notes: notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#statusUpdateModal').modal('hide');
                alert('Lead status updated successfully!');
                // Reload page to show updated status
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating status: ' + error.message);
        });
    }
</script>

</body>
</html>



