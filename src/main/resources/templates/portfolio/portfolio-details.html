<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<!-- DataTables CSS -->
<link th:href="@{/css/dataTables.bootstrap4.css}" rel="stylesheet">
<link th:href="@{/css/responsive.dataTables.min.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>
    
    <div class="page-wrapper">
        <div class="container-fluid">
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h3 class="text-themecolor">
                        <i class="fas fa-chart-pie text-primary"></i> 
                        <span th:text="${portfolio.name}">Portfolio Name</span>
                    </h3>
                    <p class="text-muted" th:text="${portfolio.description}">Portfolio description</p>
                    <div class="d-flex align-items-center mt-2">
                        <span th:if="${portfolio.isShared == 'Y'}" class="badge badge-primary mr-2">Shared Portfolio</span>
                        <span th:unless="${portfolio.isShared == 'Y'}" class="badge badge-info mr-2">Owner-Specific</span>
                        
                        <span th:if="${(portfolio.payPropTags != null && !portfolio.payPropTags.isEmpty())}" class="badge badge-success mr-2">
                            <i class="fas fa-sync"></i> PayProp Synced
                        </span>
                        <span th:unless="${(portfolio.payPropTags != null && !portfolio.payPropTags.isEmpty())}" class="badge badge-warning mr-2">
                            <i class="fas fa-clock"></i> Sync Pending
                        </span>
                        
                        <span class="badge badge-secondary" th:text="${portfolio.portfolioType}">Type</span>
                    </div>
                </div>
                <div class="col-md-4 text-right">
                    <div class="btn-group">
                        <a th:if="${canEdit}" th:href="@{'/portfolio/' + ${portfolio.id} + '/edit'}" 
                           class="btn btn-warning">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <button th:if="${canManageProperties}" class="btn btn-success" 
                                onclick="showAssignModal()">
                            <i class="fas fa-plus"></i> Assign Properties
                        </button>
                        <button th:if="${payPropEnabled}" class="btn btn-primary" 
                                onclick="syncWithPayProp()">
                            <i class="fas fa-sync"></i> Sync PayProp
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                                <i class="fas fa-cog"></i> Actions
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="recalculateAnalytics()">
                                    <i class="fas fa-calculator"></i> Recalculate Analytics
                                </a>
                                <a class="dropdown-item" href="#" onclick="exportPortfolioData()">
                                    <i class="fas fa-download"></i> Export Data
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" th:href="@{'/portfolio/all'}">
                                    <i class="fas fa-arrow-left"></i> Back to All Portfolios
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div th:if="${successMessage}" class="row">
                <div class="col-12">
                    <div class="alert alert-success alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        <h4><i class="icon fa fa-check"></i> Success!</h4>
                        <span th:text="${successMessage}">Success message</span>
                    </div>
                </div>
            </div>

            <!-- Portfolio Analytics -->
            <div class="row" th:if="${analytics}">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3 th:text="${analytics.totalProperties}">0</h3>
                            <p class="mb-0">Total Properties</p>
                            <small class="opacity-75">in this portfolio</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 th:text="${analytics.occupiedProperties}">0</h3>
                            <p class="mb-0">Occupied</p>
                            <small class="opacity-75">generating income</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h3 th:text="${analytics.vacantProperties}">0</h3>
                            <p class="mb-0">Vacant</p>
                            <small class="opacity-75">available to let</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3 th:text="${#numbers.formatDecimal(analytics.occupancyRate, 0, 'COMMA', 1, 'POINT')} + '%'">0%</h3>
                            <p class="mb-0">Occupancy Rate</p>
                            <small class="opacity-75">current performance</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Overview -->
            <div class="row" th:if="${analytics}">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">
                                <i class="fas fa-pound-sign text-success"></i> Financial Overview
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <h5>Total Monthly Rent</h5>
                                    <h3 class="text-success" th:text="'£' + ${#numbers.formatDecimal(analytics.totalMonthlyRent ?: 0, 0, 'COMMA', 0, 'POINT')}">£0</h3>
                                    <small class="text-muted">potential income</small>
                                </div>
                                <div class="col-6">
                                    <h5>Actual Monthly Income</h5>
                                    <h3 class="text-info" th:text="'£' + ${#numbers.formatDecimal(analytics.actualMonthlyIncome ?: 0, 0, 'COMMA', 0, 'POINT')}">£0</h3>
                                    <small class="text-muted">from occupied properties</small>
                                </div>
                            </div>
                            
                            <div class="mt-3" th:if="${portfolio.targetMonthlyIncome}">
                                <h6>Target vs Actual Performance</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" 
                                         th:style="'width: ' + ${(analytics.actualMonthlyIncome / portfolio.targetMonthlyIncome) * 100} + '%'"
                                         th:text="${#numbers.formatDecimal((analytics.actualMonthlyIncome / portfolio.targetMonthlyIncome) * 100, 0, 'COMMA', 1, 'POINT')} + '%'">0%</div>
                                </div>
                                <small class="text-muted">
                                    Target: £<span th:text="${#numbers.formatDecimal(portfolio.targetMonthlyIncome, 0, 'COMMA', 0, 'POINT')}">0</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">
                                <i class="fas fa-chart-line text-primary"></i> Portfolio Performance
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <h6>Current Occupancy</h6>
                                    <h4 th:text="${#numbers.formatDecimal(analytics.occupancyRate, 0, 'COMMA', 1, 'POINT')} + '%'">0%</h4>
                                </div>
                                <div class="col-6" th:if="${portfolio.targetOccupancyRate}">
                                    <h6>Target Occupancy</h6>
                                    <h4 th:text="${portfolio.targetOccupancyRate} + '%'">0%</h4>
                                </div>
                            </div>
                            
                            <div class="mt-3" th:if="${portfolio.targetOccupancyRate}">
                                <div class="progress">
                                    <div class="progress-bar" 
                                         th:classappend="${analytics.occupancyRate >= portfolio.targetOccupancyRate} ? 'bg-success' : 'bg-warning'"
                                         th:style="'width: ' + ${(analytics.occupancyRate / portfolio.targetOccupancyRate) * 100} + '%'">
                                    </div>
                                </div>
                                <small th:if="${analytics.occupancyRate >= portfolio.targetOccupancyRate}" 
                                       class="text-success">✓ Target achieved!</small>
                                <small th:unless="${analytics.occupancyRate >= portfolio.targetOccupancyRate}" 
                                       class="text-warning">Below target</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hierarchical Blocks & Properties View -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <h4><i class="fas fa-layer-group text-primary"></i> Portfolio Organization</h4>
                            <div>
                                <span id="totalPropertiesCount" class="badge badge-info mr-2">Loading...</span>
                                <button th:if="${canManageProperties}" class="btn btn-sm btn-primary mr-2" 
                                        onclick="showCreateBlockModal()">
                                    <i class="fas fa-building"></i> New Block
                                </button>
                                <button th:if="${canManageProperties}" class="btn btn-sm btn-success" 
                                        onclick="showAssignModal()">
                                    <i class="fas fa-plus"></i> Add Properties
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Loading State -->
                            <div id="loadingState" class="text-center py-5">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                <h5>Loading portfolio organization...</h5>
                            </div>

                            <!-- Empty State -->
                            <div id="emptyState" class="text-center py-5" style="display: none;">
                                <i class="fas fa-building fa-4x text-muted mb-3"></i>
                                <h5>No Properties in Portfolio</h5>
                                <p class="text-muted">Start by creating blocks or assigning properties directly to organize your portfolio.</p>
                                <div class="mt-3">
                                    <button th:if="${canManageProperties}" class="btn btn-primary mr-2" 
                                            onclick="showCreateBlockModal()">
                                        <i class="fas fa-building"></i> Create First Block
                                    </button>
                                    <button th:if="${canManageProperties}" class="btn btn-success" 
                                            onclick="showAssignModal()">
                                        <i class="fas fa-plus"></i> Assign Properties
                                    </button>
                                </div>
                            </div>

                            <!-- Hierarchical Organization View -->
                            <div id="portfolioOrganization" style="display: none;">
                                <!-- Blocks with Properties (Populated by JavaScript) -->
                                <div id="blocksContainer"></div>
                                
                                <!-- Unassigned Properties Section -->
                                <div id="unassignedSection" class="mt-3">
                                    <div class="border rounded">
                                        <div class="bg-light p-3 border-bottom">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-folder-open text-warning"></i>
                                                        <span>Unassigned Properties</span>
                                                        <span id="unassignedCount" class="badge badge-warning ml-2">0</span>
                                                    </div>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-secondary" 
                                                            onclick="toggleSection('unassigned')" 
                                                            id="unassignedToggle">
                                                        <i class="fas fa-chevron-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="unassignedProperties" class="collapse show">
                                            <!-- Unassigned properties populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div th:replace="~{general/footer.html}"></div>
    </div>
</div>

<!-- Property Assignment Modal -->
<div class="modal fade" id="assignPropertiesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Assign Properties to Portfolio</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Available Properties:</label>
                    <div style="max-height: 300px; overflow-y: auto;" id="availablePropertiesList">
                        <!-- Properties will be loaded via AJAX -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="assignSelectedProperties()">
                    <i class="fas fa-check"></i> Assign Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Block Modal -->
<div class="modal fade" id="createBlockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Create New Block</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createBlockForm">
                    <div class="form-group">
                        <label for="blockName">Block Name *</label>
                        <input type="text" class="form-control" id="blockName" required>
                    </div>
                    <div class="form-group">
                        <label for="blockDescription">Description</label>
                        <textarea class="form-control" id="blockDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="blockType">Block Type</label>
                        <select class="form-control" id="blockType">
                            <option value="BUILDING">Building</option>
                            <option value="ESTATE">Estate</option>
                            <option value="STREET">Street</option>
                            <option value="AREA">Area</option>
                            <option value="COMPLEX">Complex</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="blockCapacity">Maximum Properties (optional)</label>
                        <input type="number" class="form-control" id="blockCapacity" min="1">
                        <small class="form-text text-muted">Leave empty for unlimited capacity</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createBlock()">
                    <i class="fas fa-plus"></i> Create Block
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<!-- ADD THIS FALLBACK -->
<script>
if (typeof jQuery === 'undefined') {
    document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>');
}
</script>
<script th:src="@{/js/library/popper.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/library/waves.js}"></script>
<script th:src="@{/js/library/sidebarmenu.js}"></script>
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/custom.min.js}"></script>
<!-- DataTables -->
<script th:src="@{/js/library/jquery.dataTables.min.js}"></script>
<script th:src="@{/js/library/dataTables.responsive.min.js}"></script>

<script th:inline="javascript">
const portfolioId = /*[[${portfolio.id}]]*/ null;

// Initialize DataTable
$(document).ready(function() {
    if ($('#propertiesTable').length) {
        $('#propertiesTable').DataTable({
            responsive: true,
            order: [0, 'asc'],
            columnDefs: [
                { targets: [7], orderable: false }
            ]
        });
    }
});

function showAssignModal() {
    // Load available properties
    fetch('/portfolio/' + portfolioId + '/available-properties')
        .then(response => response.json())
        .then(data => {
            let html = '';
            if (data.success && data.properties.length > 0) {
                data.properties.forEach(property => {
                    html += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="${property.id}" id="prop_${property.id}">
                            <label class="form-check-label" for="prop_${property.id}">
                                <strong>${property.propertyName}</strong><br>
                                <small class="text-muted">${property.fullAddress}</small><br>
                                <small class="text-info">${property.propertyType} - £${property.monthlyPayment || 'N/A'}</small>
                            </label>
                        </div>
                    `;
                });
            } else {
                html = '<p class="text-muted text-center">No properties available for assignment</p>';
            }
            
            document.getElementById('availablePropertiesList').innerHTML = html;
            $('#assignPropertiesModal').modal('show');
        })
        .catch(error => {
            console.error('Error loading properties:', error);
            alert('Failed to load available properties');
        });
}

function assignSelectedProperties() {
    const selectedProperties = Array.from(document.querySelectorAll('#availablePropertiesList input:checked'))
        .map(input => input.value);
    
    if (selectedProperties.length === 0) {
        alert('Please select at least one property');
        return;
    }
    
    fetch('/portfolio/' + portfolioId + '/assign-properties', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
        },
        body: 'propertyIds=' + selectedProperties.join('&propertyIds=')
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#assignPropertiesModal').modal('hide');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to assign properties');
    });
}

function removeProperty(propertyId) {
    if (confirm('Remove this property from the portfolio?')) {
        fetch('/portfolio/' + portfolioId + '/remove-property-v2/' + propertyId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
            }
        })
        .then(response => response.json())
        .then(data => {
            // Log full debug information
            console.log('Remove property response:', data);
            
            // Log PayProp debug details if available
            if (data.payPropDebug) {
                console.log('PayProp Debug:', data.payPropDebug);
                console.log('Property PayProp ID:', data.propertyPayPropId);
                console.log('Portfolio PayProp Tags:', data.portfolioPayPropTags);
                console.log('PayProp Service Available:', data.payPropServiceAvailable);
                if (data.payPropRemovalAttempt) {
                    console.log('PayProp Removal Attempt:', data.payPropRemovalAttempt);
                }
                if (data.payPropError) {
                    console.error('PayProp Removal Error:', data.payPropError);
                }
                if (data.payPropSkipped) {
                    console.warn('PayProp Removal Skipped:', data.payPropSkipped);
                }
            }
            
            if (data.success) {
                let message = 'Property removed successfully';
                if (data.payPropSyncRemoved) {
                    message += '\n✅ PayProp tag removed';
                } else if (data.payPropError) {
                    message += '\n❌ PayProp tag removal failed: ' + data.payPropError;
                } else if (data.payPropSkipped) {
                    message += '\n⚠️ PayProp tag removal skipped: ' + data.payPropSkipped;
                }
                
                // Add debug info to alert for troubleshooting
                if (data.propertyPayPropId) {
                    message += '\nProperty PayProp ID: ' + data.propertyPayPropId;
                }
                if (data.portfolioPayPropTags) {
                    message += '\nPortfolio PayProp Tags: ' + data.portfolioPayPropTags;
                }
                if (data.payPropServiceAvailable !== undefined) {
                    message += '\nPayProp Service Available: ' + data.payPropServiceAvailable;
                }
                
                alert(message);
                location.reload();
            } else {
                alert('Error: ' + (data.message || data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to remove property');
        });
    }
}

function syncWithPayProp() {
    if (confirm('Sync this portfolio with PayProp?')) {
        fetch('/portfolio/' + portfolioId + '/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // Check if response is actually JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                // If it's HTML, read as text to see the error
                return response.text().then(text => {
                    console.error('Received HTML instead of JSON:', text);
                    throw new Error('Server returned HTML error page instead of JSON');
                });
            }
        })
        .then(data => {
            if (data.success) {
                alert('Portfolio sync initiated successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Sync error:', error);
            alert('Failed to sync portfolio: ' + error.message);
        });
    }
}

function recalculateAnalytics() {
    if (confirm('Recalculate analytics for this portfolio?')) {
        fetch('/portfolio/' + portfolioId + '/recalculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to recalculate analytics');
        });
    }
}

function exportPortfolioData() {
    window.location.href = '/portfolio/' + portfolioId + '/export';
}

// ===== BLOCK MANAGEMENT FUNCTIONS =====

// Load blocks for this portfolio
function loadBlocks() {
    const portfolioId = [[${portfolio.id}]];
    
    fetch(`/portfolio/internal/blocks/portfolio/${portfolioId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBlocks(data.blocks);
                updateBlockCountBadge(data.total);
            } else {
                showBlockError('Failed to load blocks');
            }
        })
        .catch(error => {
            console.error('Error loading blocks:', error);
            showBlockError('Error loading blocks');
        });
}

// Display blocks in the UI
function displayBlocks(blocks) {
    const container = document.getElementById('blocksContainer');
    
    if (!blocks || blocks.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-building fa-3x text-muted mb-3"></i>
                <h5>No Blocks Created</h5>
                <p class="text-muted">Create blocks to organize properties within this portfolio.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    blocks.forEach(block => {
        const capacityText = block.maxProperties ? `${block.propertyCount}/${block.maxProperties}` : `${block.propertyCount}/∞`;
        const capacityClass = block.maxProperties && block.propertyCount >= block.maxProperties ? 'danger' : 'info';
        
        html += `
            <div class="col-lg-6 col-xl-4 mb-3">
                <div class="card border-left-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title mb-1">
                                    <i class="fas fa-building text-primary"></i> 
                                    ${block.name}
                                </h6>
                                <small class="text-muted">${block.blockType}</small>
                            </div>
                            <div class="text-right">
                                <span class="badge badge-${capacityClass}">${capacityText} properties</span>
                            </div>
                        </div>
                        
                        ${block.description ? `<p class="text-muted small mt-2 mb-2">${block.description}</p>` : ''}
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                Tag: <code>${block.payPropTagNames || 'Not synced'}</code>
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editBlock(${block.id})" title="Edit Block">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteBlock(${block.id}, '${block.name}')" title="Delete Block">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Update block count badge
function updateBlockCountBadge(count) {
    const badge = document.getElementById('blockCountBadge');
    badge.textContent = `${count} block${count !== 1 ? 's' : ''}`;
}

// Show error in blocks container
function showBlockError(message) {
    const container = document.getElementById('blocksContainer');
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// Show create block modal
function showCreateBlockModal() {
    // Clear form
    document.getElementById('createBlockForm').reset();
    $('#createBlockModal').modal('show');
}

// Create new block
function createBlock() {
    const portfolioId = [[${portfolio.id}]];
    const name = document.getElementById('blockName').value.trim();
    const description = document.getElementById('blockDescription').value.trim();
    const blockType = document.getElementById('blockType').value;
    const capacity = document.getElementById('blockCapacity').value;
    
    if (!name) {
        alert('Block name is required');
        return;
    }
    
    const blockData = {
        portfolioId: portfolioId,
        name: name,
        description: description || null,
        blockType: blockType,
        maxProperties: capacity ? parseInt(capacity) : null
    };
    
    // Get CSRF token
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");
    
    fetch('/portfolio/internal/blocks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            [header]: token
        },
        body: JSON.stringify(blockData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#createBlockModal').modal('hide');
            loadPortfolioOrganization(); // Reload hierarchical organization
            showToast('success', 'Block created successfully!');
        } else {
            alert('Error creating block: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating block:', error);
        alert('Error creating block');
    });
}

// Edit block (placeholder for now)
function editBlock(blockId) {
    alert('Block editing will be implemented in the next phase');
}

// Delete block
function deleteBlock(blockId, blockName) {
    if (confirm(`Delete block "${blockName}"? Properties will be moved to portfolio-only assignment.`)) {
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");
        
        fetch(`/portfolio/internal/blocks/${blockId}?reassignmentOption=MOVE_TO_PORTFOLIO_ONLY`, {
            method: 'DELETE',
            headers: {
                [header]: token
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadPortfolioOrganization(); // Reload hierarchical organization
                showToast('success', 'Block deleted successfully');
            } else {
                alert('Error deleting block: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting block:', error);
            alert('Error deleting block');
        });
    }
}

// ===== HIERARCHICAL ORGANIZATION FUNCTIONS =====

// Load portfolio organization (blocks + properties hierarchically)
function loadPortfolioOrganization() {
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const organizationView = document.getElementById('portfolioOrganization');
    
    // Show loading
    loadingState.style.display = 'block';
    emptyState.style.display = 'none';
    organizationView.style.display = 'none';
    
    // Fetch blocks and properties
    Promise.all([
        fetch(`/portfolio/internal/blocks/portfolio/${portfolioId}/with-counts`),
        fetch(`/portfolio/${portfolioId}/properties-hierarchical`)
    ])
    .then(async ([blocksResponse, propertiesResponse]) => {
        console.log('Blocks response status:', blocksResponse.status);
        console.log('Properties response status:', propertiesResponse.status);
        
        if (!blocksResponse.ok) {
            throw new Error(`Blocks API failed: ${blocksResponse.status} ${blocksResponse.statusText}`);
        }
        if (!propertiesResponse.ok) {
            const errorText = await propertiesResponse.text();
            throw new Error(`Properties API failed: ${propertiesResponse.status} ${propertiesResponse.statusText} - ${errorText}`);
        }
        
        const blocksData = await blocksResponse.json();
        const properties = await propertiesResponse.json();
        
        console.log('Blocks data:', blocksData);
        console.log('Properties data:', properties);
        
        // ✅ FIX: Extract the actual blocks array from the response wrapper
        const blocks = blocksData.blocks || blocksData || [];
        console.log('Extracted blocks array:', blocks);
        console.log('Blocks array length:', blocks.length);
        
        renderHierarchicalOrganization(blocks, properties);
    })
    .catch(error => {
        console.error('Error loading portfolio organization:', error);
        showOrganizationError('Failed to load portfolio organization: ' + error.message);
    });
}

// Render the hierarchical organization
function renderHierarchicalOrganization(blocks, properties) {
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const organizationView = document.getElementById('portfolioOrganization');
    const blocksContainer = document.getElementById('blocksContainer');
    const unassignedContainer = document.getElementById('unassignedProperties');
    
    // Hide loading
    loadingState.style.display = 'none';
    
    // Check if we have any content
    const totalProperties = properties.assignedToBlocks.length + properties.unassigned.length;
    if (blocks.length === 0 && totalProperties === 0) {
        emptyState.style.display = 'block';
        return;
    }
    
    // Show organization view
    organizationView.style.display = 'block';
    
    // Render blocks with their properties
    renderBlocksWithProperties(blocksContainer, blocks, properties.assignedToBlocks);
    
    // Render unassigned properties
    renderUnassignedProperties(unassignedContainer, properties.unassigned);
    
    // Update counts
    updatePropertyCounts(totalProperties, properties.unassigned.length);
}

// Render blocks with their properties
function renderBlocksWithProperties(container, blocks, assignedProperties) {
    let html = '';
    
    // ✅ SAFETY CHECK: Ensure blocks is an array
    if (!Array.isArray(blocks)) {
        console.error('renderBlocksWithProperties: blocks is not an array:', blocks);
        console.error('Type of blocks:', typeof blocks);
        if (container) {
            container.innerHTML = '<div class="alert alert-warning">No blocks data available</div>';
        }
        return;
    }
    
    console.log(`Rendering ${blocks.length} blocks with properties`);
    
    blocks.forEach(block => {
        // Get properties for this block
        const blockProperties = assignedProperties.filter(prop => prop.blockId === block.id);
        const propertyCount = blockProperties.length;
        
        // Determine colors and icons
        const isExpanded = true; // Start expanded
        const chevronClass = isExpanded ? 'fa-chevron-down' : 'fa-chevron-right';
        const collapseClass = isExpanded ? 'show' : '';
        
        // Capacity status
        let capacityClass = 'secondary';
        let capacityText = propertyCount;
        if (block.maxProperties) {
            capacityText = `${propertyCount}/${block.maxProperties}`;
            capacityClass = propertyCount >= block.maxProperties ? 'danger' : 
                          propertyCount > block.maxProperties * 0.8 ? 'warning' : 'success';
        }
        
        html += `
            <div class="mb-3">
                <div class="border rounded">
                    <!-- Block Header -->
                    <div class="bg-light p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-link p-0 mr-2" onclick="toggleBlockSection(${block.id})" id="toggle-${block.id}">
                                    <i class="fas ${chevronClass}"></i>
                                </button>
                                <div>
                                    <h6 class="mb-0">
                                        <i class="fas fa-building text-primary"></i>
                                        ${block.name}
                                        <span class="badge badge-${capacityClass} ml-2">${capacityText}</span>
                                    </h6>
                                    ${block.description ? `<small class="text-muted">${block.description}</small>` : ''}
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="assignPropertiesToBlock(${block.id})" title="Assign Properties">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="editBlock(${block.id})" title="Edit Block">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteBlock(${block.id}, '${block.name}')" title="Delete Block">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Block Properties -->
                    <div id="block-${block.id}" class="collapse ${collapseClass}">
                        <div class="p-3">
                            ${renderBlockProperties(blockProperties, block.id)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render properties within a block
function renderBlockProperties(properties, blockId) {
    if (properties.length === 0) {
        return `
            <div class="text-center py-3 text-muted">
                <i class="fas fa-home fa-2x mb-2"></i>
                <p>No properties in this block</p>
                <button class="btn btn-sm btn-primary" onclick="assignPropertiesToBlock(${blockId})">
                    <i class="fas fa-plus"></i> Assign Properties
                </button>
            </div>
        `;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    properties.forEach(prop => {
        const tenantInfo = prop.currentTenant ? 
            `<small class="text-muted">Tenant: ${prop.currentTenant.fullName}</small>` :
            `<small class="text-muted">No tenant</small>`;
            
        const rentInfo = prop.monthlyPayment ? 
            `£${prop.monthlyPayment.toLocaleString()}` : 'Rent not set';
            
        const syncStatus = prop.payPropId ? 
            '<span class="badge badge-success badge-sm">Synced</span>' :
            '<span class="badge badge-warning badge-sm">Not synced</span>';
        
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <a href="/employee/property/${prop.id}" class="text-decoration-none">
                                    ${prop.propertyName}
                                </a>
                            </h6>
                            <p class="mb-1 small text-muted">${prop.fullAddress}</p>
                            <div class="d-flex gap-3">
                                <span class="small">${tenantInfo}</span>
                                <span class="small"><strong>${rentInfo}/month</strong></span>
                            </div>
                        </div>
                        <div class="text-right">
                            ${syncStatus}
                            <div class="btn-group btn-group-sm mt-1">
                                <a href="/employee/property/${prop.id}" class="btn btn-outline-info btn-sm" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-outline-warning btn-sm" onclick="removePropertyFromBlock(${prop.id}, ${blockId})" title="Remove from Block">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removeProperty(${prop.id})" title="Remove from Portfolio">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

// Render unassigned properties
function renderUnassignedProperties(container, properties) {
    if (properties.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-muted">
                <p class="mb-0">All properties are organized in blocks</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="p-3"><div class="list-group list-group-flush">';
    
    properties.forEach(prop => {
        const tenantInfo = prop.currentTenant ? 
            `<small class="text-muted">Tenant: ${prop.currentTenant.fullName}</small>` :
            `<small class="text-muted">No tenant</small>`;
            
        const rentInfo = prop.monthlyPayment ? 
            `£${prop.monthlyPayment.toLocaleString()}` : 'Rent not set';
            
        const syncStatus = prop.payPropId ? 
            '<span class="badge badge-success badge-sm">Synced</span>' :
            '<span class="badge badge-warning badge-sm">Not synced</span>';
        
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <a href="/employee/property/${prop.id}" class="text-decoration-none">
                                    ${prop.propertyName}
                                </a>
                            </h6>
                            <p class="mb-1 small text-muted">${prop.fullAddress}</p>
                            <div class="d-flex gap-3">
                                <span class="small">${tenantInfo}</span>
                                <span class="small"><strong>${rentInfo}/month</strong></span>
                            </div>
                        </div>
                        <div class="text-right">
                            ${syncStatus}
                            <div class="btn-group btn-group-sm mt-1">
                                <a href="/employee/property/${prop.id}" class="btn btn-outline-info btn-sm" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                            data-toggle="dropdown" 
                                            title="Assign to Block"
                                            onclick="populateBlockDropdown(${prop.id})">
                                        <i class="fas fa-arrow-down"></i>
                                    </button>
                                    <div class="dropdown-menu" id="blockDropdown-${prop.id}">
                                        <div class="dropdown-item text-muted">Loading blocks...</div>
                                    </div>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" onclick="removeProperty(${prop.id})" title="Remove from Portfolio">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div></div>';
    container.innerHTML = html;
}

// Populate block dropdown for property assignment
function populateBlockDropdown(propertyId) {
    const dropdown = document.getElementById(`blockDropdown-${propertyId}`);
    
    // Fetch available blocks for this portfolio
    fetch(`/portfolio/internal/blocks/portfolio/${portfolioId}/with-counts`)
        .then(response => response.json())
        .then(blocks => {
            let html = '';
            
            if (blocks.length === 0) {
                html = '<div class="dropdown-item text-muted">No blocks available</div>';
            } else {
                blocks.forEach(block => {
                    const capacityInfo = block.maxProperties ? 
                        ` (${block.propertyCount || 0}/${block.maxProperties})` : 
                        ` (${block.propertyCount || 0})`;
                    
                    html += `
                        <a class="dropdown-item" href="#" onclick="assignPropertyToBlock(${propertyId}, ${block.id}); event.preventDefault();">
                            ${block.name}${capacityInfo}
                        </a>
                    `;
                });
            }
            
            dropdown.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading blocks:', error);
            dropdown.innerHTML = '<div class="dropdown-item text-danger">Error loading blocks</div>';
        });
}

// Toggle block section
function toggleBlockSection(blockId) {
    const section = document.getElementById(`block-${blockId}`);
    const toggle = document.getElementById(`toggle-${blockId}`);
    const icon = toggle.querySelector('i');
    
    section.classList.toggle('show');
    
    if (section.classList.contains('show')) {
        icon.className = 'fas fa-chevron-down';
    } else {
        icon.className = 'fas fa-chevron-right';
    }
}

// Toggle unassigned section
function toggleSection(sectionName) {
    const section = document.getElementById(`${sectionName}Properties`);
    const toggle = document.getElementById(`${sectionName}Toggle`);
    const icon = toggle.querySelector('i');
    
    section.classList.toggle('show');
    
    if (section.classList.contains('show')) {
        icon.className = 'fas fa-chevron-down';
    } else {
        icon.className = 'fas fa-chevron-right';
    }
}

// Update property counts
function updatePropertyCounts(total, unassigned) {
    const totalCount = document.getElementById('totalPropertiesCount');
    const unassignedCount = document.getElementById('unassignedCount');
    
    totalCount.textContent = `${total} properties`;
    unassignedCount.textContent = unassigned;
}

// Show organization error
function showOrganizationError(message) {
    const loadingState = document.getElementById('loadingState');
    const organizationView = document.getElementById('portfolioOrganization');
    
    loadingState.style.display = 'none';
    organizationView.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
    organizationView.style.display = 'block';
}

// Property assignment functions
function assignPropertiesToBlock(blockId) {
    // Show modal or interface to select properties to assign
    // For now, redirect to the existing assignment page with block filter
    window.location.href = `/portfolio/${portfolioId}/assign?blockId=${blockId}`;
}

function removePropertyFromBlock(propertyId, blockId) {
    if (confirm('Move this property to unassigned? It will remain in the portfolio but not in any block.')) {
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");
        
        // Call the REST endpoint to remove property from block
        fetch(`/employee/property/${propertyId}/remove-from-block`, {
            method: 'DELETE',
            headers: {
                [header]: token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the hierarchical view to show updated organization
                loadPortfolioOrganization();
                
                // Show success message
                showToast('success', 'Property moved to unassigned successfully');
            } else {
                showToast('error', 'Failed to move property: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error removing property from block:', error);
            showToast('error', 'Error moving property from block');
        });
    }
}

function assignPropertyToBlock(propertyId, blockId) {
    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");
    
    // Call the REST endpoint to assign property to block
    fetch(`/employee/property/${propertyId}/assign-to-block`, {
        method: 'POST',
        headers: {
            [header]: token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `blockId=${blockId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the hierarchical view to show updated organization
            loadPortfolioOrganization();
            
            // Show success message
            showToast('success', 'Property assigned to block successfully');
        } else {
            showToast('error', 'Failed to assign property: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error assigning property to block:', error);
        showToast('error', 'Error assigning property to block');
    });
}

// Toast notification function
function showToast(type, message) {
    // Simple toast implementation - could be enhanced with a toast library
    const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const toast = $(`
        <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);
    
    $('body').append(toast);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        toast.alert('close');
    }, 3000);
}

// Load organization when page loads (replace the old loadBlocks)
$(document).ready(function() {
    loadPortfolioOrganization();
});

</script>

</body>
</html>