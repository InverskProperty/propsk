<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Maintenance Management - Property Owner Portal</title>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/favicon.png}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/icons.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <div class="main-wrapper">
        <div class="page-wrapper">
            <div class="content container-fluid">
                <div class="page-header">
                    <div class="row">
                        <div class="col">
                            <h3 class="page-title">Maintenance Management</h3>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a th:href="@{/property-owner/dashboard}">Dashboard</a></li>
                                <li class="breadcrumb-item active">Maintenance</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row" th:if="${error}">
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            <span th:text="${error}"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Maintenance Requests</h4>
                                <p class="text-muted">Manage maintenance requests across your properties</p>
                            </div>
                            <div class="card-body">
                                <!-- Filter Controls -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="propertyFilter">Filter by Property:</label>
                                        <select id="propertyFilter" class="form-control" onchange="filterByProperty()">
                                            <option value="">All Properties</option>
                                            <option th:each="property : ${properties}" 
                                                    th:value="${property.id}"
                                                    th:text="${property.propertyName ?: property.addressLine1}"
                                                    th:selected="${filterPropertyId != null && filterPropertyId == property.id}">
                                                Property Name
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="statusFilter">Filter by Status:</label>
                                        <select id="statusFilter" class="form-control" onchange="filterByStatus()">
                                            <option value="">All Status</option>
                                            <option value="open" th:selected="${filterStatus == 'open'}">Open</option>
                                            <option value="in-progress" th:selected="${filterStatus == 'in-progress'}">In Progress</option>
                                            <option value="completed" th:selected="${filterStatus == 'completed'}">Completed</option>
                                            <option value="closed" th:selected="${filterStatus == 'closed'}">Closed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <br>
                                        <button class="btn btn-success" onclick="createNewRequest()">
                                            <i class="fas fa-plus"></i> New Request
                                        </button>
                                        <button class="btn btn-info" onclick="refreshPage()">
                                            <i class="fas fa-refresh"></i> Refresh
                                        </button>
                                    </div>
                                </div>

                                <!-- Maintenance Tickets -->
                                <div th:if="${tickets?.size() > 0}">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Request ID</th>
                                                    <th>Property</th>
                                                    <th>Issue</th>
                                                    <th>Status</th>
                                                    <th>Priority</th>
                                                    <th>Created</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="ticket : ${tickets}">
                                                    <td th:text="${ticket.id}">#123</td>
                                                    <td>
                                                        <strong th:text="${ticket.property?.propertyName ?: ticket.property?.addressLine1 ?: 'Unknown Property'}">Property Name</strong><br>
                                                        <small class="text-muted" th:text="${ticket.property?.addressLine1 ?: ''}">Address</small>
                                                    </td>
                                                    <td>
                                                        <strong th:text="${ticket.issueType ?: 'General'}">Issue Type</strong><br>
                                                        <small class="text-muted" th:text="${ticket.description ?: 'No description'}">Description</small>
                                                    </td>
                                                    <td>
                                                        <span th:class="'badge ' + 
                                                              (${ticket.status == 'open'} ? 'bg-danger' : 
                                                               ${ticket.status == 'in-progress'} ? 'bg-warning' : 
                                                               ${ticket.status == 'completed'} ? 'bg-success' : 'bg-secondary')"
                                                              th:text="${ticket.status}">Status</span>
                                                    </td>
                                                    <td>
                                                        <span th:class="'badge ' + 
                                                              (${ticket.priority == 'emergency'} ? 'bg-danger' : 
                                                               ${ticket.priority == 'high'} ? 'bg-warning' : 
                                                               ${ticket.priority == 'medium'} ? 'bg-info' : 'bg-secondary')"
                                                              th:text="${ticket.priority ?: 'Normal'}">Priority</span>
                                                    </td>
                                                    <td th:text="${#temporals.format(ticket.createdDate, 'dd/MM/yyyy') ?: 'N/A'}">Date</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary" 
                                                                th:onclick="'viewTicketDetails(' + ${ticket.id} + ')'">
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div th:if="${tickets?.size() == 0}">
                                    <div class="text-center py-4">
                                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                                        <h5>No Maintenance Requests</h5>
                                        <p class="text-muted" th:text="${filterPropertyId != null || filterStatus != null ? 'No requests match your current filters.' : 'You have no maintenance requests at this time.'}">
                                            No maintenance requests found.
                                        </p>
                                        <button class="btn btn-success" onclick="createNewRequest()">
                                            <i class="fas fa-plus"></i> Create New Request
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/app.js}"></script>
    
    <script>
        function filterByProperty() {
            const propertyId = document.getElementById('propertyFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let url = '/property-owner/maintenance';
            const params = new URLSearchParams();
            
            if (propertyId) params.append('propertyId', propertyId);
            if (status) params.append('status', status);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            window.location.href = url;
        }
        
        function filterByStatus() {
            const propertyId = document.getElementById('propertyFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let url = '/property-owner/maintenance';
            const params = new URLSearchParams();
            
            if (propertyId) params.append('propertyId', propertyId);
            if (status) params.append('status', status);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            window.location.href = url;
        }
        
        function createNewRequest() {
            alert('Create new maintenance request functionality will be implemented here.\\nThis will allow you to submit new maintenance requests for your properties.');
        }
        
        function refreshPage() {
            window.location.reload();
        }
        
        function viewTicketDetails(ticketId) {
            alert('Viewing details for maintenance request #' + ticketId + '.\\nThis will show full request details, photos, contractor communications, etc.');
        }
    </script>
</body>
</html>