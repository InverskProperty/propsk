<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Maintenance Management - Property Owner Portal</title>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/favicon.png}">
    <!-- Bootstrap Core CSS -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/style.min.css}" rel="stylesheet">
    <!-- DataTables CSS -->
    <link th:href="@{/css/dataTables.bootstrap4.css}" rel="stylesheet">
    <!-- Font Awesome -->
    <link th:href="@{/css/all.css}" rel="stylesheet">
</head>
<body>
    <div class="main-wrapper">
        <div class="page-wrapper">
            <div class="content container-fluid">
                <div class="page-header">
                    <div class="row">
                        <div class="col">
                            <h3 class="page-title">Maintenance Management</h3>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a th:href="@{/property-owner/dashboard}">Dashboard</a></li>
                                <li class="breadcrumb-item active">Maintenance</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row" th:if="${error}">
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            <span th:text="${error}"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Maintenance Requests</h4>
                                <p class="text-muted">Manage maintenance requests across your properties</p>
                            </div>
                            <div class="card-body">
                                <!-- Filter Controls -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="propertyFilter">Filter by Property:</label>
                                        <select id="propertyFilter" class="form-control" onchange="filterByProperty()">
                                            <option value="">All Properties</option>
                                            <option th:each="property : ${properties}" 
                                                    th:value="${property.id}"
                                                    th:text="${property.propertyName ?: property.addressLine1}"
                                                    th:selected="${filterPropertyId != null && filterPropertyId == property.id}">
                                                Property Name
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="statusFilter">Filter by Status:</label>
                                        <select id="statusFilter" class="form-control" onchange="filterByStatus()">
                                            <option value="">All Status</option>
                                            <option value="open" th:selected="${filterStatus == 'open'}">Open</option>
                                            <option value="in-progress" th:selected="${filterStatus == 'in-progress'}">In Progress</option>
                                            <option value="completed" th:selected="${filterStatus == 'completed'}">Completed</option>
                                            <option value="closed" th:selected="${filterStatus == 'closed'}">Closed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <br>
                                        <button class="btn btn-success" onclick="createNewRequest()">
                                            <i class="fas fa-plus"></i> New Request
                                        </button>
                                        <button class="btn btn-info" onclick="refreshPage()">
                                            <i class="fas fa-refresh"></i> Refresh
                                        </button>
                                    </div>
                                </div>

                                <!-- Maintenance Tickets -->
                                <div th:if="${tickets?.size() > 0}">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Request ID</th>
                                                    <th>Property</th>
                                                    <th>Issue</th>
                                                    <th>Status</th>
                                                    <th>Priority</th>
                                                    <th>Created</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="ticket : ${tickets}">
                                                    <td th:text="${ticket.ticketId}">#123</td>
                                                    <td>
                                                        <strong th:text="${ticket.property?.propertyName ?: ticket.property?.addressLine1 ?: 'Unknown Property'}">Property Name</strong><br>
                                                        <small class="text-muted" th:text="${ticket.property?.addressLine1 ?: ''}">Address</small>
                                                    </td>
                                                    <td>
                                                        <strong th:text="${ticket.type ?: 'General'}">Issue Type</strong><br>
                                                        <small class="text-muted" th:text="${ticket.description ?: 'No description'}">Description</small>
                                                    </td>
                                                    <td>
                                                        <span th:if="${ticket.status == 'open'}" class="badge bg-danger" th:text="${ticket.status}">Status</span>
                                                        <span th:if="${ticket.status == 'in-progress'}" class="badge bg-warning" th:text="${ticket.status}">Status</span>
                                                        <span th:if="${ticket.status == 'completed'}" class="badge bg-success" th:text="${ticket.status}">Status</span>
                                                        <span th:if="${ticket.status != 'open' && ticket.status != 'in-progress' && ticket.status != 'completed'}" class="badge bg-secondary" th:text="${ticket.status}">Status</span>
                                                    </td>
                                                    <td>
                                                        <span th:if="${ticket.priority == 'emergency'}" class="badge bg-danger" th:text="${ticket.priority ?: 'Normal'}">Priority</span>
                                                        <span th:if="${ticket.priority == 'high'}" class="badge bg-warning" th:text="${ticket.priority ?: 'Normal'}">Priority</span>
                                                        <span th:if="${ticket.priority == 'medium'}" class="badge bg-info" th:text="${ticket.priority ?: 'Normal'}">Priority</span>
                                                        <span th:if="${ticket.priority != 'emergency' && ticket.priority != 'high' && ticket.priority != 'medium'}" class="badge bg-secondary" th:text="${ticket.priority ?: 'Normal'}">Priority</span>
                                                    </td>
                                                    <td th:text="${#temporals.format(ticket.createdAt, 'dd/MM/yyyy') ?: 'N/A'}">Date</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-primary" 
                                                                th:onclick="'viewTicketDetails(' + ${ticket.ticketId} + ')'">
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div th:if="${tickets?.size() == 0}">
                                    <div class="text-center py-4">
                                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                                        <h5>No Maintenance Requests</h5>
                                        <p class="text-muted" th:text="${filterPropertyId != null || filterStatus != null ? 'No requests match your current filters.' : 'You have no maintenance requests at this time.'}">
                                            No maintenance requests found.
                                        </p>
                                        <button class="btn btn-success" onclick="createNewRequest()">
                                            <i class="fas fa-plus"></i> Create New Request
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div class="modal fade" id="ticketDetailModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Maintenance Request Details</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="ticketDetailContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading ticket details...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create New Request Modal -->
    <div class="modal fade" id="createRequestModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Maintenance Request</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <form id="createRequestForm" enctype="multipart/form-data">
                    <!-- CSRF Token for Spring Security - using custom parameter name 'csrf' -->
                    <input type="hidden" name="csrf" th:value="${_csrf.token}" />

                    <div class="modal-body">
                        <div class="form-group">
                            <label for="requestProperty">Property *</label>
                            <select class="form-control" id="requestProperty" name="propertyId" required>
                                <option value="">Select a property...</option>
                                <option th:each="property : ${properties}"
                                        th:value="${property.id}"
                                        th:text="${property.propertyName ?: property.addressLine1}">
                                    Property Name
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="requestSubject">Issue Summary *</label>
                            <input type="text" class="form-control" id="requestSubject" name="subject" 
                                   placeholder="Brief description of the issue" required maxlength="100">
                        </div>

                        <div class="form-group">
                            <label for="requestDescription">Detailed Description *</label>
                            <textarea class="form-control" id="requestDescription" name="description" 
                                      rows="4" placeholder="Please provide a detailed description of the maintenance issue..." 
                                      required maxlength="2000"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="requestPriority">Priority *</label>
                                    <select class="form-control" id="requestPriority" name="priority" required>
                                        <option value="medium">Medium - General repairs</option>
                                        <option value="high">High - Urgent but not critical</option>
                                        <option value="emergency">Emergency - Immediate attention required</option>
                                        <option value="low">Low - Routine maintenance</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="requestCategory">Category</label>
                                    <select class="form-control" id="requestCategory" name="maintenanceCategory">
                                        <option value="">Select category...</option>
                                        <option value="plumbing">Plumbing</option>
                                        <option value="electrical">Electrical</option>
                                        <option value="heating">Heating/Cooling</option>
                                        <option value="appliances">Appliances</option>
                                        <option value="structural">Structural</option>
                                        <option value="exterior">Exterior/Landscaping</option>
                                        <option value="security">Security</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Access Requirements</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="accessRequired" name="accessRequired">
                                <label class="form-check-label" for="accessRequired">
                                    Property access required (keys/entry needed)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="tenantPresent" name="tenantPresentRequired">
                                <label class="form-check-label" for="tenantPresent">
                                    Tenant must be present during work
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="preferredTime">Preferred Time Slot</label>
                            <select class="form-control" id="preferredTime" name="preferredTimeSlot">
                                <option value="">No preference</option>
                                <option value="morning">Morning (8AM - 12PM)</option>
                                <option value="afternoon">Afternoon (12PM - 5PM)</option>
                                <option value="evening">Evening (5PM - 8PM)</option>
                                <option value="weekend">Weekend</option>
                                <option value="urgent">As soon as possible</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="requestPhotos">Photos/Documents</label>
                            <input type="file" class="form-control-file" id="requestPhotos" name="photos" 
                                   multiple accept="image/*,.pdf,.doc,.docx">
                            <small class="form-text text-muted">
                                Upload photos or documents related to the issue (optional)
                            </small>
                        </div>

                        <div id="createRequestError" class="alert alert-danger d-none"></div>
                        <div id="createRequestSuccess" class="alert alert-success d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="submitRequest">
                            <i class="fas fa-paper-plane"></i> Submit Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- All Jquery -->
    <script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
    <!-- Bootstrap JS -->
    <script th:src="@{/js/library/bootstrap.min.js}"></script>
    <script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
    
    <script>
        function filterByProperty() {
            const propertyId = document.getElementById('propertyFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let url = '/property-owner/maintenance';
            const params = new URLSearchParams();
            
            if (propertyId) params.append('propertyId', propertyId);
            if (status) params.append('status', status);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            window.location.href = url;
        }
        
        function filterByStatus() {
            const propertyId = document.getElementById('propertyFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            let url = '/property-owner/maintenance';
            const params = new URLSearchParams();
            
            if (propertyId) params.append('propertyId', propertyId);
            if (status) params.append('status', status);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            window.location.href = url;
        }
        
        function createNewRequest() {
            // Debug: Check if jQuery is loaded
            if (typeof $ === 'undefined') {
                console.error('jQuery is not loaded!');
                alert('There was a technical issue. Please refresh the page and try again.');
                return;
            }
            
            $('#createRequestModal').modal('show');
        }
        
        function refreshPage() {
            window.location.reload();
        }
        
        function viewTicketDetails(ticketId) {
            // Debug: Check if jQuery is loaded
            if (typeof $ === 'undefined') {
                console.error('jQuery is not loaded!');
                alert('There was a technical issue. Please refresh the page and try again.');
                return;
            }
            
            // Show the modal with loading spinner
            $('#ticketDetailModal').modal('show');
            
            // Reset modal content to loading state
            $('#ticketDetailContent').html(
                '<div class="text-center">' +
                    '<div class="spinner-border" role="status">' +
                        '<span class="sr-only">Loading...</span>' +
                    '</div>' +
                    '<p class="mt-2">Loading ticket details...</p>' +
                '</div>'
            );
            
            // Load ticket details via AJAX
            $.ajax({
                url: '/property-owner/maintenance/ticket/' + ticketId + '/details',
                method: 'GET',
                success: function(data) {
                    $('#ticketDetailContent').html(data);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading ticket details:', error);
                    $('#ticketDetailContent').html(
                        '<div class="alert alert-danger">' +
                            '<h5>Error Loading Ticket</h5>' +
                            '<p>Unable to load ticket details. Please try again later.</p>' +
                            '<p><strong>Error:</strong> ' + error + '</p>' +
                        '</div>'
                    );
                }
            });
        }

        // Ensure jQuery and Bootstrap are loaded before setting up handlers
        function initializeMaintenanceHandlers() {
            if (typeof $ === 'undefined') {
                console.error('jQuery is not available');
                return;
            }
            
            if (typeof $.fn.modal === 'undefined') {
                console.error('Bootstrap modal is not available');
                return;
            }
            
            console.log('jQuery and Bootstrap loaded successfully');
        }

        // Handle create request form submission
        $(document).ready(function() {
            // Initialize compatibility check
            initializeMaintenanceHandlers();
            $('#createRequestForm').on('submit', function(e) {
                e.preventDefault();
                
                // Disable submit button and show loading state
                const submitBtn = $('#submitRequest');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Submitting...');
                
                // Hide any previous messages
                $('#createRequestError, #createRequestSuccess').addClass('d-none');
                
                // Create FormData object to handle file uploads
                const formData = new FormData(this);
                
                $.ajax({
                    url: '/property-owner/maintenance/create',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#createRequestSuccess').text(response.message || 'Maintenance request submitted successfully!').removeClass('d-none');
                            
                            // Reset form after short delay
                            setTimeout(function() {
                                $('#createRequestModal').modal('hide');
                                $('#createRequestForm')[0].reset();
                                $('#createRequestSuccess').addClass('d-none');
                                
                                // Refresh the page to show the new ticket
                                window.location.reload();
                            }, 2000);
                        } else {
                            $('#createRequestError').text(response.error || 'An error occurred while submitting the request').removeClass('d-none');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error creating request:', error);
                        let errorMessage = 'An error occurred while submitting the request';
                        
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage = xhr.responseJSON.error;
                        } else if (xhr.status === 401) {
                            errorMessage = 'Authentication required. Please log in and try again.';
                        } else if (xhr.status === 403) {
                            errorMessage = 'Access denied. Please check your permissions.';
                        }
                        
                        $('#createRequestError').text(errorMessage).removeClass('d-none');
                    },
                    complete: function() {
                        // Re-enable submit button
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // Reset form when modal is hidden
            $('#createRequestModal').on('hidden.bs.modal', function() {
                $('#createRequestForm')[0].reset();
                $('#createRequestError, #createRequestSuccess').addClass('d-none');
            });
        });
    </script>
</body>
</html>