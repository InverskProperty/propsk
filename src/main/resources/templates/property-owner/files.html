<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document Files - Property Owner Portal</title>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/favicon.png}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/icons.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <div class="main-wrapper">
        <div class="page-wrapper">
            <div class="content container-fluid">
                <div class="page-header">
                    <div class="row">
                        <div class="col">
                            <h3 class="page-title">Document Files</h3>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a th:href="@{/property-owner/dashboard}">Dashboard</a></li>
                                <li class="breadcrumb-item active">Files</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row" th:if="${error}">
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            <span th:text="${error}"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Google Drive File System</h4>
                                <p class="text-muted">Access your property documents and files</p>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Document Management System</strong><br>
                                    Your documents are securely stored and organized by property. 
                                    You can upload files, generate statements, and sync with PayProp.
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                                <h5>Upload Files</h5>
                                                <p>Upload property documents and files</p>
                                                <button class="btn btn-light btn-sm" onclick="uploadFiles()">
                                                    Upload Files
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <i class="fas fa-file-invoice fa-2x mb-2"></i>
                                                <h5>Generate Statements</h5>
                                                <p>Create property and tenant statements</p>
                                                <a th:href="@{/property-owner/statements}" class="btn btn-light btn-sm">
                                                    Generate Statements
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <i class="fas fa-sync fa-2x mb-2"></i>
                                                <h5>PayProp Sync</h5>
                                                <p>Sync documents with PayProp system</p>
                                                <button class="btn btn-light btn-sm" onclick="syncPayProp()">
                                                    Sync PayProp
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h5>Your Document Folders</h5>
                                    <div class="list-group">
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Property Documents</strong>
                                                    <br>
                                                    <small class="text-muted">EICR, EPC, Insurance, and property-specific files</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('property-documents')">Browse</button>
                                            </div>
                                        </div>
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Tenant Documents</strong>
                                                    <br>
                                                    <small class="text-muted">Tenant applications, references, and agreements</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('tenant-documents')">Browse</button>
                                            </div>
                                        </div>
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Financial Statements</strong>
                                                    <br>
                                                    <small class="text-muted">Generated statements and financial reports</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('financial-statements')">Browse</button>
                                            </div>
                                        </div>
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Maintenance Records</strong>
                                                    <br>
                                                    <small class="text-muted">Maintenance requests, invoices, and work orders</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('maintenance-records')">Browse</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- File Browser Modal -->
                                    <div class="modal fade" id="fileBrowserModal" tabindex="-1" aria-labelledby="fileBrowserModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="fileBrowserModalLabel">Browse Files</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="backButton" onclick="navigateBack()" style="display: none;">
                                                            <i class="fas fa-arrow-left"></i> Back
                                                        </button>
                                                        <nav aria-label="breadcrumb" class="flex-grow-1 ms-2">
                                                            <ol class="breadcrumb mb-0" id="breadcrumbList">
                                                                <li class="breadcrumb-item active">Documents</li>
                                                            </ol>
                                                        </nav>
                                                    </div>

                                                    <div id="fileListContainer">
                                                        <div class="text-center">
                                                            <div class="spinner-border" role="status" aria-hidden="true"></div>
                                                            <p>Loading files...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-success" onclick="uploadFiles()">
                                                        <i class="fas fa-upload"></i> Upload Files
                                                    </button>
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/app.js}"></script>
    
    <script>
        // Navigation state
        let navigationStack = [];
        let currentLevel = 'root'; // root, property, property-subfolder, tenants, tenant, tenant-subfolder

        // Current context
        let currentFolderType = '';
        let currentFiles = [];
        let currentFolders = [];
        let currentPropertyId = null;
        let currentPropertyName = null;
        let currentLeaseId = null;
        let currentTenantName = null;
        let currentSubfolder = null;

        // Navigation helpers
        function updateBreadcrumb(items) {
            const breadcrumbList = document.getElementById('breadcrumbList');
            breadcrumbList.innerHTML = '';

            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'breadcrumb-item';

                if (index === items.length - 1) {
                    li.className += ' active';
                    li.setAttribute('aria-current', 'page');
                    li.textContent = item.text;
                } else {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = item.text;
                    link.onclick = (e) => {
                        e.preventDefault();
                        item.action();
                    };
                    li.appendChild(link);
                }

                breadcrumbList.appendChild(li);
            });

            // Show/hide back button
            const backButton = document.getElementById('backButton');
            if (navigationStack.length > 0) {
                backButton.style.display = 'inline-block';
            } else {
                backButton.style.display = 'none';
            }
        }

        function pushNavigation(state) {
            navigationStack.push(state);
            console.log('Navigation stack:', navigationStack);
        }

        function navigateBack() {
            if (navigationStack.length === 0) return;

            const previousState = navigationStack.pop();
            console.log('Navigating back to:', previousState);

            // Execute the previous state's action
            if (previousState.action) {
                previousState.action();
            }
        }

        function browseFolder(folderType) {
            currentFolderType = folderType;
            console.log('Browsing folder:', folderType);

            // Update modal title
            document.getElementById('fileBrowserModalLabel').textContent = 'Browse ' + formatFolderName(folderType);

            // Update modal footer upload button visibility
            const uploadButton = document.querySelector('.modal-footer .btn-success');
            if (folderType === 'property-documents') {
                uploadButton.style.display = 'none';
            } else {
                uploadButton.style.display = 'inline-block';
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('fileBrowserModal'));
            modal.show();

            // Load files
            loadFiles(folderType);
        }

        function loadFiles(folderType) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <p>Loading files...</p>
                </div>
            `;

            fetch(`/property-owner/files/browse/${folderType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentFiles = data.files || [];
                        currentFolders = data.folders || [];
                        displayFiles(data);
                    } else {
                        showError(data.error || 'Failed to load files');
                    }
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    showError('Error loading files: ' + error.message);
                });
        }

        function displayFiles(data) {
            const container = document.getElementById('fileListContainer');

            let html = '';

            // Show folders first
            if (data.folders && data.folders.length > 0) {
                html += '<h6><i class="fas fa-folder text-warning"></i> Folders</h6>';
                html += '<div class="list-group mb-3">';
                data.folders.forEach(folder => {
                    html += `
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-folder text-warning me-2"></i>
                                <strong>${folder.name}</strong>
                                <div class="small text-muted">${folder.subfolders ? folder.subfolders.join(', ') : 'Property documents'}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openPropertyFolder('${folder.id}', '${folder.name}')">
                                Open
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show files
            if (data.files && data.files.length > 0) {
                html += '<h6><i class="fas fa-file text-primary"></i> Files</h6>';
                html += '<div class="list-group">';
                data.files.forEach(file => {
                    const icon = getFileIcon(file.name);
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="${icon} me-2"></i>
                                <span>${file.name}</span>
                                <div class="small text-muted">${file.size} - Modified ${file.modified}</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-success me-2" onclick="downloadFile('${file.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewFile('${file.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show empty state
            if ((!data.folders || data.folders.length === 0) && (!data.files || data.files.length === 0)) {
                if (currentFolderType === 'property-documents') {
                    html = `
                        <div class="text-center py-4">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h5>No property folders found</h5>
                            <p class="text-muted">Your property folders will appear here once they are created automatically when you access specific properties.</p>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>How it works:</strong> Property folders are created automatically based on your property assignments. If you don't see any folders, please contact support.
                            </div>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="text-center py-4">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                            <h5>No files found</h5>
                            <p class="text-muted">This folder is empty. Upload files to get started.</p>
                            <button class="btn btn-primary" onclick="uploadFiles()">
                                <i class="fas fa-upload"></i> Upload Files
                            </button>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        function openPropertyFolder(propertyId, propertyName) {
            console.log('Opening property folder:', propertyId, propertyName);

            // Save previous state for back navigation
            pushNavigation({
                level: currentLevel,
                action: () => loadFiles(currentFolderType)
            });

            // Update context
            currentPropertyId = propertyId;
            currentPropertyName = propertyName;
            currentLeaseId = null;
            currentTenantName = null;
            currentSubfolder = null;
            currentLevel = 'property';

            // Update modal title
            document.getElementById('fileBrowserModalLabel').textContent = propertyName;

            // Update breadcrumb
            updateBreadcrumb([
                { text: 'Documents', action: () => { navigationStack = []; loadFiles(currentFolderType); } },
                { text: propertyName }
            ]);

            // Hide upload button until we're in a specific subfolder
            const uploadButton = document.querySelector('.modal-footer .btn-success');
            uploadButton.style.display = 'none';

            // Load hybrid view: both property folders and tenants
            loadPropertyHybridView(propertyId);
        }

        function loadPropertyHybridView(propertyId) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <p>Loading property contents...</p>
                </div>
            `;

            // Load both property subfolders and tenants in parallel
            Promise.all([
                fetch(`/property-owner/files/property/${propertyId}/subfolders`).then(r => r.json()),
                fetch(`/property-owner/files/property/${propertyId}/tenants`).then(r => r.json())
            ])
            .then(([subfoldersData, tenantsData]) => {
                displayPropertyHybridView(subfoldersData.subfolders || [], tenantsData.tenants || []);
            })
            .catch(error => {
                console.error('Error loading property view:', error);
                showError('Error loading property view: ' + error.message);
            });
        }

        function displayPropertyHybridView(propertySubfolders, tenants) {
            const container = document.getElementById('fileListContainer');
            let html = '';

            // Property-level document folders
            if (propertySubfolders.length > 0) {
                html += '<h6><i class="fas fa-folder text-warning"></i> Property Documents</h6>';
                html += '<div class="list-group mb-3">';

                propertySubfolders.forEach(folder => {
                    html += `
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-folder text-warning me-2"></i>
                                <strong>${folder.name}</strong>
                                <div class="small text-muted">${folder.description}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openPropertySubfolder('${folder.name}')">
                                Browse
                            </button>
                        </div>
                    `;
                });

                html += '</div>';
            }

            // Tenant folders
            if (tenants.length > 0) {
                html += '<h6><i class="fas fa-users text-primary"></i> Tenant Documents</h6>';
                html += '<div class="list-group mb-3">';

                tenants.forEach(tenant => {
                    const statusBadge = tenant.isActive ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    const dateRange = tenant.endDate ?
                        `${tenant.startDate} to ${tenant.endDate}` :
                        `${tenant.startDate} to Present`;

                    html += `
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-user text-primary me-2"></i>
                                <strong>${tenant.tenantName}</strong> ${statusBadge}
                                <div class="small text-muted">${dateRange}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openTenant('${tenant.leaseId}', '${tenant.tenantName}')">
                                Open
                            </button>
                        </div>
                    `;
                });

                html += '</div>';
            }

            // Empty state
            if (propertySubfolders.length === 0 && tenants.length === 0) {
                html = `
                    <div class="text-center py-4">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <h5>No documents or tenants found</h5>
                        <p class="text-muted">This property has no documents or tenant leases yet.</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function loadPropertyTenants(propertyId, propertyName) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <p>Loading tenants...</p>
                </div>
            `;

            fetch(`/property-owner/files/property/${propertyId}/tenants`)
                .then(response => response.json())
                .then(data => {
                    if (data.tenants) {
                        displayPropertyTenants(data.tenants);
                    } else if (data.error) {
                        showError(data.error);
                    } else {
                        showError('Failed to load tenants');
                    }
                })
                .catch(error => {
                    console.error('Error loading tenants:', error);
                    showError('Error loading tenants: ' + error.message);
                });
        }

        function displayPropertyTenants(tenants) {
            const container = document.getElementById('fileListContainer');

            if (!tenants || tenants.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5>No tenants found</h5>
                        <p class="text-muted">No leases have been created for this property yet.</p>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>Note:</strong> Tenant folders are created automatically when you create invoices/leases for this property.
                        </div>
                    </div>
                `;
                return;
            }

            let html = '<h6><i class="fas fa-users text-primary"></i> Tenants & Leases</h6>';
            html += '<div class="list-group mb-3">';

            tenants.forEach(tenant => {
                const statusBadge = tenant.isActive ?
                    '<span class="badge bg-success">Active</span>' :
                    '<span class="badge bg-secondary">Inactive</span>';

                const dateRange = tenant.endDate ?
                    `${tenant.startDate} to ${tenant.endDate}` :
                    `${tenant.startDate} to Present`;

                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-user text-primary me-2"></i>
                            <strong>${tenant.tenantName}</strong> ${statusBadge}
                            <div class="small text-muted">${dateRange}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="openTenant('${tenant.leaseId}', '${tenant.tenantName}')">
                            Open
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function openPropertySubfolder(subfolderName) {
            console.log('Opening property subfolder:', subfolderName);

            // Save previous state for back navigation
            pushNavigation({
                level: currentLevel,
                action: () => loadPropertyHybridView(currentPropertyId)
            });

            // Update context
            currentSubfolder = subfolderName;
            currentLevel = 'property-subfolder';
            currentFolderType = 'property-subfolder';

            // Update modal title
            document.getElementById('fileBrowserModalLabel').textContent = `${currentPropertyName} - ${subfolderName}`;

            // Update breadcrumb
            updateBreadcrumb([
                { text: 'Documents', action: () => { navigationStack = []; loadFiles('property-documents'); } },
                { text: currentPropertyName, action: () => { navigationStack.pop(); loadPropertyHybridView(currentPropertyId); } },
                { text: subfolderName }
            ]);

            // Show upload button
            const uploadButton = document.querySelector('.modal-footer .btn-success');
            uploadButton.style.display = 'inline-block';

            // Load files
            loadPropertySubfolderFiles(currentPropertyId, subfolderName);
        }

        function loadPropertySubfolderFiles(propertyId, subfolderName) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <p>Loading ${subfolderName} files...</p>
                </div>
            `;

            fetch(`/property-owner/files/property/${propertyId}/subfolder/${subfolderName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.files) {
                        currentFiles = data.files || [];
                        displayFiles({files: data.files});
                    } else if (data.error) {
                        showError(data.error);
                    } else {
                        showError('Failed to load subfolder files');
                    }
                })
                .catch(error => {
                    console.error('Error loading subfolder files:', error);
                    showError('Error loading subfolder files: ' + error.message);
                });
        }

        function openTenant(leaseId, tenantName) {
            console.log('Opening tenant:', leaseId, tenantName);

            // Save previous state for back navigation
            pushNavigation({
                level: currentLevel,
                action: () => loadPropertyHybridView(currentPropertyId)
            });

            // Update context
            currentLeaseId = leaseId;
            currentTenantName = tenantName;
            currentSubfolder = null;
            currentLevel = 'tenant';

            // Update modal title
            document.getElementById('fileBrowserModalLabel').textContent = `${currentPropertyName} - ${tenantName}`;

            // Update breadcrumb
            updateBreadcrumb([
                { text: 'Documents', action: () => { navigationStack = []; loadFiles('property-documents'); } },
                { text: currentPropertyName, action: () => { navigationStack.pop(); loadPropertyHybridView(currentPropertyId); } },
                { text: tenantName }
            ]);

            // Hide upload button until specific subfolder is selected
            const uploadButton = document.querySelector('.modal-footer .btn-success');
            uploadButton.style.display = 'none';

            // Display document type subfolders
            displayTenantSubfolders();
        }

        function displayTenantSubfolders() {
            const container = document.getElementById('fileListContainer');
            const subfolders = [
                {name: 'Contracts', description: 'Tenancy agreements and contracts'},
                {name: 'Inspections', description: 'Property inspection reports'},
                {name: 'Inventories', description: 'Inventory documents and check-in/out reports'},
                {name: 'Miscellaneous', description: 'Other tenant-related documents'},
                {name: 'Right-to-Rent', description: 'Right to rent checks and documentation'}
            ];

            let html = '<h6><i class="fas fa-folder text-warning"></i> Document Categories</h6>';
            html += '<div class="list-group mb-3">';

            subfolders.forEach(subfolder => {
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-folder text-warning me-2"></i>
                            <strong>${subfolder.name}</strong>
                            <div class="small text-muted">${subfolder.description}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="openTenantSubfolder('${subfolder.name}')">
                            Browse
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function openTenantSubfolder(subfolderName) {
            console.log('Opening tenant subfolder:', subfolderName);

            // Save previous state for back navigation
            pushNavigation({
                level: currentLevel,
                action: () => {
                    currentLevel = 'tenant';
                    displayTenantSubfolders();
                }
            });

            // Update context for uploads
            currentFolderType = 'tenant-subfolder';
            currentSubfolder = subfolderName;
            currentLevel = 'tenant-subfolder';

            // Update modal title
            document.getElementById('fileBrowserModalLabel').textContent = `${currentTenantName} - ${subfolderName}`;

            // Update breadcrumb
            updateBreadcrumb([
                { text: 'Documents', action: () => { navigationStack = []; loadFiles('property-documents'); } },
                { text: currentPropertyName, action: () => { while(navigationStack.length > 1) navigationStack.pop(); loadPropertyHybridView(currentPropertyId); } },
                { text: currentTenantName, action: () => { navigationStack.pop(); displayTenantSubfolders(); } },
                { text: subfolderName }
            ]);

            // Show upload button for tenant subfolders
            const uploadButton = document.querySelector('.modal-footer .btn-success');
            uploadButton.style.display = 'inline-block';

            // Load files in this subfolder
            loadTenantSubfolderFiles(currentPropertyId, currentLeaseId, subfolderName);
        }

        function loadTenantSubfolderFiles(propertyId, leaseId, subfolderName) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <p>Loading ${subfolderName} files...</p>
                </div>
            `;

            fetch(`/property-owner/files/property/${propertyId}/tenant/${leaseId}/subfolder/${subfolderName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.files) {
                        currentFiles = data.files || [];
                        displayFiles({files: data.files});
                    } else if (data.error) {
                        showError(data.error);
                    } else {
                        showError('Failed to load subfolder files');
                    }
                })
                .catch(error => {
                    console.error('Error loading subfolder files:', error);
                    showError('Error loading subfolder files: ' + error.message);
                });
        }

        function downloadFile(fileId) {
            console.log('Downloading file:', fileId);
            // NEW: Use proxy endpoint to download files without Google authentication
            window.location.href = `/property-owner/files/proxy/download/${fileId}`;
        }

        function viewFile(fileId) {
            console.log('Viewing file:', fileId);
            // NEW: Use proxy endpoint to view files without Google authentication
            window.open(`/property-owner/files/proxy/view/${fileId}`, '_blank');
        }

        function uploadFiles() {
            // Check if we're in the right context for uploads
            if (currentLevel !== 'property-subfolder' && currentLevel !== 'tenant-subfolder') {
                alert('Please navigate to a specific document folder first.\n\nTo upload files:\n1. Click "Open" on a property\n2. Select either:\n   - A property folder (EICR, EPC, Insurance, Misc), OR\n   - A tenant, then a document category\n3. Upload your files');
                return;
            }

            if (currentLevel === 'tenant-subfolder' && (!currentPropertyId || !currentLeaseId || !currentSubfolder)) {
                alert('Invalid tenant subfolder context. Please navigate again.');
                return;
            }

            if (currentLevel === 'property-subfolder' && (!currentPropertyId || !currentSubfolder)) {
                alert('Invalid property subfolder context. Please navigate again.');
                return;
            }

            // Create file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt';

            fileInput.onchange = function(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }

                // Show uploading message
                const container = document.getElementById('fileListContainer');
                const originalContent = container.innerHTML;
                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                        <h5>Uploading ${files.length} file(s)...</h5>
                        <p class="text-muted">Please wait while your files are uploaded to Google Drive.</p>
                    </div>
                `;

                // Determine upload URL based on current level
                let uploadUrl;
                let reloadFunction;

                if (currentLevel === 'property-subfolder') {
                    uploadUrl = `/property-owner/files/property/${currentPropertyId}/subfolder/${currentSubfolder}/upload`;
                    reloadFunction = () => loadPropertySubfolderFiles(currentPropertyId, currentSubfolder);
                } else if (currentLevel === 'tenant-subfolder') {
                    uploadUrl = `/property-owner/files/property/${currentPropertyId}/tenant/${currentLeaseId}/subfolder/${currentSubfolder}/upload`;
                    reloadFunction = () => loadTenantSubfolderFiles(currentPropertyId, currentLeaseId, currentSubfolder);
                }

                fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.successCount !== undefined) {
                        const totalFiles = data.successCount + data.failedCount;
                        if (data.failedCount > 0) {
                            alert(`Upload partially complete!\n${data.successCount} of ${totalFiles} files uploaded successfully.\nFailed files: ${data.failedFiles.join(', ')}`);
                        } else {
                            alert(`Upload complete! All ${data.successCount} files uploaded successfully.`);
                        }
                        // Reload the file list
                        reloadFunction();
                    } else if (data.error) {
                        container.innerHTML = originalContent;
                        alert('Upload failed: ' + data.error);
                    } else {
                        container.innerHTML = originalContent;
                        alert('Upload failed: Unknown error');
                    }
                })
                .catch(error => {
                    container.innerHTML = originalContent;
                    console.error('Error uploading files:', error);
                    alert('Error uploading files: ' + error.message);
                });
            };

            // Trigger file selection
            fileInput.click();
        }

        function syncPayProp() {
            alert('PayProp sync functionality will be implemented here.\nThis will sync your documents with the PayProp property management system.');
        }

        function formatFolderName(folderType) {
            const names = {
                'property-documents': 'Property Documents',
                'tenant-documents': 'Tenant Documents',
                'financial-statements': 'Financial Statements',
                'maintenance-records': 'Maintenance Records'
            };
            return names[folderType] || folderType;
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'fas fa-file-pdf text-danger';
                case 'doc':
                case 'docx': return 'fas fa-file-word text-primary';
                case 'xls':
                case 'xlsx': return 'fas fa-file-excel text-success';
                case 'jpg':
                case 'jpeg':
                case 'png': return 'fas fa-file-image text-info';
                default: return 'fas fa-file text-secondary';
            }
        }

        function showError(message) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${message}
                </div>
            `;
        }

        // Initialize folder structure if needed
        document.addEventListener('DOMContentLoaded', function() {
            // Check if shared drive is available and initialize if needed
            if (typeof hasServiceAccount !== 'undefined' && hasServiceAccount) {
                console.log('Service account available for shared drive');
            }

            // Auto-open property documents if propertyId is provided
            const selectedPropertyId = '[[${selectedPropertyId}]]';
            if (selectedPropertyId && selectedPropertyId !== '') {
                console.log('Auto-opening property documents for property:', selectedPropertyId);

                // Find the property name from the properties list
                const properties = [[${properties}]];
                const property = properties.find(p => p.id.toString() === selectedPropertyId);

                if (property) {
                    // Automatically open the property documents
                    setTimeout(() => {
                        browseFolder('property-documents');
                        setTimeout(() => {
                            openProperty(parseInt(selectedPropertyId), property.propertyName || property.fullAddress);
                        }, 500);
                    }, 300);
                }
            }
        });
    </script>
</body>
</html>