<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document Files - Property Owner Portal</title>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/favicon.png}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/icons.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <div class="main-wrapper">
        <div class="page-wrapper">
            <div class="content container-fluid">
                <div class="page-header">
                    <div class="row">
                        <div class="col">
                            <h3 class="page-title">Document Files</h3>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a th:href="@{/property-owner/dashboard}">Dashboard</a></li>
                                <li class="breadcrumb-item active">Files</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row" th:if="${error}">
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            <span th:text="${error}"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Google Drive File System</h4>
                                <p class="text-muted">Access your property documents and files</p>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Document Management System</strong><br>
                                    Your documents are securely stored and organized by property. 
                                    You can upload files, generate statements, and sync with PayProp.
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                                <h5>Upload Files</h5>
                                                <p>Upload property documents and files</p>
                                                <button class="btn btn-light btn-sm" onclick="uploadFiles()">
                                                    Upload Files
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <i class="fas fa-file-invoice fa-2x mb-2"></i>
                                                <h5>Generate Statements</h5>
                                                <p>Create property and tenant statements</p>
                                                <a th:href="@{/property-owner/statements}" class="btn btn-light btn-sm">
                                                    Generate Statements
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <i class="fas fa-sync fa-2x mb-2"></i>
                                                <h5>PayProp Sync</h5>
                                                <p>Sync documents with PayProp system</p>
                                                <button class="btn btn-light btn-sm" onclick="syncPayProp()">
                                                    Sync PayProp
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h5>Your Document Folders</h5>
                                    <div class="list-group">
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Property Documents</strong>
                                                    <br>
                                                    <small class="text-muted">EICR, EPC, Insurance, and property-specific files</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('property-documents')">Browse</button>
                                            </div>
                                        </div>
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Tenant Documents</strong>
                                                    <br>
                                                    <small class="text-muted">Tenant applications, references, and agreements</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('tenant-documents')">Browse</button>
                                            </div>
                                        </div>
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Financial Statements</strong>
                                                    <br>
                                                    <small class="text-muted">Generated statements and financial reports</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('financial-statements')">Browse</button>
                                            </div>
                                        </div>
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-folder text-warning me-2"></i>
                                                    <strong>Maintenance Records</strong>
                                                    <br>
                                                    <small class="text-muted">Maintenance requests, invoices, and work orders</small>
                                                </div>
                                                <button class="btn btn-outline-primary btn-sm" onclick="browseFolder('maintenance-records')">Browse</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- File Browser Modal -->
                                    <div class="modal fade" id="fileBrowserModal" tabindex="-1" aria-labelledby="fileBrowserModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="fileBrowserModalLabel">Browse Files</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div id="folderBreadcrumb" class="mb-3">
                                                        <nav aria-label="breadcrumb">
                                                            <ol class="breadcrumb">
                                                                <li class="breadcrumb-item"><a href="#" onclick="browseFolder(currentFolderType)">Home</a></li>
                                                                <li class="breadcrumb-item active" id="currentFolder" aria-current="page">Documents</li>
                                                            </ol>
                                                        </nav>
                                                    </div>

                                                    <div id="fileListContainer">
                                                        <div class="text-center">
                                                            <div class="spinner-border" role="status" aria-hidden="true"></div>
                                                            <p>Loading files...</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-success" onclick="uploadFiles()">
                                                        <i class="fas fa-upload"></i> Upload Files
                                                    </button>
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/app.js}"></script>
    
    <script>
        let currentFolderType = '';
        let currentFiles = [];
        let currentFolders = [];

        function browseFolder(folderType) {
            currentFolderType = folderType;
            console.log('Browsing folder:', folderType);

            // Update modal title
            document.getElementById('fileBrowserModalLabel').textContent = 'Browse ' + formatFolderName(folderType);
            document.getElementById('currentFolder').textContent = formatFolderName(folderType);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('fileBrowserModal'));
            modal.show();

            // Load files
            loadFiles(folderType);
        }

        function loadFiles(folderType) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <p>Loading files...</p>
                </div>
            `;

            fetch(`/property-owner/files/browse/${folderType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentFiles = data.files || [];
                        currentFolders = data.folders || [];
                        displayFiles(data);
                    } else {
                        showError(data.error || 'Failed to load files');
                    }
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    showError('Error loading files: ' + error.message);
                });
        }

        function displayFiles(data) {
            const container = document.getElementById('fileListContainer');

            let html = '';

            // Show folders first
            if (data.folders && data.folders.length > 0) {
                html += '<h6><i class="fas fa-folder text-warning"></i> Folders</h6>';
                html += '<div class="list-group mb-3">';
                data.folders.forEach(folder => {
                    html += `
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-folder text-warning me-2"></i>
                                <strong>${folder.name}</strong>
                                <div class="small text-muted">${folder.subfolders ? folder.subfolders.join(', ') : 'Property documents'}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="openPropertyFolder('${folder.id}', '${folder.name}')">
                                Open
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show files
            if (data.files && data.files.length > 0) {
                html += '<h6><i class="fas fa-file text-primary"></i> Files</h6>';
                html += '<div class="list-group">';
                data.files.forEach(file => {
                    const icon = getFileIcon(file.name);
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="${icon} me-2"></i>
                                <span>${file.name}</span>
                                <div class="small text-muted">${file.size} - Modified ${file.modified}</div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-success me-2" onclick="downloadFile('${file.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewFile('${file.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show empty state
            if ((!data.folders || data.folders.length === 0) && (!data.files || data.files.length === 0)) {
                html = `
                    <div class="text-center py-4">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <h5>No files found</h5>
                        <p class="text-muted">This folder is empty. Upload files to get started.</p>
                        <button class="btn btn-primary" onclick="uploadFiles()">
                            <i class="fas fa-upload"></i> Upload Files
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function openPropertyFolder(propertyId, propertyName) {
            // This would navigate into a specific property folder
            alert(`Opening ${propertyName} folder.\nThis would show EICR, EPC, Insurance, Statements, Tenancy, and Maintenance subfolders.`);
        }

        function downloadFile(fileId) {
            console.log('Downloading file:', fileId);

            fetch(`/property-owner/files/download/${fileId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Open direct download link
                        window.open(data.directDownloadUrl, '_blank');
                    } else {
                        alert('Error getting download URL: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error downloading file:', error);
                    alert('Error downloading file: ' + error.message);
                });
        }

        function viewFile(fileId) {
            console.log('Viewing file:', fileId);

            fetch(`/property-owner/files/view/${fileId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Open view link in new tab
                        window.open(data.viewUrl, '_blank');
                    } else {
                        alert('Error getting view URL: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error viewing file:', error);
                    alert('Error viewing file: ' + error.message);
                });
        }

        function uploadFiles() {
            // Create file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = '.pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt';

            fileInput.onchange = function(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }

                // Show uploading message
                const container = document.getElementById('fileListContainer');
                const originalContent = container.innerHTML;
                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                        <h5>Uploading ${files.length} file(s)...</h5>
                        <p class="text-muted">Please wait while your files are uploaded to Google Drive.</p>
                    </div>
                `;

                fetch(`/property-owner/files/upload/${currentFolderType}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Upload complete! ${data.uploadedCount} of ${data.totalCount} files uploaded successfully.`);
                        // Reload the file list
                        loadFiles(currentFolderType);
                    } else {
                        container.innerHTML = originalContent;
                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    container.innerHTML = originalContent;
                    console.error('Error uploading files:', error);
                    alert('Error uploading files: ' + error.message);
                });
            };

            // Trigger file selection
            fileInput.click();
        }

        function syncPayProp() {
            alert('PayProp sync functionality will be implemented here.\nThis will sync your documents with the PayProp property management system.');
        }

        function formatFolderName(folderType) {
            const names = {
                'property-documents': 'Property Documents',
                'tenant-documents': 'Tenant Documents',
                'financial-statements': 'Financial Statements',
                'maintenance-records': 'Maintenance Records'
            };
            return names[folderType] || folderType;
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            switch (ext) {
                case 'pdf': return 'fas fa-file-pdf text-danger';
                case 'doc':
                case 'docx': return 'fas fa-file-word text-primary';
                case 'xls':
                case 'xlsx': return 'fas fa-file-excel text-success';
                case 'jpg':
                case 'jpeg':
                case 'png': return 'fas fa-file-image text-info';
                default: return 'fas fa-file text-secondary';
            }
        }

        function showError(message) {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${message}
                </div>
            `;
        }

        // Initialize folder structure if needed
        document.addEventListener('DOMContentLoaded', function() {
            // Check if shared drive is available and initialize if needed
            if (typeof hasServiceAccount !== 'undefined' && hasServiceAccount) {
                console.log('Service account available for shared drive');
            }
        });
    </script>
</body>
</html>