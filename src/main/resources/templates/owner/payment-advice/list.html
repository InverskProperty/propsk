<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<link th:href="@{/css/style.min.css}" rel="stylesheet">

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>

    <div class="page-wrapper">
        <div class="container-fluid">
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-6 align-self-center">
                    <h4 class="text-themecolor">
                        <i class="fas fa-file-invoice-dollar text-primary"></i> Payment Advice
                    </h4>
                    <p class="text-muted">View detailed breakdowns of owner payments</p>
                </div>
                <div class="col-md-6 align-self-center text-right">
                    <a href="/owner-payments" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Owner Payments
                    </a>
                </div>
            </div>

            <!-- Messages -->
            <div th:if="${error}" class="row">
                <div class="col-12">
                    <div class="alert alert-danger alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                        <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}">Error</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Owner Selection Card -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="card-title text-white mb-0">
                                <i class="fas fa-user"></i> Select Owner
                            </h4>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/owner/payment-advice}" method="get">
                                <div class="form-group">
                                    <label>Property Owner</label>
                                    <select name="ownerId" class="form-control select2" onchange="this.form.submit()">
                                        <option value="">-- Select an Owner --</option>
                                        <option th:each="owner : ${owners}"
                                                th:value="${owner.customerId}"
                                                th:text="${owner.name}"
                                                th:selected="${selectedOwnerId != null and owner.customerId == selectedOwnerId}">
                                            Owner Name
                                        </option>
                                    </select>
                                </div>
                            </form>

                            <div th:if="${selectedOwner}" class="mt-3 p-3 bg-light rounded">
                                <h5 th:text="${selectedOwner.name}">Owner Name</h5>
                                <p class="mb-1" th:if="${selectedOwner.email}">
                                    <i class="fas fa-envelope text-muted"></i>
                                    <span th:text="${selectedOwner.email}">email@example.com</span>
                                </p>
                                <p class="mb-0" th:if="${selectedOwner.phone}">
                                    <i class="fas fa-phone text-muted"></i>
                                    <span th:text="${selectedOwner.phone}">+44 123 456</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Batches List -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h4 class="card-title text-white mb-0">
                                <i class="fas fa-list"></i> Payment History
                                <span th:if="${batches != null}" class="badge badge-light" th:text="${#lists.size(batches)}">0</span>
                            </h4>
                        </div>
                        <div class="card-body">
                            <div th:if="${selectedOwnerId == null}" class="text-center py-5">
                                <i class="fas fa-hand-pointer fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Select an owner to view their payment history</h5>
                            </div>

                            <div th:if="${selectedOwnerId != null and #lists.isEmpty(batches)}" class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No payment batches found for this owner</h5>
                            </div>

                            <div th:if="${selectedOwnerId != null and !#lists.isEmpty(batches)}" class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Payment Date</th>
                                            <th>Reference</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="batch : ${batches}" style="cursor: pointer;"
                                            th:onclick="'window.location.href=\'/owner/payment-advice/' + ${batch.batchId} + '\''">
                                            <td>
                                                <span th:text="${batch.paymentDate}">2025-01-01</span>
                                            </td>
                                            <td>
                                                <strong th:text="${batch.batchId}">BATCH-001</strong>
                                                <br>
                                                <small class="text-muted" th:if="${batch.paymentReference}"
                                                       th:text="${batch.paymentReference}">Ref</small>
                                            </td>
                                            <td class="font-weight-bold text-success"
                                                th:text="'£' + ${#numbers.formatDecimal(batch.totalPayment, 1, 2)}">
                                                £100.00
                                            </td>
                                            <td>
                                                <span th:if="${batch.status.name() == 'DRAFT'}" class="badge badge-secondary">Draft</span>
                                                <span th:if="${batch.status.name() == 'PENDING'}" class="badge badge-warning">Pending</span>
                                                <span th:if="${batch.status.name() == 'PAID'}" class="badge badge-success">Paid</span>
                                            </td>
                                            <td onclick="event.stopPropagation();">
                                                <div class="btn-group">
                                                    <a th:href="@{/owner/payment-advice/{id}(id=${batch.batchId})}"
                                                       class="btn btn-sm btn-primary" title="View Advice">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a th:href="@{/owner/payment-advice/{id}/pdf(id=${batch.batchId})}"
                                                       class="btn btn-sm btn-danger" title="Download PDF">
                                                        <i class="fas fa-file-pdf"></i>
                                                    </a>
                                                    <a th:href="@{/owner/payment-advice/{id}/excel(id=${batch.batchId})}"
                                                       class="btn btn-sm btn-success" title="Download Excel">
                                                        <i class="fas fa-file-excel"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div th:replace="~{general/footer.html}"></div>
</div>

<script th:src="@{/js/plugins.js}"></script>
<script th:src="@{/js/custom.js}"></script>
<script>
    $(document).ready(function() {
        $('.select2').select2({
            placeholder: 'Select an owner',
            allowClear: true
        });
    });
</script>
</body>
</html>
