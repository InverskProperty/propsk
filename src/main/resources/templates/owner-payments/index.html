<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/favicon.png}">
    <title>Owner Payments - CRM</title>

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.min.css}" rel="stylesheet">
    <link th:href="@{/css/all.css}" rel="stylesheet">

    <style>
        .mode-tabs { margin-bottom: 20px; }
        .mode-tabs .btn { border-radius: 0; }
        .mode-tabs .btn.active { background-color: #007bff; color: white; }

        .payment-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .payment-card:hover { background-color: #f8f9fa; }
        .payment-card.selected {
            border-color: #007bff;
            background-color: #e7f1ff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .payment-card.paid { border-left: 4px solid #28a745; }
        .payment-card.draft { border-left: 4px solid #ffc107; }

        .transaction-row {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .transaction-row:hover { background-color: #f8f9fa; }
        .transaction-row.selected { background-color: #e7f1ff; }

        .amount-positive { color: #28a745; font-weight: 600; }
        .amount-negative { color: #dc3545; font-weight: 600; }

        .summary-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        .summary-row.total {
            border-top: 2px solid #dee2e6;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 10px;
            padding-top: 10px;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        .panel-body {
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .property-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .property-filter .form-check {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 0;
        }

        .action-bar {
            background: #fff;
            border-top: 1px solid #dee2e6;
            padding: 15px;
            position: sticky;
            bottom: 0;
        }

        .reconciliation-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .reconciliation-section.balanced {
            background: #d4edda;
            border-color: #28a745;
        }

        .badge-partial {
            background-color: #6c757d;
            color: white;
            font-size: 0.75em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>

    <div class="page-wrapper">
        <div class="container-fluid">
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h3 class="text-themecolor">
                        <i class="fas fa-money-check-alt text-primary"></i>
                        Owner Payments
                    </h3>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                        <li class="breadcrumb-item active">Owner Payments</li>
                    </ol>
                </div>
                <div class="col-md-4 align-self-center text-right">
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Owner Selection -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label"><strong>Select Owner</strong></label>
                    <select id="ownerSelect" class="form-control" onchange="loadOwnerData()">
                        <option value="">-- Select Owner --</option>
                        <th:block th:each="owner : ${owners}">
                            <option th:value="${owner.customerId}" th:text="${owner.name}"></option>
                        </th:block>
                    </select>
                </div>
            </div>

            <!-- Mode Tabs -->
            <div class="mode-tabs btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="setMode('transactions')" id="modeTransactions">
                    <i class="fas fa-list"></i> Transactions First
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="setMode('payments')" id="modePayments">
                    <i class="fas fa-money-bill-wave"></i> Payment First
                </button>
            </div>

            <!-- Main Content Area -->
            <div id="contentArea" style="display: none;">
                <div class="row">
                    <!-- LEFT PANEL -->
                    <div class="col-md-6">
                        <div class="card">
                            <!-- TRANSACTIONS FIRST MODE: Unallocated Transactions -->
                            <div id="transactionsPanel">
                                <div class="panel-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-list"></i> Unallocated Transactions</span>
                                    <span id="transactionTotal" class="badge badge-primary">£0.00</span>
                                </div>

                                <!-- Property Filter -->
                                <div class="p-3 border-bottom">
                                    <div class="property-filter" id="propertyFilter">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="propAll" checked onchange="toggleAllProperties()">
                                            <label class="form-check-label" for="propAll">All</label>
                                        </div>
                                        <!-- Properties loaded dynamically -->
                                    </div>
                                </div>

                                <div class="panel-body" id="transactionsList">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <p>Select an owner to view transactions</p>
                                    </div>
                                </div>

                                <div class="action-bar">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <input type="checkbox" id="selectAllTransactions" onchange="toggleSelectAll()">
                                            <label for="selectAllTransactions">Select All</label>
                                        </div>
                                        <span id="selectedSummary">0 selected | £0.00</span>
                                    </div>
                                    <div class="btn-group w-100">
                                        <button class="btn btn-success" onclick="createNewPayment()" id="btnCreatePayment" disabled>
                                            <i class="fas fa-plus"></i> Create New Payment
                                        </button>
                                        <button class="btn btn-primary" onclick="showAddToExisting()" id="btnAddToExisting" disabled>
                                            <i class="fas fa-arrow-right"></i> Add to Existing
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- PAYMENT FIRST MODE: Payment List -->
                            <div id="paymentsPanel" style="display: none;">
                                <div class="panel-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-money-bill-wave"></i> Owner Payments</span>
                                    <button class="btn btn-sm btn-success" onclick="showCreatePaymentModal()">
                                        <i class="fas fa-plus"></i> New Payment
                                    </button>
                                </div>

                                <div class="panel-body" id="paymentsList">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <p>Select an owner to view payments</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT PANEL -->
                    <div class="col-md-6">
                        <div class="card">
                            <!-- TRANSACTIONS FIRST MODE: Target Payment -->
                            <div id="targetPaymentPanel">
                                <div class="panel-header">
                                    <i class="fas fa-bullseye"></i> Target Payment
                                </div>
                                <div class="panel-body" id="targetPaymentContent">
                                    <div class="empty-state">
                                        <i class="fas fa-hand-pointer"></i>
                                        <p>Select transactions and create/choose a payment</p>
                                    </div>
                                </div>
                            </div>

                            <!-- PAYMENT FIRST MODE: Payment Details + Transactions -->
                            <div id="paymentDetailsPanel" style="display: none;">
                                <div class="panel-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-file-invoice-dollar"></i> Payment Details</span>
                                    <span id="paymentRef" class="badge badge-secondary"></span>
                                </div>
                                <div class="panel-body" id="paymentDetailsContent">
                                    <div class="empty-state">
                                        <i class="fas fa-hand-pointer"></i>
                                        <p>Select a payment to view details</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Create Payment Modal -->
<div class="modal fade" id="createPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create Owner Payment</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Owner</label>
                    <input type="text" class="form-control" id="modalOwnerName" readonly>
                </div>
                <div class="form-group">
                    <label>Payment Reference</label>
                    <input type="text" class="form-control" id="modalPaymentRef" readonly>
                </div>
                <div class="form-group">
                    <label>Payment Amount (£)</label>
                    <input type="number" class="form-control" id="modalPaymentAmount" step="0.01" min="0">
                    <small class="text-muted">Leave blank to auto-calculate from transactions</small>
                </div>
                <div class="form-group">
                    <label>Payment Date</label>
                    <input type="date" class="form-control" id="modalPaymentDate">
                </div>
                <div class="form-group">
                    <label>Bank Reference (optional)</label>
                    <input type="text" class="form-control" id="modalBankRef" placeholder="e.g., BACS-12345">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmCreatePayment()">
                    <i class="fas fa-check"></i> Create Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add to Existing Payment Modal -->
<div class="modal fade" id="addToExistingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-arrow-right"></i> Add to Existing Payment</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Payment</label>
                    <select class="form-control" id="existingPaymentSelect">
                        <option value="">-- Select Payment --</option>
                    </select>
                </div>
                <div id="existingPaymentInfo" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Current Total:</strong> <span id="existingPaymentTotal">£0.00</span><br>
                        <strong>After Adding:</strong> <span id="existingPaymentNewTotal">£0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmAddToExisting()">
                    <i class="fas fa-plus"></i> Add Transactions
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Split Allocation Modal -->
<div class="modal fade" id="splitAllocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-divide"></i> Split Allocation</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-secondary">
                    <strong>Transaction:</strong> <span id="splitTxnDescription"></span><br>
                    <strong>Net to Owner:</strong> <span id="splitTxnAmount"></span><br>
                    <strong>Already Allocated:</strong> <span id="splitTxnAllocated"></span><br>
                    <strong>Remaining:</strong> <span id="splitTxnRemaining"></span>
                </div>
                <div class="form-group">
                    <label>Amount to Allocate (£)</label>
                    <input type="number" class="form-control" id="splitAmount" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>To Payment</label>
                    <select class="form-control" id="splitPaymentSelect">
                        <option value="">-- Select Payment --</option>
                    </select>
                </div>
                <div class="btn-group w-100 mb-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="setSplitAmount(0.5)">50%</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="setSplitAmount(0.25)">25%</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="setSplitAmount(1)">Remaining</button>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="splitToBalance">
                    <label class="form-check-label" for="splitToBalance">
                        Allocate to property balance instead
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmSplitAllocation()">
                    <i class="fas fa-check"></i> Allocate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Balance Allocation Modal -->
<div class="modal fade" id="balanceAllocationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-balance-scale"></i> Allocate to Property Balances</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Payment Amount:</strong> <span id="balPaymentAmount">£0.00</span><br>
                    <strong>Allocated from Transactions:</strong> <span id="balAllocatedAmount">£0.00</span><br>
                    <strong>Difference:</strong> <span id="balDifference">£0.00</span>
                </div>
                <p id="balExplanation"></p>
                <table class="table table-sm" id="balanceAllocationTable">
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Current Balance</th>
                            <th>Allocate</th>
                        </tr>
                    </thead>
                    <tbody id="balanceAllocationRows">
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="2">Total</th>
                            <th id="balTotalAllocated">£0.00</th>
                        </tr>
                    </tfoot>
                </table>
                <div class="btn-group mb-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="distributeBalanceEvenly()">Split Evenly</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="distributeByRent()">By Rent Proportion</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmBalanceAllocation()">
                    <i class="fas fa-check"></i> Apply to Balances
                </button>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/popper.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/library/waves.js}"></script>
<script th:src="@{/js/library/sidebarmenu.js}"></script>
<script th:src="@{/js/library/custom.min.js}"></script>

<script>
    // State
    let currentMode = 'transactions';
    let currentOwnerId = null;
    let currentOwnerName = '';
    let selectedTransactions = new Set();
    let selectedPayment = null;
    let unallocatedTransactions = [];
    let ownerPayments = [];
    let ownerProperties = [];
    let currentSplitTransaction = null;

    const API_BASE = '/api/transaction-allocations';

    // CSRF setup
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    function apiCall(url, method = 'GET', body = null) {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            }
        };
        if (body) options.body = JSON.stringify(body);
        return fetch(url, options).then(r => r.json());
    }

    // Mode switching
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('modeTransactions').classList.toggle('active', mode === 'transactions');
        document.getElementById('modePayments').classList.toggle('active', mode === 'payments');

        document.getElementById('transactionsPanel').style.display = mode === 'transactions' ? 'block' : 'none';
        document.getElementById('targetPaymentPanel').style.display = mode === 'transactions' ? 'block' : 'none';
        document.getElementById('paymentsPanel').style.display = mode === 'payments' ? 'block' : 'none';
        document.getElementById('paymentDetailsPanel').style.display = mode === 'payments' ? 'block' : 'none';

        if (currentOwnerId) loadOwnerData();
    }

    // Load owner data
    async function loadOwnerData() {
        const ownerId = document.getElementById('ownerSelect').value;
        if (!ownerId) {
            document.getElementById('contentArea').style.display = 'none';
            return;
        }

        currentOwnerId = ownerId;
        currentOwnerName = document.getElementById('ownerSelect').options[document.getElementById('ownerSelect').selectedIndex].text;
        document.getElementById('contentArea').style.display = 'block';

        // Load unallocated transactions
        const txnData = await apiCall(`${API_BASE}/unallocated/owner/${ownerId}`);
        unallocatedTransactions = txnData.transactions || [];

        // Extract unique properties
        ownerProperties = [...new Map(unallocatedTransactions
            .filter(t => t.propertyId)
            .map(t => [t.propertyId, { id: t.propertyId, name: t.propertyName }])
        ).values()];

        renderPropertyFilter();
        renderTransactionsList();

        // Load payments (mock for now - need to create endpoint)
        await loadPayments();

        updateSummary();
    }

    function renderPropertyFilter() {
        const container = document.getElementById('propertyFilter');
        container.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="propAll" checked onchange="toggleAllProperties()">
                <label class="form-check-label" for="propAll">All</label>
            </div>
        `;
        ownerProperties.forEach(prop => {
            container.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input property-checkbox" type="checkbox"
                           id="prop${prop.id}" value="${prop.id}" checked onchange="filterTransactions()">
                    <label class="form-check-label" for="prop${prop.id}">${prop.name}</label>
                </div>
            `;
        });
    }

    function toggleAllProperties() {
        const allChecked = document.getElementById('propAll').checked;
        document.querySelectorAll('.property-checkbox').forEach(cb => cb.checked = allChecked);
        filterTransactions();
    }

    function filterTransactions() {
        renderTransactionsList();
    }

    function getSelectedPropertyIds() {
        return Array.from(document.querySelectorAll('.property-checkbox:checked')).map(cb => parseInt(cb.value));
    }

    function renderTransactionsList() {
        const container = document.getElementById('transactionsList');
        const selectedProps = getSelectedPropertyIds();

        const filtered = unallocatedTransactions.filter(t =>
            !t.propertyId || selectedProps.includes(t.propertyId)
        );

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle text-success"></i>
                    <p>All transactions allocated!</p>
                </div>
            `;
            return;
        }

        let total = 0;
        container.innerHTML = filtered.map(txn => {
            total += parseFloat(txn.remainingUnallocated);
            const isPartial = txn.netToOwner !== txn.remainingUnallocated;
            const amountClass = txn.remainingUnallocated >= 0 ? 'amount-positive' : 'amount-negative';
            const selected = selectedTransactions.has(txn.transactionId);

            return `
                <div class="transaction-row ${selected ? 'selected' : ''}" data-id="${txn.transactionId}">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" class="mr-3 txn-checkbox" value="${txn.transactionId}"
                               ${selected ? 'checked' : ''} onchange="toggleTransaction(${txn.transactionId})">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <span>${txn.transactionDate} | ${txn.propertyName || 'No Property'}</span>
                                <span class="${amountClass}">£${Math.abs(txn.remainingUnallocated).toFixed(2)}</span>
                            </div>
                            <small class="text-muted">
                                ${txn.category || 'Unknown'} - ${txn.description || ''}
                                ${isPartial ? '<span class="badge badge-partial ml-2">Partial</span>' : ''}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary ml-2" onclick="showSplitModal(${txn.transactionId})" title="Split">
                            <i class="fas fa-divide"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('transactionTotal').textContent = `£${total.toFixed(2)}`;
    }

    function toggleTransaction(txnId) {
        if (selectedTransactions.has(txnId)) {
            selectedTransactions.delete(txnId);
        } else {
            selectedTransactions.add(txnId);
        }
        renderTransactionsList();
        updateSummary();
    }

    function toggleSelectAll() {
        const allChecked = document.getElementById('selectAllTransactions').checked;
        const selectedProps = getSelectedPropertyIds();
        const filtered = unallocatedTransactions.filter(t =>
            !t.propertyId || selectedProps.includes(t.propertyId)
        );

        selectedTransactions.clear();
        if (allChecked) {
            filtered.forEach(t => selectedTransactions.add(t.transactionId));
        }
        renderTransactionsList();
        updateSummary();
    }

    function updateSummary() {
        const selected = Array.from(selectedTransactions);
        const selectedTxns = unallocatedTransactions.filter(t => selected.includes(t.transactionId));
        const total = selectedTxns.reduce((sum, t) => sum + parseFloat(t.remainingUnallocated), 0);

        document.getElementById('selectedSummary').textContent =
            `${selected.length} selected | £${total.toFixed(2)}`;

        document.getElementById('btnCreatePayment').disabled = selected.length === 0;
        document.getElementById('btnAddToExisting').disabled = selected.length === 0;
    }

    // Payments
    async function loadPayments() {
        // For now, we'll need to fetch batch summaries
        // This needs a new endpoint - placeholder for now
        ownerPayments = [];
        renderPaymentsList();
    }

    function renderPaymentsList() {
        const container = document.getElementById('paymentsList');

        if (ownerPayments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No payments yet</p>
                </div>
            `;
            return;
        }

        container.innerHTML = ownerPayments.map(payment => `
            <div class="payment-card ${payment.status} ${selectedPayment === payment.batchReference ? 'selected' : ''}"
                 onclick="selectPayment('${payment.batchReference}')">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${payment.batchReference}</strong>
                        <div class="text-muted small">
                            ${payment.allocationCount} items | ${payment.created}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="amount-positive">£${payment.netTotal.toFixed(2)}</div>
                        <span class="badge badge-${payment.status === 'paid' ? 'success' : 'warning'}">
                            ${payment.status}
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function selectPayment(batchRef) {
        selectedPayment = batchRef;
        renderPaymentsList();

        // Load payment details
        const data = await apiCall(`${API_BASE}/batch/${batchRef}`);
        renderPaymentDetails(data);
    }

    function renderPaymentDetails(data) {
        const container = document.getElementById('paymentDetailsContent');
        document.getElementById('paymentRef').textContent = data.summary?.batchReference || '';

        if (!data.summary) {
            container.innerHTML = '<div class="empty-state"><p>Payment not found</p></div>';
            return;
        }

        const allocations = data.allocations || [];
        let html = `
            <div class="mb-3">
                <strong>Allocations:</strong>
            </div>
        `;

        if (allocations.length === 0) {
            html += '<p class="text-muted">No transactions allocated yet</p>';
        } else {
            html += allocations.map(a => `
                <div class="d-flex justify-content-between py-2 border-bottom">
                    <div>
                        <span class="text-muted">${a.propertyName || 'Unknown'}</span>
                    </div>
                    <div class="${a.allocatedAmount >= 0 ? 'amount-positive' : 'amount-negative'}">
                        £${Math.abs(a.allocatedAmount).toFixed(2)}
                        <button class="btn btn-sm btn-link text-danger p-0 ml-2" onclick="removeAllocation(${a.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        html += `
            <div class="summary-box">
                <div class="summary-row">
                    <span>Income:</span>
                    <span class="amount-positive">£${data.summary.totalIncome?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="summary-row">
                    <span>Expenses:</span>
                    <span class="amount-negative">£${Math.abs(data.summary.totalExpenses || 0).toFixed(2)}</span>
                </div>
                <div class="summary-row total">
                    <span>Net Total:</span>
                    <span>£${data.summary.netTotal?.toFixed(2) || '0.00'}</span>
                </div>
            </div>

            <div class="mt-3">
                <button class="btn btn-success btn-block" onclick="markPaymentPaid('${data.summary.batchReference}')">
                    <i class="fas fa-check"></i> Mark as Paid
                </button>
            </div>
        `;

        container.innerHTML = html;
    }

    // Modals
    async function showCreatePaymentModal() {
        document.getElementById('modalOwnerName').value = currentOwnerName;

        // Generate new reference
        const refData = await apiCall(`${API_BASE}/batch/generate-reference?prefix=OWNER`);
        document.getElementById('modalPaymentRef').value = refData.batchReference;

        // Set default date to today
        document.getElementById('modalPaymentDate').value = new Date().toISOString().split('T')[0];

        // Calculate total from selected transactions
        const selected = Array.from(selectedTransactions);
        const selectedTxns = unallocatedTransactions.filter(t => selected.includes(t.transactionId));
        const total = selectedTxns.reduce((sum, t) => sum + parseFloat(t.remainingUnallocated), 0);
        document.getElementById('modalPaymentAmount').value = total > 0 ? total.toFixed(2) : '';

        $('#createPaymentModal').modal('show');
    }

    async function confirmCreatePayment() {
        const batchRef = document.getElementById('modalPaymentRef').value;
        const selected = Array.from(selectedTransactions);

        if (selected.length === 0 && currentMode === 'transactions') {
            alert('Please select transactions to allocate');
            return;
        }

        // Allocate selected transactions to the new batch
        if (selected.length > 0) {
            await apiCall(`${API_BASE}/allocate/bulk`, 'POST', {
                transactionIds: selected,
                batchReference: batchRef
            });
        }

        selectedTransactions.clear();
        $('#createPaymentModal').modal('hide');

        // Reload data
        await loadOwnerData();

        // In payment-first mode, select the new payment
        if (currentMode === 'payments') {
            await selectPayment(batchRef);
        }
    }

    function createNewPayment() {
        showCreatePaymentModal();
    }

    async function showAddToExisting() {
        // Populate existing payments dropdown
        const select = document.getElementById('existingPaymentSelect');
        select.innerHTML = '<option value="">-- Select Payment --</option>';
        ownerPayments.filter(p => p.status !== 'paid').forEach(p => {
            select.innerHTML += `<option value="${p.batchReference}">${p.batchReference} (£${p.netTotal.toFixed(2)})</option>`;
        });

        $('#addToExistingModal').modal('show');
    }

    async function confirmAddToExisting() {
        const batchRef = document.getElementById('existingPaymentSelect').value;
        if (!batchRef) {
            alert('Please select a payment');
            return;
        }

        const selected = Array.from(selectedTransactions);
        await apiCall(`${API_BASE}/allocate/bulk`, 'POST', {
            transactionIds: selected,
            batchReference: batchRef
        });

        selectedTransactions.clear();
        $('#addToExistingModal').modal('hide');
        await loadOwnerData();
    }

    // Split allocation
    function showSplitModal(txnId) {
        currentSplitTransaction = unallocatedTransactions.find(t => t.transactionId === txnId);
        if (!currentSplitTransaction) return;

        document.getElementById('splitTxnDescription').textContent =
            `${currentSplitTransaction.category} - ${currentSplitTransaction.propertyName}`;
        document.getElementById('splitTxnAmount').textContent = `£${currentSplitTransaction.netToOwner}`;
        document.getElementById('splitTxnAllocated').textContent =
            `£${(currentSplitTransaction.netToOwner - currentSplitTransaction.remainingUnallocated).toFixed(2)}`;
        document.getElementById('splitTxnRemaining').textContent = `£${currentSplitTransaction.remainingUnallocated}`;
        document.getElementById('splitAmount').value = currentSplitTransaction.remainingUnallocated;
        document.getElementById('splitAmount').max = Math.abs(currentSplitTransaction.remainingUnallocated);

        // Populate payment select
        const select = document.getElementById('splitPaymentSelect');
        select.innerHTML = '<option value="">-- Select Payment --</option>';
        ownerPayments.forEach(p => {
            select.innerHTML += `<option value="${p.batchReference}">${p.batchReference}</option>`;
        });

        $('#splitAllocationModal').modal('show');
    }

    function setSplitAmount(fraction) {
        if (!currentSplitTransaction) return;
        const amount = Math.abs(currentSplitTransaction.remainingUnallocated) * fraction;
        document.getElementById('splitAmount').value = amount.toFixed(2);
    }

    async function confirmSplitAllocation() {
        if (!currentSplitTransaction) return;

        const amount = parseFloat(document.getElementById('splitAmount').value);
        const batchRef = document.getElementById('splitPaymentSelect').value;
        const toBalance = document.getElementById('splitToBalance').checked;

        if (toBalance) {
            // TODO: Implement balance allocation
            alert('Balance allocation coming soon');
            return;
        }

        if (!batchRef) {
            alert('Please select a payment');
            return;
        }

        // Determine sign based on original transaction
        const signedAmount = currentSplitTransaction.remainingUnallocated >= 0 ? amount : -amount;

        await apiCall(`${API_BASE}/allocate/partial`, 'POST', {
            transactionId: currentSplitTransaction.transactionId,
            batchReference: batchRef,
            amount: signedAmount
        });

        $('#splitAllocationModal').modal('hide');
        await loadOwnerData();
    }

    // Utility
    function refreshData() {
        if (currentOwnerId) {
            loadOwnerData();
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Set default date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('modalPaymentDate').value = today;
    });
</script>

</body>
</html>
