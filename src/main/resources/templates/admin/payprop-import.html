<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>PayProp Historical Data Import</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 0.375rem;
            padding: 2rem;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .upload-area.drag-over {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .preview-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .import-card {
            transition: transform 0.2s ease;
        }
        .import-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-upload"></i>
                        PayProp Historical Data Import
                    </h1>
                    <div>
                        <a href="/admin/payprop-import/download-template" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download"></i> Download Template
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-check-circle-fill"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${warnings}" class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Warnings:</strong>
            <ul class="mb-0 mt-2">
                <li th:each="warning : ${warnings}" th:text="${warning}"></li>
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${errors}" class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Errors:</strong>
            <ul class="mb-0 mt-2">
                <li th:each="error : ${errors}" th:text="${error}"></li>
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Import Options -->
        <div class="row mt-4">
            <!-- Spreadsheet Import -->
            <div class="col-lg-6 mb-4">
                <div class="card import-card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-file-earmark-spreadsheet text-success"></i>
                            Import from Spreadsheet
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">
                            Upload your property management spreadsheet (Robert Ellis/Propsk format).
                            The system will automatically convert it to PayProp-compatible format.
                        </p>

                        <form id="spreadsheet-form" action="/admin/payprop-import/upload-spreadsheet" method="post" enctype="multipart/form-data">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <!-- Period Input -->
                            <div class="mb-3">
                                <label for="period" class="form-label">Statement Period</label>
                                <input type="text" class="form-control" id="period" name="period"
                                       placeholder="e.g., 22nd May 2025 to 21st Jun 2025" required>
                                <div class="form-text">Enter the exact period as shown on your statement</div>
                            </div>

                            <!-- File Upload -->
                            <div class="mb-3">
                                <label for="spreadsheet-file" class="form-label">Spreadsheet File</label>
                                <div class="upload-area" id="spreadsheet-upload-area">
                                    <i class="bi bi-cloud-upload fs-1 text-muted mb-2"></i>
                                    <p class="mb-2">Drop your spreadsheet here or <strong>click to browse</strong></p>
                                    <p class="text-muted small">Supports CSV, Excel (.xlsx, .xls)</p>
                                    <input type="file" class="form-control" id="spreadsheet-file" name="file"
                                           accept=".csv,.xlsx,.xls" style="display: none;" required>
                                </div>
                                <div id="spreadsheet-file-info" class="mt-2" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-file-earmark text-primary me-2"></i>
                                        <span id="spreadsheet-file-name"></span>
                                        <span class="badge bg-secondary ms-2" id="spreadsheet-file-size"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Preview -->
                            <div id="spreadsheet-preview" class="mb-3" style="display: none;">
                                <label class="form-label">File Preview</label>
                                <div id="spreadsheet-preview-content" class="preview-box"></div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success" id="import-spreadsheet-btn" disabled>
                                    <i class="bi bi-upload"></i> Import Data
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="convert-csv-btn" disabled>
                                    <i class="bi bi-file-text"></i> Convert to CSV
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="download-csv-btn" disabled>
                                    <i class="bi bi-download"></i> Download CSV
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- CSV Import -->
            <div class="col-lg-6 mb-4">
                <div class="card import-card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-file-text text-primary"></i>
                            Import PayProp CSV
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">
                            Upload a PayProp-compatible CSV file. Use this if you've already converted
                            your data or have data in the correct format.
                        </p>

                        <form id="csv-form" action="/admin/payprop-import/upload-csv" method="post" enctype="multipart/form-data">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <!-- File Upload -->
                            <div class="mb-3">
                                <label for="csv-file" class="form-label">CSV File</label>
                                <div class="upload-area" id="csv-upload-area">
                                    <i class="bi bi-file-text fs-1 text-muted mb-2"></i>
                                    <p class="mb-2">Drop your CSV file here or <strong>click to browse</strong></p>
                                    <p class="text-muted small">Must be PayProp-compatible format</p>
                                    <input type="file" class="form-control" id="csv-file" name="file"
                                           accept=".csv" style="display: none;" required>
                                </div>
                                <div id="csv-file-info" class="mt-2" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-file-text text-primary me-2"></i>
                                        <span id="csv-file-name"></span>
                                        <span class="badge bg-secondary ms-2" id="csv-file-size"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Preview -->
                            <div id="csv-preview" class="mb-3" style="display: none;">
                                <label class="form-label">File Preview</label>
                                <div id="csv-preview-content" class="preview-box"></div>
                            </div>

                            <!-- Format Info -->
                            <div class="alert alert-info">
                                <h6 class="alert-heading">Required CSV Format:</h6>
                                <small>
                                    <code>transaction_date,amount,description,transaction_type,category,property_reference,customer_reference,bank_reference,payment_method,notes</code>
                                </small>
                            </div>

                            <!-- Action Button -->
                            <button type="submit" class="btn btn-primary" id="import-csv-btn" disabled>
                                <i class="bi bi-upload"></i> Import CSV
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Guidelines -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle"></i>
                            Import Guidelines
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Spreadsheet Import</h6>
                                <ul class="small">
                                    <li>Supports Robert Ellis and Propsk statement formats</li>
                                    <li>Automatically extracts rent payments, commissions, and expenses</li>
                                    <li>Handles multiple payment sources (Robert Ellis, Propsk, PayProp)</li>
                                    <li>Period information is required for accurate date mapping</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>CSV Import</h6>
                                <ul class="small">
                                    <li>Must follow PayProp-compatible format exactly</li>
                                    <li>Each rent payment must have a corresponding commission entry</li>
                                    <li>Property references must match existing properties</li>
                                    <li>Dates must be in YYYY-MM-DD format</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-3">
                            <h6>Commission Structure</h6>
                            <p class="small text-muted mb-0">
                                The system expects 15% total commission (10% management + 5% service fee) as per your current structure.
                                Commission entries should be negative amounts on the same date as the corresponding rent payment.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Download Modal -->
    <div class="modal fade" id="csvDownloadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-text"></i>
                        Converted CSV Data
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Your spreadsheet has been converted to PayProp format:</p>
                    <div class="mb-3">
                        <label class="form-label">CSV Data Preview</label>
                        <textarea id="csv-data-preview" class="form-control" rows="10" readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="download-csv-btn">
                        <i class="bi bi-download"></i> Download CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // File upload handling
        function setupFileUpload(uploadAreaId, fileInputId, fileInfoId, previewId, importBtnId, convertBtnId = null) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            const fileInfo = document.getElementById(fileInfoId);
            const preview = document.getElementById(previewId);
            const importBtn = document.getElementById(importBtnId);
            const convertBtn = convertBtnId ? document.getElementById(convertBtnId) : null;

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect(files[0], fileInfo, preview, importBtn, convertBtn);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0], fileInfo, preview, importBtn, convertBtn);
                }
            });
        }

        function handleFileSelect(file, fileInfo, preview, importBtn, convertBtn) {
            // Show file info
            const fileName = fileInfo.querySelector('[id$="-file-name"]');
            const fileSize = fileInfo.querySelector('[id$="-file-size"]');

            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';

            // Enable buttons
            importBtn.disabled = false;
            if (convertBtn) convertBtn.disabled = false;

            // Enable download button for spreadsheets
            const downloadBtn = document.getElementById('download-csv-btn');
            if (downloadBtn && file.name.toLowerCase().match(/\.(xlsx|xls|csv)$/)) {
                downloadBtn.disabled = false;
            }

            // Load preview
            loadFilePreview(file, preview);
        }

        function loadFilePreview(file, previewContainer) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n').slice(0, 5); // First 5 lines
                const previewContent = lines.join('\n');

                const previewDiv = previewContainer.querySelector('[id$="-preview-content"]');
                previewDiv.textContent = previewContent;
                previewContainer.style.display = 'block';
            };
            reader.readAsText(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize file uploads
        setupFileUpload('spreadsheet-upload-area', 'spreadsheet-file', 'spreadsheet-file-info',
                       'spreadsheet-preview', 'import-spreadsheet-btn', 'convert-csv-btn');

        setupFileUpload('csv-upload-area', 'csv-file', 'csv-file-info',
                       'csv-preview', 'import-csv-btn');

        // Direct download functionality (following your existing patterns)
        document.getElementById('download-csv-btn').addEventListener('click', function() {
            const form = document.getElementById('spreadsheet-form');
            const formData = new FormData(form);

            // Validate inputs
            const period = document.getElementById('period').value.trim();
            const file = document.getElementById('spreadsheet-file').files[0];

            if (!period || !file) {
                alert('Please select a file and enter the period before downloading');
                return;
            }

            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Downloading...';

            // Create a hidden form for file download (your existing pattern)
            const downloadForm = document.createElement('form');
            downloadForm.method = 'POST';
            downloadForm.action = '/admin/payprop-import/download-converted-csv';
            downloadForm.style.display = 'none';

            // Add form data
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.name = 'file';
            fileInput.files = document.getElementById('spreadsheet-file').files;

            const periodInput = document.createElement('input');
            periodInput.type = 'hidden';
            periodInput.name = 'period';
            periodInput.value = period;

            downloadForm.appendChild(fileInput);
            downloadForm.appendChild(periodInput);
            document.body.appendChild(downloadForm);

            // Submit and cleanup
            downloadForm.submit();
            document.body.removeChild(downloadForm);

            // Reset button state
            setTimeout(() => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-download"></i> Download CSV';
            }, 2000);
        });

        // Convert to CSV functionality
        document.getElementById('convert-csv-btn').addEventListener('click', function() {
            const form = document.getElementById('spreadsheet-form');
            const formData = new FormData(form);

            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Converting...';

            fetch('/admin/payprop-import/convert-to-csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show modal with CSV data
                    document.getElementById('csv-data-preview').value = data.csvData;

                    // Set up download
                    const downloadBtn = document.getElementById('download-csv-btn');
                    downloadBtn.onclick = () => downloadCsv(data.csvData, data.filename);

                    const modal = new bootstrap.Modal(document.getElementById('csvDownloadModal'));
                    modal.show();
                } else {
                    alert('Conversion failed: ' + data.error);
                }
            })
            .catch(error => {
                alert('Conversion failed: ' + error.message);
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-file-text"></i> Convert to CSV';
            });
        });

        function downloadCsv(csvData, filename) {
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename || 'payprop_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Form validation
        document.getElementById('spreadsheet-form').addEventListener('submit', function(e) {
            const period = document.getElementById('period').value.trim();
            const file = document.getElementById('spreadsheet-file').files[0];

            if (!period) {
                e.preventDefault();
                alert('Please enter the statement period');
                return;
            }

            if (!file) {
                e.preventDefault();
                alert('Please select a spreadsheet file');
                return;
            }
        });

        document.getElementById('csv-form').addEventListener('submit', function(e) {
            const file = document.getElementById('csv-file').files[0];

            if (!file) {
                e.preventDefault();
                alert('Please select a CSV file');
                return;
            }
        });
    </script>
</body>
</html>