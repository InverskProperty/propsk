<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<link th:href="@{/css/dataTables.bootstrap4.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

<style>
    .detail-card {
        margin-bottom: 20px;
    }
    .detail-label {
        font-weight: 600;
        color: #666;
        margin-bottom: 5px;
    }
    .detail-value {
        font-size: 1.1rem;
        color: #333;
    }
    .property-card {
        transition: transform 0.2s;
        cursor: pointer;
    }
    .property-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .owner-mode-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
</style>

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>

    <div class="page-wrapper" style="margin-left: 0;">
        <div class="container-fluid">
            <!-- Owner Mode Banner -->
            <div class="owner-mode-banner" th:if="${customer}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-user-shield"></i>
                        <strong>Owner Portal</strong> -
                        <span th:text="${customer.name}">Owner Name</span>
                        <span class="badge badge-light ml-2" th:text="${isOwner ? 'Property Owner' : 'Delegated User'}">Type</span>
                    </div>
                    <div>
                        <a href="/customer-login/blocks" class="btn btn-sm btn-light mr-2">
                            <i class="fas fa-arrow-left"></i> Back to Blocks
                        </a>
                        <a href="/property-owner/dashboard" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Block Header -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h3 class="text-themecolor">
                        <i class="fas fa-building text-primary"></i>
                        <span th:text="${block.name}">Block Name</span>
                    </h3>
                    <p class="text-muted">
                        <span class="badge badge-info" th:text="${block.blockType}">Type</span>
                        <span class="ml-2" th:if="${block.isActive == 'Y'}">
                            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Active</span>
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-right">
                    <a th:if="${isOwner}" th:href="@{/customer-login/blocks/{id}/edit(id=${block.id})}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> Edit Block
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Block Details -->
                <div class="col-lg-4">
                    <div class="card detail-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Block Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="detail-label">Name</div>
                                <div class="detail-value" th:text="${block.name}">Block Name</div>
                            </div>

                            <div class="mb-3" th:if="${block.description}">
                                <div class="detail-label">Description</div>
                                <div class="detail-value" th:text="${block.description}">Description</div>
                            </div>

                            <div class="mb-3">
                                <div class="detail-label">Block Type</div>
                                <div class="detail-value">
                                    <span class="badge badge-info" th:text="${block.blockType}">Type</span>
                                </div>
                            </div>

                            <div class="mb-3" th:if="${block.maxProperties}">
                                <div class="detail-label">Capacity</div>
                                <div class="detail-value">
                                    <span th:text="${propertyCount}">0</span> / <span th:text="${block.maxProperties}">0</span> properties
                                    <div class="progress mt-2">
                                        <div class="progress-bar" role="progressbar"
                                             th:style="${'width: ' + (propertyCount * 100 / block.maxProperties) + '%'}"
                                             th:classappend="${(propertyCount * 100 / block.maxProperties) > 80 ? 'bg-warning' : 'bg-success'}">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3" th:unless="${block.maxProperties}">
                                <div class="detail-label">Capacity</div>
                                <div class="detail-value">
                                    <span th:text="${propertyCount}">0</span> properties
                                    <span class="text-muted">(Unlimited)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card detail-card" th:if="${block.addressLine1}">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Address</h5>
                        </div>
                        <div class="card-body">
                            <div th:text="${block.addressLine1}">Address Line 1</div>
                            <div th:if="${block.addressLine2}" th:text="${block.addressLine2}">Address Line 2</div>
                            <div>
                                <span th:if="${block.city}" th:text="${block.city}">City</span>
                                <span th:if="${block.county}" th:text="${', ' + block.county}">County</span>
                            </div>
                            <div th:if="${block.postcode}" th:text="${block.postcode}">Postcode</div>
                        </div>
                    </div>
                </div>

                <!-- Properties in Block -->
                <div class="col-lg-8">
                    <!-- Date Range Filter -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="form-row align-items-center">
                                        <div class="col-auto">
                                            <label class="mb-0 mr-2"><small>Date Range:</small></label>
                                        </div>
                                        <div class="col-auto">
                                            <input type="date" class="form-control form-control-sm" id="startDate">
                                        </div>
                                        <div class="col-auto">
                                            <span class="mx-1">to</span>
                                        </div>
                                        <div class="col-auto">
                                            <input type="date" class="form-control form-control-sm" id="endDate">
                                        </div>
                                        <div class="col-auto">
                                            <button class="btn btn-sm btn-primary" onclick="refreshAllData()">
                                                <i class="fas fa-sync"></i> Refresh
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-right">
                                    <small class="text-muted">Default: Last 12 Months</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabbed Financial Analytics Card -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line"></i> Financial Analytics
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Nav tabs -->
                            <ul class="nav nav-tabs" id="financialTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="summary-tab" data-toggle="tab" href="#summary" role="tab">
                                        <i class="fas fa-chart-bar"></i> Summary
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="analytics-tab" data-toggle="tab" href="#analytics" role="tab" onclick="loadAnalyticsTab()">
                                        <i class="fas fa-chart-pie"></i> Detailed Analytics
                                    </a>
                                </li>
                            </ul>

                            <!-- Tab panes -->
                            <div class="tab-content p-3">
                                <!-- Summary Tab -->
                                <div class="tab-pane fade show active" id="summary" role="tabpanel">
                                    <div id="financialSummaryContainer">
                                        <div class="text-center py-3">
                                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                            <p class="text-muted mt-2">Loading financial data...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analytics Tab -->
                                <div class="tab-pane fade" id="analytics" role="tabpanel">
                                    <div id="analyticsContainer">
                                        <div class="text-center py-3">
                                            <i class="fas fa-info-circle fa-2x text-muted"></i>
                                            <p class="text-muted mt-2">Click to load detailed analytics</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Properties List Card -->
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-home"></i> Properties in Block
                                <span class="badge badge-light ml-2" th:text="${propertyCount}">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="propertiesContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{general/footer.html}"></div>

<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/popper.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/library/waves.js}"></script>
<script th:src="@{/js/library/sidebarmenu.js}"></script>
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/custom.min.js}"></script>

<script th:inline="javascript">
const blockId = /*[[${block.id}]]*/ 0;
const csrfToken = /*[[${_csrf.token}]]*/ '';
const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

// Chart instances
let monthlyTrendsChart = null;
let expenseBreakdownChart = null;
let analyticsLoaded = false;

$(document).ready(function() {
    // Set default date range to last 12 months
    const today = new Date();
    const twelveMonthsAgo = new Date();
    twelveMonthsAgo.setMonth(today.getMonth() - 12);

    $('#endDate').val(today.toISOString().split('T')[0]);
    $('#startDate').val(twelveMonthsAgo.toISOString().split('T')[0]);

    loadBlockProperties();
    loadBlockFinancials();
});

function loadBlockProperties() {
    fetch(`/customer-login/blocks/api/${blockId}/properties`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayProperties(data.properties);
            } else {
                $('#propertiesContainer').html(`
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load properties: ${data.error || 'Unknown error'}
                    </div>
                `);
            }
        })
        .catch(error => {
            console.error('Error loading properties:', error);
            $('#propertiesContainer').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i>
                    Error loading properties
                </div>
            `);
        });
}

function displayProperties(properties) {
    const container = $('#propertiesContainer');

    if (properties.length === 0) {
        container.html(`
            <div class="text-center py-4">
                <i class="fas fa-home fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No properties in this block</h5>
                <p class="text-muted">Properties can be assigned to this block from the Assignment Centre</p>
            </div>
        `);
        return;
    }

    let html = '<div class="row">';
    properties.forEach(property => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card property-card" onclick="viewProperty(${property.id})">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-home text-primary"></i>
                            ${property.propertyName}
                        </h6>
                        <p class="card-text text-muted small mb-2">
                            ${[property.addressLine1, property.city, property.postcode].filter(x => x).join(', ')}
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge badge-${getStatusColor(property.status)}">${property.status || 'Vacant'}</span>
                            <span class="badge badge-secondary">${property.propertyType || 'Property'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    container.html(html);
}

function getStatusColor(status) {
    if (!status) return 'secondary';

    const statusUpper = status.toUpperCase();
    const colors = {
        'ACTIVE': 'success',
        'OCCUPIED': 'success',
        'ACTIVE LEASE': 'success',
        'VACANT': 'warning',
        'AVAILABLE': 'primary',
        'ADVERTISING': 'primary',
        'OFFER ACCEPTED': 'info',
        'REFERENCING': 'info',
        'IN CONTRACTS': 'info',
        'CONTRACTS COMPLETE': 'success',
        'MAINTENANCE': 'warning',
        'INACTIVE': 'secondary',
        'CANCELLED': 'danger'
    };
    return colors[statusUpper] || 'secondary';
}

function viewProperty(propertyId) {
    window.location.href = `/property-owner/property/${propertyId}`;
}

function loadBlockFinancials() {
    fetch(`/customer-login/blocks/api/${blockId}/financial`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFinancialSummary(data);
            } else {
                $('#financialSummaryContainer').html(`
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load financial data: ${data.error || 'Unknown error'}
                    </div>
                `);
            }
        })
        .catch(error => {
            console.error('Error loading financials:', error);
            $('#financialSummaryContainer').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i>
                    Error loading financial data
                </div>
            `);
        });
}

function displayFinancialSummary(data) {
    // API returns data with propertySummaries array
    const properties = data.propertySummaries || [];
    // Extract totals from nested totals object
    const totals = data.totals || {};

    let html = `
        <div class="row mb-3">
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Total Rent Due</h6>
                    <h4 class="text-primary mb-0">£${formatCurrency(totals.totalRentDue || 0)}</h4>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Total Received</h6>
                    <h4 class="text-success mb-0">£${formatCurrency(totals.totalRent || 0)}</h4>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Arrears</h6>
                    <h4 class="text-${(totals.totalArrears || 0) > 0 ? 'danger' : 'success'} mb-0">
                        £${formatCurrency(totals.totalArrears || 0)}
                    </h4>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Net Owner Income</h6>
                    <h4 class="text-info mb-0">£${formatCurrency(totals.netToOwner || 0)}</h4>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-2">
                <div class="text-center p-2 bg-light rounded">
                    <small class="text-muted">Total Expenses</small>
                    <h5 class="text-warning mb-0">£${formatCurrency(totals.totalExpenses || 0)}</h5>
                </div>
            </div>
            <div class="col-md-6 mb-2">
                <div class="text-center p-2 bg-light rounded">
                    <small class="text-muted">Total Commissions</small>
                    <h5 class="text-secondary mb-0">£${formatCurrency(totals.totalCommission || 0)}</h5>
                </div>
            </div>
        </div>
    `;

    // Add property breakdown if available
    if (properties.length > 0) {
        html += `
            <hr class="my-3">
            <h6 class="text-muted mb-2">
                <i class="fas fa-chart-bar"></i> Per-Property Breakdown
                <small class="text-muted">(${properties.length} properties)</small>
            </h6>
            <div class="table-responsive">
                <table class="table table-sm table-hover table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Property</th>
                            <th class="text-right">Rent Due</th>
                            <th class="text-right">Rent Received</th>
                            <th class="text-right">Expenses</th>
                            <th class="text-right">Commission</th>
                            <th class="text-right">Net to Owner</th>
                            <th class="text-right">Arrears</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        properties.forEach(prop => {
            const arrearsAmount = prop.arrears || 0;
            const arrearsClass = arrearsAmount > 0 ? 'text-danger' : 'text-success';

            html += `
                <tr onclick="viewProperty(${prop.propertyId})" style="cursor: pointer;">
                    <td>${prop.propertyName}</td>
                    <td class="text-right text-info">£${formatCurrency(prop.rentDue || 0)}</td>
                    <td class="text-right">£${formatCurrency(prop.totalRent || 0)}</td>
                    <td class="text-right">£${formatCurrency(prop.totalExpenses || 0)}</td>
                    <td class="text-right">£${formatCurrency(prop.totalCommission || 0)}</td>
                    <td class="text-right font-weight-bold">£${formatCurrency(prop.netToOwner || 0)}</td>
                    <td class="text-right ${arrearsClass}">£${formatCurrency(arrearsAmount)}</td>
                </tr>
            `;
        });

        // Add totals row
        const totals = data.totals || {};
        const totalArrearsAmount = totals.totalArrears || 0;
        const totalArrearsClass = totalArrearsAmount > 0 ? 'text-danger' : 'text-success';

        html += `
                    </tbody>
                    <tfoot class="bg-light">
                        <tr class="font-weight-bold" style="font-size: 1.1em;">
                            <td><strong>TOTAL</strong></td>
                            <td class="text-right text-info"><strong>£${formatCurrency(totals.totalRentDue || 0)}</strong></td>
                            <td class="text-right text-primary"><strong>£${formatCurrency(totals.totalRent || 0)}</strong></td>
                            <td class="text-right text-danger"><strong>£${formatCurrency(totals.totalExpenses || 0)}</strong></td>
                            <td class="text-right text-warning"><strong>£${formatCurrency(totals.totalCommission || 0)}</strong></td>
                            <td class="text-right text-success"><strong>£${formatCurrency(totals.netToOwner || 0)}</strong></td>
                            <td class="text-right ${totalArrearsClass}"><strong>£${formatCurrency(totalArrearsAmount)}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
    }

    $('#financialSummaryContainer').html(html);
}

function formatCurrency(value) {
    if (!value) return '0.00';
    return parseFloat(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// ==== NEW ANALYTICS FUNCTIONS ====

function refreshAllData() {
    loadBlockFinancials();
    if (analyticsLoaded) {
        loadAnalyticsTab();
    }
}

function loadAnalyticsTab() {
    if (analyticsLoaded) {
        return; // Already loaded, don't reload
    }

    const container = $('#analyticsContainer');
    container.html(`
        <div class="text-center py-3">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="text-muted mt-2">Loading analytics data...</p>
        </div>
    `);

    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();

    // Load all analytics data in parallel
    Promise.all([
        fetch(`/customer-login/blocks/api/${blockId}/occupancy?startDate=${startDate}&endDate=${endDate}`).then(r => r.json()),
        fetch(`/customer-login/blocks/api/${blockId}/roi`).then(r => r.json()),
        fetch(`/customer-login/blocks/api/${blockId}/chart-data?startDate=${startDate}&endDate=${endDate}`).then(r => r.json())
    ])
    .then(([occupancyData, roiData, chartData]) => {
        displayAnalytics(occupancyData, roiData, chartData);
        analyticsLoaded = true;
    })
    .catch(error => {
        console.error('Error loading analytics:', error);
        container.html(`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Error loading analytics data. Please try again.
            </div>
        `);
    });
}

function displayAnalytics(occupancyData, roiData, chartData) {
    let html = `
        <!-- Occupancy Table -->
        <div class="mb-4">
            <h5 class="text-primary">
                <i class="fas fa-calendar-check"></i> Occupancy Analysis (Last 12 Months)
            </h5>
            <div class="table-responsive">
                <table class="table table-sm table-hover table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Property</th>
                            <th>Current Status</th>
                            <th class="text-right">Occupancy %</th>
                            <th class="text-right">Occupied Days</th>
                            <th class="text-right">Vacant Days</th>
                            <th class="text-right">Lost Income</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    if (occupancyData.success && occupancyData.occupancyData) {
        occupancyData.occupancyData.forEach(prop => {
            const occupancyPct = prop.occupancyPercentage || 0;
            let occupancyColor = 'success';
            if (occupancyPct < 70) occupancyColor = 'danger';
            else if (occupancyPct < 90) occupancyColor = 'warning';

            const statusBadge = prop.currentStatus === 'Occupied' ?
                '<span class="badge badge-success">Occupied</span>' :
                '<span class="badge badge-warning">Vacant</span>';

            html += `
                <tr>
                    <td>${prop.propertyName}</td>
                    <td>${statusBadge}</td>
                    <td class="text-right">
                        <span class="badge badge-${occupancyColor}">${occupancyPct.toFixed(1)}%</span>
                    </td>
                    <td class="text-right">${prop.occupiedDays}</td>
                    <td class="text-right">${prop.vacantDays}</td>
                    <td class="text-right text-danger">£${formatCurrency(prop.lostIncome)}</td>
                </tr>
            `;
        });
    }

    html += `
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Monthly Trends Chart -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-line"></i> Monthly Performance Trends</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="monthlyTrendsChart" height="80"></canvas>
                    </div>
                </div>
            </div>

            <!-- Expense Breakdown Chart -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Expense Breakdown</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="expenseBreakdownChart" height="160"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROI Summary Table -->
        <div class="mb-4">
            <h5 class="text-success">
                <i class="fas fa-piggy-bank"></i> Return on Investment (ROI) Summary
            </h5>
            <div class="table-responsive">
                <table class="table table-sm table-hover table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Property</th>
                            <th class="text-right">Purchase Price</th>
                            <th class="text-right">Current Value</th>
                            <th class="text-right">Capital Gain %</th>
                            <th class="text-right">Rental Yield %</th>
                            <th class="text-right">Total ROI %</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    if (roiData.success && roiData.roiData) {
        roiData.roiData.forEach(prop => {
            if (!prop.hasValuationData) {
                html += `
                    <tr class="text-muted">
                        <td>${prop.propertyName}</td>
                        <td colspan="5" class="text-center"><em>Valuation data not available</em></td>
                    </tr>
                `;
            } else {
                const totalROI = prop.totalROI || 0;
                const roiColor = totalROI > 0 ? 'text-success' : 'text-danger';

                html += `
                    <tr>
                        <td>${prop.propertyName}</td>
                        <td class="text-right">£${formatCurrency(prop.purchasePrice)}</td>
                        <td class="text-right">£${formatCurrency(prop.currentValue)}</td>
                        <td class="text-right ${prop.capitalGain > 0 ? 'text-success' : 'text-danger'}">
                            ${prop.capitalGain.toFixed(2)}%
                        </td>
                        <td class="text-right text-info">${prop.rentalYield.toFixed(2)}%</td>
                        <td class="text-right font-weight-bold ${roiColor}">
                            ${totalROI.toFixed(2)}%
                        </td>
                    </tr>
                `;
            }
        });
    }

    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;

    $('#analyticsContainer').html(html);

    // Initialize charts after DOM is ready
    setTimeout(() => {
        initializeMonthlyTrendsChart(chartData);
        initializeExpenseBreakdownChart(chartData);
    }, 100);
}

function initializeMonthlyTrendsChart(chartData) {
    const ctx = document.getElementById('monthlyTrendsChart');
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (monthlyTrendsChart) {
        monthlyTrendsChart.destroy();
    }

    const monthlyTrends = chartData.monthlyTrends || [];

    // Extract labels and data
    const labels = monthlyTrends.map(m => m.month || m.yearMonth);
    const incomeData = monthlyTrends.map(m => m.income || m.totalIncome || 0);
    const expensesData = monthlyTrends.map(m => m.expenses || m.totalExpenses || 0);
    const commissionData = monthlyTrends.map(m => m.commission || m.totalCommission || 0);
    const netData = monthlyTrends.map(m => m.netToOwner || m.netIncome || 0);

    monthlyTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Income',
                    data: incomeData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Expenses',
                    data: expensesData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Commission',
                    data: commissionData,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Net to Owner',
                    data: netData,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    borderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '£' + context.parsed.y.toFixed(2);
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '£' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function initializeExpenseBreakdownChart(chartData) {
    const ctx = document.getElementById('expenseBreakdownChart');
    if (!ctx) return;

    // Destroy existing chart if it exists
    if (expenseBreakdownChart) {
        expenseBreakdownChart.destroy();
    }

    const expensesByCategory = chartData.expensesByCategory || {};
    const labels = Object.keys(expensesByCategory);
    const data = Object.values(expensesByCategory);

    if (labels.length === 0) {
        $(ctx).parent().html('<p class="text-muted text-center py-4">No expense data available</p>');
        return;
    }

    const backgroundColors = [
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(199, 199, 199, 0.8)',
        'rgba(83, 102, 255, 0.8)',
        'rgba(255, 102, 146, 0.8)',
        'rgba(102, 255, 178, 0.8)'
    ];

    expenseBreakdownChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '£' + context.parsed.toFixed(2);
                            return label;
                        }
                    }
                }
            }
        }
    });
}
</script>

</body>
</html>
