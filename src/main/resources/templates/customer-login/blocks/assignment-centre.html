<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<link th:href="@{/css/style.min.css}" rel="stylesheet">

<style>
    .owner-mode-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .block-item {
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s;
    }
    .block-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.2);
    }
    .property-badge {
        cursor: pointer;
        margin: 5px;
        padding: 8px 12px;
        display: inline-block;
    }
    .unassigned-property {
        border: 1px dashed #ccc;
        padding: 10px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
    }
    .unassigned-property:hover {
        background-color: #f0f0f0;
        border-color: #007bff;
    }
</style>

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>

    <div class="page-wrapper" style="margin-left: 0;">
        <div class="container-fluid">
            <!-- Owner Mode Banner -->
            <div class="owner-mode-banner" th:if="${customer}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-user-shield"></i>
                        <strong>Owner Portal</strong> -
                        <span th:text="${customer.name}">Owner Name</span>
                        <span class="badge badge-light ml-2" th:text="${isOwner ? 'Property Owner' : 'Delegated User'}">Type</span>
                    </div>
                    <div>
                        <a href="/customer-login/blocks" class="btn btn-sm btn-light mr-2">
                            <i class="fas fa-arrow-left"></i> Back to Blocks
                        </a>
                        <a href="/property-owner/dashboard" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Page Header -->
            <div class="row page-titles">
                <div class="col-md-12">
                    <h3 class="text-themecolor">
                        <i class="fas fa-exchange-alt text-primary"></i>
                        Assignment Centre
                    </h3>
                    <p class="text-muted">View block assignments and property allocations</p>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="messageArea"></div>

            <!-- Assignment Overview -->
            <div class="row">
                <!-- Blocks Section -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-building"></i> Blocks & Properties
                                <span class="badge badge-light ml-2" id="totalBlocksCount">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="blocksContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- Unassigned Properties Section -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-home"></i> Unassigned Properties
                                <span class="badge badge-light ml-2" id="unassignedCount">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Properties not assigned to any block</p>
                            <div id="unassignedContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{general/footer.html}"></div>

<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/popper.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/library/waves.js}"></script>
<script th:src="@{/js/library/sidebarmenu.js}"></script>
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/custom.min.js}"></script>

<script th:inline="javascript">
const csrfToken = /*[[${_csrf.token}]]*/ '';
const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
const isOwner = /*[[${isOwner}]]*/ false;

$(document).ready(function() {
    loadAssignmentOverview();
});

function loadAssignmentOverview() {
    fetch('/customer-login/blocks/api/assignment-overview')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBlocks(data.blocks);
                displayUnassignedProperties(data.unassignedProperties);
                updateCounts(data.totalBlocks, data.totalUnassigned);
            } else {
                showMessage('error', 'Failed to load assignment overview: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading assignment overview:', error);
            showMessage('error', 'Error loading assignment overview');
        });
}

function displayBlocks(blocks) {
    const container = $('#blocksContainer');

    if (blocks.length === 0) {
        container.html(`
            <div class="text-center py-4">
                <i class="fas fa-building fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No blocks available</h5>
            </div>
        `);
        return;
    }

    let html = '';
    blocks.forEach(block => {
        html += `
            <div class="block-item">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-building text-primary"></i>
                            ${block.name}
                        </h5>
                        <small class="text-muted">
                            ${block.propertyCount || 0} properties
                            ${block.maxProperties ? ` / ${block.maxProperties} max` : ''}
                        </small>
                    </div>
                    <a href="/customer-login/blocks/${block.id}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> View
                    </a>
                </div>
                <div class="mt-2">
                    <div id="block-${block.id}-properties" class="d-flex flex-wrap">
                        <span class="text-muted small">Loading properties...</span>
                    </div>
                </div>
            </div>
        `;
    });

    container.html(html);

    // Load properties for each block
    blocks.forEach(block => {
        loadBlockProperties(block.id);
    });
}

function loadBlockProperties(blockId) {
    fetch(`/customer-login/blocks/api/${blockId}/properties`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBlockProperties(blockId, data.properties);
            }
        })
        .catch(error => {
            console.error(`Error loading properties for block ${blockId}:`, error);
        });
}

function displayBlockProperties(blockId, properties) {
    const container = $(`#block-${blockId}-properties`);

    if (properties.length === 0) {
        container.html('<span class="text-muted small">No properties assigned</span>');
        return;
    }

    let html = '';
    properties.forEach(property => {
        html += `
            <span class="badge badge-info property-badge" onclick="viewProperty(${property.id})" title="${property.propertyName}">
                <i class="fas fa-home"></i> ${property.propertyName.substring(0, 20)}${property.propertyName.length > 20 ? '...' : ''}
            </span>
        `;
    });

    container.html(html);
}

function displayUnassignedProperties(properties) {
    const container = $('#unassignedContainer');

    if (properties.length === 0) {
        container.html(`
            <div class="text-center py-3">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <p class="text-muted small">All properties are assigned</p>
            </div>
        `);
        return;
    }

    let html = '';
    properties.forEach(property => {
        html += `
            <div class="unassigned-property" onclick="viewProperty(${property.id})">
                <div>
                    <strong>${property.propertyName}</strong>
                </div>
                <small class="text-muted">${[property.addressLine1, property.city].filter(x => x).join(', ') || 'N/A'}</small>
            </div>
        `;
    });

    container.html(html);
}

function updateCounts(totalBlocks, totalUnassigned) {
    $('#totalBlocksCount').text(totalBlocks);
    $('#unassignedCount').text(totalUnassigned);
}

function viewProperty(propertyId) {
    window.location.href = `/property-owner/properties/${propertyId}`;
}

function showMessage(type, message) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';

    const icon = {
        'success': 'fa-check',
        'error': 'fa-exclamation-triangle',
        'warning': 'fa-exclamation',
        'info': 'fa-info-circle'
    }[type] || 'fa-info-circle';

    const html = `
        <div class="alert ${alertClass} alert-dismissible fade show">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <h4><i class="icon fa ${icon}"></i> ${type.charAt(0).toUpperCase() + type.slice(1)}!</h4>
            ${message}
        </div>
    `;

    $('#messageArea').html(html);

    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>

</body>
</html>
