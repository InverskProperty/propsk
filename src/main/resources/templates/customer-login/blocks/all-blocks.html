<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<!-- DataTables CSS -->
<link th:href="@{/css/dataTables.bootstrap4.css}" rel="stylesheet">
<link th:href="@{/css/responsive.dataTables.min.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

<style>
    .block-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        height: 100%;
    }
    .block-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .block-type-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .property-count-badge {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .sync-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .sync-synced { background-color: #28a745; }
    .sync-pending { background-color: #ffc107; }
    .sync-failed { background-color: #dc3545; }
    .block-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .owner-mode-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
</style>

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>

    <div class="page-wrapper" style="margin-left: 0;">
        <div class="container-fluid">
            <!-- Owner Mode Banner -->
            <div class="owner-mode-banner" th:if="${customer}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-user-shield"></i>
                        <strong>Owner Portal</strong> -
                        <span th:text="${customer.name}">Owner Name</span>
                        <span class="badge badge-light ml-2" th:text="${isOwner ? 'Property Owner' : 'Delegated User'}">Type</span>
                    </div>
                    <a href="/property-owner/dashboard" class="btn btn-sm btn-light">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h3 class="text-themecolor">
                        <i class="fas fa-building text-primary"></i>
                        My Blocks
                    </h3>
                    <p class="text-muted">
                        <span th:if="${isOwner}">Manage your property blocks, service charges, and block-level operations</span>
                        <span th:unless="${isOwner}">View blocks for properties you have access to</span>
                    </p>
                </div>
                <div class="col-md-4 text-right">
                    <div class="btn-group">
                        <a th:href="@{/customer-login/blocks/assignment-centre}" class="btn btn-info">
                            <i class="fas fa-exchange-alt"></i> Assignment Centre
                        </a>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <div class="dropdown-menu dropdown-menu-right">
                                <a class="dropdown-item" href="#" onclick="filterBlocks('all')">
                                    <i class="fas fa-list"></i> All Blocks
                                </a>
                                <a class="dropdown-item" href="#" onclick="filterBlocks('active')">
                                    <i class="fas fa-check-circle"></i> Active Only
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#" onclick="toggleView('grid')">
                                    <i class="fas fa-th"></i> Grid View
                                </a>
                                <a class="dropdown-item" href="#" onclick="toggleView('table')">
                                    <i class="fas fa-table"></i> Table View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="messageArea"></div>

            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="totalBlocks">0</h4>
                                    <small>Total Blocks</small>
                                </div>
                                <div>
                                    <i class="fas fa-building fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="activeBlocks">0</h4>
                                    <small>Active Blocks</small>
                                </div>
                                <div>
                                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="totalProperties">0</h4>
                                    <small>Properties in Blocks</small>
                                </div>
                                <div>
                                    <i class="fas fa-home fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="accessibleProperties">0</h4>
                                    <small>Accessible Properties</small>
                                </div>
                                <div>
                                    <i class="fas fa-key fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blocks Grid View -->
            <div id="blocksGridView" class="block-grid"></div>

            <!-- Blocks Table View (hidden by default) -->
            <div id="blocksTableView" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <table id="blocksTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Address</th>
                                    <th>Properties</th>
                                    <th>Portfolio</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="blocksTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div th:replace="~{general/footer.html}"></div>

<!-- Scripts -->
<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/popper.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/library/waves.js}"></script>
<script th:src="@{/js/library/sidebarmenu.js}"></script>
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/custom.min.js}"></script>
<script th:src="@{/js/library/jquery.dataTables.min.js}"></script>
<script th:src="@{/js/library/dataTables.responsive.min.js}"></script>

<script th:inline="javascript">
let allBlocks = [];
let currentView = 'grid';
let currentFilter = 'all';
const csrfToken = /*[[${_csrf.token}]]*/ '';
const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
const isOwner = /*[[${isOwner}]]*/ false;

$(document).ready(function() {
    loadAllBlocks();
});

function loadAllBlocks() {
    fetch('/customer-login/blocks/api/all')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allBlocks = data.blocks;
                updateStatistics();
                displayBlocks();
            } else {
                showMessage('error', 'Failed to load blocks: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading blocks:', error);
            showMessage('error', 'Error loading blocks');
        });
}

function updateStatistics() {
    const total = allBlocks.length;
    const active = allBlocks.filter(b => b.isActive === 'Y').length;
    const totalProps = allBlocks.reduce((sum, b) => sum + (b.propertyCount || 0), 0);

    document.getElementById('totalBlocks').textContent = total;
    document.getElementById('activeBlocks').textContent = active;
    document.getElementById('totalProperties').textContent = totalProps;
    document.getElementById('accessibleProperties').textContent = totalProps;
}

function displayBlocks() {
    const filtered = filterBlocksArray(allBlocks);

    if (currentView === 'grid') {
        displayBlocksGrid(filtered);
    } else {
        displayBlocksTable(filtered);
    }
}

function filterBlocksArray(blocks) {
    switch(currentFilter) {
        case 'active':
            return blocks.filter(b => b.isActive === 'Y');
        default:
            return blocks;
    }
}

function displayBlocksGrid(blocks) {
    const container = document.getElementById('blocksGridView');
    container.innerHTML = '';

    if (blocks.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-building fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No blocks found</h4>
                <p class="text-muted">${isOwner ? 'Contact your property manager to set up blocks for your properties' : 'No blocks available for your assigned properties'}</p>
            </div>
        `;
        return;
    }

    blocks.forEach(block => {
        const card = createBlockCard(block);
        container.innerHTML += card;
    });
}

function createBlockCard(block) {
    const address = [block.addressLine1, block.city, block.postcode].filter(x => x).join(', ') || 'No address';

    const editButton = isOwner ? `
        <button class="btn btn-sm btn-outline-primary" onclick="editBlock(${block.id}); event.stopPropagation();" title="Edit Block">
            <i class="fas fa-edit"></i>
        </button>
    ` : '';

    return `
        <div class="card block-card" onclick="viewBlockDetails(${block.id})">
            <span class="badge badge-info block-type-badge">${block.blockType || 'BUILDING'}</span>
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-building text-primary"></i>
                    ${block.name}
                </h5>
                <p class="card-text text-muted small mb-2">${address}</p>
                ${block.portfolioName ? `<p class="card-text text-info small mb-3"><i class="fas fa-folder"></i> ${block.portfolioName}</p>` : ''}

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="property-count-badge text-info">${block.propertyCount || 0}</span>
                        <small class="text-muted">Properties</small>
                    </div>
                    <div>
                        ${block.maxProperties ? `<small class="text-muted">Max: ${block.maxProperties}</small>` : '<small class="text-muted">Unlimited</small>'}
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">${block.isActive === 'Y' ? '<span class="text-success"><i class="fas fa-check-circle"></i> Active</span>' : '<span class="text-secondary">Inactive</span>'}</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-sm btn-outline-info" onclick="viewBlockDetails(${block.id}); event.stopPropagation();" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${editButton}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayBlocksTable(blocks) {
    $('#blocksTableView').show();
    $('#blocksGridView').hide();

    const tbody = document.getElementById('blocksTableBody');
    tbody.innerHTML = '';

    blocks.forEach(block => {
        const row = tbody.insertRow();

        const editButton = isOwner ? `<button class="btn btn-warning btn-sm" onclick="editBlock(${block.id})" title="Edit"><i class="fas fa-edit"></i></button>` : '';

        row.innerHTML = `
            <td><strong>${block.name}</strong></td>
            <td><span class="badge badge-info">${block.blockType || 'BUILDING'}</span></td>
            <td>${[block.addressLine1, block.city].filter(x => x).join(', ') || 'N/A'}</td>
            <td><span class="badge badge-primary">${block.propertyCount || 0}</span></td>
            <td>${block.portfolioName || 'N/A'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-info" onclick="viewBlockDetails(${block.id})" title="View"><i class="fas fa-eye"></i></button>
                    ${editButton}
                </div>
            </td>
        `;
    });

    if ($.fn.DataTable.isDataTable('#blocksTable')) {
        $('#blocksTable').DataTable().destroy();
    }
    $('#blocksTable').DataTable({
        responsive: true,
        order: [[0, 'asc']]
    });
}

function viewBlockDetails(blockId) {
    window.location.href = `/customer-login/blocks/${blockId}`;
}

function editBlock(blockId) {
    if (!isOwner) {
        showMessage('warning', 'Only property owners can edit blocks');
        return;
    }
    window.location.href = `/customer-login/blocks/${blockId}/edit`;
}

function filterBlocks(filter) {
    currentFilter = filter;
    displayBlocks();
}

function toggleView(view) {
    currentView = view;
    if (view === 'grid') {
        $('#blocksTableView').hide();
        $('#blocksGridView').show();
    }
    displayBlocks();
}

function showMessage(type, message) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';

    const icon = {
        'success': 'fa-check',
        'error': 'fa-exclamation-triangle',
        'warning': 'fa-exclamation',
        'info': 'fa-info-circle'
    }[type] || 'fa-info-circle';

    const html = `
        <div class="alert ${alertClass} alert-dismissible fade show">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <h4><i class="icon fa ${icon}"></i> ${type.charAt(0).toUpperCase() + type.slice(1)}!</h4>
            ${message}
        </div>
    `;

    document.getElementById('messageArea').innerHTML = html;

    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>

</body>
</html>
