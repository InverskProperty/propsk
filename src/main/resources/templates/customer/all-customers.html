<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" content="${_csrf.token}"/>
<meta name="_csrf_header" content="${_csrf.headerName}"/>

<!-- Editable CSS -->
<link rel="stylesheet" type="text/css"
      th:href="@{/css/dataTables.bootstrap4.css}">
<link rel="stylesheet" type="text/css"
      th:href="@{/css/responsive.dataTables.min.css}">
<link th:href="@{/css/login-register-lock.css}" rel="stylesheet">
<link th:href="@{/css/jquery.toast.css}" rel="stylesheet">
<!-- Custom CSS -->
<link th:href="@{/css/style.min.css}" rel="stylesheet">
<!-- page css -->
<link th:href="@{/css/pages/inbox.css}" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body class="skin-blue fixed-layout">
<!-- ============================================================== -->
<!-- Preloader - style you can find in spinners.css -->
<!-- ============================================================== -->
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>
<!-- ============================================================== -->
<!-- Main wrapper - style you can find in pages.scss -->
<!-- ============================================================== -->
<div id="main-wrapper">
    <!-- ============================================================== -->
    <!-- Topbar header - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div th:replace="~{general/header.html}"></div>
    <!-- ============================================================== -->
    <!-- End Topbar header -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Left Sidebar - style you can find in sidebar.scss  -->
    <!-- ============================================================== -->
    <div th:replace="~{general/left-sidebar.html}"></div>
    <!-- ============================================================== -->
    <!-- End Left Sidebar - style you can find in sidebar.scss  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- Page wrapper  -->
    <!-- ============================================================== -->
    <div class="page-wrapper">
        <!-- ============================================================== -->
        <!-- Container fluid  -->
        <!-- ============================================================== -->
        <div class="container-fluid">
            <!-- ============================================================== -->
            <!-- Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <div th:insert="~{general/page-titles.html}"></div>
            <!-- ============================================================== -->
            <!-- End Bread crumb and right sidebar toggle -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Start Page Content -->
            <!-- ============================================================== -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <div th:if="${bindingResult != null && bindingResult.hasFieldErrors('failedErrorMessage')}" class="alert alert-danger">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button>
                                <h3 class="text-info"><i class="fa fa-exclamation-circle"></i> Not Allowed
                                </h3><span th:text="${bindingResult.getFieldError('failedErrorMessage').defaultMessage}"></span>
                            </div>
                            <h4 class="card-title">Customers</h4>
                            <div class="table-responsive m-t-40">
                                <table id="config-table" class="table display table-bordered table-striped no-wrap">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Customer Type</th>
                                            <th>Manages Owner</th>
                                            <th>Country</th>
                                            <th>Show Full Details</th>
                                            <th th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}">Edit Role</th>
                                            <th th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}">Reset Password</th>
                                            <th th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}">Delete</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:if="${customers != null}" th:each="customer : ${customers}">
                                            <td th:text="${customer.customerId}"></td>
                                            <td th:text="${customer.name}"></td>
                                            <td th:text="${customer.email}"></td>
                                            <td th:text="${customer.phone}"></td>
                                            <td>
                                                <span th:if="${customer.customerType != null}"
                                                      th:text="${customer.customerType.displayName}"
                                                      th:class="${'badge badge-' + (customer.customerType.name() == 'PROPERTY_OWNER' ? 'success' : customer.customerType.name() == 'TENANT' ? 'info' : customer.customerType.name() == 'DELEGATED_USER' ? 'warning' : customer.customerType.name() == 'MANAGER' ? 'warning' : 'secondary')}">
                                                </span>
                                                <span th:if="${customer.customerType == null}" class="badge badge-secondary">Unknown</span>
                                            </td>
                                            <td>
                                                <span th:if="${customer.managesOwner != null}" th:text="${customer.managesOwner.name}"></span>
                                                <span th:if="${customer.managesOwner == null}">-</span>
                                            </td>
                                            <td th:text="${customer.country}"></td>
                                            <td><a th:href="${home + 'employee/customer/' + customer.customerId}"><i class="fas fa-eye"></i></a></td>
                                            <td th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}">
                                                <button type="button" class="btn btn-sm btn-info"
                                                        onclick="openEditRoleModal(this)"
                                                        th:attr="data-customer-id=${customer.customerId},
                                                                data-customer-name=${customer.name},
                                                                data-customer-type=${customer.customerType != null ? customer.customerType.name() : 'REGULAR_CUSTOMER'},
                                                                data-manages-owner-id=${customer.managesOwnerId}">
                                                    <i class="fas fa-user-edit"></i> Edit Role
                                                </button>
                                            </td>
                                            <td th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}">
                                                <button type="button" class="btn btn-sm btn-warning"
                                                        onclick="resetCustomerPassword(this)"
                                                        th:attr="data-customer-id=${customer.customerId},
                                                                data-customer-name=${customer.name},
                                                                data-customer-email=${customer.email}">
                                                    <i class="fas fa-key"></i> Reset
                                                </button>
                                            </td>
                                            <td th:if="${#authorization.expression('hasRole(''ROLE_MANAGER'')')}">
                                                <form th:action="${home + 'employee/customer/delete-customer/' + customer.customerId}" method="post">
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        <i class="mdi mdi-delete"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ============================================================== -->
            <!-- End Page Content -->
            <!-- ============================================================== -->
            <!-- ============================================================== -->
            <!-- Right sidebar -->
            <!-- ============================================================== -->
            <!-- .right-sidebar -->
            <div th:insert="~{general/right-sidebar.html}"></div>
            <!-- ============================================================== -->
            <!-- End Right sidebar -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Container fluid  -->
        <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- End Page wrapper  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- footer -->
    <!-- ============================================================== -->
    <div th:replace="~{general/footer.html}"></div>
    <!-- ============================================================== -->
    <!-- End footer -->
    <!-- ============================================================== -->
</div>
<!-- ============================================================== -->
<!-- End Wrapper -->
<!-- ============================================================== -->
<!-- ============================================================== -->
<!-- All Jquery -->
<!-- ============================================================== -->
<script th:inline="javascript">
    var home = /*[[${home}]]*/ null;
</script>
<script th:src="@{/js/library/jquery-3.2.1.min.js}" type="text/javascript">></script>
<!--    &lt;!&ndash; Bootstrap tether Core JavaScript &ndash;&gt;-->
<script th:src="@{/js/library/popper.min.js}" type="text/javascript">></script>
<script th:src="@{/js/library/bootstrap.min.js}" type="text/javascript">></script>
<!--    &lt;!&ndash; slimscrollbar scrollbar JavaScript &ndash;&gt;-->
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}" type="text/javascript">></script>
<!--Wave Effects -->
<script th:src="@{/js/library/waves.js}" type="text/javascript">></script>
<!--Menu sidebar -->
<script th:src="@{/js/library/sidebarmenu.js}" type="text/javascript">></script>
<!--stickey kit -->
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/jquery.sparkline.min.js}" type="text/javascript">></script>
<!--Custom JavaScript -->

<script th:src="@{/js/library/custom.min.js}" type="text/javascript">></script>
<script th:src="@{/js/library/jquery.toast.js}"></script>
<script th:src="@{/js/library/toastr.js}"></script>
<!-- Editable -->
<script th:src="@{/js/library/jquery.dataTables.min.js}"></script>
<script th:src="@{/js/library/dataTables.responsive.min.js}"></script>
<script>
    $('#config-table').DataTable({
        responsive: true
    });
</script>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" role="dialog" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoleModalLabel">Edit Customer Role</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editRoleForm">
                <div class="modal-body">
                    <input type="hidden" id="editCustomerId" name="customerId">

                    <div class="form-group">
                        <label for="editCustomerName">Customer Name</label>
                        <input type="text" class="form-control" id="editCustomerName" readonly>
                    </div>

                    <div class="form-group">
                        <label for="editCustomerType">Customer Type <span class="text-danger">*</span></label>
                        <select class="form-control" id="editCustomerType" name="customerType" required>
                            <option value="">Select Customer Type</option>
                            <option value="REGULAR_CUSTOMER">Regular Customer</option>
                            <option value="TENANT">Tenant</option>
                            <option value="PROPERTY_OWNER">Property Owner</option>
                            <option value="CONTRACTOR">Contractor</option>
                            <option value="DELEGATED_USER">Delegated User (Manager for Property Owner)</option>
                            <option value="MANAGER">Manager</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>

                    <div class="form-group" id="editOwnerAssignmentSection" style="display: none;">
                        <label for="editManagesOwnerId">Manages Property Owner <span class="text-danger">*</span></label>
                        <select class="form-control" id="editManagesOwnerId" name="managesOwnerId">
                            <option value="">Select Property Owner</option>
                            <option th:each="owner : ${customers}"
                                    th:if="${owner.customerType != null && owner.customerType.name() == 'PROPERTY_OWNER'}"
                                    th:value="${owner.customerId}"
                                    th:text="${owner.name + ' (' + owner.email + ')'}">
                            </option>
                        </select>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <i class="fa fa-exclamation-triangle"></i> <strong>Note:</strong> Changing a customer's role will affect their access permissions immediately.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Open edit role modal and populate with customer data
    function openEditRoleModal(button) {
        const customerId = $(button).data('customer-id');
        const customerName = $(button).data('customer-name');
        const customerType = $(button).data('customer-type');
        const managesOwnerId = $(button).data('manages-owner-id');

        console.log('üîç Opening edit modal for:', {customerId, customerName, customerType, managesOwnerId});

        // Populate modal fields
        $('#editCustomerId').val(customerId);
        $('#editCustomerName').val(customerName);
        $('#editCustomerType').val(customerType);
        $('#editManagesOwnerId').val(managesOwnerId || '');

        // Show/hide owner assignment section
        updateOwnerAssignmentSection();

        // Show modal
        $('#editRoleModal').modal('show');
    }

    // Update owner assignment section visibility based on selected customer type
    function updateOwnerAssignmentSection() {
        const customerType = $('#editCustomerType').val();

        if (customerType === 'DELEGATED_USER' || customerType === 'MANAGER') {
            $('#editOwnerAssignmentSection').show();
            $('#editManagesOwnerId').attr('required', true);
        } else {
            $('#editOwnerAssignmentSection').hide();
            $('#editManagesOwnerId').attr('required', false);
            $('#editManagesOwnerId').val('');
        }
    }

    // Handle customer type change
    $('#editCustomerType').on('change', function() {
        updateOwnerAssignmentSection();
    });

    // Handle form submission
    $('#editRoleForm').on('submit', function(e) {
        e.preventDefault();

        const customerId = $('#editCustomerId').val();
        const customerType = $('#editCustomerType').val();
        const managesOwnerId = $('#editManagesOwnerId').val();

        console.log('üíæ Submitting role update:', {customerId, customerType, managesOwnerId});

        // Validate required fields
        if (!customerType) {
            alert('‚ùå Please select a customer type');
            return;
        }

        if ((customerType === 'DELEGATED_USER' || customerType === 'MANAGER') && !managesOwnerId) {
            alert('‚ùå Please select a property owner for this delegated user/manager');
            return;
        }

        // Get CSRF token
        const token = $('meta[name="_csrf"]').attr('content');
        const header = $('meta[name="_csrf_header"]').attr('content');

        // Submit via AJAX
        $.ajax({
            url: home + 'employee/customer/' + customerId + '/update-role',
            type: 'POST',
            data: {
                customerType: customerType,
                managesOwnerId: managesOwnerId || null
            },
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                console.log('‚úÖ Role updated successfully');
                $('#editRoleModal').modal('hide');

                // Show success message
                $.toast({
                    heading: 'Success',
                    text: 'Customer role updated successfully!',
                    position: 'top-right',
                    loaderBg: '#ff6849',
                    icon: 'success',
                    hideAfter: 3000
                });

                // Reload page to show updated data
                setTimeout(function() {
                    location.reload();
                }, 1000);
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Error updating role:', error);

                let errorMessage = 'Failed to update customer role';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    errorMessage = xhr.responseText;
                }

                $.toast({
                    heading: 'Error',
                    text: errorMessage,
                    position: 'top-right',
                    loaderBg: '#ff6849',
                    icon: 'error',
                    hideAfter: 5000
                });
            }
        });
    });

    // Reset customer password to default (123)
    function resetCustomerPassword(button) {
        const customerId = $(button).data('customer-id');
        const customerName = $(button).data('customer-name');
        const customerEmail = $(button).data('customer-email');

        // Confirm action
        if (!confirm(`Are you sure you want to reset the password for ${customerName} (${customerEmail})?\n\nThe password will be reset to: 123\n\nThe customer should change this password after logging in.`)) {
            return;
        }

        console.log('üîÑ Resetting password for customer:', customerId);

        // Get CSRF token
        const token = $('meta[name="_csrf"]').attr('content');
        const header = $('meta[name="_csrf_header"]').attr('content');

        // Submit via AJAX
        $.ajax({
            url: home + 'employee/customer/' + customerId + '/reset-password',
            type: 'POST',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                console.log('‚úÖ Password reset successfully:', response);

                // Show success message with the password
                $.toast({
                    heading: 'Password Reset Successful',
                    text: `Password for ${customerEmail} has been reset to: 123\n\nPlease share this with the customer securely.`,
                    position: 'top-right',
                    loaderBg: '#28a745',
                    icon: 'success',
                    hideAfter: 8000
                });

                // Also show an alert with the password so they can copy it
                alert(`‚úÖ Password Reset Successful\n\nEmail: ${customerEmail}\nNew Password: 123\n\nPlease share this password with the customer securely.\nThey should change it after their first login.`);
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Error resetting password:', error);

                let errorMessage = 'Failed to reset password';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.responseText) {
                    errorMessage = xhr.responseText;
                }

                $.toast({
                    heading: 'Error',
                    text: errorMessage,
                    position: 'top-right',
                    loaderBg: '#ff6849',
                    icon: 'error',
                    hideAfter: 5000
                });
            }
        });
    }
</script>
</body>
</html>

