<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<!-- DataTables CSS -->
<link th:href="@{/css/dataTables.bootstrap4.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

<style>
    .block-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    .block-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .property-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
    }
    .unassigned-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
    }
    .stats-card {
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
</style>

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>

    <div class="page-wrapper">
        <div class="container-fluid">
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h3 class="text-themecolor">
                        <i class="fas fa-exchange-alt text-primary"></i>
                        Assignment Centre
                    </h3>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/blocks}">Blocks</a></li>
                        <li class="breadcrumb-item active">Assignment Centre</li>
                    </ol>
                </div>
                <div class="col-md-4 text-right">
                    <div class="btn-group">
                        <a th:href="@{/blocks}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Blocks
                        </a>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row" id="summaryCards">
                <div class="col-md-6">
                    <div class="stats-card bg-white shadow-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Total Blocks</h6>
                                <h2 class="mb-0" id="totalBlocks">-</h2>
                            </div>
                            <div>
                                <i class="fas fa-building fa-3x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card bg-white shadow-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Unassigned Properties</h6>
                                <h2 class="mb-0 text-warning" id="totalUnassigned">-</h2>
                            </div>
                            <div>
                                <i class="fas fa-home fa-3x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#blocksTab" role="tab">
                                <i class="fas fa-building"></i> Blocks & Properties
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#unassignedTab" role="tab">
                                <i class="fas fa-exclamation-triangle"></i> Unassigned Properties
                                <span class="badge badge-warning ml-1" id="unassignedBadge">0</span>
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Blocks Tab -->
                        <div class="tab-pane active" id="blocksTab" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div id="blocksContainer">
                                        <p class="text-center text-muted py-5">
                                            <i class="fas fa-spinner fa-spin fa-2x"></i><br>
                                            Loading blocks...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Unassigned Properties Tab -->
                        <div class="tab-pane" id="unassignedTab" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div class="unassigned-section">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0">
                                                <i class="fas fa-home"></i> Properties Not Assigned to Any Block
                                            </h5>
                                            <button class="btn btn-primary" onclick="showBulkAssignModal()">
                                                <i class="fas fa-plus"></i> Assign to Block
                                            </button>
                                        </div>
                                        <div id="unassignedPropertiesContainer">
                                            <p class="text-center text-muted py-3">
                                                <i class="fas fa-spinner fa-spin"></i> Loading...
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div th:replace="~{general/footer.html}"></div>
    </div>
</div>

<!-- Bulk Assign Modal -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Assign Properties to Block
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="targetBlockSelect">Select Block</label>
                    <select class="form-control" id="targetBlockSelect">
                        <option value="">-- Select a block --</option>
                    </select>
                </div>
                <div id="propertiesToAssignContainer">
                    <p class="text-muted">Select a block to see assignable properties</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performBulkAssign()" id="bulkAssignBtn">
                    <i class="fas fa-check"></i> Assign Selected
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script th:src="@{/js/library/jquery-3.2.1.min.js}"></script>
<script th:src="@{/js/library/popper.min.js}"></script>
<script th:src="@{/js/library/bootstrap.min.js}"></script>
<script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/library/waves.js}"></script>
<script th:src="@{/js/library/sidebarmenu.js}"></script>
<script th:src="@{/js/library/sticky-kit.min.js}"></script>
<script th:src="@{/js/library/custom.min.js}"></script>

<script th:inline="javascript">
/*<![CDATA[*/
const csrfToken = /*[[${_csrf.token}]]*/ '';
const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

let assignmentData = null;

$(document).ready(function() {
    loadAssignmentData();
});

function refreshData() {
    loadAssignmentData();
}

function loadAssignmentData() {
    fetch('/blocks/api/assignment-overview')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                assignmentData = data;
                updateSummary(data);
                renderBlocks(data.blocks);
                renderUnassignedProperties(data.unassignedProperties);
            } else {
                showError('Failed to load assignment data: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading assignment data:', error);
            showError('Error loading assignment data');
        });
}

function updateSummary(data) {
    $('#totalBlocks').text(data.totalBlocks);
    $('#totalUnassigned').text(data.totalUnassigned);
    $('#unassignedBadge').text(data.totalUnassigned);
}

function renderBlocks(blocks) {
    if (!blocks || blocks.length === 0) {
        $('#blocksContainer').html(`
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                No blocks found. <a href="/blocks" class="alert-link">Create a new block</a> to get started.
            </div>
        `);
        return;
    }

    let html = '<div class="row">';

    blocks.forEach(block => {
        const capacityText = block.maxProperties
            ? `${block.propertyCount}/${block.maxProperties} properties`
            : `${block.propertyCount} properties`;

        const capacityClass = block.availableCapacity === 0 ? 'text-danger' :
                             block.availableCapacity <= 5 ? 'text-warning' :
                             'text-success';

        html += `
            <div class="col-md-6 mb-3">
                <div class="block-card card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title mb-1">
                                    <a href="/blocks/${block.id}">${block.name}</a>
                                </h5>
                                <span class="badge badge-info">${block.blockType || 'BUILDING'}</span>
                            </div>
                            <div class="text-right">
                                <h4 class="mb-0 ${capacityClass}">${block.propertyCount}</h4>
                                <small class="text-muted">properties</small>
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">${capacityText}</small>
                                ${block.availableCapacity !== null ?
                                    `<br><small class="${capacityClass}">
                                        ${block.availableCapacity} slots available
                                    </small>` : ''}
                            </div>
                            <div>
                                <a href="/blocks/${block.id}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <button class="btn btn-sm btn-success" onclick="quickAssign(${block.id}, '${block.name}')">
                                    <i class="fas fa-plus"></i> Assign
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    $('#blocksContainer').html(html);
}

function renderUnassignedProperties(properties) {
    if (!properties || properties.length === 0) {
        $('#unassignedPropertiesContainer').html(`
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                All properties are assigned to blocks!
            </div>
        `);
        return;
    }

    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllUnassigned" onclick="toggleSelectAllUnassigned()">
                        </th>
                        <th>Property Name</th>
                        <th>Type</th>
                        <th>Address</th>
                        <th>Postcode</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    properties.forEach(property => {
        const address = [property.addressLine1, property.city].filter(x => x).join(', ');
        html += `
            <tr>
                <td>
                    <input type="checkbox" class="unassigned-checkbox" value="${property.id}">
                </td>
                <td>
                    <a href="/property/${property.id}">
                        ${property.propertyName || 'Unnamed Property'}
                    </a>
                </td>
                <td>${property.propertyType || '-'}</td>
                <td>${address || '-'}</td>
                <td>${property.postcode || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="assignSingleProperty(${property.id}, '${property.propertyName}')">
                        <i class="fas fa-plus"></i> Assign
                    </button>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    $('#unassignedPropertiesContainer').html(html);
}

function toggleSelectAllUnassigned() {
    const isChecked = $('#selectAllUnassigned').prop('checked');
    $('.unassigned-checkbox').prop('checked', isChecked);
}

function showBulkAssignModal() {
    if (!assignmentData || !assignmentData.blocks) {
        alert('No blocks available');
        return;
    }

    // Populate block dropdown
    let options = '<option value="">-- Select a block --</option>';
    assignmentData.blocks.forEach(block => {
        const capacityInfo = block.maxProperties ? ` (${block.propertyCount}/${block.maxProperties})` : '';
        options += `<option value="${block.id}">${block.name}${capacityInfo}</option>`;
    });
    $('#targetBlockSelect').html(options);

    // Show selected properties count
    const selectedCount = $('.unassigned-checkbox:checked').length;
    if (selectedCount === 0) {
        alert('Please select at least one property to assign');
        return;
    }

    $('#bulkAssignModal').modal('show');
}

function quickAssign(blockId, blockName) {
    if (!assignmentData || !assignmentData.unassignedProperties || assignmentData.unassignedProperties.length === 0) {
        alert('No unassigned properties available');
        return;
    }

    // Set the block
    $('#targetBlockSelect').val(blockId);

    // Show modal
    $('#bulkAssignModal').modal('show');
}

function assignSingleProperty(propertyId, propertyName) {
    if (!assignmentData || !assignmentData.blocks || assignmentData.blocks.length === 0) {
        alert('No blocks available');
        return;
    }

    // Populate block dropdown
    let options = '<option value="">-- Select a block --</option>';
    assignmentData.blocks.forEach(block => {
        options += `<option value="${block.id}">${block.name}</option>`;
    });

    const blockId = prompt(`Assign "${propertyName}" to which block?\n\nEnter block ID or cancel:`);
    if (!blockId) return;

    assignPropertiesToBlock(blockId, [propertyId]);
}

function performBulkAssign() {
    const blockId = $('#targetBlockSelect').val();
    if (!blockId) {
        alert('Please select a block');
        return;
    }

    const selectedPropertyIds = [];
    $('.unassigned-checkbox:checked').each(function() {
        selectedPropertyIds.push(parseInt($(this).val()));
    });

    if (selectedPropertyIds.length === 0) {
        alert('Please select at least one property');
        return;
    }

    assignPropertiesToBlock(blockId, selectedPropertyIds);
}

function assignPropertiesToBlock(blockId, propertyIds) {
    $('#bulkAssignBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Assigning...');

    fetch(`/blocks/api/${blockId}/assign-properties`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify({ propertyIds: propertyIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully assigned ${data.successCount} ${data.successCount === 1 ? 'property' : 'properties'} to ${data.blockName}!`);
            $('#bulkAssignModal').modal('hide');
            loadAssignmentData(); // Refresh data
        } else {
            alert('Failed to assign properties: ' + (data.error || 'Unknown error'));
        }
        $('#bulkAssignBtn').prop('disabled', false).html('<i class="fas fa-check"></i> Assign Selected');
    })
    .catch(error => {
        console.error('Error assigning properties:', error);
        alert('Error assigning properties');
        $('#bulkAssignBtn').prop('disabled', false).html('<i class="fas fa-check"></i> Assign Selected');
    });
}

function showError(message) {
    $('#blocksContainer').html(`
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> ${message}
        </div>
    `);
}
/*]]>*/
</script>

</body>
</html>
