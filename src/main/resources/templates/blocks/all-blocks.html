<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:insert="~{general/head.html}"></div>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<!-- DataTables CSS -->
<link th:href="@{/css/dataTables.bootstrap4.css}" rel="stylesheet">
<link th:href="@{/css/responsive.dataTables.min.css}" rel="stylesheet">
<link th:href="@{/css/style.min.css}" rel="stylesheet">

<style>
    .block-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        height: 100%;
    }
    .block-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .block-type-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .property-count-badge {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .sync-status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .sync-synced { background-color: #28a745; }
    .sync-pending { background-color: #ffc107; }
    .sync-failed { background-color: #dc3545; }
    .block-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
</style>

</head>

<body class="skin-blue fixed-layout">
<div class="preloader">
    <div class="loader">
        <div class="loader__figure"></div>
        <p class="loader__label">CRM</p>
    </div>
</div>

<div id="main-wrapper">
    <div th:replace="~{general/header.html}"></div>
    <div th:replace="~{general/left-sidebar.html}"></div>

    <div class="page-wrapper">
        <div class="container-fluid">
            <!-- Breadcrumb -->
            <div class="row page-titles">
                <div class="col-md-8 align-self-center">
                    <h3 class="text-themecolor">
                        <i class="fas fa-building text-primary"></i>
                        Block Management
                    </h3>
                    <p class="text-muted">Manage property blocks, service charges, and block-level operations</p>
                </div>
                <div class="col-md-4 text-right">
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="showCreateBlockModal()">
                            <i class="fas fa-plus"></i> Create New Block
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#" onclick="filterBlocks('all')">
                                    <i class="fas fa-list"></i> All Blocks
                                </a>
                                <a class="dropdown-item" href="#" onclick="filterBlocks('active')">
                                    <i class="fas fa-check-circle"></i> Active Only
                                </a>
                                <a class="dropdown-item" href="#" onclick="filterBlocks('synced')">
                                    <i class="fas fa-sync"></i> PayProp Synced
                                </a>
                                <a class="dropdown-item" href="#" onclick="filterBlocks('pending')">
                                    <i class="fas fa-clock"></i> Sync Pending
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#" onclick="toggleView('grid')">
                                    <i class="fas fa-th"></i> Grid View
                                </a>
                                <a class="dropdown-item" href="#" onclick="toggleView('table')">
                                    <i class="fas fa-table"></i> Table View
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="messageArea"></div>

            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="totalBlocks">0</h4>
                                    <small>Total Blocks</small>
                                </div>
                                <div>
                                    <i class="fas fa-building fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="activeBlocks">0</h4>
                                    <small>Active Blocks</small>
                                </div>
                                <div>
                                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="totalProperties">0</h4>
                                    <small>Properties in Blocks</small>
                                </div>
                                <div>
                                    <i class="fas fa-home fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0" id="syncPending">0</h4>
                                    <small>Sync Pending</small>
                                </div>
                                <div>
                                    <i class="fas fa-sync-alt fa-2x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blocks Grid View -->
            <div id="blocksGridView" class="block-grid"></div>

            <!-- Blocks Table View (hidden by default) -->
            <div id="blocksTableView" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <table id="blocksTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Address</th>
                                    <th>Properties</th>
                                    <th>Status</th>
                                    <th>PayProp Sync</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="blocksTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Create Block Modal -->
<div class="modal fade" id="createBlockModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building"></i> Create New Block
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createBlockForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="blockName">Block Name *</label>
                                <input type="text" class="form-control" id="blockName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="blockType">Block Type</label>
                                <select class="form-control" id="blockType">
                                    <option value="BUILDING">Building</option>
                                    <option value="ESTATE">Estate</option>
                                    <option value="STREET">Street</option>
                                    <option value="AREA">Area</option>
                                    <option value="COMPLEX">Complex</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="blockDescription">Description</label>
                        <textarea class="form-control" id="blockDescription" rows="3"></textarea>
                    </div>

                    <h6 class="mt-3 mb-2"><i class="fas fa-map-marker-alt"></i> Address Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addressLine1">Address Line 1</label>
                                <input type="text" class="form-control" id="addressLine1">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="addressLine2">Address Line 2</label>
                                <input type="text" class="form-control" id="addressLine2">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" class="form-control" id="city">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="county">County</label>
                                <input type="text" class="form-control" id="county">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="postcode">Postcode</label>
                                <input type="text" class="form-control" id="postcode">
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-3 mb-2"><i class="fas fa-cog"></i> Configuration</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="maxProperties">Maximum Properties</label>
                                <input type="number" class="form-control" id="maxProperties" min="1">
                                <small class="form-text text-muted">Leave empty for unlimited</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="colorCode">Color Code</label>
                                <input type="color" class="form-control" id="colorCode" value="#007bff">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createBlock()">
                    <i class="fas fa-save"></i> Create Block
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Block Details Modal -->
<div class="modal fade" id="blockDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blockDetailsTitle">Block Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="blockDetailsBody">
                <!-- Block details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<div th:replace="~{general/footer.html}"></div>

<!-- Scripts -->
<script th:src="@{/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/perfect-scrollbar.jquery.min.js}"></script>
<script th:src="@{/js/custom.min.js}"></script>
<script th:src="@{/js/jquery.dataTables.min.js}"></script>
<script th:src="@{/js/dataTables.bootstrap4.min.js}"></script>

<script th:inline="none">
let allBlocks = [];
let currentView = 'grid';
let currentFilter = 'all';
const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

$(document).ready(function() {
    loadAllBlocks();
});

function loadAllBlocks() {
    fetch('/blocks/api/all')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allBlocks = data.blocks;
                updateStatistics();
                displayBlocks();
            } else {
                showMessage('error', 'Failed to load blocks: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading blocks:', error);
            showMessage('error', 'Error loading blocks');
        });
}

function updateStatistics() {
    const total = allBlocks.length;
    const active = allBlocks.filter(b => b.isActive === 'Y').length;
    const pending = allBlocks.filter(b => b.syncStatus === 'pending' || b.syncStatus === 'failed').length;
    const totalProps = allBlocks.reduce((sum, b) => sum + (b.propertyCount || 0), 0);

    document.getElementById('totalBlocks').textContent = total;
    document.getElementById('activeBlocks').textContent = active;
    document.getElementById('totalProperties').textContent = totalProps;
    document.getElementById('syncPending').textContent = pending;
}

function displayBlocks() {
    const filtered = filterBlocksArray(allBlocks);

    if (currentView === 'grid') {
        displayBlocksGrid(filtered);
    } else {
        displayBlocksTable(filtered);
    }
}

function filterBlocksArray(blocks) {
    switch(currentFilter) {
        case 'active':
            return blocks.filter(b => b.isActive === 'Y');
        case 'synced':
            return blocks.filter(b => b.syncStatus === 'synced');
        case 'pending':
            return blocks.filter(b => b.syncStatus === 'pending' || b.syncStatus === 'failed');
        default:
            return blocks;
    }
}

function displayBlocksGrid(blocks) {
    const container = document.getElementById('blocksGridView');
    container.innerHTML = '';

    if (blocks.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-building fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No blocks found</h4>
                <p class="text-muted">Create your first block to get started</p>
                <button class="btn btn-primary" onclick="showCreateBlockModal()">
                    <i class="fas fa-plus"></i> Create Block
                </button>
            </div>
        `;
        return;
    }

    blocks.forEach(block => {
        const card = createBlockCard(block);
        container.innerHTML += card;
    });
}

function createBlockCard(block) {
    const syncStatusClass = `sync-${block.syncStatus || 'pending'}`;
    const syncStatusText = {
        'synced': 'Synced',
        'pending': 'Pending',
        'failed': 'Failed',
        'syncing': 'Syncing...'
    }[block.syncStatus] || 'Unknown';

    const address = [block.addressLine1, block.city, block.postcode].filter(x => x).join(', ') || 'No address';

    return `
        <div class="card block-card" onclick="viewBlockDetails(${block.id})">
            <span class="badge badge-info block-type-badge">${block.blockType || 'BUILDING'}</span>
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-building text-primary"></i>
                    ${block.name}
                </h5>
                <p class="card-text text-muted small mb-3">${address}</p>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="property-count-badge text-info">${block.propertyCount || 0}</span>
                        <small class="text-muted">Properties</small>
                    </div>
                    <div>
                        ${block.maxProperties ? `<small class="text-muted">Max: ${block.maxProperties}</small>` : ''}
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="sync-status-indicator ${syncStatusClass}"></span>
                        <small>${syncStatusText}</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-sm btn-outline-primary" onclick="editBlock(${block.id}); event.stopPropagation();">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="syncBlock(${block.id}); event.stopPropagation();"
                                ${block.syncStatus === 'syncing' ? 'disabled' : ''}>
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayBlocksTable(blocks) {
    $('#blocksTableView').show();
    $('#blocksGridView').hide();

    const tbody = document.getElementById('blocksTableBody');
    tbody.innerHTML = '';

    blocks.forEach(block => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${block.name}</strong></td>
            <td><span class="badge badge-info">${block.blockType || 'BUILDING'}</span></td>
            <td>${[block.addressLine1, block.city].filter(x => x).join(', ') || 'N/A'}</td>
            <td>${block.propertyCount || 0}</td>
            <td><span class="badge badge-${block.isActive === 'Y' ? 'success' : 'secondary'}">${block.isActive === 'Y' ? 'Active' : 'Inactive'}</span></td>
            <td><span class="badge badge-${getSyncStatusColor(block.syncStatus)}">${block.syncStatus || 'pending'}</span></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-info" onclick="viewBlockDetails(${block.id})"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-warning" onclick="editBlock(${block.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-success" onclick="syncBlock(${block.id})"><i class="fas fa-sync"></i></button>
                </div>
            </td>
        `;
    });

    if ($.fn.DataTable.isDataTable('#blocksTable')) {
        $('#blocksTable').DataTable().destroy();
    }
    $('#blocksTable').DataTable({
        responsive: true,
        order: [[0, 'asc']]
    });
}

function getSyncStatusColor(status) {
    const colors = {
        'synced': 'success',
        'pending': 'warning',
        'failed': 'danger',
        'syncing': 'info'
    };
    return colors[status] || 'secondary';
}

function showCreateBlockModal() {
    $('#createBlockModal').modal('show');
}

function createBlock() {
    const blockData = {
        name: document.getElementById('blockName').value,
        description: document.getElementById('blockDescription').value,
        blockType: document.getElementById('blockType').value,
        addressLine1: document.getElementById('addressLine1').value,
        addressLine2: document.getElementById('addressLine2').value,
        city: document.getElementById('city').value,
        county: document.getElementById('county').value,
        postcode: document.getElementById('postcode').value,
        maxProperties: document.getElementById('maxProperties').value || null,
        colorCode: document.getElementById('colorCode').value
    };

    if (!blockData.name || blockData.name.trim() === '') {
        showMessage('error', 'Block name is required');
        return;
    }

    fetch('/blocks/api/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(blockData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', 'Block created successfully');
            $('#createBlockModal').modal('hide');
            document.getElementById('createBlockForm').reset();
            loadAllBlocks();
        } else {
            showMessage('error', 'Failed to create block: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating block:', error);
        showMessage('error', 'Error creating block');
    });
}

function viewBlockDetails(blockId) {
    window.location.href = `/blocks/${blockId}`;
}

function editBlock(blockId) {
    window.location.href = `/blocks/${blockId}/edit`;
}

function syncBlock(blockId) {
    if (!confirm('Sync this block with PayProp?')) return;

    showMessage('info', 'Syncing block...');

    fetch(`/portfolio/internal/blocks/payprop/${blockId}/sync`, {
        method: 'POST',
        headers: {
            [csrfHeader]: csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('success', `Block synced successfully. ${data.propertiesSynced} properties synced.`);
            loadAllBlocks();
        } else {
            showMessage('error', 'Sync failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error syncing block:', error);
        showMessage('error', 'Error syncing block');
    });
}

function filterBlocks(filter) {
    currentFilter = filter;
    displayBlocks();
}

function toggleView(view) {
    currentView = view;
    if (view === 'grid') {
        $('#blocksTableView').hide();
        $('#blocksGridView').show();
    }
    displayBlocks();
}

function showMessage(type, message) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';

    const icon = {
        'success': 'fa-check',
        'error': 'fa-exclamation-triangle',
        'warning': 'fa-exclamation',
        'info': 'fa-info-circle'
    }[type] || 'fa-info-circle';

    const html = `
        <div class="alert ${alertClass} alert-dismissible fade show">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <h4><i class="icon fa ${icon}"></i> ${type.charAt(0).toUpperCase() + type.slice(1)}!</h4>
            ${message}
        </div>
    `;

    document.getElementById('messageArea').innerHTML = html;

    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>

</body>
</html>
